<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TGS/TMP Review Checklist</title>
    
    <!-- ============================================
         SEO Meta Tags
         ============================================ -->
    <meta name="description" content="Interactive TMP &amp; TGS Workflow Checklist for traffic management planning. Multi-role review system with guided handover, auto-save, and PDF export.">
    <meta name="author" content="Crompton Concepts">
    <meta name="keywords" content="TGS, TMP, Traffic Guidance Scheme, Traffic Management Plan, AGTTM, QGTTM, road safety, checklist">
    
    <!-- ============================================
         Security: Content Security Policy (CSP)
         Note: For full protection, also set via HTTP headers.
         Meta CSP limitations: no report-uri, no frame-ancestors
         ============================================ -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: blob: https://images.unsplash.com https://placehold.co;
        connect-src 'self' https://api.openai.com https://cromptonconcepts.sharepoint.com;
        frame-src 'none';
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    
    <!-- ============================================
         Critical Rendering Path Optimizations
         - Preconnect: Early TLS handshake for critical domains
         - DNS-Prefetch: Fallback for browsers without preconnect
         ============================================ -->
    
    <!-- Google Fonts (critical for typography) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- jsdelivr CDN (used by pako, html2pdf - non-blocking with defer) -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- Google Fonts stylesheet -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@500;600;700&family=Cormorant+Garamond:wght@600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================
           ROOT CSS CUSTOM PROPERTIES (Design Tokens)
           ============================================ */
        :root {
            /* Primary Colors */
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --primary-dark: #3730a3;
            --primary-light: #e0e7ff;
            
            /* Secondary Colors */
            --secondary-color: #64748b;
            --secondary-hover: #475569;
            
            /* Status Colors */
            --success-color: #10b981;
            --success-hover: #059669;
            --success-bg: #ecfdf5;
            --success-fg: #047857;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --warning-color: #f59e0b;
            --warning-hover: #d97706;
            --info-color: #06b6d4;
            --info-hover: #0891b2;
            
            /* Role Colors */
            --role-designer-color: #3b82f6;
            --role-admin-intermediate-color: #8b5cf6;
            --role-qa-color: #10b981;
            --role-tmd-color: #f59e0b;
            --role-admin-final-color: #ec4899;
            
            /* Text Colors */
            --text-color: #1e293b;
            --text-secondary: #64748b;
            --text-inverse: #ffffff;
            --heading-color: #0f172a;
            
            /* Background Colors */
            --background-color: #f8fafc;
            --background-secondary: #f1f5f9;
            --card-background: #ffffff;
            --container-background: #ffffff;
            --surface-elevated: #f8fafc;
            --surface-muted: #f1f5f9;
            --disabled-bg: #e2e8f0;
            
            /* Border Colors */
            --border-color: #e2e8f0;
            --border-hover: #cbd5e1;
            --border-color-light: #cbd5f5;
            --divider-color: #e2e8f0;
            
            /* Glass/Transparent Effects */
            --glass-card-bg: rgba(255, 255, 255, 0.85);
            --glass-chip-bg: rgba(248, 250, 252, 0.9);
            --glass-border: rgba(226, 232, 240, 0.8);
            --glass-shadow: 0 8px 32px rgba(15, 23, 42, 0.1);
            --workflow-card-bg: rgba(255, 255, 255, 0.95);
            --hover-bg: rgba(241, 245, 249, 0.8);
            
            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(15, 23, 42, 0.05);
            --shadow-sm: 0 1px 3px rgba(15, 23, 42, 0.1), 0 1px 2px rgba(15, 23, 42, 0.06);
            --shadow-md: 0 4px 6px rgba(15, 23, 42, 0.1), 0 2px 4px rgba(15, 23, 42, 0.06);
            --shadow-lg: 0 10px 15px rgba(15, 23, 42, 0.1), 0 4px 6px rgba(15, 23, 42, 0.05);
            --shadow-xl: 0 20px 25px rgba(15, 23, 42, 0.1), 0 10px 10px rgba(15, 23, 42, 0.04);
            --shadow-focus: 0 0 0 3px rgba(99, 102, 241, 0.25);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-hero: linear-gradient(135deg, #1e3a8a 0%, #6366f1 50%, #a855f7 100%);
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 24px;
            --space-2xl: 32px;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            --radius-2xl: 16px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* Miscellaneous */
            --focus-ring: rgba(99, 102, 241, 0.4);
            --action-panel-bg: rgba(15, 23, 42, 0.95);
            --kbd-bg: rgba(30, 41, 59, 0.8);
            --kbd-text: #e2e8f0;
            --help-bg: #fffbeb;
            --help-border: #fcd34d;
            --body-pattern-color: rgba(99, 102, 241, 0.03);
        }
        
        /* ============================================
           DARK THEME OVERRIDES
           ============================================ */
        :root[data-theme="dark"] {
            /* Text Colors */
            --text-color: #f1f5f9;
            --text-secondary: #94a3b8;
            --heading-color: #f8fafc;
            
            /* Background Colors */
            --background-color: #0f172a;
            --background-secondary: #1e293b;
            --card-background: #1e293b;
            --container-background: #0f172a;
            --surface-elevated: #1e293b;
            --surface-muted: #334155;
            --disabled-bg: #334155;
            
            /* Border Colors */
            --border-color: #334155;
            --border-hover: #475569;
            --divider-color: #334155;
            
            /* Glass/Transparent Effects */
            --glass-card-bg: rgba(30, 41, 59, 0.85);
            --glass-chip-bg: rgba(51, 65, 85, 0.9);
            --glass-border: rgba(71, 85, 105, 0.6);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --workflow-card-bg: rgba(30, 41, 59, 0.95);
            --hover-bg: rgba(51, 65, 85, 0.6);
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.5);
            
            /* Miscellaneous */
            --body-pattern-color: rgba(99, 102, 241, 0.02);
        }
        
        /* ============================================
           BASE STYLES
           ============================================ */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Hide load buttons for designer in new project mode */
        body.designer-new-project .section-load-btn,
        body.designer-new-project .section-save-load {
            display: none !important;
        }
        
        /* Hide only the load button and tip text in tgs-set-actions, keep the Copy button visible */
        body.designer-new-project .tgs-set-actions > p {
            display: none !important;
        }
        
        /* Progress Bar at Top */
        #progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--border-color);
            z-index: 10000;
        }
        
        #progress-bar {
            height: 100%;
            width: 0;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }
        
        /* ============================================
           LANDING PAGE STYLES
           ============================================ */
        .landing-glass-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            max-width: min(1100px, 90vw);
            min-height: 520px;
            background: var(--glass-card-bg);
            border-radius: 28px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            backdrop-filter: blur(16px);
            overflow: hidden;
        }
        
        .landing-left {
            padding: 48px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 16px;
        }
        
        .landing-kicker {
            display: inline-block;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--primary-color);
            background: var(--primary-light);
            padding: 6px 14px;
            border-radius: 999px;
            width: fit-content;
        }
        
        .landing-left h1 {
            font-size: clamp(2rem, 4vw, 2.6rem);
            font-weight: 800;
            line-height: 1.15;
            color: var(--heading-color);
            margin: 0;
        }
        
        .landing-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .landing-footer-links {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 0.85rem;
            margin-top: 12px;
            color: var(--text-secondary);
        }
        
        .landing-footer-links a,
        .landing-footer-links button {
            color: var(--primary-color);
            text-decoration: none;
            background: none;
            border: none;
            cursor: pointer;
            font: inherit;
        }
        
        .landing-footer-links a:hover,
        .landing-footer-links button:hover {
            text-decoration: underline;
        }
        
        .landing-right {
            background: #f8fafc;
            padding: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .features-compact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            width: 100%;
        }
        
        .feature-compact-item {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }
        
        .feature-icon-box {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        /* Feature title - styled smaller for visual hierarchy despite being h2 */
        .feature-text h2.feature-title,
        .feature-text .feature-title {
            margin: 0 0 4px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--heading-color);
        }
        
        .feature-text p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* Instruction title - styled smaller for visual hierarchy despite being h4 */
        h4.instruction-title,
        .instruction-title {
            font-size: 0.95em;
            font-weight: 600;
            margin: 0 0 8px;
            color: inherit;
        }

        /* ============================================
           DARK THEME - LANDING PAGE
           ============================================ */
        :root[data-theme="dark"] .landing-right {
            background: #0f172a;
        }

        :root[data-theme="dark"] .feature-compact-item {
            background: #1e293b;
            border-color: #334155;
        }

        :root[data-theme="dark"] .feature-text h2.feature-title,
        :root[data-theme="dark"] .feature-text .feature-title {
            color: #f1f5f9;
        }

        :root[data-theme="dark"] .feature-text p {
            color: #cbd5e1;
        }

        :root[data-theme="dark"] .feature-icon-box {
            background: rgba(99, 102, 241, 0.2);
        }

        :root[data-theme="dark"] .hero-badge {
            color: rgba(236, 239, 255, 0.88);
        }

        :root[data-theme="dark"] .hero-copy h1 {
            color: #f9fbff;
        }

        :root[data-theme="dark"] .hero-subtitle {
            color: rgba(236, 239, 255, 0.78);
        }

        :root[data-theme="dark"] .hero-meta-link {
            color: rgba(236, 239, 255, 0.7);
        }

        :root[data-theme="dark"] .hero-meta-link:hover {
            color: #ffffff;
        }

        @media (max-width: 850px) {
            .landing-glass-card {
                grid-template-columns: 1fr;
                max-width: min(600px, 95vw);
                height: auto;
            }

            .landing-left {
                padding: 30px 25px;
                text-align: center;
            }

            .landing-right {
                display: none;
            }

            .landing-left h1 {
                font-size: clamp(1.8rem, 5vw, 2.2rem);
                text-align: center;
            }

            .landing-kicker {
                align-self: center;
            }

            .landing-actions {
                justify-content: center;
                flex-direction: column;
                width: 100%;
            }

            .landing-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .landing-footer-links {
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        @media (min-width: 851px) and (max-width: 1024px) {
            .landing-glass-card {
                max-width: min(900px, 90vw);
            }

            .landing-left h1 {
                font-size: clamp(2rem, 4vw, 2.4rem);
            }
        }

        @media (max-width: 480px) {
            .landing-page {
                padding: 1rem;
            }

            .landing-glass-card {
                border-radius: 16px;
                max-width: 100%;
            }

            .landing-left {
                padding: 20px 15px;
            }

            .landing-left h1 {
                font-size: 1.6rem;
                line-height: 1.2;
            }

            .hero-subtitle {
                font-size: 0.85rem;
            }

            .landing-kicker {
                font-size: 0.65rem;
                padding: 4px 10px;
            }

            .landing-actions .btn {
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .landing-footer-links {
                font-size: 0.75rem;
                gap: 10px;
                flex-direction: column;
                align-items: center;
            }

            .landing-footer-links span {
                display: none;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg);
            }

            33% {
                transform: translateY(-20px) rotate(1deg);
            }

            66% {
                transform: translateY(-10px) rotate(-1deg);
            }
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: var(--container-background);
            border: 1px solid var(--border-color);
            padding: clamp(1rem, 3vw, 3rem) clamp(0.75rem, 2vw, 2rem);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
            box-sizing: border-box;

        }

        .hero-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: clamp(32px, 6vw, 60px);
            margin-bottom: 0;
            padding: clamp(32px, 5vw, 56px);
            border-radius: 36px;
            background: rgba(8, 16, 48, 0.72);
            border: 1px solid rgba(255, 255, 255, 0.22);
            box-shadow: 0 30px 60px rgba(5, 10, 40, 0.45);
            backdrop-filter: blur(18px);
            color: #f8fafc;
            overflow: hidden;
        }

        .hero-header::before {
            content: '';
            position: absolute;
            inset: -20%;
            background: radial-gradient(circle at 20% -10%, rgba(99, 102, 241, 0.35) 0%, transparent 55%),
                radial-gradient(circle at 120% 50%, rgba(14, 165, 233, 0.28) 0%, transparent 65%);
            opacity: 0.85;
            z-index: 0;
            pointer-events: none;
        }

        .hero-copy {
            position: relative;
            z-index: 1;
            flex: 1;
            min-width: 0;
            color: #f8fafc;
        }

        .hero-kicker {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            border-radius: 999px;
            font-size: 0.82rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(236, 239, 255, 0.88);
            background: rgba(99, 102, 241, 0.28);
            margin-bottom: var(--space-md);
        }

        .hero-copy h1 {
            margin: 0 0 var(--space-md) 0;
            font-size: clamp(2.2rem, 4vw, 3.2rem);
            line-height: 1.1;
            text-align: left;
            color: #f9fbff;
        }

        .hero-subtitle {
            color: #4a5568;
            font-size: 1.05rem;
            line-height: 1.7;
            margin-bottom: clamp(20px, 4vw, 32px);
            max-width: min(580px, 100%);
        }

        .hero-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            margin-bottom: clamp(20px, 4vw, 32px);
            position: relative;
            z-index: 2;
        }

        .hero-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            border-radius: 999px;
            padding: 12px 26px;
            font-weight: 600;
            box-shadow: none;
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .hero-actions .btn:hover {
            transform: translateY(-2px);
        }

        .landing-page .btn-primary {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(129, 140, 248, 0.95));
            border: none;
            color: #ffffff;
            box-shadow: 0 22px 44px rgba(79, 70, 229, 0.45);
        }

        .landing-page .btn-primary:hover {
            box-shadow: 0 26px 52px rgba(79, 70, 229, 0.55);
        }

        .landing-page .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.5);
            color: #1e293b;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.12);
        }

        .landing-page .btn-secondary:hover {
            background: #ffffff;
            border-color: rgba(99, 102, 241, 0.4);
            color: #0f172a;
            box-shadow: 0 24px 52px rgba(15, 23, 42, 0.16);
        }

        :root[data-theme="dark"] .landing-page .btn-secondary {
            background: rgba(30, 41, 59, 0.95);
            color: #ffffff;
            border-color: rgba(148, 163, 184, 0.3);
        }

        :root[data-theme="dark"] .landing-page .btn-secondary:hover {
            background: rgba(51, 65, 85, 1);
            color: #ffffff;
        }

        .landing-page .btn-info {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.88), rgba(59, 130, 246, 0.9));
            border: none;
            color: #ffffff;
            box-shadow: 0 20px 40px rgba(14, 165, 233, 0.35);
        }

        .landing-page .btn-info:hover {
            box-shadow: 0 24px 48px rgba(14, 165, 233, 0.45);
        }

        .hero-meta-link {
            font-size: 0.9rem;
            color: rgba(236, 239, 255, 0.7);
            text-decoration: underline;
            transition: color var(--transition-fast);
        }

        .hero-meta-link:hover {
            color: #ffffff;
        }

        .hero-visual {
            position: relative;
            z-index: 1;
            flex: 0 0 clamp(220px, 28vw, 320px);
            height: clamp(220px, 28vw, 320px);
            border-radius: 32px;
            background: rgba(255, 255, 255, 0.14);
            border: 1px solid rgba(255, 255, 255, 0.24);
            box-shadow: 0 28px 50px rgba(5, 10, 35, 0.4);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .hero-visual::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.32), rgba(14, 165, 233, 0.25));
            z-index: 1;
        }

        .hero-visual::after {
            content: '';
            position: absolute;
            inset: 18px;
            border-radius: inherit;
            background: rgba(255, 255, 255, 0.08);
            z-index: 2;
        }

        .hero-visual-art {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.28;
            filter: saturate(1.05) contrast(1.05);
            z-index: 0;
        }

        .hero-visual-content {
            position: relative;
            z-index: 3;
            text-align: center;
            color: rgba(255, 255, 255, 0.92);
        }

        .hero-visual-content strong {
            display: block;
            font-size: 0.95rem;
            letter-spacing: 0.08em;
        }

        .hero-visual-content span {
            display: block;
            margin-top: 10px;
            font-size: 2.6rem;
            font-weight: 700;
        }

        .landing-page {
            min-height: 100vh;
            padding: clamp(48px, 8vw, 96px);
            background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.18), transparent 55%),
                radial-gradient(circle at bottom left, rgba(79, 70, 229, 0.14), transparent 55%),
                linear-gradient(135deg, rgba(226, 232, 240, 0.4), rgba(219, 234, 254, 0.6));
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        :root[data-theme="dark"] .landing-page {
            background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.15), transparent 55%),
                radial-gradient(circle at bottom left, rgba(139, 92, 246, 0.12), transparent 55%),
                linear-gradient(135deg, #0f172a, #1e293b);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 25% 25%, var(--body-pattern-color) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, var(--body-pattern-color) 2px, transparent 2px);
            background-size: 60px 60px;
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        .landing-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .landing-modal.is-visible {
            display: flex;
        }

        .landing-modal-dialog {
            background: var(--container-background);
            border-radius: 18px;
            max-width: 640px;
            width: min(640px, 100%);
            max-height: 90vh;
            overflow-y: auto;
            padding: clamp(24px, 4vw, 36px);
            box-shadow: var(--shadow-xl);
            position: relative;
        }

        .landing-modal-close {
            position: absolute;
            top: 14px;
            right: 16px;
            border: none;
            background: transparent;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary-color);
        }

        .landing-modal-dialog h2 {
            margin-top: 0;
            margin-bottom: 12px;
        }

        .landing-modal-intro {
            margin: 0 0 16px;
            color: var(--secondary-color);
        }

        .landing-modal-list {
            margin: 0 0 16px;
            padding-left: 22px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            color: var(--secondary-color);
        }

        .landing-modal-list strong {
            color: var(--primary-dark);
        }

        .landing-modal-footnote {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .landing-modal-footnote a {
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem 0.75rem;
                border-radius: var(--radius-lg);
                margin: 0;
            }

            .landing-page {
                padding: 1rem;
            }

            .landing-meta,
            .landing-cta-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }

        @media (max-width: 960px) {
            .hero-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .hero-visual {
                width: 100%;
                height: 180px;
            }

            .hero-actions {
                width: 100%;
            }

            .hero-actions .btn {
                justify-content: center;
                width: 100%;
                box-shadow: none;
            }
        }



        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg,
                    var(--role-designer-color) 0%,
                    var(--role-admin-intermediate-color) 25%,
                    var(--role-qa-color) 50%,
                    var(--role-tmd-color) 75%,
                    var(--role-admin-final-color) 100%);
            animation: gradientShift 8s ease-in-out infinite;
        }

        @keyframes gradientShift {

            0%,
            100% {
                filter: hue-rotate(0deg) brightness(1);
            }

            50% {
                filter: hue-rotate(10deg) brightness(1.1);
            }
        }

        /* Glass Card Effect for Inner Elements */
        .container::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.1) 0%,
                    rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
            z-index: -1;
        }

        h1,
        h2,
        h3 {
            font-family: 'Inter', sans-serif;
            color: var(--heading-color);
            text-align: center;
            font-weight: 700;
            line-height: 1.1;
        }

        h1 {
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            margin-bottom: var(--space-lg);
            margin-top: var(--space-xl);
            font-weight: 800;
            background: var(--gradient-hero);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 200%;
            animation: gradientText 6s ease-in-out infinite;
            letter-spacing: -0.025em;
            position: relative;
        }

        :root[data-theme="dark"] h1 {
            background: linear-gradient(135deg, #ffffff, #a5b4fc);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: #ffffff;
            text-shadow: 0 0 25px rgba(148, 163, 184, 0.35);
        }

        h2 {
            font-size: clamp(1.75rem, 3vw, 2.25rem);
            margin-bottom: var(--space-md);
            margin-top: var(--space-xl);
            font-weight: 600;
            color: var(--heading-color);
            letter-spacing: -0.01em;
        }

        h3 {
            font-size: clamp(1.25rem, 2.5vw, 1.5rem);
            margin-bottom: var(--space-sm);
            margin-top: var(--space-lg);
            font-weight: 600;
            color: var(--text-color);
        }

        /* Ensure section headers and headings are visible in dark theme */
        :root[data-theme="dark"] h1,
        :root[data-theme="dark"] h2,
        :root[data-theme="dark"] h3,
        :root[data-theme="dark"] h4,
        :root[data-theme="dark"] h5,
        :root[data-theme="dark"] h6,
        :root[data-theme="dark"] .section-header,
        :root[data-theme="dark"] .section-title,
        :root[data-theme="dark"] .accordion-header,
        :root[data-theme="dark"] .project-suite-container > h2,
        :root[data-theme="dark"] .workflow-bar h3 {
            color: #f1f5f9 !important;
        }

        /* TMP-specific header in dark mode */
        :root[data-theme="dark"] .tmp-set-header {
            color: #f1f5f9 !important;
        }

        @keyframes gradientText {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes titlePulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            width: 100px;
            height: 4px;
            background: var(--gradient-primary);
            transform: translateX(-50%);
            border-radius: 2px;

        }

        @keyframes underlineGrow {
            0% {
                transform: scaleX(0);
                opacity: 0;
            }

            100% {
                transform: scaleX(1);
                opacity: 1;
            }
        }

        /* Workflow Instruction Box Styles */
        .workflow-instruction-box {
            margin: 15px 0;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid;
            font-size: 0.92em;
            line-height: 1.6;
        }
        
        .workflow-instruction-box.info {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            border-left-color: #0ea5e9;
            color: #0369a1;
        }
        
        .workflow-instruction-box.tip {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            border-left-color: #10b981;
            color: #047857;
        }
        
        .workflow-instruction-box.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
            border-left-color: #f59e0b;
            color: #92400e;
        }
        
        .workflow-instruction-box.highlight {
            background: linear-gradient(135deg, #fae8ff 0%, #fdf4ff 100%);
            border-left-color: #a855f7;
            color: #7e22ce;
        }
        
        .workflow-instruction-box h5 {
            margin: 0 0 8px 0;
            font-size: 1em;
            font-weight: 600;
        }
        
        .workflow-instruction-box p {
            margin: 0;
        }
        
        .workflow-instruction-box ol, .workflow-instruction-box ul {
            margin: 8px 0 0;
            padding-left: 20px;
        }
        
        .workflow-instruction-box li {
            margin-bottom: 4px;
        }
        
        :root[data-theme="dark"] .workflow-instruction-box.info {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(14, 165, 233, 0.08) 100%);
            color: #7dd3fc;
        }
        
        :root[data-theme="dark"] .workflow-instruction-box.tip {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.08) 100%);
            color: #6ee7b7;
        }
        
        :root[data-theme="dark"] .workflow-instruction-box.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%);
            color: #fcd34d;
        }
        
        :root[data-theme="dark"] .workflow-instruction-box.highlight {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.08) 100%);
            color: #d8b4fe;
        }

        /* Quick Reference Workflow Cards */
        .workflow-quick-ref {
            margin: 20px 0;
            padding: 20px 25px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdf4 100%);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        
        .workflow-quick-ref h4 {
            margin: 0 0 15px 0;
            color: var(--heading-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .workflow-quick-ref .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .workflow-step-card {
            padding: 12px 15px;
            background: var(--surface-elevated);
            border-radius: 10px;
            border-left: 4px solid;
        }
        
        .workflow-step-card.step-1 { border-left-color: #3b82f6; }
        .workflow-step-card.step-2 { border-left-color: #8b5cf6; }
        .workflow-step-card.step-3 { border-left-color: #10b981; }
        .workflow-step-card.step-4 { border-left-color: #f59e0b; }
        .workflow-step-card.step-5 { border-left-color: #ec4899; }
        
        .workflow-step-card strong {
            color: var(--heading-color);
        }
        
        .workflow-step-card p {
            margin: 5px 0 0;
            font-size: 0.88em;
            color: var(--text-secondary);
        }
        
        :root[data-theme="dark"] .workflow-quick-ref {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.08) 100%);
        }

        .workflow-bar {
            padding: var(--space-xl) var(--space-2xl);
            border-radius: 28px;
            margin-bottom: var(--space-2xl);
            background: var(--workflow-card-bg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            position: relative;
        }

        .workflow-bar h3 {
            color: var(--heading-color);
        }

        :root[data-theme="dark"] .workflow-bar h3 {
            color: #ffffff;
        }

        @keyframes slideInFromTop {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }



        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 9999;
        }

        .toast {
            min-width: 280px;
            max-width: 380px;
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            background: var(--card-background);
            border-left: 6px solid var(--success-color);
            color: var(--text-color);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: toastEnter 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(8px);
        }
        
        .toast.toast-exit {
            animation: toastExit 0.3s ease forwards;
        }
        
        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--info-color); }
        
        :root[data-theme="dark"] .toast {
            background: rgba(30, 41, 59, 0.95);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .toast .toast-icon {
            font-size: 1.4rem;
            line-height: 1;
        }

        .toast .toast-content {
            flex: 1;
        }

        .toast strong {
            display: block;
            font-size: 1rem;
            margin-bottom: 4px;
            color: var(--heading-color);
        }
        
        :root[data-theme="dark"] .toast strong {
            color: #f1f5f9;
        }
        
        :root[data-theme="dark"] .toast .toast-content {
            color: #e2e8f0;
        }

        .toast button.toast-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }

        @keyframes toastEnter {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes toastExit {
            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        /* Quick Actions Panel */
        #quick-actions-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--action-panel-bg);
            backdrop-filter: blur(12px);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            display: flex;
            gap: 12px;
            align-items: center;
            z-index: 9999;
            transition: transform 0.3s var(--ease-smooth), opacity 0.3s;
            opacity: 0;
            pointer-events: none;
            color: white;
            font-size: 14px;
        }

        #quick-actions-panel.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .quick-action-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        kbd {
            background: var(--kbd-bg);
            color: var(--kbd-text);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Help Tooltip System */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--info-color);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
            cursor: help;
            margin-left: 6px;
            transition: all 0.2s;
        }

        .help-icon:hover {
            transform: scale(1.15);
            background: var(--info-hover);
        }

        .help-tooltip {
            position: absolute;
            background: var(--help-bg);
            border: 2px solid var(--help-border);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            z-index: 10000;
            font-size: 13px;
            line-height: 1.5;
            display: none;
            color: #78350f;
        }

        .help-tooltip.show {
            display: block;
            animation: tooltipFadeIn 0.2s ease;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .help-tooltip strong {
            color: #92400e;
            display: block;
            margin-bottom: 4px;
        }

        /* Undo/Redo Notification */
        #undo-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--card-background);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--success-color);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 9998;
            animation: slideInRight 0.3s ease;
        }

        #undo-notification.show {
            display: flex;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Keyboard Shortcuts Help Modal */
        #shortcuts-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        #shortcuts-modal.show {
            display: flex;
        }

        .shortcuts-content {
            background: var(--card-background);
            padding: 32px;
            border-radius: 16px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .shortcuts-grid {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--surface-elevated);
            border-radius: 6px;
        }

        .shortcut-desc {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
        }

        .workflow-bar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            align-items: stretch;
        }

        .workflow-card-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xl);
        }

        .workflow-card {
            background: var(--card-background);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .workflow-card h3 {
            color: var(--heading-color);
        }

        :root[data-theme="dark"] .workflow-card {
            background: rgba(15, 23, 42, 0.95);
            border-color: rgba(148, 163, 184, 0.35);
            box-shadow: 0 25px 55px rgba(2, 6, 23, 0.7);
        }

        :root[data-theme="dark"] .workflow-card h3,
        :root[data-theme="dark"] .workflow-card label,
        :root[data-theme="dark"] .workflow-card p,
        :root[data-theme="dark"] .workflow-card small {
            color: #ffffff;
        }

        .workflow-bar-grid>* {
            min-width: 0;
        }

        .workflow-enhancements {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 25px 0 35px;
        }

        .enhancement-card {
            background: var(--workflow-card-bg);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        :root[data-theme="dark"] .enhancement-card {
            background: rgba(17, 24, 39, 0.9);
            border-color: rgba(99, 102, 241, 0.35);
            box-shadow: 0 22px 40px rgba(2, 6, 23, 0.6);
        }

        .enhancement-card h3 {
            margin: 0 0 6px;
            color: var(--heading-color);
        }

        .enhancement-card p {
            margin: 0 0 14px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        :root[data-theme="dark"] .enhancement-card h3,
        :root[data-theme="dark"] .enhancement-card p {
            color: #ffffff;
        }

        .section-navigator-control {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 6px;
        }

        #section-jump-select {
            flex: 1;
            min-width: 220px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--card-background);
            font-size: 0.95rem;
        }

        .section-jump-summary {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .form-search-block {
            margin-top: 16px;
        }

        .form-search-block label {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--heading-color);
        }

        :root[data-theme="dark"] .form-search-block label {
            color: #ffffff;
        }

        .form-search-block input[type="search"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--card-background);
            font-size: 0.95rem;
            margin-top: 6px;
        }

        .form-search-feedback {
            font-size: 0.85rem;
            margin-top: 4px;
            color: var(--text-secondary);
        }

        .user-notes-field {
            width: 100%;
            min-height: 140px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 12px 14px;
            resize: vertical;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            background: var(--card-background);
        }

        .notes-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .notes-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .notes-actions .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            min-height: 32px;
        }

        .question-block.search-hit,
        .accordion-header.search-hit {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.35);
            border-color: var(--primary-color) !important;
        }

        .question-block.search-hit::after {
            content: 'Match';
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--primary-dark);
            background: rgba(99, 102, 241, 0.18);
            padding: 2px 6px;
            border-radius: 999px;
        }

        .search-muted {
            opacity: 0.35;
        }

        .accordion-section.search-section-hit .accordion-header {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        @media (max-width: 768px) {
            .workflow-enhancements {
                margin: 20px 0 25px;
            }

            .notes-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        .workflow-actions,
        .workflow-status {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .contact-developer-block {
            margin-top: 10px;
            padding-top: 18px;
            border-top: 1px dashed var(--border-color-light, #cbd5f5);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .contact-developer-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .contact-developer-actions .btn {
            flex: 1;
            justify-content: center;
            min-width: 120px;
        }

        .contact-support-copy {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .contact-support-copy h4 {
            margin: 0;
            font-size: 1em;
            color: var(--heading-color);
        }

        .contact-support-copy p {
            margin: 0;
            font-size: 0.9em;
            color: var(--text-muted);
        }

        :root[data-theme="dark"] .contact-support-copy h4,
        :root[data-theme="dark"] .contact-support-copy p {
            color: #ffffff;
        }

        .role-card {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            text-align: center;
        }

        @media (min-width: 1100px) {
            .workflow-bar-grid {
                grid-template-columns: minmax(300px, 0.8fr) minmax(420px, 1.2fr);
            }
        }

        .role-selector {
            text-align: center;
        }

        .role-selector h3 {
            margin-top: 0;
            color: var(--heading-color);
            font-weight: 600;
            font-size: 1.3em;
        }

        :root[data-theme="dark"] .role-selector h3 {
            color: #ffffff;
        }

        select#role {
            width: 100%;
            padding: 12px 16px;
            font-size: 1rem;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            background: var(--card-background);
            min-width: 250px;
            color: var(--text-color);
            box-shadow: var(--shadow-sm);
            font-weight: 600;
        }

        select#role:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-lg);
        }

        select#role:focus {
            outline: none;
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.25);
        }

        /* Ensure role selector stays visible */
        .role-selector,
        select#role {
            visibility: visible !important;
            opacity: 1 !important;
            animation: none !important;
            transform: none !important;
        }

        #current-role-display {
            font-weight: 600;
            font-size: 0.875rem;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-full);
            color: var(--text-inverse);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            animation: slideIn 0.3s var(--ease-out-back);
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: linear-gradient(120deg, #6366f1, #ec4899);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-ops {
            margin-top: 0;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            padding: 10px;
            border-radius: 16px;
            background: var(--glass-chip-bg);
        }

        .theme-toggle-btn {
            background: transparent;
            color: var(--text-color);
            border-color: var(--border-color);
            box-shadow: none;
            font-weight: 600;
        }

        .theme-toggle-btn:hover {
            background: var(--surface-muted);
            border-color: var(--border-hover);
            box-shadow: var(--shadow-sm);
        }

        .theme-toggle-icon {
            font-size: 1.1rem;
        }

        .btn {
            padding: var(--space-md) var(--space-lg);
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            line-height: 1.5;
            min-height: 44px;
            white-space: nowrap;
        }

        @keyframes buttonEntry {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
            transition: transform var(--transition-fast);
        }

        .btn:focus-visible,
        input:focus-visible,
        textarea:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .btn:focus {
            outline: none;
            box-shadow: var(--shadow-lg),
                0 0 0 3px rgba(37, 99, 235, 0.3);
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-inverse);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
            box-shadow: var(--shadow-lg), 0 0 0 3px var(--focus-ring);
        }

        .btn-secondary {
            background: var(--surface-elevated);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
            border-color: var(--border-hover);
        }

        :root[data-theme="dark"] .btn-secondary {
            background: rgba(30, 41, 59, 0.85);
            color: var(--text-color);
            border-color: rgba(148, 163, 184, 0.4);
        }

        :root[data-theme="dark"] .btn-secondary:hover {
            background: rgba(51, 65, 85, 0.85);
            border-color: rgba(148, 163, 184, 0.6);
        }

        .btn-success {
            background: var(--success-color);
            color: var(--text-inverse);
            border-color: var(--success-color);
        }

        .btn-success:hover {
            background: var(--success-hover);
            border-color: var(--success-hover);
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(16, 185, 129, 0.12);
        }

        .btn-info {
            background: var(--info-color);
            color: var(--text-inverse);
            border-color: var(--info-color);
        }

        .btn-info:hover {
            background: var(--info-hover);
            border-color: var(--info-hover);
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(6, 182, 212, 0.15);
        }

        /* Load (Import) button - distinct shaded colour similar to save but different */
        .btn-load {
            background: linear-gradient(135deg, rgba(6, 182, 212, 1) 0%, rgba(99, 102, 241, 1) 100%);
            color: var(--text-inverse);
            border-color: rgba(6, 182, 212, 0.95);
            box-shadow: var(--shadow-sm);
        }

        .btn-load:hover {
            background: linear-gradient(135deg, rgba(6, 162, 192, 1) 0%, rgba(79, 70, 229, 1) 100%);
            border-color: var(--info-hover);
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(6, 182, 212, 0.12);
        }

        .btn-danger {
            background: var(--danger-color);
            color: var(--text-inverse);
            border-color: var(--danger-color);
        }

        .btn-danger:hover {
            background: var(--danger-hover);
            border-color: var(--danger-hover);
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(239, 68, 68, 0.12);
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--text-inverse);
            border-color: var(--warning-color);
        }

        .btn-warning:hover {
            background: var(--warning-hover);
            border-color: var(--warning-hover);
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(245, 158, 11, 0.12);
        }

        .btn-teams {
            background: #464EB8;
            color: var(--text-inverse);
            border-color: #464EB8;
        }

        .btn-teams:hover {
            background: #3730a3;
            border-color: #3730a3;
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(70, 78, 184, 0.12);
        }

        .btn svg {
            width: 20px;
            height: 20px;
            position: relative;
            z-index: 1;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn.disabled,
        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .btn.disabled:hover,
        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .btn.disabled::before,
        .btn:disabled::before {
            display: none;
        }

        .skip-btn {
            padding: 10px 18px;
            font-size: 0.9em;
            float: right;
        }

        .skip-section-btn {
            padding: 8px 15px;
            font-size: 0.85em;
            margin-left: 20px;
            font-weight: 500;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8em;
            font-weight: 500;
            border-radius: 6px;
        }

        .accordion-section {
            margin-bottom: var(--space-xl);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            overflow: hidden;
            transition: all var(--transition-normal);
            background: var(--card-background);
            box-shadow: var(--shadow-sm);
            position: relative;

        }

        :root[data-theme="dark"] .accordion-section {
            background: rgba(17, 24, 39, 0.92);
            border-color: rgba(148, 163, 184, 0.3);
            box-shadow: 0 25px 55px rgba(2, 6, 23, 0.7);
        }



        .accordion-section:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--border-hover);
            transform: translateY(-1px);
        }

        .accordion-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .accordion-section:hover::before {
            opacity: 1;
        }

        .accordion-header {
            background: var(--background-secondary);
            padding: var(--space-lg) var(--space-xl);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 1.125rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-user-select: none;
            user-select: none;
            transition: all var(--transition-normal);
            border-bottom: 1px solid var(--divider-color);
            position: relative;
            overflow: hidden;
            color: var(--heading-color);
        }

        :root[data-theme="dark"] .accordion-header {
            background: rgba(15, 23, 42, 0.92);
            border-bottom-color: rgba(148, 163, 184, 0.25);
            color: var(--text-color);
        }

        .accordion-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(37, 99, 235, 0.1),
                    transparent);
            transition: left var(--transition-normal);
        }

        .accordion-header-text {
            flex-grow: 1;
        }

        .accordion-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .check-all-controls {
            display: none;
            align-items: center;
            gap: 8px;
            background-color: rgba(0, 0, 0, 0.03);
            padding: 5px 10px;
            border-radius: 8px;
        }

        :root[data-theme="dark"] .check-all-controls {
            background-color: rgba(30, 41, 59, 0.75);
        }

        .check-all-label {
            font-size: 0.85em;
            font-weight: 500;
            color: var(--secondary-color);
        }

        :root[data-theme="dark"] .check-all-label {
            color: #ffffff;
        }

        body.role-selected-designer .check-all-controls,
        body.role-selected-qa .check-all-controls,
        body.role-selected-tmd .check-all-controls,
        body.role-selected-admin-intermediate .check-all-controls,
        body.role-selected-admin-final .check-all-controls {
            display: flex;
        }

        .tgs-set-bulk-controls {
            display: none;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, rgba(59, 130, 246, 0.05) 100%);
            padding: 12px 20px;
            border-radius: 12px;
            margin: 15px 0 20px 0;
            border: 2px solid rgba(37, 99, 235, 0.15);
            box-shadow: var(--shadow-sm);
        }

        :root[data-theme="dark"] .tgs-set-bulk-controls {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(99, 102, 241, 0.08) 100%);
            border-color: rgba(99, 102, 241, 0.35);
        }

        body.role-selected-designer .tgs-set-bulk-controls,
        body.role-selected-qa .tgs-set-bulk-controls,
        body.role-selected-tmd .tgs-set-bulk-controls,
        body.role-selected-admin-intermediate .tgs-set-bulk-controls,
        body.role-selected-admin-final .tgs-set-bulk-controls {
            display: flex;
        }

        .tgs-set-bulk-label {
            font-size: 0.95em;
            font-weight: 600;
            color: var(--primary-dark);
            margin-right: 8px;
        }

        :root[data-theme="dark"] .tgs-set-bulk-label {
            color: #ffffff;
        }

        .tgs-set-bulk-controls .btn {
            font-size: 0.9em;
            padding: 8px 16px;
            font-weight: 600;
        }

        /* Ensure copy set controls are always visible for all roles */
        .copy-set-controls,
        .copy-set-btn,
        .copy-set-dropdown {
            display: inline-flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Performance optimizations: GPU acceleration and will-change hints */
        .accordion-header,
        .tgs-set-container,
        .tmp-set-container,
        .toast,
        .modal-overlay {
            will-change: transform;
            transform: translateZ(0);
        }
        
        /* Reduce repaints/reflows */
        .form-field,
        textarea,
        input[type="text"],
        select {
            contain: layout style;
        }

        .accordion-header:hover {
            background: linear-gradient(135deg,
                    rgba(241, 245, 249, 0.9) 0%,
                    rgba(226, 232, 240, 0.9) 100%);
            padding-left: 36px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8),
                var(--shadow-sm);
        }

        :root[data-theme="dark"] .accordion-header:hover {
            background: rgba(30, 41, 59, 0.95);
            box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.1), var(--shadow-sm);
        }

        .accordion-header:hover::before {
            left: 100%;
        }

        .accordion-header::after {
            content: '';
            font-size: 0.9em;
            transition: transform var(--transition-normal);
            color: var(--primary-color);
            font-weight: bold;
            margin-left: 20px;
            padding: 8px;
            border-radius: 50%;
            background: rgba(37, 99, 235, 0.1);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .accordion-header.active {
            background: linear-gradient(135deg,
                    var(--primary-light) 0%,
                    rgba(219, 234, 254, 0.9) 100%);
            color: var(--primary-hover);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8),
                var(--shadow-md);
        }

        :root[data-theme="dark"] .accordion-header.active {
            background: rgba(99, 102, 241, 0.18);
            color: var(--text-color);
            box-shadow: inset 0 1px 0 rgba(99, 102, 241, 0.3), var(--shadow-md);
        }

        .accordion-header.active::after {
            transform: rotate(180deg);
            background: rgba(37, 99, 235, 0.2);
        }

        .accordion-content {
            padding: 35px;
            display: none;
            background: var(--card-background);
            color: var(--text-color);
            border-top: 2px solid var(--border-color);
        }

        :root[data-theme="dark"] .accordion-content {
            background: rgba(17, 24, 39, 0.92);
            border-top-color: rgba(148, 163, 184, 0.25);
        }

        .question-block {
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            background: var(--card-background);
            transition: all var(--transition-normal);
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .question-block.hidden-by-focus {
            display: none !important;
        }

        .question-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
            transform: scaleY(0);
            transition: transform var(--transition-normal);
            transform-origin: bottom;
        }

        .question-block:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .question-block:hover::before {
            transform: scaleY(1);
            transform-origin: top;
        }

        .question-block p.question-text {
            margin-top: 0;
            font-weight: 600;
            font-size: 1.2em;
            color: var(--heading-color);
            line-height: 1.6;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-light);
        }

        :root[data-theme="dark"] .question-block p.question-text {
            color: var(--text-color);
            border-bottom-color: rgba(99, 102, 241, 0.35);
        }

        .question-block label {
            display: block;
            font-weight: 700;
            font-size: 1.1em;
            margin-top: 20px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .question-block label:first-child {
            margin-top: 0;
        }

        .checks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 20px;
            margin: 20px 0;
            align-items: stretch;
        }

        .checks-grid .check-item:nth-child(1) {
            /* Designer */
            grid-column: 1;
            grid-row: 1;
        }

        .checks-grid .check-item:nth-child(2) {
            /* Admin Intermediate */
            grid-column: 2;
            grid-row: 1;
        }

        .checks-grid .check-item:nth-child(3) {
            /* QA */
            grid-column: 1;
            grid-row: 2;
        }

        .checks-grid .check-item:nth-child(4) {
            /* TMD */
            grid-column: 2;
            grid-row: 2;
        }

        .checks-grid .check-item:nth-child(5) {
            /* Admin Final */
            grid-column: 1 / -1;
            /* Span full width */
            grid-row: 3;
        }

        .check-item {
            display: flex;
            align-items: center;
            padding: 16px 18px;
            border-radius: 12px;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.9) 0%,
                    rgba(248, 250, 252, 0.9) 100%);
            border: 2px solid rgba(226, 232, 240, 0.6);
            transition: all var(--transition-normal);
            backdrop-filter: blur(5px);
            box-shadow: var(--shadow-xs);
            position: relative;
            overflow: hidden;
        }

        .check-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(37, 99, 235, 0.1),
                    transparent);
            transition: left var(--transition-normal);
        }

        .check-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md),
                0 0 20px rgba(37, 99, 235, 0.1);
            transform: translateX(4px) translateY(-2px);
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.95) 0%,
                    rgba(248, 250, 252, 0.95) 100%);
        }

        .check-item:hover::before {
            left: 100%;
        }

        .check-item input[type="checkbox"],
        .check-item input[type="radio"] {
            width: 24px;
            height: 24px;
            margin-right: 14px;
            accent-color: var(--primary-color);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .check-item input[type="checkbox"]:hover,
        .check-item input[type="radio"]:hover {
            transform: scale(1.1);
        }

        .check-item input[type="checkbox"]:checked,
        .check-item input[type="radio"]:checked {
            transform: scale(1.05);
            filter: drop-shadow(0 2px 4px rgba(37, 99, 235, 0.3));
        }

        .check-item label {
            font-weight: 500;
            font-size: 0.95em;
            cursor: pointer;
            flex: 1;
            transition: color var(--transition-fast);
            position: relative;
            z-index: 1;
        }

        .check-item:hover label {
            color: var(--primary-dark);
        }

        :root[data-theme="dark"] .check-item {
            background: rgba(15, 23, 42, 0.85);
            border-color: rgba(148, 163, 184, 0.4);
            box-shadow: 0 12px 24px rgba(2, 6, 23, 0.6);
        }

        :root[data-theme="dark"] .check-item::before {
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.25), transparent);
        }

        :root[data-theme="dark"] .check-item label {
            color: #ffffff;
        }

        :root[data-theme="dark"] .check-item:hover label {
            color: #ffffff;
        }

        /* Custom questions role check styling */
        .role-check-group {
            flex-direction: column;
            align-items: flex-start;
            padding: 12px;
            gap: 8px;
        }

        .role-check-group>label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--heading-color);
        }

        .role-checks {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .role-checks .check-item {
            background: transparent;
            border: none;
            padding: 4px 8px;
            box-shadow: none;
            min-width: auto;
        }

        /* Custom Question Button Enhancements */
        .custom-add-question-btn {
            position: relative;
            overflow: hidden;
        }

        .custom-add-question-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .custom-add-question-btn:hover::before {
            left: 100%;
        }

        .custom-add-button-container {
            animation: buttonGlow 2s ease-in-out infinite alternate;
        }

        @keyframes buttonGlow {
            0% {
                box-shadow: 0 0 5px rgba(59, 130, 246, 0.3);
            }

            100% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.3);
            }
        }

        /* Role Sign-Off Section Title Styling */
        .role-signoff-title {
            animation: roleSignoffEntry 0.8s ease-out;
        }

        .role-signoff-title:hover {
            transform: translateY(-2px);
            transition: transform 0.3s ease;
        }

        @keyframes roleSignoffEntry {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .site-presence-block {
            margin-top: 20px;
            padding: 18px;
            border-radius: 10px;
            background: var(--primary-light);
            border-left: 4px solid var(--primary-color);
        }

        .site-presence-block legend {
            font-weight: 600;
            font-size: 1.05em;
            margin-bottom: 12px;
            color: var(--heading-color);
        }

        .site-presence-options {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            justify-content: flex-start;
        }
        
        .site-presence-options .check-item {
            background: var(--surface-elevated);
        }
        
        :root[data-theme="dark"] .site-presence-options .check-item {
            background: rgba(255, 255, 255, 0.08);
        }

        .conflict-block {
            margin-top: 20px;
            padding: 18px;
            border-radius: 10px;
            background: rgba(249, 115, 22, 0.12);
            border-left: 4px solid var(--warning-color);
        }

        .conflict-block legend {
            font-weight: 700;
            font-size: 1.05em;
            margin-bottom: 12px;
            color: var(--warning-color);
        }

        .comments-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        textarea,
        input[type="text"],
        input[type="date"],
        input[type="number"] {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            margin-top: 0px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 400;
            transition: all var(--transition-normal);
            background: var(--card-background);
            box-shadow: var(--shadow-sm);
            position: relative;
            color: var(--text-color);
            line-height: 1.5;
        }

        textarea:hover,
        input[type="text"]:hover,
        input[type="date"]:hover,
        input[type="number"]:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.6;
        }

        input,
        textarea,
        select {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.95) 0%,
                    rgba(248, 250, 252, 0.95) 100%);
            color: var(--text-color);
        }

        input:disabled,
        textarea:disabled,
        select:disabled,
        button.btn:disabled {
            background: var(--disabled-bg);
            color: var(--text-secondary);
            cursor: not-allowed;
            border-color: var(--border-color) !important;
            box-shadow: none !important;
            opacity: 0.85;
            transform: none !important;
        }

        :root[data-theme="dark"] input:disabled,
        :root[data-theme="dark"] textarea:disabled,
        :root[data-theme="dark"] select:disabled,
        :root[data-theme="dark"] button.btn:disabled {
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            border-color: rgba(148, 163, 184, 0.5) !important;
            opacity: 0.9;
        }

        /* Improved visibility for disabled check items (radio/checkbox groups) */
        .check-item:has(input:disabled) {
            opacity: 0.85;
        }
        
        .check-item:has(input:disabled) label {
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        
        :root[data-theme="dark"] .check-item:has(input:disabled) {
            opacity: 0.9;
            border-color: rgba(148, 163, 184, 0.5);
        }
        
        :root[data-theme="dark"] .check-item:has(input:disabled) label {
            color: #cbd5e1;
        }

        /* Role check groups - ensure disabled role sections remain visible */
        .checks-grid > .check-item:has(input:disabled) {
            background: var(--surface-muted);
            border-color: var(--border-color);
        }
        
        :root[data-theme="dark"] .checks-grid > .check-item:has(input:disabled) {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(148, 163, 184, 0.4);
        }
        
        .checks-grid > .check-item:has(input:disabled) span {
            color: var(--text-secondary);
        }
        
        :root[data-theme="dark"] .checks-grid > .check-item:has(input:disabled) span {
            color: #94a3b8;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color) !important;
            box-shadow: var(--shadow-focus);
        }

        :root[data-theme="dark"] textarea,
        :root[data-theme="dark"] input,
        :root[data-theme="dark"] select {
            background: #1f2937 !important;
            color: #f8fafc !important;
            border-color: rgba(148, 163, 184, 0.7) !important;
            box-shadow: none;
            -webkit-text-fill-color: #f8fafc;
        }

        :root[data-theme="dark"] textarea::placeholder,
        :root[data-theme="dark"] input::placeholder {
            color: rgba(226, 232, 240, 0.7);
        }
        
        /* Dark Mode - Additional Text Visibility Fixes */
        :root[data-theme="dark"] label,
        :root[data-theme="dark"] legend,
        :root[data-theme="dark"] .question-block label {
            color: #e2e8f0 !important;
        }
        
        :root[data-theme="dark"] .site-presence-block {
            background: rgba(99, 102, 241, 0.15);
            border-left-color: var(--primary-color);
        }
        
        :root[data-theme="dark"] .site-presence-block legend {
            color: #f1f5f9 !important;
        }
        
        :root[data-theme="dark"] .conflict-block {
            background: rgba(245, 158, 11, 0.15);
        }
        
        :root[data-theme="dark"] .conflict-block legend {
            color: #fcd34d !important;
        }
        
        :root[data-theme="dark"] p,
        :root[data-theme="dark"] span:not(.theme-toggle-icon),
        :root[data-theme="dark"] li {
            color: #e2e8f0;
        }
        
        :root[data-theme="dark"] .landing-modal-dialog {
            background: var(--card-background);
            color: var(--text-color);
        }
        
        :root[data-theme="dark"] .landing-modal-intro,
        :root[data-theme="dark"] .landing-modal-list,
        :root[data-theme="dark"] .landing-modal-footnote {
            color: #cbd5e1;
        }
        
        :root[data-theme="dark"] .landing-modal-list strong {
            color: #a5b4fc;
        }
        
        :root[data-theme="dark"] .help-tooltip {
            background: #1e293b;
            border-color: #475569;
            color: #f1f5f9;
        }
        
        :root[data-theme="dark"] .help-tooltip strong {
            color: #fcd34d;
        }
        
        :root[data-theme="dark"] .quick-comment-selector {
            background: #1f2937 !important;
            color: #f8fafc !important;
        }
        
        :root[data-theme="dark"] .quick-comment-selector option {
            background: #1e293b;
            color: #f8fafc;
        }
        
        :root[data-theme="dark"] .signoff-helper-text {
            color: #cbd5e1 !important;
        }
        
        :root[data-theme="dark"] .tgs-set-header,
        :root[data-theme="dark"] .tmp-set-header {
            color: #f1f5f9 !important;
        }
        
        :root[data-theme="dark"] .file-info-text,
        :root[data-theme="dark"] .info-text {
            color: #94a3b8 !important;
        }

        /* ============================================
           DARK MODE - COMPREHENSIVE TEXT VISIBILITY FIXES
           Rule: Dark background = white text, White background = black text
           ============================================ */
        
        /* Modal Content - Dark bg needs white text */
        :root[data-theme="dark"] .modal-content {
            background: #1e293b !important;
            color: #ffffff !important;
        }
        
        :root[data-theme="dark"] .modal-content h1,
        :root[data-theme="dark"] .modal-content h2,
        :root[data-theme="dark"] .modal-content h3,
        :root[data-theme="dark"] .modal-content h4,
        :root[data-theme="dark"] .modal-content h5,
        :root[data-theme="dark"] .modal-content h6 {
            color: #ffffff !important;
        }
        
        :root[data-theme="dark"] .modal-content p,
        :root[data-theme="dark"] .modal-content span,
        :root[data-theme="dark"] .modal-content li,
        :root[data-theme="dark"] .modal-content label {
            color: #e2e8f0 !important;
        }
        
        :root[data-theme="dark"] .modal-close-btn {
            color: #94a3b8 !important;
        }
        
        :root[data-theme="dark"] .modal-close-btn:hover {
            color: #ffffff !important;
        }
        
        /* Final Summary Container */
        :root[data-theme="dark"] #final-summary-container {
            background: #1e293b !important;
            color: #ffffff !important;
        }
        
        :root[data-theme="dark"] #final-summary-container h1,
        :root[data-theme="dark"] #final-summary-container h2,
        :root[data-theme="dark"] #final-summary-container h3,
        :root[data-theme="dark"] #final-summary-container h4 {
            color: #ffffff !important;
        }
        
        :root[data-theme="dark"] #final-summary-container p,
        :root[data-theme="dark"] #final-summary-container span,
        :root[data-theme="dark"] #final-summary-container li,
        :root[data-theme="dark"] #final-summary-container td,
        :root[data-theme="dark"] #final-summary-container th {
            color: #e2e8f0 !important;
        }
        
        :root[data-theme="dark"] .summary-section h3,
        :root[data-theme="dark"] .summary-section h4 {
            color: #ffffff !important;
            border-bottom-color: rgba(148, 163, 184, 0.35) !important;
        }
        
        :root[data-theme="dark"] .company-header {
            color: #ffffff !important;
        }
        
        /* History Log */
        :root[data-theme="dark"] .history-log li {
            color: #e2e8f0 !important;
            border-bottom-color: rgba(148, 163, 184, 0.3) !important;
        }
        
        :root[data-theme="dark"] .history-log strong {
            color: #ffffff !important;
        }
        
        /* All headings in dark mode */
        :root[data-theme="dark"] h1,
        :root[data-theme="dark"] h2,
        :root[data-theme="dark"] h3,
        :root[data-theme="dark"] h4,
        :root[data-theme="dark"] h5,
        :root[data-theme="dark"] h6 {
            color: #ffffff !important;
        }
        
        /* Question blocks and form labels */
        :root[data-theme="dark"] .question-block {
            color: #e2e8f0 !important;
        }
        
        :root[data-theme="dark"] .question-block p,
        :root[data-theme="dark"] .question-block .question-text {
            color: #e2e8f0 !important;
        }
        
        /* Accordion sections */
        :root[data-theme="dark"] .accordion-header {
            color: #ffffff !important;
        }
        
        /* Check items */
        :root[data-theme="dark"] .check-item label,
        :root[data-theme="dark"] .check-item span {
            color: #e2e8f0 !important;
        }
        
        /* Sign-off sections */
        :root[data-theme="dark"] .signoff-block {
            color: #e2e8f0 !important;
        }
        
        :root[data-theme="dark"] .signoff-block h3,
        :root[data-theme="dark"] .signoff-block h4 {
            color: #ffffff !important;
        }
        
        :root[data-theme="dark"] .signoff-block label {
            color: #e2e8f0 !important;
        }
        
        /* Workflow cards and status */
        :root[data-theme="dark"] .workflow-step-card {
            color: #e2e8f0 !important;
        }
        
        :root[data-theme="dark"] .workflow-step-card h4 {
            color: #ffffff !important;
        }
        
        /* Info blocks with light backgrounds need dark text */
        :root[data-theme="dark"] .alert-info,
        :root[data-theme="dark"] .info-box {
            background: rgba(6, 182, 212, 0.15) !important;
            color: #ffffff !important;
        }
        
        :root[data-theme="dark"] .alert-warning {
            background: rgba(245, 158, 11, 0.15) !important;
            color: #ffffff !important;
        }
        
        :root[data-theme="dark"] .alert-success {
            background: rgba(16, 185, 129, 0.15) !important;
            color: #ffffff !important;
        }
        
        :root[data-theme="dark"] .alert-danger,
        :root[data-theme="dark"] .alert-error {
            background: rgba(239, 68, 68, 0.15) !important;
            color: #ffffff !important;
        }
        
        /* Tables */
        :root[data-theme="dark"] table {
            color: #e2e8f0 !important;
        }
        
        :root[data-theme="dark"] table th {
            color: #ffffff !important;
            background: rgba(30, 41, 59, 0.8) !important;
        }
        
        :root[data-theme="dark"] table td {
            color: #e2e8f0 !important;
        }
        
        /* Tooltips and popovers */
        :root[data-theme="dark"] .tooltip,
        :root[data-theme="dark"] .popover {
            background: #1e293b !important;
            color: #ffffff !important;
        }
        
        /* Dropdown menus */
        :root[data-theme="dark"] .dropdown-menu,
        :root[data-theme="dark"] .context-menu {
            background: #1e293b !important;
            color: #ffffff !important;
        }
        
        :root[data-theme="dark"] .dropdown-menu li,
        :root[data-theme="dark"] .context-menu li {
            color: #e2e8f0 !important;
        }
        
        :root[data-theme="dark"] .dropdown-menu li:hover,
        :root[data-theme="dark"] .context-menu li:hover {
            background: rgba(99, 102, 241, 0.2) !important;
            color: #ffffff !important;
        }
        
        /* Badge and pill elements */
        :root[data-theme="dark"] .badge,
        :root[data-theme="dark"] .pill,
        :root[data-theme="dark"] .tag {
            color: #ffffff !important;
        }
        
        /* Loading overlay */
        :root[data-theme="dark"] .loading-overlay {
            background: rgba(15, 23, 42, 0.9) !important;
        }
        
        :root[data-theme="dark"] .loading-overlay span,
        :root[data-theme="dark"] .loading-overlay p {
            color: #ffffff !important;
        }
        
        /* Progress bars text */
        :root[data-theme="dark"] .progress-bar {
            color: #ffffff !important;
        }
        
        /* Card and container titles */
        :root[data-theme="dark"] .card-title,
        :root[data-theme="dark"] .section-title,
        :root[data-theme="dark"] .panel-title {
            color: #ffffff !important;
        }
        
        /* Description and help text */
        :root[data-theme="dark"] .description,
        :root[data-theme="dark"] .help-text,
        :root[data-theme="dark"] .hint-text,
        :root[data-theme="dark"] small {
            color: #94a3b8 !important;
        }
        
        /* Link colors in dark mode */
        :root[data-theme="dark"] a:not(.btn) {
            color: #93c5fd !important;
        }
        
        :root[data-theme="dark"] a:not(.btn):hover {
            color: #bfdbfe !important;
        }
        
        /* Ensure all general text is visible */
        :root[data-theme="dark"] .text-dark,
        :root[data-theme="dark"] .text-black {
            color: #ffffff !important;
        }
        
        /* Form field labels and legends */
        :root[data-theme="dark"] fieldset legend {
            color: #ffffff !important;
        }
        
        /* Status pills should have contrasting text */
        :root[data-theme="dark"] .status-pill {
            color: #ffffff !important;
        }
        
        /* Inline code and pre blocks */
        :root[data-theme="dark"] code,
        :root[data-theme="dark"] pre {
            background: rgba(30, 41, 59, 0.8) !important;
            color: #e2e8f0 !important;
        }


        .project-suite-container {
            border: 3px solid var(--primary-hover);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            background: var(--surface-elevated);
            color: var(--text-color);
        }

        :root[data-theme="dark"] .project-suite-container {
            background: rgba(15, 23, 42, 0.92);
            border-color: rgba(99, 102, 241, 0.45);
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.65);
        }

        .project-suite-container>h2 {
            text-align: left;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        :root[data-theme="dark"] .project-suite-container>h2 {
            border-bottom-color: rgba(148, 163, 184, 0.35);
        }

        .tgs-set-generator {
            display: flex;
            gap: 30px;
            align-items: flex-end;
            margin-top: 15px;
            padding: 20px;
            background: var(--surface-elevated);
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .tgs-set-generator>div {
            flex: 1;
            min-width: 200px;
        }

        .tgs-set-generator .form-set-question {
            align-self: center;
            min-width: 300px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-background);
        }

        .tgs-set-generator .btn-primary {
            width: auto;
            flex-shrink: 0;
            padding: 16px 30px;
        }

        .tmp-set-container,
        .tgs-set-container {
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            background: var(--card-background);
            box-shadow: var(--shadow-md);
            position: relative;
        }

        .custom-section-placeholder {
            background: var(--surface-elevated);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            color: var(--text-secondary) !important;
        }

        :root[data-theme="dark"] .custom-section-placeholder {
            background: rgba(15, 23, 42, 0.75) !important;
            border-color: rgba(99, 102, 241, 0.35) !important;
            color: #ffffff !important;
        }

        .custom-add-button-container {
            border-radius: 16px;
            border: 2px dashed var(--border-color);
        }

        :root[data-theme="dark"] .custom-add-button-container {
            background: rgba(15, 23, 42, 0.8) !important;
            border-color: rgba(99, 102, 241, 0.35) !important;
        }

        .tmp-set-container {
            border-style: double;
            border-width: 4px;
            border-color: var(--info-color);
        }

        .tgs-set-container.redesign-required {
            border-color: var(--danger-color);
            border-style: dashed;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.4);
        }

        .tgs-set-container.redesign-required>h2 {
            color: var(--danger-color) !important;
        }

        .tmp-set-container.manual-save-required,
        .tgs-set-container.manual-save-required {
            border-color: var(--warning-color);
            box-shadow: 0 15px 35px rgba(245, 158, 11, 0.25);
        }

        .tmp-set-container.manual-save-required:not(.locked-set)::after,
        .tgs-set-container.manual-save-required:not(.locked-set)::after {
            content: 'Manual save required before handoff';
            position: absolute;
            bottom: 12px;
            right: 18px;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-hover);
            font-size: 0.9em;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .tmp-set-container>h2,
        .tgs-set-container>h2 {
            margin-top: 0;
            padding-bottom: 15px;
            text-align: left;
            border-bottom: 3px solid var(--primary-light);
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .project-suite-title,
        .tmp-suite-title {
            color: var(--heading-color);
            text-shadow: 0 2px 6px rgba(15, 23, 42, 0.1);
        }

        :root[data-theme="dark"] .project-suite-title,
        :root[data-theme="dark"] .tmp-suite-title {
            color: #ffffff;
            text-shadow: none;
        }

        .focus-mode-status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.02em;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.08);
            color: var(--text-color);
            text-transform: uppercase;
            margin-bottom: 10px;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
            width: fit-content;
        }

        .focus-mode-status-pill::before {
            content: '';
            font-size: 0.8em;
        }

        .focus-mode-status-pill.is-focus {
            background: #dc2626;
            color: #ffffff;
            box-shadow: 0 10px 22px rgba(220, 38, 38, 0.35);
        }

        .focus-mode-status-pill.is-focus::before {
            content: '';
            font-size: 0.9em;
        }

        .question-block.jump-highlight {
            outline: 2px solid var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }

        .bulk-progress {
            display: none;
            margin-top: 15px;
        }

        .bulk-progress .progress-bar {
            background: var(--surface-muted);
            border-radius: 999px;
            overflow: hidden;
            height: 10px;
            margin-bottom: 8px;
        }

        .bulk-progress .progress-fill {
            background: var(--primary-color);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .conflict-review-modal .modal-content {
            max-width: 640px;
        }

        #conflict-review-list {
            max-height: 320px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 10px;
            background: var(--surface-elevated);
        }

        #conflict-review-list button {
            margin-top: 6px;
        }

        .focus-mode-banner {
            background-color: var(--role-tmd-color);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .focus-mode-banner button {
            margin-left: 20px;
        }

        .tmp-set-container.locked-set::before,
        .tgs-set-container.locked-set::before {
            content: attr(data-lock-message);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(240, 244, 248, 0.95);
            backdrop-filter: blur(2px);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Poppins', sans-serif;
            font-size: 2em;
            font-weight: 700;
            color: var(--secondary-color);
            border-radius: 15px;
            border: 4px dashed var(--secondary-color);
            text-align: center;
            padding: 50px;
            line-height: 1.4;
        }

        .tmp-set-container.locked-set,
        .tgs-set-container.locked-set {
            pointer-events: none;
        }

        .tmp-set-container.locked-set *,
        .tgs-set-container.locked-set * {
            cursor: not-allowed !important;
        }

        /* Allow Load/Save buttons to always work - they're for file management, not form editing */
        .tmp-set-container.locked-set .section-save-load,
        .tgs-set-container.locked-set .section-save-load,
        .tmp-set-container.locked-set .section-save-load *,
        .tgs-set-container.locked-set .section-save-load * {
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        .tmp-set-container.locked-set .accordion-header,
        .tgs-set-container.locked-set .accordion-header {
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        #goToTopBtn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        #goToTopBtn:hover {
            transform: translateX(-50%) translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        #goToTopBtn.show {
            display: flex;
        }

        #goToBottomBtn {
            position: fixed;
            bottom: 30px;
            left: calc(50% + 70px);
            transform: translateX(-50%);
            z-index: 99;
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #333;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        #goToBottomBtn:hover {
            transform: translateX(-50%) translateY(-5px);
            box-shadow: var(--shadow-xl);
            background: linear-gradient(135deg, #ffed4e, #ffc947);
        }

        #goToBottomBtn.show {
            display: flex;
        }

        /* Blur effect for non-active sign-off sections */
        .signoff-block-wrapper.blurred {
            filter: blur(3px);
            /* Increased blur */
            opacity: 0.5;
            pointer-events: none;
            /* Disables clicks */
            -webkit-user-select: none;
            user-select: none;
            /* Disables text selection */
            background: rgba(226, 232, 240, 0.3) !important;
            /* Greys it out slightly */
            transition: all 0.3s ease;
        }

        /* Ensure the active one pops */
        .signoff-block-wrapper.focused {
            filter: none;
            opacity: 1;
            pointer-events: auto;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15), var(--shadow-md);
            transform: scale(1.01);
            z-index: 10;
            background: var(--card-background);
        }

        .role-designer,
        .role-qa,
        .role-tmd,
        .role-admin-intermediate,
        .role-admin-final {
            border-left: 5px solid;
            padding-left: 15px !important;
        }

        .role-designer {
            border-color: var(--role-designer-color);
        }

        .role-qa {
            border-color: var(--role-qa-color);
        }

        .role-tmd {
            border-color: var(--role-tmd-color);
        }

        .role-admin-intermediate {
            border-color: var(--role-admin-intermediate-color);
        }

        .role-admin-final {
            border-color: var(--role-admin-final-color);
        }

        .signoff-block {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-left: 0 !important;
        }

        .decision-block {
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
        }

        .decision-block>label {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 700;
            font-size: 1.3em;
            margin-bottom: 10px;
            display: block;
            color: var(--heading-color);
        }

        .decision-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .decision-options .check-item {
            border-color: var(--border-color);
        }

        .decision-options .check-item.forward {
            border-left: 4px solid var(--success-color);
        }

        .decision-options .check-item.backward {
            border-left: 4px solid var(--danger-color);
        }

        :root[data-theme="dark"] .decision-options .check-item {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(148, 163, 184, 0.35);
        }

        :root[data-theme="dark"] .decision-options .check-item.forward {
            border-left-color: var(--success-color);
        }

        :root[data-theme="dark"] .decision-options .check-item.backward {
            border-left-color: var(--danger-color);
        }

        .decision-options .check-item label {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1em;
        }

        .signoff-block.is-tmd-signoff {
            grid-template-columns: 1fr auto auto auto;
        }

        .signoff-block .check-item {
            margin-bottom: 0;
        }

        .signoff-block label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1em;
        }

        /* Signoff section specific styling */
        .signoff-block input.signoff-field {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1em;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .signoff-block input.signoff-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .signoff-block .check-item label {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2em;
            font-weight: 600;
            color: var(--heading-color);
        }

        .signoff-block-wrapper h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4em;
            font-weight: 700;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-bottom: 20px;
            color: var(--primary-dark);
        }

        /* Enhanced signoff block styling */
        .signoff-block-wrapper {
            background: var(--workflow-card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .signoff-block-wrapper.signoff-complete {
            opacity: 0.55;
            position: relative;
        }

        .signoff-block-wrapper.signoff-complete::after {
            content: 'Signed Off';
            position: absolute;
            top: 12px;
            right: 20px;
            background: var(--success-bg, #ecfdf3);
            color: var(--success-fg, #047857);
            border-radius: 999px;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .signoff-helper-text {
            margin: 0 0 20px 0;
            padding: 12px 16px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.08);
            color: var(--text-secondary);
            font-weight: 500;
            text-align: center;
        }

        :root[data-theme="dark"] .signoff-helper-text {
            background: rgba(99, 102, 241, 0.15);
            color: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.2);
        }

        .signoff-block-wrapper:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Signature line styling */
        .signoff-block input[type="text"].signoff-field {
            border-bottom: 2px solid var(--primary-color);
            border-top: none;
            border-left: none;
            border-right: none;
            border-radius: 0;
            background: transparent;
            padding: 8px 5px;
            font-style: italic;
        }

        .signoff-block input[type="text"].signoff-field::placeholder {
            color: var(--secondary-color);
            font-style: italic;
            opacity: 0.7;
        }

        /* Date field styling */
        .signoff-block input[type="date"].signoff-field {
            font-family: 'Cormorant Garamond', serif;
            color: var(--text-color);
            background: rgba(37, 99, 235, 0.02);
        }

        /* Completion checkbox styling */
        .signoff-block .check-item input[type="checkbox"] {
            transform: scale(1.2);
            margin-right: 10px;
            accent-color: var(--primary-color);
        }

        /* Add elegant divider between signoff elements */
        .signoff-block>div:not(:last-child) {
            border-bottom: 1px dotted var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .signoff-block>div:last-child {
            margin-bottom: 0;
        }

        .notification-block {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed var(--border-color);
            text-align: center;
        }

        .file-link-block-signoff {
            grid-column: 1 / -1;
            margin-bottom: 20px;
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            padding: 15px;
            background: var(--surface-elevated);
        }

        :root[data-theme="dark"] .signoff-block {
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
        }

        :root[data-theme="dark"] .signoff-block-wrapper {
            background: rgba(15, 23, 42, 0.88);
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.65);
        }

        :root[data-theme="dark"] .signoff-block-wrapper h3 {
            color: #ffffff;
            border-color: rgba(129, 140, 248, 0.65);
        }

        :root[data-theme="dark"] .signoff-block label,
        :root[data-theme="dark"] .signoff-block .check-item label,
        :root[data-theme="dark"] .decision-block>label,
        :root[data-theme="dark"] .decision-options .check-item label {
            color: #ffffff;
        }

        :root[data-theme="dark"] .decision-block {
            background: rgba(15, 23, 42, 0.75);
            border-color: rgba(148, 163, 184, 0.45);
            box-shadow: 0 12px 28px rgba(2, 6, 23, 0.65);
        }

        :root[data-theme="dark"] .signoff-block input.signoff-field {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(148, 163, 184, 0.5);
            color: #f8fafc;
        }

        :root[data-theme="dark"] .signoff-block input.signoff-field::placeholder {
            color: rgba(226, 232, 240, 0.6);
        }

        :root[data-theme="dark"] .signoff-block>div:not(:last-child) {
            border-bottom-color: rgba(148, 163, 184, 0.3);
        }

        :root[data-theme="dark"] .file-link-block-signoff {
            background: rgba(30, 41, 59, 0.92);
            border-color: rgba(99, 102, 241, 0.45);
        }

        .history-log {
            margin-top: 20px;
            padding: 20px;
            border: 1px dashed var(--secondary-color);
            border-radius: 8px;
            background: var(--surface-elevated);
            font-size: 0.9em;
            color: var(--text-color);
        }

        :root[data-theme="dark"] .history-log {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(99, 102, 241, 0.45);
        }

        .history-log strong {
            color: var(--heading-color);
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
            font-family: 'Poppins';
        }

        .history-log ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .history-log li {
            padding: 8px 0;
            border-bottom: 1px dotted var(--border-color);
            color: var(--text-color);
        }

        .history-log li:last-child {
            border-bottom: none;
        }

        #final-summary-container {
            border: none;
            padding: 30px;
            background: var(--card-background);
            color: var(--text-color);
        }

        .summary-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 25px;
            margin-bottom: 30px;
        }

        .file-link-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 25px;
            margin-top: 20px;
        }

        .file-link-grid p {
            margin: 0;
            padding: 0;
        }

        .link-preview {
            margin-top: 8px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .summary-section h3,
        .summary-section h4 {
            font-family: 'Poppins';
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 30px;
            text-align: left;
        }

        .summary-section h4 {
            font-size: 1.2em;
            color: var(--primary-hover);
            margin-top: 25px;
        }

        .company-header {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--heading-color);
            text-align: center;
            margin-bottom: 10px;
            padding-top: 10px;
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--card-background);
            box-shadow: var(--shadow-sm);
            border-radius: 8px;
        }

        .checklist-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
            table-layout: fixed;
        }

        .checklist-summary-table th,
        .checklist-summary-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            vertical-align: top;
            text-align: left;
            word-wrap: break-word;
        }

        .checklist-summary-table th {
            background-color: var(--primary-light);
            font-family: 'Poppins';
            font-weight: 600;
            color: var(--heading-color);
        }

        .checklist-summary-table td.question-col {
            width: 30%;
            font-weight: 500;
        }

        .checklist-summary-table th.status-col {
            width: 8%;
            text-align: center;
        }

        .checklist-summary-table td.status-col {
            text-align: center;
        }

        .checklist-summary-table th.comments-col {
            width: 38%;
        }

        .checklist-summary-table tr:nth-child(even) {
            background-color: #f1f5f9;
        }

        :root[data-theme="dark"] .checklist-summary-table tr:nth-child(even) {
            background-color: rgba(15, 23, 42, 0.85);
        }

        .status-badge {
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.9em;
            color: white;
            min-width: 60px;
            text-align: center;
        }

        .status-checked {
            background-color: var(--success-color);
        }

        .status-unchecked {
            background-color: var(--danger-color);
        }

        .status-pending {
            background-color: #f1f5f9;
            color: var(--secondary-color);
        }

        :root[data-theme="dark"] .status-pending {
            background-color: rgba(30, 41, 59, 0.85);
            color: #ffffff;
            border: 1px solid rgba(148, 163, 184, 0.4);
        }

        .status-na {
            background-color: var(--warning-color);
            color: #212529;
        }

        .summary-comment-block {
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px dotted var(--border-color);
            font-size: 0.95em;
        }

        .summary-comment-block:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .summary-comment-block strong {
            display: block;
            margin-bottom: 3px;
            color: var(--heading-color);
        }

        .feedback-link {
            display: block;
            text-align: center;
            font-size: 0.85em;
            margin-top: 15px;
            color: var(--secondary-color);
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .feedback-link:hover {
            opacity: 1;
            color: var(--primary-hover);
        }

        #cloud-drive-banner {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: min(420px, calc(100% - 48px));
            background: rgba(15, 23, 42, 0.92);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            color: var(--text-inverse);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            text-align: left;
            z-index: 1100;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(15px);
            transition: opacity var(--transition-normal), transform var(--transition-normal), visibility var(--transition-normal);
        }

        #cloud-drive-banner::before {
            content: '';
            font-size: 1.5rem;
        }

        #cloud-drive-banner.is-visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0);
        }

        #cloud-drive-banner strong {
            display: block;
            margin-bottom: 6px;
            color: var(--text-inverse);
            font-weight: 600;
        }

        #cloud-drive-banner small {
            color: rgba(226, 232, 240, 0.9);
            display: block;
            line-height: 1.4;
        }

        #cloud-drive-banner .cloud-banner-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-inverse);
            padding: 4px;
            border-radius: var(--radius-full);
            transition: background var(--transition-fast);
        }

        #cloud-drive-banner .cloud-banner-close:hover {
            background: rgba(99, 102, 241, 0.15);
        }

        @media (max-width: 640px) {
            #cloud-drive-banner {
                left: 16px;
                right: 16px;
                width: calc(100% - 32px);
                bottom: 16px;
            }
        }

        .theme-toggle-floating {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--card-background);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .theme-toggle-floating:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        /* Duplicate theme-toggle-floating removed */

        /* Prominent Fixed Theme Toggle */
        #fixed-theme-toggle {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 9999;
            /* Ensure it sits on top of everything */
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--gradient-primary);
            /* Use brand gradient for high visibility */
            border: 3px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(4px);
            animation: floatToggle 6s ease-in-out infinite;
        }

        #fixed-theme-toggle:hover {
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 15px 35px rgba(99, 102, 241, 0.6);
            border-color: white;
        }

        #fixed-theme-toggle:active {
            transform: scale(0.95);
        }

        @keyframes floatToggle {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* Dark mode adjustment to ensure it still pops */
        :root[data-theme="dark"] #fixed-theme-toggle {
            background: linear-gradient(135deg, #312e81, #4f46e5);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Mobile adjustment */
        @media (max-width: 768px) {
            #fixed-theme-toggle {
                width: 50px;
                height: 50px;
                font-size: 22px;
                top: 15px;
                right: 15px;
            }
        }

        /* Ensure hidden during print */
        @media print {
            #fixed-theme-toggle {
                display: none !important;
            }
        }

        #signoff-status-tracker {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 15px;
            padding: 22px;
            border-radius: 20px;
            background: var(--glass-card-bg);
            min-width: 320px;
            position: relative;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--glass-border);
            overflow: hidden;
        }

        @media (min-width: 1200px) {
            #signoff-status-tracker {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }

        #signoff-status-tracker::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 0% 0%, rgba(236, 72, 153, 0.2), transparent 55%),
                radial-gradient(circle at 90% 0%, rgba(14, 165, 233, 0.22), transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        #signoff-status-tracker h4 {
            grid-column: 1 / -1;
            margin: 0 0 4px 0;
            text-align: center;
            font-family: 'Poppins', sans-serif;
            color: var(--heading-color);
            font-size: 1.1em;
            letter-spacing: 0.2px;
            position: relative;
            z-index: 1;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 18px 14px;
            border-radius: 16px;
            background: var(--surface-elevated);
            border: 1px solid var(--border-color);
            font-size: 0.95em;
            text-align: center;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .status-item::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            opacity: 0;
            background: linear-gradient(120deg, rgba(99, 102, 241, 0.2), rgba(59, 130, 246, 0.2));
            transition: opacity 0.25s ease;
        }

        .status-item:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--shadow-lg);
        }

        .status-item:hover::after {
            opacity: 1;
        }

        .status-item>span:first-child {
            font-weight: 600;
            color: var(--heading-color);
            position: relative;
            z-index: 1;
        }

        .status-item:not(:last-child) {
            border-bottom: none;
        }

        .status-indicator {
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            position: relative;
            z-index: 1;
        }

        .status-complete {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.4));
            color: var(--success-color);
        }

        .status-pending {
            background: linear-gradient(135deg, rgba(148, 163, 184, 0.2), rgba(226, 232, 240, 0.5));
            color: var(--secondary-color);
        }

        .status-skipped {
            background: linear-gradient(135deg, rgba(251, 113, 133, 0.2), rgba(244, 114, 182, 0.4));
            color: white;
        }

        .status-awaiting {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.3), rgba(99, 102, 241, 0.45));
            color: white;
        }

        .status-item.status-summary {
            grid-column: 1 / -1;
            background: var(--glass-chip-bg);
            border-color: var(--glass-border);
            align-items: center;
        }

        .status-item.status-summary .status-indicator {
            box-shadow: none;
        }

        .status-indicator.role-chip {
            background: var(--role-chip-bg, var(--primary-color));
            color: var(--text-inverse);
        }

        .progress-bar-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            width: 0%;
            height: 25px;
            background: linear-gradient(90deg, #10b981, #34d399);
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: 600;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s infinite;
        }
        
        @keyframes progressShine {
            0% { transform: translateX(-200%); }
            50%, 100% { transform: translateX(200%); }
        }
        
        /* Progress Bar Color States */
        .progress-bar[style*="width: 100%"],
        .progress-bar[style*="width:100%"] {
            background: linear-gradient(90deg, #059669, #10b981);
        }
        
        :root[data-theme="dark"] .progress-bar-container {
            background-color: rgba(51, 65, 85, 0.8);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        :root[data-theme="dark"] .progress-bar {
            background: linear-gradient(90deg, #059669, #10b981);
        }

        .role-selected-designer .form-field.role-designer:not(:disabled) {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            border-color: var(--role-designer-color);
        }

        .role-selected-qa .form-field.role-qa:not(:disabled) {
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
            border-color: var(--role-qa-color);
        }

        .role-selected-tmd .form-field.role-tmd:not(:disabled) {
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
            border-color: var(--role-tmd-color);
        }

        .role-selected-admin-intermediate .form-field.role-admin-intermediate:not(:disabled) {
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
            border-color: var(--role-admin-intermediate-color);
        }

        .role-selected-admin-final .form-field.role-admin-final:not(:disabled) {
            box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.2);
            border-color: var(--role-admin-final-color);
        }

        .form-field.field-locked,
        .form-field[data-signoff-locked="true"] {
            background: rgba(226, 232, 240, 0.5);
            cursor: not-allowed;
        }

        /* Only Current Role view: hide non-current role fields */
        body.only-current-role .checks-grid>.check-item {
            display: none;
        }

        body.only-current-role.role-selected-designer .checks-grid>.check-item.role-designer {
            display: flex;
        }

        body.only-current-role.role-selected-qa .checks-grid>.check-item.role-qa {
            display: flex;
        }

        body.only-current-role.role-selected-tmd .checks-grid>.check-item.role-tmd {
            display: flex;
        }

        body.only-current-role.role-selected-admin-intermediate .checks-grid>.check-item.role-admin-intermediate {
            display: flex;
        }

        body.only-current-role.role-selected-admin-final .checks-grid>.check-item.role-admin-final {
            display: flex;
        }

        /* Hide other roles' comment boxes; rely on :has for modern browsers */
        body.only-current-role .comments-grid>div {
            display: none;
        }

        body.only-current-role.role-selected-designer .comments-grid>div:has(textarea.role-designer) {
            display: block;
        }

        body.only-current-role.role-selected-qa .comments-grid>div:has(textarea.role-qa) {
            display: block;
        }

        body.only-current-role.role-selected-tmd .comments-grid>div:has(textarea.role-tmd) {
            display: block;
        }

        body.only-current-role.role-selected-admin-intermediate .comments-grid>div:has(textarea.role-admin-intermediate) {
            display: block;
        }

        body.only-current-role.role-selected-admin-final .comments-grid>div:has(textarea.role-admin-final) {
            display: block;
        }

        /* Hide sign-off blocks for other roles when toggled */
        body.only-current-role .signoff-block-wrapper {
            display: none;
        }

        body.only-current-role.role-selected-designer .signoff-block-wrapper[data-role="designer"] {
            display: block;
        }

        body.only-current-role.role-selected-qa .signoff-block-wrapper[data-role="qa"] {
            display: block;
        }

        body.only-current-role.role-selected-tmd .signoff-block-wrapper[data-role="tmd"] {
            display: block;
        }

        body.only-current-role.role-selected-admin-intermediate .signoff-block-wrapper[data-role="admin-intermediate"] {
            display: block;
        }

        body.only-current-role.role-selected-admin-final .signoff-block-wrapper[data-role="admin-final"] {
            display: block;
        }

        /* Site presence: show only for Designer/QA in only-current-role mode */
        body.only-current-role:not(.role-selected-designer):not(.role-selected-qa) .site-presence-block {
            display: none;
        }

        .signoff-block .check-item input[type="checkbox"]:disabled,
        .signoff-block .check-item input[type="radio"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--card-background);
            color: var(--text-color);
            padding: 40px;
            border-radius: 15px;
            box-shadow: var(--shadow-xl);
            width: 90%;
            max-width: 600px;
            text-align: center;
            position: relative;
            animation: slideUp 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            font-weight: bold;
            color: var(--secondary-color);
            cursor: pointer;
            line-height: 1;
            /* Button reset for accessibility */
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
        }

        .modal-close-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .modal-actions {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        @media (max-width: 1024px) {
            .workflow-bar-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .comments-grid {
                grid-template-columns: 1fr;
            }

            .checklist-summary-table,
            .checklist-summary-table tbody,
            .checklist-summary-table tr,
            .checklist-summary-table th,
            .checklist-summary-table td {
                display: block;
                width: 100% !important;
            }

            .checklist-summary-table thead {
                display: none;
            }

            .checklist-summary-table tr {
                margin-bottom: 15px;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                page-break-inside: avoid;
            }

            .checklist-summary-table td {
                border: none;
                border-bottom: 1px solid #eee;
                padding: 8px 10px;
                text-align: left;
            }

            .signoff-block,
            .signoff-block.is-tmd-signoff {
                grid-template-columns: 1fr;
            }

            .tgs-set-generator {
                flex-direction: column;
                align-items: stretch;
            }

            .tgs-set-generator .btn-primary {
                width: 100%;
            }

            .file-link-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .workflow-bar {
                padding: var(--space-lg);
            }

            .btn {
                font-size: 0.8rem;
                padding: var(--space-sm) var(--space-md);
                min-height: 40px;
            }

            .accordion-header-actions {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-xs);
            }
        }

        /* Print Optimizations */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
            }

            .no-print,
            .theme-toggle-floating,
            .btn-print-report {
                display: none !important;
            }

            .container {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Prevent page breaks inside key elements (PDF page break fix) */
            .question-block, 
            .signoff-block-wrapper, 
            .accordion-section,
            .tgs-set-container,
            .tmp-set-container,
            .summary-section,
            .check-item,
            .form-group {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .accordion-section {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }

            .question-block {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }

            /* Hide floating action buttons in PDF */
            .section-save-load, 
            .tgs-set-actions,
            .floating-actions,
            .quick-actions-panel {
                display: none !important;
            }
        }

        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --text-color: #000000;
                --background-color: #ffffff;
            }
        }

        /* Focus improvements for accessibility */
        .btn:focus-visible,
        input:focus-visible,
        textarea:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Stronger keyboard focus for accessibility (non-invasive) */
        :focus {
            outline: 3px solid var(--heading-color);
            outline-offset: 2px;
            box-shadow: var(--shadow-focus);
        }

        /* Back-to-top button styles */
        #back-to-top {
            position: fixed;
            right: 18px;
            bottom: 18px;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background: var(--surface-elevated);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9999;
            color: var(--heading-color);
            font-size: 18px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(8px);
            transition: opacity 0.22s var(--transition-fast), transform 0.28s var(--ease-out-back);
        }

        #back-to-top.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
    body.read-mode input:not([type="checkbox"]):not([type="radio"]),
    body.read-mode textarea {
        border: none;
        background: transparent;
        box-shadow: none;
        padding: 0;
        resize: none;
        pointer-events: none; /* Prevent editing */
        font-weight: 500;
    }
    body.read-mode .question-block {
        border: none;
        background: transparent;
        box-shadow: none;
        padding-left: 0;
    }
    /* Hide unchecked radios in read mode to reduce clutter */
    body.read-mode input[type="radio"]:not(:checked) + label {
        opacity: 0.3;
    }
    .chart-donut {
        width: 60px; height: 60px;
        border-radius: 50%;
        background: conic-gradient(var(--success-color) 0% var(--pct), var(--border-color) var(--pct) 100%);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.75em; font-weight: 700;
        position: relative;
    }
    .chart-donut::before {
        content: '';
        position: absolute; inset: 8px;
        background: var(--card-background); border-radius: 50%;
    }
    .chart-text { position: relative; z-index: 1; }
    /* Lazy-loading TGS visual helpers */
    .tgs-lazy-container {
        display: flex;
        flex-direction: column;
        gap: 40px;
        margin-top: 20px;
    }

    .tgs-set-container {
        position: relative;
    }

    /* Scroll margin for fixed header offset on navigation */
    .accordion-section, 
    .question-block, 
    .project-suite-container,
    .tgs-set-container,
    .tmp-set-container {
        scroll-margin-top: 120px;
    }

    .add-tgs-set-btn {
        transition: transform var(--transition-normal), box-shadow var(--transition-normal);
    }

    .add-tgs-set-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.18);
    }

    .add-tgs-set-btn.attention-highlight {
        animation: pulse 0.9s ease-in-out 3;
        box-shadow: 0 0 0 3px var(--focus-ring);
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    .tgs-set-actions {
        animation: slideInUp 0.4s ease-out;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Banner utility classes */
    .banner-info {
        background-color: #e6f4ff;
        color: #084298;
        border: 1px solid #b6e0fe;
    }
    .banner-success {
        background-color: #e6ffed;
        color: #0b5e2a;
        border: 1px solid #b7eb8f;
    }
    .banner-warning {
        background-color: #fff7cc;
        color: #7a5d00;
        border: 1px solid #ffe58f;
    }
    /* Dark mode overrides */
    :root[data-theme="dark"] .banner-info {
        background-color: rgba(14, 165, 233, 0.2);
        color: #7dd3fc;
        border-color: rgba(14, 165, 233, 0.4);
    }
    :root[data-theme="dark"] .banner-success {
        background-color: rgba(16, 185, 129, 0.2);
        color: #6ee7b7;
        border-color: rgba(16, 185, 129, 0.4);
    }
    :root[data-theme="dark"] .banner-warning {
        background-color: rgba(245, 158, 11, 0.2);
        color: #fcd34d;
        border-color: rgba(245, 158, 11, 0.4);
    }

    /* Loading Overlay */
    #file-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    #file-loading-overlay .loading-content {
        text-align: center;
        color: white;
    }

    #file-loading-overlay .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    #file-loading-overlay .loading-message {
        font-size: 1.1em;
        font-weight: 500;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Full Screen Loading Overlay */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.85); /* Dark semi-transparent background */
        backdrop-filter: blur(5px); /* Blurs the content behind */
        z-index: 2147483647; /* Max Z-Index to stay on top of everything */
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none; /* Allows clicks to pass through when invisible */
    }

    /* Container for spinner and text */
    .loader-content {
        text-align: center;
        color: #ffffff;
        font-family: 'Inter', sans-serif;
    }

    /* The Spinner Animation */
    #loading-overlay .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color, #6366f1); /* Uses your theme color */
        animation: spinLoader 1s ease-in-out infinite;
        margin: 0 auto 15px;
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
    }

    /* Text Styling */
    #loading-text {
        font-size: 1.2rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        animation: pulseText 1.5s infinite;
    }

    /* Keyframes */
    @keyframes spinLoader {
        to { transform: rotate(360deg); }
    }

    @keyframes pulseText {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    /* Class to trigger visibility */
    #loading-overlay.active {
        opacity: 1;
        pointer-events: all; /* Blocks clicks when visible */
    }

    /* ============================================
       HIGH-VISIBILITY CHECKBOX/RADIO STYLES
       ============================================ */

    /* 1. Generic Selected State (The Container) */
    /* Highlights the whole box when an item is checked */
    .check-item:has(input:checked) {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(79, 70, 229, 0.08) 100%) !important;
        border-color: var(--primary-color) !important;
        border-width: 2px !important;
        box-shadow: 0 4px 10px rgba(99, 102, 241, 0.2) !important;
        transform: translateY(-1px);
    }

    /* 2. The Input Element (Checkmark/Radio Dot) */
    /* Makes the actual click target larger and bolder */
    .check-item input[type="checkbox"]:checked,
    .check-item input[type="radio"]:checked {
        transform: scale(1.3);
        border-width: 2px;
    }

    /* 3. The Label Text */
    /* Bolds the text for easier reading */
    .check-item:has(input:checked) label {
        color: var(--primary-dark);
        font-weight: 800 !important;
        letter-spacing: 0.01em;
    }

    /* 4. Semantic Coloring for YES / NO / NA */
    /* These override the generic blue style above with specific status colors */

    /* YES (Green Success Theme) */
    .check-item:has(input[value="yes"]:checked) {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
        border-color: var(--success-color) !important;
        box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2) !important;
    }
    .check-item:has(input[value="yes"]:checked) label {
        color: #065f46 !important; /* Dark Green Text */
    }
    .check-item input[value="yes"]:checked {
        accent-color: var(--success-color);
    }

    /* NO (Red Danger Theme) */
    .check-item:has(input[value="no"]:checked) {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%) !important;
        border-color: var(--danger-color) !important;
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2) !important;
    }
    .check-item:has(input[value="no"]:checked) label {
        color: #991b1b !important; /* Dark Red Text */
    }
    .check-item input[value="no"]:checked {
        accent-color: var(--danger-color);
    }

    /* N/A (Orange Warning Theme) */
    .check-item:has(input[value="na"]:checked) {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%) !important;
        border-color: var(--warning-color) !important;
        box-shadow: 0 4px 10px rgba(245, 158, 11, 0.2) !important;
    }
    .check-item:has(input[value="na"]:checked) label {
        color: #92400e !important; /* Dark Orange Text */
    }
    .check-item input[value="na"]:checked {
        accent-color: var(--warning-color);
    }

    /* ============================================
       DARK MODE ADJUSTMENTS
       ============================================ */
    :root[data-theme="dark"] .check-item:has(input:checked) {
        background: rgba(99, 102, 241, 0.25) !important;
        border-color: var(--primary-light) !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5) !important;
    }
    :root[data-theme="dark"] .check-item:has(input:checked) label {
        color: #ffffff !important;
    }

    /* Dark Mode Semantic Overrides */
    :root[data-theme="dark"] .check-item:has(input[value="yes"]:checked) {
        background: rgba(16, 185, 129, 0.25) !important;
        border-color: #34d399 !important;
    }
    :root[data-theme="dark"] .check-item:has(input[value="no"]:checked) {
        background: rgba(239, 68, 68, 0.25) !important;
        border-color: #f87171 !important;
    }
    :root[data-theme="dark"] .check-item:has(input[value="na"]:checked) {
        background: rgba(245, 158, 11, 0.25) !important;
        border-color: #fbbf24 !important;
    }

    /* ============================================
       STICKY TABLE OF CONTENTS (TOC) SIDEBAR
       ============================================ */
    #sticky-toc {
        position: fixed;
        left: 0;
        top: 100px;
        z-index: 999;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }
    #sticky-toc.open {
        transform: translateX(0);
    }
    #toc-toggle {
        position: absolute;
        right: -40px;
        top: 0;
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        font-size: 1.2rem;
        transition: background 0.2s ease;
    }
    #toc-toggle:hover {
        background: var(--primary-hover);
    }
    #toc-toggle:focus {
        outline: 2px solid var(--primary-light);
        outline-offset: 2px;
    }
    .toc-content {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        width: 250px;
        max-height: 60vh;
        overflow-y: auto;
        padding: 15px;
        box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        border-radius: 0 0 8px 0;
    }
    .toc-content h4 {
        margin: 0 0 10px 0;
        font-size: 0.95rem;
        color: var(--heading-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }
    .toc-link {
        display: block;
        padding: 8px;
        font-size: 0.85rem;
        color: var(--text-color);
        text-decoration: none;
        border-left: 2px solid transparent;
        cursor: pointer;
        transition: all 0.15s ease;
        border-radius: 0 4px 4px 0;
    }
    .toc-link:hover,
    .toc-link.active {
        background: var(--surface-muted);
        border-left-color: var(--primary-color);
        color: var(--primary-color);
        font-weight: 600;
    }
    .toc-link.toc-suite {
        font-weight: 600;
        color: var(--heading-color);
    }
    .toc-link.toc-tgs {
        padding-left: 20px;
        font-size: 0.8rem;
    }
    .toc-link.toc-tmp {
        padding-left: 20px;
        font-size: 0.8rem;
        color: var(--role-admin-intermediate-color);
    }

    </style>
</head>

<body>
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>

    <button id="fixed-theme-toggle" class="theme-toggle-fixed no-print" title="Toggle Theme">
        <span class="theme-toggle-icon"></span>
    </button>
    <input type="file" id="file-loader" accept=".json" title="Load JSON progress file" aria-label="Load JSON progress file" style="display:none;">
    <!-- Global drag-drop overlay for loading JSON files -->
    <div id="global-dropzone" class="no-print" style="display:none; position:fixed; inset:0; background:rgba(99,102,241,0.9); z-index:10000; align-items:center; justify-content:center; flex-direction:column; color:white;">
        <svg style="width:80px;height:80px;margin-bottom:20px;"><use href="#icon-upload"></use></svg>
        <h1 style="margin:0 0 10px 0;">Drop JSON File Here</h1>
        <p style="margin:0;">to load project progress</p>
    </div>
    <button id="back-to-top" class="no-print" title="Back to top" aria-label="Back to top" aria-hidden="false">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="M12 4l-8 8h5v8h6v-8h5l-8-8z" fill="currentColor"></path>
        </svg>
    </button>

    <div style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" id="icon-plus" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="icon-upload" viewBox="0 0 24 24">
            <path fill="currentColor" d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="icon-save" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="icon-finalize" viewBox="0 0 24 24">
            <path fill="currentColor" d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="icon-print" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="icon-reset" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6s-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8s-3.58-8-8-8z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="icon-doc" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="icon-notify" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" id="icon-teams" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M13.25,12.5A1.25,1.25 0 0,0 12,13.75V19.5H13.25A1.25,1.25 0 0,0 14.5,18.25V12.5H13.25M11.5,4.5H9.5V6H8V4A2,2 0 0,1 10,2H11.5A1.5,1.5 0 0,1 13,3.5A1.5,1.5 0 0,1 11.5,5V4.5M10.75,12.5A1.25,1.25 0 0,0 9.5,13.75V19.5H10.75A1.25,1.25 0 0,0 12,18.25V12.5H10.75M23,14A1,1 0 0,1 22,15H19.5V13.75A2.75,2.75 0 0,0 16.75,11H15.5V9.25A1.25,1.25 0 0,0 14.25,8H12V7H14.25A2.75,2.75 0 0,1 17,9.75V11H18.25A2.75,2.75 0 0,1 21,13.75V15H20A1,1 0 0,1 21,16H22A1,1 0 0,1 23,15V14M1,15A1,1 0 0,1 2,14H4.5V13.75A2.75,2.75 0 0,1 7.25,11H8.5V9.75A2.75,2.75 0 0,1 11.25,7H12.5A1.25,1.25 0 0,0 11.25,8.25V10H9.5A1.5,1.5 0 0,0 8,11.5V13.75A1.25,1.25 0 0,0 9.25,15H8A1,1 0 0,1 7,16H2A1,1 0 0,1 1,15Z" />
        </svg>
    </div>

    <section id="landing-page" class="landing-page no-print" aria-labelledby="landing-title">
        <div class="landing-glass-card">

            <!-- Left Column: Main Content -->
            <div class="landing-left">
                <span class="landing-kicker">Traffic Review Workflow</span>
                <h1 id="landing-title">Interactive TMP &amp; TGS Workflow Checklist</h1>
                <p class="hero-subtitle">
                    Streamline your handover process. Complete role-specific checks, sign off with confidence, and generate the progress file for the next reviewer in line.
                </p>

                <div class="landing-actions">
                    <button class="btn btn-primary" id="start-review-btn" type="button" title="Begin your workflow review session">
                        <span>Start My Review</span>
                    </button>
                    <button class="btn btn-secondary" id="how-it-works-btn" type="button" title="Learn how to use this checklist">
                        <span>How It Works</span>
                    </button>
                </div>

                <div class="landing-footer-links">
                    <a href="https://cromptonconcepts.sharepoint.com/:f:/s/Operations/ErhiBoKSG-NGlwEmJLiKN3UBU7CVYTskqypCOfuPSswCpQ?e=D5mLCd" target="_blank" rel="noopener noreferrer">Download Guide</a>
                    <span></span>
                    <button id="tour-features-btn">View Features</button>
                    <span></span>
                    <a href="mailto:sanju@cromptonconcepts.com.au">Support</a>
                </div>
            </div>

            <!-- Right Column: Compact Features Grid -->
            <div class="landing-right">
                <img src="https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?auto=format&fit=crop&w=600&q=80" alt="Workflow Preview" style="width: 100%; height: auto; border-radius: 12px; box-shadow: var(--shadow-lg);">
            </div>

        </div>
    </section>

    <div id="how-it-works-modal" class="landing-modal no-print" aria-hidden="true">
        <div class="landing-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="how-it-works-title">
            <button type="button" class="landing-modal-close" aria-label="Close dialog"></button>
            <h2 id="how-it-works-title">How the Workflow Operates</h2>
            <p class="landing-modal-intro">This interactive checklist keeps every reviewer aligned from the first draft to final sign-off.</p>
            
            <h3 style="margin: 20px 0 10px; color: var(--primary-color);"> For Designers (Starting a New Review)</h3>
            <ol class="landing-modal-list" style="margin-bottom: 20px;">
                <li><strong>Select "Designer"</strong> from the role dropdown</li>
                <li><strong>Fill in Project Details</strong>  CC Number, Project Name, Location, etc.</li>
                <li><strong>Generate Project Suite(s)</strong>  Click the button to create the form structure</li>
                <li><strong>Initialize TMP</strong>  Or skip to TGS if no TMP is needed</li>
                <li><strong>Add TGS Sets</strong>  Create one set for each TGS drawing</li>
                <li><strong>Complete Checklists</strong>  Answer each question (Yes/No/N/A)</li>
                <li><strong>Sign Off</strong>  Select your action, enter name/date, check the completion box</li>
                <li><strong>Save & Notify</strong>  Export the progress file and notify the next reviewer</li>
            </ol>
            
            <h3 style="margin: 20px 0 10px; color: var(--secondary-color);"> For Reviewers (Continuing a Review)</h3>
            <ol class="landing-modal-list" style="margin-bottom: 20px;">
                <li><strong>Select your role</strong> from the dropdown (Admin, QA, TMD, etc.)</li>
                <li><strong>Generate Project Suite</strong>  This creates the empty structure for loading</li>
                <li><strong>Initialize TMP/TGS sections</strong>  Click to activate each section</li>
                <li><strong>Load the progress file</strong>  Use the "Load TGS File" button in each section</li>
                <li><strong>Review & Add Comments</strong>  Check the previous reviewer's work, add notes</li>
                <li><strong>Sign Off</strong>  Forward to next reviewer or send back if issues found</li>
                <li><strong>Save & Notify</strong>  Export and notify the next person in the workflow</li>
            </ol>
            
            <h3 style="margin: 20px 0 10px; color: var(--success-color);"> Pro Tips</h3>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
                <li>Use <strong>Bulk Check</strong> buttons to mark multiple questions at once</li>
                <li>Toggle <strong>"Show only my role's fields"</strong> to focus on your section</li>
                <li>Click <strong>"Review Flagged Items"</strong> to see items marked as "No"</li>
                <li>Use keyboard shortcuts: <kbd>Ctrl+S</kbd> to save, <kbd>?</kbd> for help</li>
            </ul>
            
            <div class="landing-modal-footnote">Need a guided rollout for your team? <a href="mailto:sanju@cromptonconcepts.com.au?subject=Live Demo Request: TGS Workflow">Book a live walkthrough.</a></div>
        </div>
    </div>

    <div id="features-modal" class="landing-modal no-print" aria-hidden="true">
        <div class="landing-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="features-title" style="max-width: 800px;">
            <button type="button" class="landing-modal-close" aria-label="Close dialog"></button>
            <h2 id="features-title">Key Features</h2>
            <p class="landing-modal-intro">Everything you need to manage your traffic management plans efficiently.</p>
            
            <div class="features-modal-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <article class="feature-compact-item" style="background: var(--surface-ground); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                    <div class="feature-icon-box" style="font-size: 2rem; margin-bottom: 10px;"></div>
                    <div class="feature-text">
                        <h3 class="feature-title" style="margin: 0 0 8px; font-size: 1.1rem;">Guided Handover</h3>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">Step-by-step prompts ensure seamless transition between Designer and Admin.</p>
                    </div>
                </article>

                <article class="feature-compact-item" style="background: var(--surface-ground); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                    <div class="feature-icon-box" style="font-size: 2rem; margin-bottom: 10px;"></div>
                    <div class="feature-text">
                        <h3 class="feature-title" style="margin: 0 0 8px; font-size: 1.1rem;">Auto-Save Exports</h3>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">Sign-offs trigger automatic JSON file generation for progress tracking.</p>
                    </div>
                </article>

                <article class="feature-compact-item" style="background: var(--surface-ground); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                    <div class="feature-icon-box" style="font-size: 2rem; margin-bottom: 10px;"></div>
                    <div class="feature-text">
                        <h3 class="feature-title" style="margin: 0 0 8px; font-size: 1.1rem;">Instant Notifications</h3>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">Generate pre-formatted Teams or Email messages for the next reviewer.</p>
                    </div>
                </article>

                <article class="feature-compact-item" style="background: var(--surface-ground); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                    <div class="feature-icon-box" style="font-size: 2rem; margin-bottom: 10px;"></div>
                    <div class="feature-text">
                        <h3 class="feature-title" style="margin: 0 0 8px; font-size: 1.1rem;">Focus Mode</h3>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">Only see what matters to your role and flag conflicts immediately.</p>
                    </div>
                </article>
            </div>
        </div>
    </div>

    <div class="container" id="app-shell" style="display:none;">
        <div id="cloud-drive-banner" class="no-print" role="status" aria-live="polite" aria-hidden="true">
            <button type="button" class="cloud-banner-close" aria-label="Dismiss cloud drive warning"
                onclick="dismissCloudDriveBanner()"></button>
            <strong>Cloud Drive Detected</strong>
            <small>For best results: Save this file to your computer before using, or ensure your browser allows
                downloads from this location.</small>
        </div>

        <div id="form-wrapper">
            <div class="workflow-bar">
                <div class="workflow-bar-grid">
                    <div class="workflow-card-group">
                        <section class="workflow-card role-card" id="role-selector-panel" aria-labelledby="role-selector-heading">
                            <div class="role-selector">
                                <h3 id="role-selector-heading">Select Your Current Role</h3>
                                <select id="role" title="Select your current workflow role" aria-label="Select your current workflow role">
                                    <option value="">-- Please Select --</option>
                                    <option value="designer">Designer</option>
                                    <option value="admin-intermediate">Admin Intermediate</option>
                                    <option value="qa">QA</option>
                                    <option value="tmd">TMD</option>
                                    <option value="admin-final">Admin Final</option>
                                </select>
                                <div id="current-role-display" style="display:none; margin-top:15px;"></div>
                                <div style="margin-top:10px; display:flex; align-items:center; gap:8px;"
                                    class="no-print">
                                    <input type="checkbox" id="toggle-only-current-role">
                                    <label for="toggle-only-current-role"
                                        title="Hide fields and sign-offs not for your role">Show only my roles
                                        fields</label>
                                </div>
                                <div class="workflow-instruction-box info no-print" style="margin-top: 15px;">
                                    <h4 class="instruction-title"> Getting Started</h4>
                                    <ol style="margin: 5px 0 0; padding-left: 18px;">
                                        <li><strong>Select your role</strong> above to enable your specific fields</li>
                                        <li><strong>Reviewers:</strong> Load the progress file you received</li>
                                        <li><strong>Designers:</strong> Fill out project details below to begin</li>
                                    </ol>
                                </div>
                            </div>
                        </section>

                        <section class="workflow-card workflow-actions" aria-labelledby="actions-heading">
                            <h3 id="actions-heading" class="no-print" style="margin-top:0;">Actions</h3>
                            <div class="file-ops">
                                <button class="btn btn-secondary js-print-draft-btn disabled" id="print-btn" title="Print a draft version of the checklist"><svg>
                                        <use href="#icon-print"></use>
                                    </svg><span>Print Draft</span></button>
                                <button class="btn btn-info" id="export-pdf-btn" type="button" onclick="exportToPDF()" title="Download the checklist as a PDF report"><span>Download PDF Report</span></button>
                                <button class="btn btn-success" id="global-notify-btn" style="display:none;"
                                    disabled title="Send notification to the next reviewer"><svg>
                                        <use href="#icon-notify"></use>
                                    </svg><span id="global-notify-btn-text">Notify Next Reviewer</span></button>
                                <button class="btn btn-danger" id="reset-btn" title="Clear all data and reset the form to start fresh"><svg>
                                        <use href="#icon-reset"></use>
                                    </svg><span>Reset Form</span></button>
                                <button class="btn btn-success js-finalize-btn" id="finalize-btn"
                                    style="display:none;" title="Mark the checklist as complete and finalize"><svg>
                                        <use href="#icon-finalize"></use>
                                    </svg><span>Finalize Report</span></button>
                            </div>
                            <div class="contact-developer-block no-print" aria-label="Support options">
                                <div class="contact-support-copy">
                                    <h4>Need a tweak or spotted an issue?</h4>
                                    <p>Reach out and well help keep this workflow running smoothly.</p>
                                </div>
                                <div class="contact-developer-actions" role="group"
                                    aria-label="Support contact actions">
                                    <a class="btn btn-secondary" href="mailto:sanju@cromptonconcepts.com.au"
                                        aria-label="Email support" title="Send an email to our support team">
                                        <span>Email Support</span>
                                    </a>
                                    <div class="btn-group" style="display:inline-block; position:relative;">
                                        <button class="btn btn-info dropdown-toggle" type="button" id="callSupportDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="min-width:120px;">
                                            Call Support
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="callSupportDropdown" style="position:absolute; left:0; top:100%; min-width:160px; z-index:1001; display:none; background:var(--card-background); box-shadow:0 2px 8px rgba(0,0,0,0.08); border-radius:6px; border:1px solid var(--border-color);">
                                            <a class="dropdown-item" href="tel:+610405535187" style="display:block; padding:8px 16px; color:var(--text-color); text-decoration:none;" target="_blank" rel="noopener noreferrer"> Call Mobile</a>
                                            <a class="dropdown-item" href="https://teams.microsoft.com/l/chat/0/0?users=sanju@cromptonconcepts.com.au" style="display:block; padding:8px 16px; color:var(--text-color); text-decoration:none;" target="_blank" rel="noopener noreferrer"> Call via Teams</a>
                                        </div>
                                    </div>
                                <script>
                                // Simple dropdown for Call Support
                                document.addEventListener('DOMContentLoaded', function() {
                                    var btn = document.getElementById('callSupportDropdown');
                                    if (btn) {
                                        var menu = btn.nextElementSibling;
                                        btn.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            if (menu.style.display === 'block') {
                                                menu.style.display = 'none';
                                            } else {
                                                menu.style.display = 'block';
                                                // Hide on outside click
                                                setTimeout(function() {
                                                    document.addEventListener('click', hideMenu, { once: true });
                                                }, 0);
                                            }
                                        });
                                        function hideMenu(ev) {
                                            if (!menu.contains(ev.target) && ev.target !== btn) {
                                                menu.style.display = 'none';
                                            }
                                        }
                                    }
                                });
                                </script>
                                </div>
                            </div>
                        </section>
                    </div>

                    <section class="workflow-card workflow-status" aria-labelledby="status-heading">
                        <h3 id="status-heading" class="no-print" style="margin-top:0;">Overall Status</h3>
                        <p class="no-print" style="font-size: 0.85em; color: var(--text-secondary); margin: 0 0 10px;">
                            Track sign-off progress across all TMP and TGS sections below.
                        </p>
                        <div id="signoff-status-tracker" class="no-print" style="display: none;"></div>
                    </section>
                </div>
            </div>

            <div class="workflow-enhancements no-print" aria-label="Productivity helpers">
                <!-- Quick Reference Workflow Guide -->
                <div class="workflow-quick-ref">
                    <h4>
                        <span style="font-size: 1.3em;"></span> Quick Reference: Workflow Steps
                    </h4>
                    <div class="steps-grid">
                        <div class="workflow-step-card step-1">
                            <strong>1. Project Setup</strong>
                            <p>Enter CC Number and project details above</p>
                        </div>
                        <div class="workflow-step-card step-2">
                            <strong>2. Initialize TMP</strong>
                            <p>Create TMP section (or skip if not needed)</p>
                        </div>
                        <div class="workflow-step-card step-3">
                            <strong>3. Add TGS Sets</strong>
                            <p>Add and complete each TGS drawing checklist</p>
                        </div>
                        <div class="workflow-step-card step-4">
                            <strong>4. Review & Sign-Off</strong>
                            <p>Complete checklist, then sign-off for your role</p>
                        </div>
                        <div class="workflow-step-card step-5">
                            <strong>5. Save & Handover</strong>
                            <p>Export file and notify the next reviewer</p>
                        </div>
                    </div>
                </div>
            </div>

            <form id="tgs-form">
                <section class="accordion-section" data-section-id="projectdetails" aria-labelledby="projectdetails-heading">
                    <div class="accordion-header active" id="projectdetails-heading">Project Details</div>
                    <div class="accordion-content" style="display:block;">
                        
                        <div class="workflow-instruction-box tip no-print" style="margin-bottom: 20px;">
                            <h4 class="instruction-title"> Project Details Section</h4>
                            <p><strong>Designers:</strong> Fill in the CC Number and project information below. These details will carry through to all TMP and TGS forms.</p>
                            <p style="margin-top: 6px;"><strong>Reviewers:</strong> These fields should already be populated from the loaded file. Verify and update if needed.</p>
                        </div>

                        <div class="question-block">
                            <label for="ccNumber">CC Number:</label>
                            <input type="text" class="form-field top-level-field role-designer" id="ccNumber" data-validate-type="ccNumber"
                                placeholder="e.g., CC-2024001" maxlength="20" pattern="^CC-\\d+$"
                                title="Enter digits only; the 'CC-' prefix is automatic" autocomplete="off">

                            <label for="projectName">Project Name:</label>
                            <textarea class="form-field top-level-field role-designer" id="projectName"
                                placeholder="Enter full project name"></textarea>
                        </div>

                        <div class="question-block">
                            <label for="projectLocation">Project Location:</label>
                            <div style="position: relative;">
                                <input type="text" class="form-field top-level-field role-designer" id="projectLocation"
                                    placeholder="Enter road and suburb..." autocomplete="off">
                            </div>
                            <label for="jobNature">Nature of Job/Activity:</label>
                            <textarea class="form-field top-level-field role-designer" id="jobNature"></textarea>
                            <label for="clientInfo">Client Information:</label>
                            <textarea class="form-field top-level-field role-designer" id="clientInfo"></textarea>
                        </div>

                        <div class="question-block">
                            <div class="workflow-instruction-box warning no-print" style="margin-bottom: 15px;">
                                <h4 class="instruction-title"> Project Suites</h4>
                                <p>A <strong>Project Suite</strong> represents a distinct package within this project (e.g., different stages or locations). Each suite has its own TMP and TGS sets.</p>
                                <p style="margin-top: 6px;"><strong>Tip:</strong> Most projects have 1 suite. Only increase this if you have multiple independent TMP/TGS packages to review.</p>
                            </div>
                            <div>
                                <label for="projectSuitesCount">Number of Project Suites in this project?</label>
                                <input type="number" class="form-field top-level-field" id="projectSuitesCount" min="1"
                                    value="1">
                            </div>
                            <button type="button" class="btn btn-primary" id="generate-suites-btn"
                                style="margin-top:20px; width:100%;" title="Click to create the TMP and TGS form structure">Generate Project Suites</button>
                            <p class="no-print" style="margin-top: 10px; font-size: 0.85em; color: var(--text-secondary); text-align: center;">
                                 Click this button to create the form structure before proceeding to TMP/TGS sections
                            </p>
                        </div>

                    </div>
                </section>

                <div id="multi-suite-container"></div>

            </form>

            <section class="workflow-bar no-print" style="margin-top: 30px;" aria-labelledby="bottom-actions-heading">
                <h3 id="bottom-actions-heading" style="color: var(--heading-color);">Actions</h3>
                <div class="workflow-instruction-box tip" style="margin-bottom: 15px;">
                    <h4 class="instruction-title"> Saving Your Work</h4>
                    <p><strong>Auto-save:</strong> Your progress is saved automatically to browser storage. However, always export a JSON file before closing to ensure nothing is lost.</p>
                    <p style="margin-top: 6px;"><strong>PDF Report:</strong> Use "Download PDF Report" to generate a formal document for records or printing.</p>
                </div>
                <div class="file-ops">
                    <button class="btn btn-secondary js-print-draft-btn disabled" id="print-btn-bottom" title="Print a draft version of the checklist"><svg>
                            <use href="#icon-print"></use>
                        </svg><span>Print Draft</span></button>
                    <button class="btn btn-info" type="button" onclick="exportToPDF()" title="Download the checklist as a PDF report"><span>Download PDF Report</span></button>
                    <button class="btn btn-danger" id="reset-btn-bottom" title="Clear all data and reset the form to start fresh"><svg>
                            <use href="#icon-reset"></use>
                        </svg><span>Reset Form</span></button>
                    <button class="btn btn-success js-finalize-btn" id="finalize-btn-bottom" style="display:none;" title="Mark the checklist as complete and finalize"><svg>
                            <use href="#icon-finalize"></use>
                        </svg><span>Finalize Report</span></button>
                </div>
            </section>

        </div>

        <div id="final-summary-container" style="display:none;">
        </div>

        
    </div>

    <button id="goToTopBtn" class="no-print" title="Go to top"></button>
    <button id="goToBottomBtn" class="no-print" title="Go to bottom"></button>

    <!-- ================================================================= -->
    <!-- START: AI ASSISTANT MODULE (STABLE V3) -->
    <!-- ================================================================= -->
    <style>
        /* AI Button Styles */
        #ai-floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.5);
            border: none;
            cursor: pointer;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: aiFloat 4s ease-in-out infinite;
            color: white;
        }

        #ai-floating-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 15px 35px rgba(99, 102, 241, 0.7);
        }

        @keyframes aiFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* Chat Window Styles */
        #ai-chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 500px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            display: none;
            flex-direction: column;
            z-index: 9999;
            overflow: hidden;
            animation: aiSlideUp 0.3s ease-out;
            font-family: sans-serif;
        }

        @keyframes aiSlideUp {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .ai-header {
            padding: 15px 20px;
            background: var(--gradient-primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .ai-settings-btn {
            background: none; border: none; color: white; cursor: pointer; opacity: 0.8; font-size: 1.2rem;
        }
        
        .ai-close-btn {
            background: none; border: none; color: white; cursor: pointer; font-size: 1.5rem; line-height: 1;
        }

        .ai-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--background-secondary);
            font-size: 0.9em;
        }

        .ai-msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .ai-msg.user {
            align-self: flex-end;
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .ai-msg.bot {
            align-self: flex-start;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-bottom-left-radius: 2px;
        }

        .ai-msg.loading {
            font-style: italic;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            padding: 0;
        }

        .ai-input-area {
            padding: 15px;
            background: var(--card-background);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        #ai-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--surface-elevated);
            color: var(--text-color);
            resize: none;
            height: 42px;
            line-height: 20px;
            font-family: inherit;
        }

        #ai-send-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        #ai-send-btn:hover { background: var(--primary-hover); }
        
        .ai-msg.bot strong { font-weight: 700; color: var(--heading-color); }
        .ai-msg.bot ul { margin: 5px 0 5px 20px; padding: 0; }
        .ai-msg.bot li { margin-bottom: 4px; }
        
        @media (max-width: 480px) {
            #ai-chat-window { width: 100%; height: 100%; bottom: 0; right: 0; border-radius: 0; }
            #ai-floating-btn { bottom: 20px; right: 20px; }
        }
        
        /* AI Settings Button */
        .ai-settings-btn {
            background: none; border: none; color: white; cursor: pointer; opacity: 0.8; font-size: 1.2rem;
        }
        .ai-settings-btn:hover { opacity: 1; }
        
        /* API Key Config Panel */
        #ai-key-config {
            position: absolute;
            inset: 0;
            background: var(--card-background);
            z-index: 10;
            padding: 20px;
            display: none;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            color: var(--text-color);
        }
        
        /* Scroll to Top Button Enhancement */
        #goToTopBtn, #goToBottomBtn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        #goToTopBtn:hover, #goToBottomBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }
        
        /* Reading Progress Indicator */
        #progress-bar {
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7);
            background-size: 200% 100%;
            animation: progressGradient 2s ease infinite;
        }
        
        @keyframes progressGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        /* Improved Focus States for Accessibility */
        .btn:focus-visible,
        input:focus-visible,
        textarea:focus-visible,
        select:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
            box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.15);
        }
        
        /* Better Radio/Checkbox Visibility */
        :root[data-theme="dark"] input[type="radio"],
        :root[data-theme="dark"] input[type="checkbox"] {
            accent-color: #818cf8;
        }
        
        /* Current Section Highlight */
        .accordion-section.current-section {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15), var(--shadow-lg);
        }
        
        /* Smooth Animations for Better UX */
        @media (prefers-reduced-motion: no-preference) {
            .accordion-content {
                transition: max-height 0.3s ease-out, opacity 0.2s ease;
            }
            
            .question-block {
                transition: all 0.2s ease;
            }
            
            .btn {
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>

    <!-- Floating AI Button -->
    <button id="ai-floating-btn" class="no-print" title="Ask AI Assistant"></button>

    <!-- Chat Window -->
    <div id="ai-chat-window" class="no-print">
        <div class="ai-header">
            <span> AI Assistant</span>
            <div style="display:flex; gap:10px;">
                <button class="ai-settings-btn" onclick="toggleAiConfig()" title="API Settings"></button>
                <button class="ai-close-btn" onclick="toggleAiChat()"></button>
            </div>
        </div>

        <!-- API Key Configuration -->
        <div id="ai-key-config">
            <h3 style="margin-top:0;"> ChatGPT Settings</h3>
            <p style="font-size:0.85em; color:var(--text-secondary); margin-bottom:15px;">Enter your OpenAI API key to use ChatGPT, or leave blank to use the free alternative.</p>
            
            <label style="display:block; text-align:left; margin-bottom:5px; font-weight:600; font-size:0.9em;">OpenAI API Key (optional):</label>
            <input type="password" id="openai-api-key" placeholder="sk-... (leave blank for free mode)" class="form-field" style="margin-bottom:15px;">
            
            <button class="btn btn-primary" onclick="saveAiSettings()">Save Settings</button>
            
            <p style="margin-top:15px; font-size:0.8em;">
                <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer" style="color:var(--primary-color);">Get an OpenAI API Key</a>
            </p>
            <button class="btn btn-sm btn-secondary" onclick="toggleAiConfig()" style="margin-top:10px;">Cancel</button>
        </div>

        <div class="ai-messages" id="ai-messages">
            <div class="ai-msg bot">
                Hello! I'm your AI assistant. I can help with traffic management rules or general questions.
                <br><br>
                <em style="font-size:0.85em;"> Click  to add your OpenAI API key for ChatGPT, or use the free mode!</em>
            </div>
        </div>

        <div class="ai-input-area">
            <textarea id="ai-input" placeholder="Ask a question..." rows="1" aria-label="AI Assistant Chat Input"></textarea>
            <button id="ai-send-btn"></button>
        </div>
    </div>

    <script>
        /* ============================
           CHATGPT ASSISTANT
           Supports OpenAI API or free fallback
           ============================ */
        (function() {
            const aiBtn = document.getElementById('ai-floating-btn');
            const aiWindow = document.getElementById('ai-chat-window');
            const aiMessages = document.getElementById('ai-messages');
            const aiInput = document.getElementById('ai-input');
            const aiSendBtn = document.getElementById('ai-send-btn');
            const aiConfig = document.getElementById('ai-key-config');
            const apiKeyInput = document.getElementById('openai-api-key');

            // Toggle Chat Window
            function toggleAiChat() {
                if (aiWindow.style.display === 'flex') {
                    aiWindow.style.display = 'none';
                } else {
                    aiWindow.style.display = 'flex';
                    aiConfig.style.display = 'none';
                    setTimeout(() => aiInput.focus(), 100);
                }
            }

            window.toggleAiChat = toggleAiChat;
            aiBtn.addEventListener('click', toggleAiChat);

            // Toggle Settings
            function toggleAiConfig() {
                if (aiConfig.style.display === 'flex') {
                    aiConfig.style.display = 'none';
                } else {
                    aiConfig.style.display = 'flex';
                    apiKeyInput.value = localStorage.getItem('tgs_openai_key') || '';
                }
            }
            window.toggleAiConfig = toggleAiConfig;

            // Save Settings
            function saveAiSettings() {
                const key = apiKeyInput.value.trim();
                localStorage.setItem('tgs_openai_key', key);
                aiConfig.style.display = 'none';
                
                if (key) {
                    addMessage('bot', ' OpenAI API key saved! Now using <strong>ChatGPT</strong>.');
                } else {
                    addMessage('bot', ' Settings saved! Using <strong>free AI mode</strong>.');
                }
            }
            window.saveAiSettings = saveAiSettings;

            // Add Message to Chat
            function addMessage(sender, text) {
                const div = document.createElement('div');
                div.className = `ai-msg ${sender}`;
                
                // Escape HTML to prevent XSS
                const escapeHtml = (str) => str.replace(/[&<>"']/g, 
                    tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[tag]));

                let formattedText = escapeHtml(text)
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n- /g, '<br> ')
                    .replace(/\n\* /g, '<br> ')
                    .replace(/\n(\d+)\. /g, '<br>$1. ')
                    .replace(/\n/g, '<br>');
                    
                div.innerHTML = formattedText;
                aiMessages.appendChild(div);
                aiMessages.scrollTop = aiMessages.scrollHeight;
                return div;
            }

            // Send Message to AI
            async function handleSend() {
                const text = aiInput.value.trim();
                if (!text) return;

                const apiKey = localStorage.getItem('tgs_openai_key') || '';
                
                addMessage('user', text);
                aiInput.value = '';
                aiInput.style.height = '42px';

                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'ai-msg loading';
                loadingDiv.textContent = 'Thinking...';
                aiMessages.appendChild(loadingDiv);
                aiMessages.scrollTop = aiMessages.scrollHeight;

                try {
                    // If you have a role selector in your main HTML, it will be picked up here
                    const currentRole = document.getElementById('role') ? document.getElementById('role').value : 'User';
                    const systemPrompt = `You are a helpful assistant. Current user role: ${currentRole}. Keep answers concise.`;
                    
                    let answer = '';
                    
                    if (apiKey && apiKey.startsWith('sk-')) {
                        // Use OpenAI ChatGPT API
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-3.5-turbo',
                                messages: [
                                    { role: 'system', content: systemPrompt },
                                    { role: 'user', content: text }
                                ],
                                max_tokens: 1000,
                                temperature: 0.7
                            })
                        });

                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message || 'API error');
                        }
                        
                        answer = data.choices?.[0]?.message?.content || '';
                    } else {
                        // Use free Pollinations.ai fallback with GET request
                        const encodedPrompt = encodeURIComponent(`${systemPrompt}\n\nUser: ${text}\n\nAssistant:`);
                        const response = await fetch(`https://text.pollinations.ai/${encodedPrompt}`, {
                            method: 'GET'
                        });

                        if (!response.ok) {
                            throw new Error('Free AI service unavailable. Please add an OpenAI API key in settings () for reliable access.');
                        }

                        answer = await response.text();
                    }

                    if (aiMessages.contains(loadingDiv)) {
                        aiMessages.removeChild(loadingDiv);
                    }
                    
                    if (answer && answer.trim()) {
                        addMessage('bot', answer.trim());
                    } else {
                        addMessage('bot', ' No response received. Please try again.');
                    }

                } catch (err) {
                    if (aiMessages.contains(loadingDiv)) {
                        aiMessages.removeChild(loadingDiv);
                    }
                    console.error('AI Assistant Error:', err);
                    addMessage('bot', ` Error: ${err.message || 'Unable to reach AI service.'}`);
                }
            }

            // Event Listeners
            aiSendBtn.addEventListener('click', handleSend);
            aiInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
            
            aiInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                if (this.value === '') this.style.height = '42px';
            });
        })();
    </script>
    <!-- ================================================================= -->
    <!-- END: AI ASSISTANT MODULE -->
    <!-- ================================================================= -->

    <div class="toast-container no-print" aria-live="polite" aria-atomic="true"></div>

    <!-- Quick Actions Panel -->
    <div id="quick-actions-panel">
        <span style="font-weight: 600; margin-right: 8px;">Quick Actions:</span>
        <button class="quick-action-btn" onclick="quickSave()" title="Save progress (Ctrl+S)">
             Save
        </button>
        <button class="quick-action-btn" onclick="quickUndo()" title="Undo last change (Ctrl+Z)">
             Undo
        </button>
        <button class="quick-action-btn" onclick="quickRedo()" title="Redo (Ctrl+Y)">
             Redo
        </button>
        <button class="quick-action-btn" onclick="showShortcutsModal()" title="Keyboard shortcuts (?)">
             Shortcuts
        </button>
        <button class="quick-action-btn" onclick="hideQuickActions()" title="Dismiss (Esc)">
            
        </button>
    </div>

    <!-- Undo Notification -->
    <div id="undo-notification">
        <span id="undo-message">Action completed</span>
        <button onclick="quickUndo()"
            style="padding: 4px 12px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Undo</button>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" onclick="if(event.target.id === 'shortcuts-modal') hideShortcutsModal()">
        <div class="shortcuts-content">
            <h2 style="margin: 0 0 8px 0; color: var(--heading-color);"> Keyboard Shortcuts</h2>
            <p style="color: var(--text-secondary); margin: 0 0 20px 0; font-size: 14px;">Speed up your workflow with
                these shortcuts</p>

            <div class="shortcuts-grid">
                <div class="shortcut-row">
                    <span class="shortcut-desc">Save progress</span>
                    <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>S</kbd></div>
                </div>
                <div class="shortcut-row">
                    <span class="shortcut-desc">Undo last change</span>
                    <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>Z</kbd></div>
                </div>
                <div class="shortcut-row">
                    <span class="shortcut-desc">Redo</span>
                    <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>Y</kbd></div>
                </div>
                <div class="shortcut-row">
                    <span class="shortcut-desc">Show quick actions</span>
                    <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>K</kbd></div>
                </div>
                <div class="shortcut-row">
                    <span class="shortcut-desc">Show this help</span>
                    <div class="shortcut-keys"><kbd>?</kbd></div>
                </div>
                <div class="shortcut-row">
                    <span class="shortcut-desc">Print draft</span>
                    <div class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>P</kbd></div>
                </div>
                <div class="shortcut-row">
                    <span class="shortcut-desc">Jump to top</span>
                    <div class="shortcut-keys"><kbd>Home</kbd></div>
                </div>
                <div class="shortcut-row">
                    <span class="shortcut-desc">Jump to bottom</span>
                    <div class="shortcut-keys"><kbd>End</kbd></div>
                </div>
                <div class="shortcut-row">
                    <span class="shortcut-desc">Close modal/panel</span>
                    <div class="shortcut-keys"><kbd>Esc</kbd></div>
                </div>
            </div>

            <button onclick="hideShortcutsModal()"
                style="margin-top: 24px; width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Got
                it!</button>
        </div>
    </div>

    <div id="notify-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <button type="button" class="modal-close-btn" aria-label="Close notification dialog">&times;</button>
            <h3>Notify Next Reviewer</h3>
            <div class="workflow-instruction-box info" style="margin-bottom: 15px;">
                <h4 class="instruction-title"> Handover Steps</h4>
                <ol style="margin: 5px 0 0; padding-left: 18px; font-size: 0.9em;">
                    <li><strong>Save the progress file</strong>  Click "Save Progress File" to download the JSON</li>
                    <li><strong>Upload to SharePoint</strong>  Place the file in the project's shared folder</li>
                    <li><strong>Notify the reviewer</strong>  Use Email or Teams to send the handover message</li>
                </ol>
            </div>
            <p>Your progress must be saved to a file for the next person to review. Click "Save Progress" first, then
                choose how you want to notify them.</p>
            <label for="notification-template-select" style="display:block; margin-bottom:6px; font-weight:600;">Message Template</label>
            <select id="notification-template-select" class="form-field" title="Select message template" aria-label="Select message template">
                <option value="pass_forward">Pass Forward</option>
                <option value="send_back">Send Back</option>
                <option value="finalize">Finalize</option>
            </select>
            <textarea id="email-template-preview" aria-label="Email template preview"></textarea>
            <div class="modal-actions">
                <button class="btn btn-primary" id="modal-save-btn"><svg>
                        <use href="#icon-save"></use>
                    </svg><span>Save Progress File</span></button>
                <button class="btn btn-success" id="modal-email-btn"><svg>
                        <use href="#icon-notify"></use>
                    </svg><span>Share via Email</span></button>
                <button class="btn btn-teams" id="modal-teams-btn">
                    <svg>
                        <use href="#icon-teams"></use>
                    </svg>
                    <span>Share via Teams</span>
                </button>
            </div>
        </div>
    </div>

    <div id="conflict-review-modal" class="modal-overlay conflict-review-modal" style="display:none;">
        <div class="modal-content">
            <button type="button" class="modal-close-btn" aria-label="Close flagged items review">&times;</button>
            <h3>Flagged Items Review</h3>
            <p>Use this list to jump directly to questions that were flagged during the review.</p>
            <div id="conflict-review-count" style="font-weight:600; margin-bottom:10px;"></div>
            <div id="conflict-review-list"></div>
            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-secondary" type="button" onclick="closeConflictReview()" title="Close conflict review modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Designer Workflow Modal -->
    <div id="designer-workflow-modal" class="modal-overlay" style="display:none; z-index: 10001;">
        <div class="modal-content"
            style="max-width: 400px; text-align: center; padding: 25px; position: relative; background: var(--card-background);">
            <button type="button" class="modal-close-btn" aria-label="Close designer workflow dialog"
                onclick="document.getElementById('designer-workflow-modal').style.display='none'; ModalFocusTrap.deactivate('designer-workflow-modal')">&times;</button>
            <h3 style="margin-top: 0; color: var(--primary-color);">Designer Workflow</h3>
            <p style="margin: 15px 0 25px; font-size: 1.1em; color: var(--text-primary);">Are you starting a new project
                or re-reviewing an existing file?</p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-primary" onclick="handleDesignerChoice('new')" style="min-width: 130px;" title="Create a new project checklist from scratch">
                    <svg style="width:16px;height:16px;margin-right:8px;vertical-align:text-bottom;">
                        <use href="#icon-plus"></use>
                    </svg>
                    New Project
                </button>
                <button class="btn btn-secondary" onclick="handleDesignerChoice('review')" style="min-width: 130px;" title="Load and review an existing project file">
                    <svg style="width:16px;height:16px;margin-right:8px;vertical-align:text-bottom;">
                        <use href="#icon-upload"></use>
                    </svg>
                    Re-review File
                </button>
            </div>
        </div>
    </div>

    <!-- Project Structure Info Modal - Shown when loading files for non-designers -->
    <div id="project-structure-modal" class="modal-overlay" style="display:none; z-index: 10003;">
        <div class="modal-content" style="max-width: 550px; text-align: left; padding: 30px; position: relative; background: var(--card-background);">
            <button type="button" class="modal-close-btn" aria-label="Close project structure dialog" onclick="cancelProjectStructureLoad()" style="color: var(--text-secondary);">&times;</button>
            <h3 style="margin-top: 0; color: var(--primary-color); text-align: center;">
                 Project Structure Information
            </h3>
            <p style="margin: 10px 0 20px; font-size: 0.95em; color: var(--text-secondary); text-align: center;">
                The file you're loading contains the following structure:
            </p>
            
            <div id="project-structure-details" style="background: var(--surface-elevated); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                <!-- Populated dynamically -->
            </div>
            
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%); border-radius: 12px; padding: 15px; border: 1px solid #ffc107; margin-bottom: 20px;">
                <p style="margin: 0; color: #856404; font-size: 0.95em;">
                    <strong> Important:</strong> Before clicking "Load Data", please ensure you have created the matching number of suites and TGS sets using the form controls above.
                </p>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-secondary" onclick="cancelProjectStructureLoad()" style="min-width: 100px;">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="proceedWithProjectLoad()" style="min-width: 160px;">
                     Load Data
                </button>
            </div>
        </div>
    </div>

    <!-- Handover Info Modal - Shown before TMP sign-off -->
    <div id="handover-info-modal" class="modal-overlay" style="display:none; z-index: 10002;">
        <div class="modal-content" style="max-width: 520px; text-align: left; padding: 30px; position: relative; background: var(--card-background);">
            <button type="button" class="modal-close-btn" aria-label="Close handover info dialog" onclick="cancelHandoverInfo()" style="color: var(--text-secondary);">&times;</button>
            <h3 style="margin-top: 0; color: var(--primary-color); text-align: center;">
                 Handover Information for Next User
            </h3>
            <p style="margin: 10px 0 20px; font-size: 0.95em; color: var(--text-secondary); text-align: center;">
                Before completing TMP sign-off, please provide details for the next reviewer:
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-weight: 600; color: var(--heading-color); display: block; margin-bottom: 5px;">
                            Total Suites:
                        </label>
                        <input type="number" id="handover-total-suites" class="form-field" min="1" 
                               style="width: 100%; padding: 10px; border-radius: 8px;" placeholder="e.g., 1">
                    </div>
                    
                    <div>
                        <label style="font-weight: 600; color: var(--heading-color); display: block; margin-bottom: 5px;">
                            Total TGS Sets:
                        </label>
                        <input type="number" id="handover-total-tgs" class="form-field" min="0" 
                               style="width: 100%; padding: 10px; border-radius: 8px;" placeholder="e.g., 3">
                    </div>
                </div>
                
                <div>
                    <label style="font-weight: 600; color: var(--heading-color); display: block; margin-bottom: 5px;">
                        Forwarded To:
                    </label>
                    <select id="handover-forwarded-to" class="form-field" 
                            title="Select next reviewer" aria-label="Select next reviewer"
                            style="width: 100%; padding: 10px; border-radius: 8px; cursor: pointer;">
                        <option value="">-- Select Next Reviewer --</option>
                        <option value="Designer">Designer</option>
                        <option value="Admin (Intermediate)">Admin (Intermediate)</option>
                        <option value="QA">QA</option>
                        <option value="TMD">TMD</option>
                        <option value="Admin (Final)">Admin (Final)</option>
                        <option value="Final Archive">Final Archive (Complete)</option>
                    </select>
                </div>
                
                <div>
                    <label style="font-weight: 600; color: var(--heading-color); display: block; margin-bottom: 5px;">
                        Additional Notes (Optional):
                    </label>
                    <textarea id="handover-notes" class="form-field" rows="2"
                              style="width: 100%; padding: 10px; border-radius: 8px; resize: vertical;" 
                              placeholder="Any special instructions or notes..."></textarea>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="cancelHandoverInfo()" style="min-width: 100px;">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="confirmHandoverInfo()" style="min-width: 140px;">
                     Confirm & Sign Off
                </button>
            </div>
        </div>
    </div>

    <!-- Last TGS Confirmation Modal -->
    <div id="last-tgs-confirm-modal" class="modal-overlay" style="display:none; z-index: 10002;">
        <div class="modal-content" style="max-width: 450px; text-align: center; padding: 30px; position: relative; background: var(--card-background);">
            <button type="button" class="modal-close-btn" aria-label="Close TGS confirmation dialog" onclick="cancelLastTgsConfirm()" style="color: var(--text-secondary);">&times;</button>
            <h3 style="margin-top: 0; color: var(--primary-color);">
                 TGS Sign-Off
            </h3>
            <p style="margin: 15px 0 25px; font-size: 1em; color: var(--text-color);">
                Is this your <strong>last TGS set</strong> to review for this project?
            </p>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-secondary" onclick="handleLastTgsChoice(false)" style="min-width: 140px;">
                    No, I have more
                </button>
                <button class="btn btn-primary" onclick="handleLastTgsChoice(true)" style="min-width: 140px;">
                     Yes, this is my last
                </button>
            </div>
        </div>
    </div>

    <!-- Handover Info Display Modal - Shown when loading a file -->
    <div id="handover-display-modal" class="modal-overlay" style="display:none; z-index: 10002;">
        <div class="modal-content" style="max-width: 500px; text-align: left; padding: 30px; position: relative; background: var(--card-background);">
            <button type="button" class="modal-close-btn" aria-label="Close handover display dialog" onclick="closeHandoverDisplayModal()" style="color: var(--text-secondary);">&times;</button>
            <h3 style="margin-top: 0; color: var(--primary-color); text-align: center;">
                 Handover Information
            </h3>
            <p style="margin: 10px 0 20px; font-size: 0.95em; color: var(--text-secondary); text-align: center;">
                The previous user provided the following details:
            </p>
            
            <div id="handover-display-content" style="background: var(--surface-elevated); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color);">
                <!-- Content will be populated dynamically -->
            </div>
            
            <div style="display: flex; justify-content: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="closeHandoverDisplayModal()" style="min-width: 140px;">
                     Got It
                </button>
            </div>
        </div>
    </div>

    <!-- Full Screen Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="loader-content">
            <div class="spinner"></div>
            <p id="loading-text">Processing File...</p>
        </div>
    </div>

    <!-- External Libraries (defer: download parallel, execute after DOM ready)
         SRI: Subresource Integrity hashes prevent supply chain attacks -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js" 
            defer 
            integrity="sha384-rNlaE5fs9dGIjmxWDALQh/RBAaGRYT5ChrzHo6tRfgrZ36iRFAiquP5g41Jsv+0j" 
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" 
            defer 
            integrity="sha384-Yv5O+t3uE3hunW8uyrbpPW3iw6/5/Y7HitWJBLgqfMoA36NogMmy+8wWZMpn3HWc" 
            crossorigin="anonymous"></script>
    
    <script>
        let currentRole = '';
        
        // ========================================
        // Loading System for File Operations
        // ========================================
        // Define LoadingSystem if not already exists
        if (typeof LoadingSystem === 'undefined') {
            window.LoadingSystem = {
                show: function(message = "Loading...") {
                    const overlay = document.getElementById('loading-overlay');
                    const text = document.getElementById('loading-text');
                    if (overlay && text) {
                        text.textContent = message;
                        overlay.classList.add('active');
                    }
                },
                hide: function() {
                    const overlay = document.getElementById('loading-overlay');
                    if (overlay) {
                        // Fade out effect
                        overlay.style.opacity = '0';
                        setTimeout(() => {
                            overlay.classList.remove('active');
                            overlay.style.opacity = ''; // Reset for next time
                        }, 300);
                    }
                }
            };
        }
        
        // ========================================
        // Modal Focus Trap Utility for Accessibility
        // ========================================
        const ModalFocusTrap = {
            activeTraps: new Map(),
            
            /**
             * Activates focus trap for a modal
             * @param {string} modalId - The modal element ID
             * @param {HTMLElement} triggerElement - Element that opened the modal (to return focus)
             */
            activate(modalId, triggerElement = document.activeElement) {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                
                const focusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
                const focusableElements = modal.querySelectorAll(focusableSelector);
                const firstFocusable = focusableElements[0];
                const lastFocusable = focusableElements[focusableElements.length - 1];
                
                // Store the trigger element to return focus when closing
                this.activeTraps.set(modalId, {
                    triggerElement,
                    keyHandler: (e) => {
                        if (e.key === 'Escape') {
                            // Find and click the close button or cancel button
                            const closeBtn = modal.querySelector('.modal-close-btn, .btn-secondary[onclick*="cancel"], .btn-secondary[onclick*="close"]');
                            if (closeBtn) closeBtn.click();
                            return;
                        }
                        
                        if (e.key !== 'Tab') return;
                        
                        if (e.shiftKey) {
                            // Shift + Tab
                            if (document.activeElement === firstFocusable) {
                                e.preventDefault();
                                lastFocusable?.focus();
                            }
                        } else {
                            // Tab
                            if (document.activeElement === lastFocusable) {
                                e.preventDefault();
                                firstFocusable?.focus();
                            }
                        }
                    }
                });
                
                // Add keyboard listener
                modal.addEventListener('keydown', this.activeTraps.get(modalId).keyHandler);
                
                // Set aria-hidden on main content
                const appShell = document.getElementById('app-shell');
                const landingPage = document.getElementById('landing-page');
                if (appShell) appShell.setAttribute('aria-hidden', 'true');
                if (landingPage && landingPage.style.display !== 'none') {
                    landingPage.setAttribute('aria-hidden', 'true');
                }
                
                // Focus first focusable element after a brief delay
                setTimeout(() => firstFocusable?.focus(), 50);
            },
            
            /**
             * Deactivates focus trap for a modal
             * @param {string} modalId - The modal element ID
             */
            deactivate(modalId) {
                const trap = this.activeTraps.get(modalId);
                if (!trap) return;
                
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.removeEventListener('keydown', trap.keyHandler);
                }
                
                // Restore aria-hidden on main content
                const appShell = document.getElementById('app-shell');
                const landingPage = document.getElementById('landing-page');
                if (appShell) appShell.removeAttribute('aria-hidden');
                if (landingPage) landingPage.removeAttribute('aria-hidden');
                
                // Return focus to trigger element
                if (trap.triggerElement && typeof trap.triggerElement.focus === 'function') {
                    trap.triggerElement.focus();
                }
                
                this.activeTraps.delete(modalId);
            }
        };

        const checklistData = {
            "Document Control & Administrative": [
                "The TGS has a unique reference number, revision number, and date.",
                "Project details are complete: project number, name, location (road name, suburb, start/end points), and client information (logo, contact) are clearly stated.",
                "The nature of the job/activity is clearly identified (e.g. Concrete pours, service connection, etc.) and the control method (e.g. Single lane reversible flow, lateral shift, etc.).",
                "Correct Designer, QAS, and TMD are identified including correct TMD License No. in corresponding states.",
                "If safety barriers are proposed, is there a RPEQ design available? Are barrier measurements and clearances compliant and remaining lane widths available for client's proposed closure?",
                "RPEQ Certification: If the TGS includes non-compliant widths, clearances, or the design of safety barriers, is a design by a Registered Professional Engineer of Queensland (RPEQ) included or referenced?",
                "Is correct client information recorded (including logo, contact)?",
                "If the initial designer and amendment designer are different, is R.D.T. and R.D. recorded?",
                "The drawing is clear, legible, and correctly scaled (or marked 'Not to Scale' with all distances dimensioned). No floating or unnecessary texts, signage, and overlapping notes on the template.",
                "A cross-section diagram is provided where necessary to clarify widths and clearances.",
                "All signs, devices, and distances are clearly labelled without ambiguity.",
                "Is the correct authorities identified (State, Local, and QPS)?",
                "A legend or itemised list specifies all required signs and devices, including their sizes and types; and a manifest showing the number of devices and Traffic Controllers. Are the right number of TCs are reflected on the plan.",
                "Zoning, road hierarchy and heritage places are correctly identified and referenced per Council planning scheme and data.",
                "Subject lots and frontages are indicated on TGS and TMP where development site covers multiple lots and/or multiple frontages, or when the site address is different from the actual frontage where works are/where permit has to be applied for.",
                "Print Region size (A1, A2, A3, A4, A5) is correctly identified and boxed on planning template according to design scale.",
                "A legend or itemised list specifies all required signs and devices, including their sizes and types; and a manifest showing the number of devices and Traffic Controllers. Are the right number of TCs are reflected on the plan."
            ],
            "TMP Integration & Risk Assessment": [
                "The TGS aligns with the objectives, scope, staging, and approved work hours outlined in the overarching TMP.",
                "The TGS implements the specific risk treatments selected in the options analysis.",
                "Is the options analysis site specific (generic is not recommended)?",
                "A traffic impact assessment for end-of-queue management has been conducted for hold-and-release, shuttle flow, or closures at controlled intersections, and the TGS reflects its findings.",
                "Has the correct volume data used for for TIA?",
                "If assuming percentage, has an appropriate percentage assumed for the type of the road? (e.g., apartments, industrial areas, houses).",
                "The chosen method follows the Hierarchy of Control (Around > Through > Past), and the choice is justified and site specific.",
                "The work is correctly classified as Static, Mobile, or Short-Term Low-Impact, and it strictly meets all criteria for that classification.",
                "The TGS addresses site-specific risks identified in the risk assessment (e.g., nearby schools, property access, heavy vehicle routes, public transport)."
            ],
            "Design Principles": [
                "The existing road width is sufficient to accommodate the proposed TTM methodology (work area + clearances + traffic lanes).",
                "Excavation > 500 mm < or = 2.5 m of trafficable lane.",
                "Is appropriate delineation selected?",
                "Is end of queue signs included (for hold and release, single lane reversible flow, lane closures at controlled intersections)?",
                "Is the queue length correctly calculate for the traffic volume?",
                "If a single lane reversible flow and contraflow is proposed at a roundabout, is there a swept path available to determine if vehicles can travel on the opposite side of the road?",
                "The correct speed value is used for all calculations (posted speed, unless traffic is >10 km/h different).",
                "If a sign or taper is placed within 200m of a speed reduction, its placement is calculated using the higher speed value.",
                "Temporary Speed Limits are justified, correctly implemented (e.g., buffer zones), signed (duplicated and with repeaters), and properly terminated.",
                "The minimum sight distance to every sign and key decision point is compliant with AGTTM Part 3, Table 2.3.",
                "The longitudinal spacing between consecutive signs is compliant with AGTTM Part 3, Table 2.2.",
                "All temporary lane widths are compliant with the minimums specified in QGTTM Part 3, Table 2.5.",
                "Edge clearances from the traffic lane to devices (e.g., cones) are compliant with AGTTM Part 3, Table 5.2.",
                "Safety buffer is provided for posted speeds >=60kph.",
                "Lane Status signs accurately represent the lane closure/configuration and sign is duplicated/repeated with appropriate 1200x300/bottom panels.",
                "Traffic controller position has adequate escape route.",
                "Appropriate detour routes have been assessed and selected to accommodate the volume and/or type of displaced traffic. (e.g.. No detour via one-way road in opposing direction).",
                "Traffic Controllers and Merge Taper placed a minimum 50m away from operating signals. (If risk is larger in placing the T/C or Merge Taper 50m away from the signals, is it documented and has been risk assessed?).",
                "Traffic bound/route accurate for Detour Map.",
                "Truck Movements/Path correctly identified and shown on plan based on provided markup or engineering swept path.",
                "Workman signage removed or covered on Aftercare TGS or when not visible (i.e. Events , Long-Term Plans, Truck Deliveries only)."
            ],
            "Site Conditions & Specific Calculations": [
                "The end-of-queue position is estimated, and the Primary PREPARE TO STOP sign is placed based on this queue.",
                "Additional PREPARE TO STOP are placed as per QGTTM part 3 Tables 4.4a & b.",
                "Are the sight distances to PTS are compliant with AGTTM Part 3 Table 2.3.",
                "If the estimated queue on non-road train roads is < 30m, is it rounded up to 30 m.",
                "If the estimated queue where road trains are expected < 70m, is it rounded up to 70 m.",
                "On roads 80 km/h or with restricted sight distance, mandatory end-of-queue treatments and signs are shown as per the Guideline - Traffic Management at Works on Roads.",
                "Taper lengths and separation distances are correctly calculated.",
                "The type of delineation (cones, bollards, markings) is appropriate for the work duration and speed. All devices are correctly spaced.",
                "An approved product is specified, end treatments are included, and the deflection zone is clear. An RPEQ design is provided if required.",
                "If an excavation >500mm deep is within 2.5m of a traffic lane, protection is provided in accordance with QGTTM Part 3, Section 6.8.",
                "A PTCD is specified where required (QLD: AADT > 500, speed  70 km/h).",
                "Mobile works - Convoy Configuration: All necessary vehicles are present. An approved TMA is specified for all Category 3 roads.",
                "Mobile works - Vehicle Spacing: The spacing between the shadow vehicle and work/worker is a minimum of 40m. Spacing between other convoy vehicles is correct for the speed."
            ],
            "Advanced & Specific Work Types": [
                "Mobile works - Signage: All vehicles have appropriate warning devices. A 40 km/h mobile speed zone is implemented if workers are on foot within 1.2m of traffic.",
                "Short-term Low Impact works (STLIW) - Strict Criteria Adherence: The work strictly complies with all time and clearance limits. Prohibited items (tapers, controllers, temporary speed limits) are not used.",
                "STLIW - Lookout Method: If a lookout is used, their required sight distance is specified and compliant with the Guideline - Traffic Management at Works on Roads.",
                "STLIW - Vehicle Warning: A work vehicle with an active warning device is present, and the sight distance to the vehicle is sufficient.",
                "Hold and Release provided, as required. (i.e. Trucks Reversing In the site, Pedestrians crossing midblock, Superstructure (Gantry) installations, or during material lifts and hoisting).",
                "Event Road Closures: Are QPS required on signalized intersections to direct and assist detouring vehicles?",
                "Will the use of QPS provide safer and lesser impact on works affecting signalized intersections?",
                "Are position of Site Amenities, Crane Locations, Work Vehicles, Connection/Services provided and correctly shown on plan?",
                "If site has recently undergone road widening or is in the GCLR3 Corridor, is a markup or reference provided for the change in road configuration and conditions?"
            ],
            "Vulnerable Road Users": [
                "Pedestrians - If a footpath is closed, a safe, accessible, and direct alternative is provided with a desirable width of 1.8m.",
                "Pedestrians - The temporary path surface is specified as firm, smooth, and free of trip hazards.",
                "Pedestrians - If the width is < 1.8 m is there a RPEQ certified design.",
                "Pedestrians - If on the roadway, the path is separated from traffic with 1.2m clearance or a speed reduction to 40 km/h.",
                "Cyclists/motorbikes - A safe alternative route or managed merge is provided for cyclists if their path is blocked.",
                "Cyclists/motorbikes - The TGS addresses surface hazards (e.g., loose gravel, steel plates, raised edges) that are dangerous for two-wheeled vehicles.",
                "Is there is a school crossing, is drop-off and pick-up traffic managed?",
                "Pedestrians - DDA-compliant pram ramps are provided at midblock crossing or where there is no existing ramp."
            ],
            "Night Works": [
                "The TGS specifies mandatory lighting for the work area and control stations.",
                "Flashing lamps are specified on key advance warning signs for approach speeds of 80 km/h or greater."
            ],
            "Site Access & VMP": [
                "Entry/exit points to the worksite are clearly defined with adequate sight distance (4 Seconds).",
                "If required, a Vehicle Movement Plan (VMP) is included, detailing haul routes, entry/exit procedures, and on-site vehicle paths."
            ],
            "Special Conditions": [
                "Roundabouts: If a single lane reversible flow is proposed at a roundabout, a swept path analysis is provided to confirm vehicle movements are possible.",
                "Curve widening of 0.5 m per lane is added to roads with curve radius 100-250 m.",
                "At Curve with radius <100 m In addition to the curve widening of 0.5 m per lane, consider the swept path of long vehicles (for example, buses, trams)."
            ],
            "Implementation & Removal": [
                "The TGS includes notes for the safe installation and removal of devices.",
                "Procedures are specified for handling redundant equipment (e.g., storing outside the clear zone).",
                "The TGS includes notes in usage of Leg Extenders, as required.",
                "Implementation of changing panels on variable speed zones (i.e. School Zones) are noted, as required."
            ]
        };

        const roles = {
            designer: { name: "Designer", color: "var(--role-designer-color)" },
            "admin-intermediate": { name: "Admin Intermediate", color: "var(--role-admin-intermediate-color)" },
            qa: { name: "QA", color: "var(--role-qa-color)" },
            tmd: { name: "TMD", color: "var(--role-tmd-color)" },
            "admin-final": { name: "Admin Final", color: "var(--role-admin-final-color)" }
        };

        const roleOrder = ["designer", "admin-intermediate", "qa", "tmd", "admin-final"];
        const signOffVisualOrder = ["designer", "admin-intermediate", "qa", "tmd", "admin-final"];
        const LOCAL_STORAGE_KEY = 'tgsWorkflowAutosave_v3';
        const THEME_STORAGE_KEY = 'tgsWorkflowThemePreference';
        const PROJECT_DETAIL_FIELDS = [
            'ccNumber',
            'projectName',
            'projectLocation',
            'jobNature',
            'clientInfo',
            'projectSuitesCount'
        ];

        const FORM_SEARCH_MIN_CHARS = 2;
        let sectionNavRefreshHandle = null;

        const emailTemplates = {
            'send_back': 'Please review the flagged items and provide your feedback so we can move forward.',
            'pass_forward': 'Ready for your review. Load the attached JSON to continue the workflow.',
            'finalize': 'Final review complete. Archiving the documents as per workflow.'
        };

        const validationRules = {
            ccNumber: /^CC-\d{4,}$/,
            tmdNumber: /^TMD-\d+$/,
            url: /^https?:\/\/.+/i
        };

        const auditTrail = [];
        let lazySectionObserver = null;

        // Track when data is being populated from files so automated handlers can opt-out
        let _fileLoadDepth = 0;
        let _loadingTimeout = null;
        window._isLoadingFromFile = false;
        
        // Show loading overlay after a short delay (to avoid flicker for fast loads)
        function showLoadingOverlay(message = 'Loading...') {
            // Clear any pending hide
            if (_loadingTimeout) {
                clearTimeout(_loadingTimeout);
                _loadingTimeout = null;
            }
            
            let overlay = document.getElementById('file-loading-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'file-loading-overlay';
                overlay.innerHTML = `
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-message">${message}</div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            
            // Update message
            const msgEl = overlay.querySelector('.loading-message');
            if (msgEl) msgEl.textContent = message;
            
            // Show with fade in
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
            });
        }
        
        function hideLoadingOverlay() {
            const overlay = document.getElementById('file-loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                _loadingTimeout = setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                    _loadingTimeout = null;
                }, 200);
            }
        }
        
        const beginFileLoad = (suiteIndex = null, setIndex = null, type = null) => {
            _fileLoadDepth += 1;
            window._isLoadingFromFile = true;
            
            // Track which specific section is being loaded (for isolated updates)
            if (suiteIndex !== null) {
                window._loadingSection = { suiteIndex, setIndex, type };
            }
            
            // Show loading overlay after 300ms delay (avoid flicker for fast loads)
            if (_fileLoadDepth === 1) {
                _loadingTimeout = setTimeout(() => {
                    if (window._isLoadingFromFile) {
                        showLoadingOverlay('Loading file data...');
                    }
                }, 300);
            }
        };
        const endFileLoad = () => {
            _fileLoadDepth = Math.max(0, _fileLoadDepth - 1);
            if (_fileLoadDepth === 0) {
                // Hide loading overlay
                hideLoadingOverlay();
                
                // Clear section tracking
                window._loadingSection = null;
                
                // Delay flag reset slightly to allow dependent UI refreshes to finish
                setTimeout(() => { if (_fileLoadDepth === 0) window._isLoadingFromFile = false; }, 0);
            }
        };

        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function suggestSuiteName(location = '', jobNature = '') {
            const locationPart = (location.split(',')[0] || '').trim().replace(/\s+/g, '-');
            const jobPart = (jobNature.split(/\s+/)[0] || '').trim().replace(/\s+/g, '-');
            return [locationPart, jobPart].filter(Boolean).join('-');
        }

        function applySmartSuiteNameSuggestions() {
            const location = document.getElementById('projectLocation')?.value || '';
            const jobNature = document.getElementById('jobNature')?.value || '';
            const suggestion = suggestSuiteName(location, jobNature);
            if (!suggestion) return;
            document.querySelectorAll('textarea[id$="_projectSuiteName"]').forEach((field, index) => {
                if (!field.value.trim()) {
                    field.placeholder = `${suggestion}-${index + 1}`;
                }
            });
        }

        function attachValidationRules(root = document) {
            if (!root) return;
            root.querySelectorAll('[data-validate-type]').forEach(field => {
                if (field.dataset.validationBound === 'true') return;
                const type = field.dataset.validateType;
                const regex = validationRules[type];
                if (!regex) return;
                const handler = () => {
                    const value = (field.value || '').trim();
                    if (!value) {
                        field.setCustomValidity('');
                        return;
                    }
                    const isValid = regex.test(value);
                    field.setCustomValidity(isValid ? '' : `Invalid ${type.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                };
                ['input', 'blur'].forEach(evt => field.addEventListener(evt, handler));
                field.dataset.validationBound = 'true';
            });
        }

        function startBulkProgress(total = 0, label = 'Processing') {
            const panel = document.getElementById('bulk-progress');
            if (!panel || !total) return;
            panel.style.display = 'block';
            panel.dataset.total = total;
            panel.dataset.label = label;
            const text = panel.querySelector('.progress-text');
            const fill = panel.querySelector('.progress-fill');
            if (text) text.textContent = `${label}: 0/${total}`;
            if (fill) fill.style.width = '0%';
        }

        function updateBulkProgress(processed = 0) {
            const panel = document.getElementById('bulk-progress');
            if (!panel || panel.style.display !== 'block') return;
            const total = Number(panel.dataset.total) || 0;
            if (!total) return;
            const label = panel.dataset.label || 'Processing';
            const clamped = Math.min(processed, total);
            const text = panel.querySelector('.progress-text');
            const fill = panel.querySelector('.progress-fill');
            if (text) text.textContent = `${label}: ${clamped}/${total}`;
            if (fill) fill.style.width = `${(clamped / total) * 100}%`;
        }

        function endBulkProgress() {
            const panel = document.getElementById('bulk-progress');
            if (!panel) return;
            panel.style.display = 'none';
            panel.dataset.total = '0';
            panel.dataset.label = '';
        }

        function setupLazySectionObserver() {
            if (lazySectionObserver) return;
            lazySectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        renderSection(entry.target);
                        lazySectionObserver.unobserve(entry.target);
                    }
                });
            }, { 
                rootMargin: '400px 0px', // Increased from 200px for better preloading
                threshold: 0.01 
            });
        }

        function registerLazySection(section) {
            if (!section) return;
            setupLazySectionObserver();
            if (section.dataset.lazyRegistered === 'true') return;
            section.dataset.lazyRegistered = 'true';
            lazySectionObserver.observe(section);
        }

        function renderSection(section) {
            if (!section || section.dataset.rendered === 'true') return;
            section.dataset.rendered = 'true';
            section.classList.add('lazy-rendered');
        }

        /* Quick snippet dictionary and per-textarea UI */
        const COMMON_SNIPPETS = [
            "Compliant with AGTTM Part 3.",
            "Signage spacing inadequate for speed limit.",
            "Missing taper length calculation.",
            "Refer to Standard Drawing 1234.",
            "Please clarify pedestrian management."
        ];

        function attachSnippetTools() {
            // Only attach to comment section textarea, not project details or form fields
            const commentTextarea = document.getElementById('comment-input');
            if (!commentTextarea) return;
            
            // Check if button already exists
            if (commentTextarea.parentNode.querySelector('.snippet-trigger')) return;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-secondary snippet-trigger no-print';
            btn.innerHTML = '';
            btn.title = 'Insert Quick Snippet';
            btn.style.cssText = 'position: absolute; right: 10px; top: 40px; padding: 4px 10px; z-index: 5;';
            
            btn.onclick = (e) => {
                e.preventDefault();
                const list = document.createElement('div');
                list.className = 'snippet-popup';
                list.style.cssText = `
                    position: absolute; right: 0; top: 35px; 
                    background: var(--card-background); 
                    color: var(--text-color);
                    border: 1px solid var(--border-color); 
                    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
                    z-index: 100; border-radius: 6px; width: 250px; text-align: left;
                `;
                
                COMMON_SNIPPETS.forEach(text => {
                    const item = document.createElement('div');
                    item.textContent = text;
                    item.style.cssText = `
                        padding: 8px; 
                        cursor: pointer; 
                        border-bottom: 1px solid var(--border-color); 
                        font-size: 0.85em;
                        color: var(--text-color);
                    `;
                    item.onmouseover = () => item.style.background = 'var(--surface-elevated)';
                    item.onmouseout = () => item.style.background = 'var(--card-background)';
                    item.onclick = () => {
                        commentTextarea.value = (commentTextarea.value ? commentTextarea.value + " " : "") + text;
                        commentTextarea.dispatchEvent(new Event('input', {bubbles: true})); // Trigger autosave
                        list.remove();
                    };
                    list.appendChild(item);
                });
                
                // Close on click outside
                const closer = (ev) => {
                    if(ev.target !== btn && !list.contains(ev.target)) {
                        list.remove();
                        document.removeEventListener('click', closer);
                    }
                };
                setTimeout(() => document.addEventListener('click', closer), 0);
                
                btn.parentNode.appendChild(list);
            };
            
            commentTextarea.parentNode.style.position = 'relative';
            commentTextarea.parentNode.appendChild(btn);
        }

        async function exportToPDF() {
            if (typeof html2pdf === 'undefined') {
                alert('PDF export library not loaded.');
                return;
            }
            
            // Show loading
            const loadMsg = document.createElement('div');
            loadMsg.innerHTML = '<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);color:white;display:flex;justify-content:center;align-items:center;z-index:99999;font-size:20px;">Generating PDF... Please wait.</div>';
            document.body.appendChild(loadMsg);

            try {
                const element = document.getElementById('app-shell');
                
                // Clone to modify without affecting UI
                const clone = element.cloneNode(true);
                clone.style.width = '100%';
                clone.style.maxWidth = '1200px'; // Force width for PDF consistency
                
                // 1. Remove non-print elements
                clone.querySelectorAll('.no-print, button, .workflow-actions').forEach(el => el.remove());
                
                // 2. Expand all accordions
                clone.querySelectorAll('.accordion-content').forEach(el => el.style.display = 'block');
                
                // 3. CONVERT INPUTS TO TEXT (Critical for PDF)
                clone.querySelectorAll('input, textarea, select').forEach(input => {
                    const val = input.value;
                    const type = input.type;
                    
                    if (type === 'checkbox' || type === 'radio') {
                        // Keep checkboxes but make them static
                        if(input.checked) input.setAttribute('checked', 'checked');
                    } else {
                        // Replace text inputs with paragraphs
                        const p = document.createElement('p');
                        p.textContent = val;
                        p.style.fontWeight = "bold";
                        p.style.whiteSpace = "pre-wrap"; // Preserve line breaks in textareas
                        input.parentNode.replaceChild(p, input);
                    }
                });

                const opt = {
                    margin:       [10, 10, 10, 10],
                    filename:     `TGS_Report_${new Date().toISOString().slice(0,10)}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
                };

                await html2pdf().set(opt).from(clone).save();
                
            } catch (err) {
                console.error(err);
                alert('PDF Generation failed. Try using Browser Print (Ctrl+P) instead.');
            } finally {
                document.body.removeChild(loadMsg);
            }
        }

        function collectFlaggedItemsFromContainer(container) {
            if (!container) return [];
            const flagged = [];
            container.querySelectorAll('input[id*="_conflict_"]:checked').forEach(cb => {
                const block = cb.closest('.question-block');
                if (!block) return;
                const label = block.querySelector('label');
                flagged.push({
                    element: block,
                    question: label ? label.textContent.trim() : 'Flagged question',
                    suiteIndex: container.dataset.suiteIndex,
                    setIndex: container.dataset.setIndex,
                    type: container.dataset.type || 'tgs'
                });
            });
            return flagged;
        }

        function openConflictReview(suiteIndex = null, setIndex = null, type = null) {
            const modal = document.getElementById('conflict-review-modal');
            const listEl = document.getElementById('conflict-review-list');
            const countEl = document.getElementById('conflict-review-count');
            if (!modal || !listEl || !countEl) return;

            let targets = [];
            if (suiteIndex === null || typeof suiteIndex === 'undefined') {
                targets = Array.from(document.querySelectorAll('.tgs-set-container, .tmp-set-container'));
            } else if (type === 'tmp') {
                targets = Array.from(document.querySelectorAll(`.tmp-set-container[data-suite-index="${suiteIndex}"]`));
            } else {
                targets = Array.from(document.querySelectorAll(`.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`));
            }

            const flagged = targets.flatMap(collectFlaggedItemsFromContainer);
            listEl.innerHTML = '';
            if (!flagged.length) {
                listEl.innerHTML = '<em>No flagged questions in this section.</em>';
            } else {
                flagged.forEach(item => {
                    const row = document.createElement('div');
                    row.style.padding = '8px 0';
                    row.style.borderBottom = '1px solid var(--border-color)';
                    const setLabel = item.type === 'tmp' ? 'TMP' : `Set ${Number(item.setIndex) + 1}`;
                    row.innerHTML = `<strong>${item.question}</strong><br><small>Suite ${Number(item.suiteIndex) + 1}  ${item.type.toUpperCase()} ${setLabel}</small>`;
                    const jumpBtn = document.createElement('button');
                    jumpBtn.className = 'btn btn-secondary';
                    jumpBtn.textContent = 'Jump to question';
                    jumpBtn.style.marginTop = '6px';
                    jumpBtn.addEventListener('click', () => {
                        item.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        closeConflictReview();
                        const section = item.element.closest('.accordion-section');
                        const header = section?.querySelector('.accordion-header');
                        if (header && !header.classList.contains('active')) {
                            header.click();
                        }
                        item.element.classList.add('jump-highlight');
                        setTimeout(() => item.element.classList.remove('jump-highlight'), 2000);
                    });
                    row.appendChild(jumpBtn);
                    listEl.appendChild(row);
                });
            }
            countEl.textContent = `${flagged.length} item${flagged.length === 1 ? '' : 's'} flagged`;
            modal.style.display = 'block';
            ModalFocusTrap.activate('conflict-review-modal');
        }

        function closeConflictReview() {
            const modal = document.getElementById('conflict-review-modal');
            if (modal) modal.style.display = 'none';
            ModalFocusTrap.deactivate('conflict-review-modal');
        }

        function logAuditEvent(fieldId, oldValue, newValue) {
            if (oldValue === newValue) return;
            const entry = {
                timestamp: new Date().toISOString(),
                user: roles[currentRole]?.name || currentRole || 'Unknown User',
                field: fieldId,
                oldValue,
                newValue
            };
            auditTrail.push(entry);
            appendAuditEntry(entry);
        }

        function appendAuditEntry(entry) {
            const container = document.getElementById('audit-trail-log');
            if (!container) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'audit-entry';
            wrapper.style.padding = '8px 0';
            wrapper.style.borderBottom = '1px solid var(--border-color)';
            wrapper.innerHTML = `
                <strong>${entry.user}</strong> updated <code>${entry.field}</code>
                <br><small>${new Date(entry.timestamp).toLocaleString()}</small>
                <div style="font-size:0.85em; color:var(--text-secondary);">
                    <div>Old: ${entry.oldValue ?? ''}</div>
                    <div>New: ${entry.newValue ?? ''}</div>
                </div>`;
            container.appendChild(wrapper);
        }

        function logAuditSnapshot() {
            if (!auditTrail.length) {
                alert('No audit entries recorded yet.');
                return;
            }
            const blob = new Blob([JSON.stringify(auditTrail, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `audit-trail-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }, 100);
        }

        async function handleVersionCompare() {
            const fileA = document.getElementById('version-file-a')?.files?.[0];
            const fileB = document.getElementById('version-file-b')?.files?.[0];
            if (!fileA || !fileB) {
                alert('Select two JSON files to compare.');
                return;
            }
            try {
                const [dataA, dataB] = await Promise.all([readFileAsJSON(fileA), readFileAsJSON(fileB)]);
                const diffs = compareVersions(dataA, dataB);
                renderVersionDiffs(diffs, fileA.name, fileB.name);
            } catch (err) {
                console.error('Version compare failed', err);
                alert('Unable to compare versions. Please ensure both files are valid JSON exports.');
            }
        }

        function compareVersions(v1Data, v2Data, path = '', diffs = []) {
            const v1 = typeof v1Data === 'object' && v1Data !== null ? v1Data : {};
            const v2 = typeof v2Data === 'object' && v2Data !== null ? v2Data : {};
            const keys = new Set([...Object.keys(v1), ...Object.keys(v2)]);
            keys.forEach(key => {
                const nextPath = path ? `${path}.${key}` : key;
                const valueA = v1[key];
                const valueB = v2[key];
                const areObjects = typeof valueA === 'object' && valueA !== null && typeof valueB === 'object' && valueB !== null;
                if (areObjects) {
                    compareVersions(valueA, valueB, nextPath, diffs);
                } else if (JSON.stringify(valueA) !== JSON.stringify(valueB)) {
                    diffs.push({ path: nextPath, before: valueA, after: valueB });
                }
            });
            return diffs;
        }

        function renderVersionDiffs(diffs, nameA, nameB) {
            const container = document.getElementById('version-compare-results');
            if (!container) return;
            container.innerHTML = '';
            const header = document.createElement('div');
            header.innerHTML = `<strong>Comparing:</strong> ${nameA}  ${nameB}`;
            container.appendChild(header);
            if (!diffs.length) {
                container.innerHTML += '<p>No differences detected.</p>';
                return;
            }
            diffs.slice(0, 100).forEach(diff => {
                const row = document.createElement('div');
                row.style.padding = '6px 0';
                row.style.borderBottom = '1px solid var(--border-color)';
                
                // Safe rendering to prevent XSS
                const pathStrong = document.createElement('strong');
                pathStrong.textContent = diff.path;
                
                const beforeSpan = document.createElement('span');
                beforeSpan.style.color = 'var(--danger-color)';
                beforeSpan.textContent = JSON.stringify(diff.before);
                
                const afterSpan = document.createElement('span');
                afterSpan.style.color = 'var(--success-color)';
                afterSpan.textContent = JSON.stringify(diff.after);
                
                row.appendChild(pathStrong);
                row.appendChild(document.createElement('br'));
                row.appendChild(beforeSpan);
                row.appendChild(document.createTextNode('  '));
                row.appendChild(afterSpan);
                
                container.appendChild(row);
            });
        }

        function readFileAsJSON(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        resolve(JSON.parse(reader.result));
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function updateEmailTemplatePreviewFromSelection() {
            const select = document.getElementById('notification-template-select');
            const preview = document.getElementById('email-template-preview');
            if (!select || !preview) return;
            const template = emailTemplates[select.value] || '';
            if (!preview.value || preview.dataset.fromTemplate === 'true') {
                preview.value = template;
                preview.dataset.fromTemplate = 'true';
            }
        }

        function getStoredThemePreference() {
            try {
                const saved = localStorage.getItem(THEME_STORAGE_KEY);
                if (saved === 'dark' || saved === 'light') return saved;
            } catch (_) {
                return null;
            }
            return null;
        }

        function hasSavedThemePreference() {
            return getStoredThemePreference() !== null;
        }

        function resolveInitialTheme() {
            const stored = getStoredThemePreference();
            if (stored) return stored;
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) return 'dark';
            return 'light';
        }

        function applyTheme(theme) {
            const normalized = theme === 'dark' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', normalized);

            const isDark = normalized === 'dark';

            // Update fixed toggle
            const fixedToggle = document.getElementById('fixed-theme-toggle');
            if (fixedToggle) {
                const icon = fixedToggle.querySelector('.theme-toggle-icon');
                if (icon) icon.textContent = isDark ? '' : '';
                fixedToggle.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
            }
        }

        function setThemePreference(theme) {
            const normalized = theme === 'dark' ? 'dark' : 'light';
            try { localStorage.setItem(THEME_STORAGE_KEY, normalized); } catch (_) { }
            applyTheme(normalized);
        }

        function toggleThemePreference() {
            const currentTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
            const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setThemePreference(nextTheme);
        }

        function initThemeHandling() {
            applyTheme(resolveInitialTheme());
            const mediaQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
            if (mediaQuery && typeof mediaQuery.addEventListener === 'function') {
                mediaQuery.addEventListener('change', (event) => {
                    if (!hasSavedThemePreference()) {
                        applyTheme(event.matches ? 'dark' : 'light');
                    }
                });
            } else if (mediaQuery && typeof mediaQuery.addListener === 'function') {
                mediaQuery.addListener((event) => {
                    if (!hasSavedThemePreference()) {
                        applyTheme(event.matches ? 'dark' : 'light');
                    }
                });
            }
        }

        function getNextReviewer(suiteIndex, setIndex, type = 'tgs') {
            const status = getWorkflowStatus(suiteIndex, setIndex, type);
            return status.awaitingRole;
        }

        function getRoleFileLinkStatus(suiteIndex, setIndex, role, type = 'tgs') {
            const roleNameForId = role === 'admin-intermediate' ? 'AdminIntermediate' : role === 'admin-final' ? 'AdminFinal' : role.charAt(0).toUpperCase() + role.slice(1);
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const linkId = `${idPrefix}_tgsFileLink${roleNameForId}`;
            const fileLinkEl = document.getElementById(linkId);
            const linkProvided = !!fileLinkEl?.value.trim();
            return { linkProvided: linkProvided, linkElement: fileLinkEl };
        }

        function isRoleSignedOff(suiteIndex, setIndex, role, type = 'tgs') {
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const check = document.getElementById(`${idPrefix}_completion_check_${role}`);
            const name = document.getElementById(`${idPrefix}_signoff_name_${role}`);
            const date = document.getElementById(`${idPrefix}_signoff_date_${role}`);
            const tmdNumber = document.getElementById(`${idPrefix}_signoff_tmd_number_tmd`);

            // For overall status display, just check if the completion checkbox, name, and date are filled
            // The action field is not required to show a role as "completed" in status
            const baseCheck = check?.checked && name?.value.trim() && date?.value.trim();

            if (role === 'designer' || role === 'admin-intermediate' || role === 'qa' || role === 'admin-final') {
                return baseCheck;
            }

            if (role === 'tmd') {
                const tmdCheck = baseCheck && tmdNumber?.value.trim();
                return tmdCheck;
            }

            return false;
        }

        function createQuestionBlock(suiteIndex, setIndex, questionText, qIndex, totalQuestions, type = 'tgs') {
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const questionId = `${idPrefix}_q${qIndex}`;
            const blockId = `${questionId}_block`;
            let checksHTML = '', commentsHTML = '', skipButtonHTML = '';

            if (qIndex < totalQuestions) {
                skipButtonHTML = `<button type="button" class="btn btn-secondary skip-btn no-print" data-target-id="${blockId.replace(/_block$/, `_block`)}">Skip to Next</button>`;
            }

            for (const roleKey in roles) {
                checksHTML += `
            <div class="check-item role-${roleKey}" style="flex-direction: column; align-items: flex-start; border-left: 4px solid var(--role-${roleKey}-color); padding: 18px;">
                <span style="font-weight: 600; font-size: 1.05em; margin-bottom: 12px; color: var(--heading-color);">${roles[roleKey].name} Check:</span>
                <div class="site-presence-options" style="width: 100%;">
                    <div class="check-item" style="border: none; padding: 8px 12px; margin: 0; border-radius: 8px; min-width: 70px; justify-content: center;">
                        <input type="radio" class="form-field role-${roleKey}" name="${questionId}_${roleKey}_check" id="${questionId}_${roleKey}_check_yes" value="yes">
                        <label for="${questionId}_${roleKey}_check_yes" style="margin: 0; font-weight: 500;">Yes</label>
                    </div>
                    <div class="check-item" style="border: none; padding: 8px 12px; margin: 0; border-radius: 8px; min-width: 70px; justify-content: center;">
                        <input type="radio" class="form-field role-${roleKey}" name="${questionId}_${roleKey}_check" id="${questionId}_${roleKey}_check_no" value="no">
                        <label for="${questionId}_${roleKey}_check_no" style="margin: 0; font-weight: 500;">No</label>
                    </div>
                    <div class="check-item" style="border: none; padding: 8px 12px; margin: 0; border-radius: 8px; min-width: 70px; justify-content: center;">
                        <input type="radio" class="form-field role-${roleKey}" name="${questionId}_${roleKey}_check" id="${questionId}_${roleKey}_check_na" value="na">
                        <label for="${questionId}_${roleKey}_check_na" style="margin: 0; font-weight: 500;">N/A</label>
                    </div>
                </div>
            </div>`;
            }

            commentsHTML = '<div class="comments-grid">';
            for (const roleKey in roles) {
                commentsHTML += `<div>
                    <label for="${questionId}_${roleKey}_comments">${roles[roleKey].name} Comments:</label>
                    <select class="quick-comment-selector" data-target="${questionId}_${roleKey}_comments" title="Quick comment for ${roles[roleKey].name}" aria-label="Quick comment selection" style="margin-bottom: 8px; font-size: 0.9em;">
                        <option value="">-- Quick Comments --</option>
                        <option value="Compliant with AGTTM Part 3.">Compliant with AGTTM Part 3.</option>
                        <option value="Signage spacing inadequate for speed limit.">Signage spacing inadequate for speed limit.</option>
                        <option value="Missing taper length calculation.">Missing taper length calculation.</option>
                        <option value="Refer to Standard Drawing.">Refer to Standard Drawing.</option>
                        <option value="Please clarify pedestrian management.">Please clarify pedestrian management.</option>
                        <option value="Traffic control measures appear adequate.">Traffic control measures appear adequate.</option>
                        <option value="Requires RPEQ certification.">Requires RPEQ certification.</option>
                        <option value="Plan needs revision - see comments.">Plan needs revision - see comments.</option>
                        <option value="Approved with conditions.">Approved with conditions.</option>
                        <option value="Please provide additional documentation.">Please provide additional documentation.</option>
                    </select>
                    <div class="comment-wrapper" style="position:relative;">
                        <textarea class="form-field role-${roleKey}" id="${questionId}_${roleKey}_comments"></textarea>
                        <button type="button" class="copy-down-btn" title="Copy comment from previous reviewer" aria-label="Copy comment from previous reviewer" style="position:absolute; top:4px; right:4px; width:24px; height:24px; padding:0; border:none; background:var(--secondary-bg); border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center; opacity:0.7; transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z" fill="currentColor"/></svg>
                        </button>
                    </div>
                </div>`;
            }
            commentsHTML += '</div>';

            const sitePresenceHTML = `<div class="site-presence-block">
        <legend>Present at site? (Designer/QA Only)</legend>
        <div class="site-presence-options">
            <div class="check-item"><input type="radio" class="form-field role-designer role-qa site-presence-field" name="${questionId}_present_at_site" id="${questionId}_present_yes" value="yes"><label for="${questionId}_present_yes">Yes</label></div>
            <div class="check-item"><input type="radio" class="form-field role-designer role-qa site-presence-field" name="${questionId}_present_at_site" id="${questionId}_present_no" value="no"><label for="${questionId}_present_no">No</label></div>
            <div class="check-item"><input type="radio" class="form-field role-designer role-qa site-presence-field" name="${questionId}_present_at_site" id="${questionId}_present_na" value="na"><label for="${questionId}_present_na">Not applicable</label></div>
        </div>
    </div>`;

            return `<div class="question-block" id="${blockId}">
                ${skipButtonHTML}
                <p class="question-text">${qIndex}. ${questionText}</p>
                <div class="checks-grid">${checksHTML}</div>
                ${sitePresenceHTML}
                <div class="conflict-placeholder" data-question-id="${questionId}"></div>
                ${commentsHTML}
            </div>`;
        }

        function buildChecklist(suiteIndex, setIndex, type = 'tgs') {
            let checklistHTML = '';
            const totalQuestions = Object.values(checklistData).flat().length;
            let questionIndex = 1;
            const sectionTitles = Object.keys(checklistData);
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;

            // Document Number field
            let numberField = '';
            if (type === 'tmp') {
                const ccVal = (document.getElementById('ccNumber')?.value || '').trim();
                numberField = `<input type="hidden" class="form-field role-designer" id="${idPrefix}_docNo" value="${ccVal}">`;
            } else {
                const labelText = 'Enter TGS Number:';
                const placeholderText = 'e.g., TGS-001 Rev 2';
                numberField = `<div class="question-block">
                            <label>${labelText}</label>
                            <textarea class="form-field role-designer" id="${idPrefix}_docNo" placeholder="${placeholderText}"></textarea>
                        </div>`;
            }
            checklistHTML += numberField;

            // Checklist Instructions
            checklistHTML += `
        <div class="workflow-instruction-box tip no-print" style="margin: 15px 0;">
            <h4 class="instruction-title"> Reviewing the Checklist</h4>
            <p><strong>For each question:</strong> Select Yes, No, or N/A based on your review. Add comments where needed to explain issues or notes.</p>
            <p style="margin-top: 6px;"><strong>Bulk Actions:</strong> Use the buttons below to mark all questions at once, or use section-level bulk checks in each accordion header.</p>
        </div>`;

            // Bulk Check Controls (Moved here)
            const bulkClassPrefix = type === 'tmp' ? 'tmp' : 'tgs';
            const dataSetIndex = type === 'tmp' ? 'tmp' : setIndex;

            checklistHTML += `
        <div class="${bulkClassPrefix}-set-bulk-controls no-print" style="display: flex; justify-content: center; flex-wrap: wrap; gap: 12px; margin: 25px 0 35px; padding: 15px; background: var(--surface-muted); border-radius: 12px;">
            <span class="${bulkClassPrefix}-set-bulk-label" style="width: 100%; text-align: center; margin-bottom: 5px; font-weight: 600; color: var(--text-secondary);">Bulk Check All Questions</span>
            <button type="button" class="btn btn-sm btn-success ${bulkClassPrefix}-set-bulk-btn" data-suite-index="${suiteIndex}" data-set-index="${dataSetIndex}" data-type="${type}" data-action="yes" style="min-width: 100px;">All Yes</button>
            <button type="button" class="btn btn-sm btn-danger ${bulkClassPrefix}-set-bulk-btn" data-suite-index="${suiteIndex}" data-set-index="${dataSetIndex}" data-type="${type}" data-action="no" style="min-width: 100px;">All No</button>
            <button type="button" class="btn btn-sm btn-warning ${bulkClassPrefix}-set-bulk-btn" data-suite-index="${suiteIndex}" data-set-index="${dataSetIndex}" data-type="${type}" data-action="na" style="min-width: 100px;">All N/A</button>
        </div>
    `;

            for (let i = 0; i < sectionTitles.length; i++) {
                const sectionTitle = sectionTitles[i];
                const sectionId = `${idPrefix}_${sectionTitle.replace(/[^a-z0-9]/gi, '').toLowerCase()}`;
                let contentHTML = '';

                checklistData[sectionTitle].forEach(question => {
                    contentHTML += createQuestionBlock(suiteIndex, setIndex, question, questionIndex, totalQuestions, type);
                    questionIndex++;
                });

                let targetSectionId = '';
                let buttonText = 'Skip Section';
                if (i < sectionTitles.length - 1) {
                    const nextSectionTitle = sectionTitles[i + 1];
                    targetSectionId = `${idPrefix}_${nextSectionTitle.replace(/[^a-z0-9]/gi, '').toLowerCase()}`;
                } else {
                    targetSectionId = `${idPrefix}_signoff`;
                    buttonText = 'Skip to Sign-Off';
                }

                const checkAllControls = `
            <div class="check-all-controls no-print">
                <span class="check-all-label">Bulk Check:</span>
                <button type="button" class="btn btn-sm btn-success check-all-btn" data-action="yes">All Yes</button>
                <button type="button" class="btn btn-sm btn-danger check-all-btn" data-action="no">All No</button>
                <button type="button" class="btn btn-sm btn-warning check-all-btn" data-action="na">All N/A</button>
            </div>
        `;

                checklistHTML += `<section class="accordion-section" id="${sectionId}" data-suite-index="${suiteIndex}" data-set-index="${setIndex}" data-type="${type}" data-section-id="${sectionId}" data-section-title="${sectionTitle}" aria-label="${sectionTitle}">
            <div class="accordion-header">
                <div class="accordion-header-text">${sectionTitle}</div>
                <div class="accordion-header-actions">
                    ${checkAllControls}
                    <button type="button" class="btn btn-secondary skip-section-btn no-print" data-target-section-id="${targetSectionId}">${buttonText}</button>
                </div>
            </div>
            <div class="accordion-content">${contentHTML}</div>
        </section>`;
            }

            // Custom Section
            const customSectionId = `${idPrefix}_customsection`;
            const customSectionHTML = `
        <section class="accordion-section" id="${customSectionId}" data-suite-index="${suiteIndex}" data-set-index="${setIndex}" data-type="${type}" data-section-id="${customSectionId}" data-section-title="Custom Section" aria-label="Custom Section">
            <div class="accordion-header">
                <div class="accordion-header-text">Custom Section</div>
            </div>
            <div class="accordion-content">
                <div id="${idPrefix}_custom_list" class="custom-section-list">
                    <div class="custom-section-placeholder" id="${idPrefix}_custom_placeholder" style="text-align: center; padding: 40px; font-style: italic;">
                        Add custom questions using the button below.
                    </div>
                </div>
                <div class="custom-add-button-container" style="text-align: center; margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 16px; border: 2px dashed #0ea5e9;">
                    <button type="button" class="btn btn-primary btn-lg custom-add-question-btn no-print" onclick="addCustomQuestion(${suiteIndex}, '${setIndex}', '${type}')" style="padding: 16px 32px; font-size: 1.1em; font-weight: 600; background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%); border: none; box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25);">
                        <svg style="width: 20px; height: 20px; margin-right: 8px; fill: currentColor;" viewBox="0 0 24 24"><path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
                        Add Custom Question
                    </button>
                </div>
            </div>
        </section>`;

            checklistHTML += customSectionHTML;
            return checklistHTML;
        }

        function buildSignOffSection(suiteIndex, setIndex, type = 'tgs') {
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const sectionId = `${idPrefix}_signoff`;
            let signoffHTML = `<section class="accordion-section" id="${sectionId}" data-section-id="${sectionId}" data-section-title="Sign-Off & Completion" aria-label="Sign-Off & Completion">
        <div class="accordion-header active">Sign-Off & Completion</div>
        <div class="accordion-content" style="display:block;">
            
            <div class="workflow-instruction-box info no-print" style="margin-bottom: 20px;">
                <h4 class="instruction-title"> Sign-Off Process</h4>
                <ol style="margin: 5px 0 0; padding-left: 18px;">
                    <li><strong>Complete your review</strong> of all checklist items above</li>
                    <li><strong>Find your role's section</strong> below (highlighted with your role color)</li>
                    <li><strong>Select an action:</strong> Forward to next reviewer OR Send back if issues found</li>
                    <li><strong>Sign off:</strong> Enter your name, date, and check the completion box</li>
                    <li><strong>Save & notify:</strong> After sign-off, save the progress file and notify the next reviewer</li>
                </ol>
            </div>
            
            <p class="signoff-helper-text">Each user must select an action, check the box, enter their name, and select the date to sign off.</p>`;

            signoffHTML += `<input type="hidden" id="${idPrefix}_historyLog" value="[]">`;
            signoffHTML += `<input type="hidden" class="form-field review-version-field" id="${idPrefix}_reviewVersion" value="1">`;

            const signOffRoles = ['designer', 'admin-intermediate', 'qa', 'tmd', 'admin-final'];

            for (const roleKey of signOffRoles) {
                const roleName = roles[roleKey].name;
                const roleColor = roles[roleKey].color;

                const roleNameForId = roleKey === 'admin-intermediate' ? 'AdminIntermediate' :
                    roleKey === 'admin-final' ? 'AdminFinal' :
                        roleKey.charAt(0).toUpperCase() + roleKey.slice(1);
                const linkId = `${idPrefix}_tgsFileLink${roleNameForId}`;

                const roleSectionTitle = `
            <div class="role-signoff-title" style="text-align: center; margin: 40px 0 25px 0; padding: 20px; background: linear-gradient(135deg, ${roleColor}15 0%, ${roleColor}08 100%); border-radius: 16px; border: 2px solid ${roleColor}25;">
                <h3 style="margin: 0; font-size: 1.5em; font-weight: 700; color: ${roleColor}; text-transform: uppercase;">${roleName} Sign-Off</h3>
            </div>`;

                const linkBlockHTML = `<div class="file-link-block-signoff">
            <label for="${linkId}" style="color: ${roleColor}; font-size: 1em; font-weight: 700;">${roleName}'s Document Link (Optional):</label>
            <input type="text" class="form-field role-${roleKey} link-field" id="${linkId}" placeholder="${roleName}'s shareable link (e.g., SharePoint, Google Drive)">
            <div class="link-preview" id="${linkId}_preview"></div>
        </div>`;

                let decisionBlockHTML = `<div class="decision-block role-${roleKey}" id="${idPrefix}_${roleKey}_decision_block">
            <input type="hidden" class="form-field signoff-field role-${roleKey}" id="${idPrefix}_${roleKey}_action" value="">
            <label><b>${roleName} Action:</b></label>
            <div class="decision-options">`;

                if (roleKey === 'designer') {
                    decisionBlockHTML += `
                <div class="check-item forward"><input type="radio" class="form-field role-designer decision-radio" name="${idPrefix}_designer_decision" value="pass_admin_intermediate"><label>Forward to Admin Intermediate</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-designer decision-radio" name="${idPrefix}_designer_decision" value="pass_qa"><label>Forward to QA</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-designer decision-radio" name="${idPrefix}_designer_decision" value="pass_tmd"><label>Forward to TMD</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-designer decision-radio" name="${idPrefix}_designer_decision" value="pass_admin_final"><label>Forward to Admin Final</label></div>`;
                } else if (roleKey === 'admin-intermediate') {
                    decisionBlockHTML += `
                <div class="check-item backward"><input type="radio" class="form-field role-admin-intermediate decision-radio" name="${idPrefix}_admin-intermediate_decision" value="send_back_designer"><label>Send back to Designer</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-admin-intermediate decision-radio" name="${idPrefix}_admin-intermediate_decision" value="pass_qa"><label>Forward to QA</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-admin-intermediate decision-radio" name="${idPrefix}_admin-intermediate_decision" value="pass_tmd"><label>Forward to TMD</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-admin-intermediate decision-radio" name="${idPrefix}_admin-intermediate_decision" value="pass_admin_final"><label>Forward to Admin Final</label></div>`;
                } else if (roleKey === 'qa') {
                    decisionBlockHTML += `
                <div class="check-item backward"><input type="radio" class="form-field role-qa decision-radio" name="${idPrefix}_qa_decision" value="send_back_designer"><label>Send back to Designer</label></div>
                <div class="check-item backward"><input type="radio" class="form-field role-qa decision-radio" name="${idPrefix}_qa_decision" value="send_back_admin_intermediate"><label>Send back to Admin Intermediate</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-qa decision-radio" name="${idPrefix}_qa_decision" value="pass_tmd"><label>Forward to TMD</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-qa decision-radio" name="${idPrefix}_qa_decision" value="pass_admin_final"><label>Forward to Admin Final</label></div>`;
                } else if (roleKey === 'tmd') {
                    decisionBlockHTML += `
                <div class="check-item backward"><input type="radio" class="form-field role-tmd decision-radio" name="${idPrefix}_tmd_decision" value="send_back_designer"><label>Send back to Designer</label></div>
                <div class="check-item backward"><input type="radio" class="form-field role-tmd decision-radio" name="${idPrefix}_tmd_decision" value="send_back_admin_intermediate"><label>Send back to Admin Intermediate</label></div>
                <div class="check-item backward"><input type="radio" class="form-field role-tmd decision-radio" name="${idPrefix}_tmd_decision" value="send_back_qa"><label>Send back to QA</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-tmd decision-radio" name="${idPrefix}_tmd_decision" value="pass_admin_final"><label>Forward to Admin Final</label></div>`;
                } else if (roleKey === 'admin-final') {
                    decisionBlockHTML += `
                <div class="check-item backward"><input type="radio" class="form-field role-admin-final decision-radio" name="${idPrefix}_admin-final_decision" value="send_back_designer"><label>Send back to Designer</label></div>
                <div class="check-item backward"><input type="radio" class="form-field role-admin-final decision-radio" name="${idPrefix}_admin-final_decision" value="send_back_admin_intermediate"><label>Send back to Admin Intermediate</label></div>
                <div class="check-item backward"><input type="radio" class="form-field role-admin-final decision-radio" name="${idPrefix}_admin-final_decision" value="send_back_tmd"><label>Send back to TMD</label></div>
                <div class="check-item forward"><input type="radio" class="form-field role-admin-final decision-radio" name="${idPrefix}_admin-final_decision" value="finalize"><label>Finalize Document</label></div>`;
                }
                decisionBlockHTML += `</div></div>`;

                const signoffFieldsId = `${idPrefix}_${roleKey}_signoff_fields`;
                const isTmdClass = roleKey === 'tmd' ? 'is-tmd-signoff' : '';
                const tmdNumberField = roleKey === 'tmd' ? `
            <div>
                <label for="${idPrefix}_signoff_tmd_number_tmd">TMD Number:</label>
                <input type="text" class="form-field signoff-field role-tmd" data-validate-type="tmdNumber" id="${idPrefix}_signoff_tmd_number_tmd">
            </div>` : '';

                const signoffFieldsHTML = `
            <div id="${signoffFieldsId}" class="signoff-block ${isTmdClass}" style="display:none;">
                <div>
                    <label for="${idPrefix}_signoff_name_${roleKey}">Name:</label>
                    <input type="text" class="form-field signoff-field role-${roleKey}" id="${idPrefix}_signoff_name_${roleKey}">
                </div>
                <div>
                    <label for="${idPrefix}_signoff_date_${roleKey}">Date:</label>
                    <input type="date" class="form-field signoff-field role-${roleKey}" id="${idPrefix}_signoff_date_${roleKey}">
                </div>
                ${tmdNumberField}
                <div class="check-item">
                    <input type="checkbox" class="form-field signoff-field role-${roleKey}" id="${idPrefix}_completion_check_${roleKey}">
                    <label for="${idPrefix}_completion_check_${roleKey}"><b>I, the ${roleName}, have completed my review.</b></label>
                </div>
            </div>`;

                signoffHTML += `<div class="signoff-block-wrapper role-${roleKey}" data-role="${roleKey}">
            ${roleSectionTitle}
            ${linkBlockHTML}
            ${decisionBlockHTML}
            ${signoffFieldsHTML}
        </div>`;
            }
            signoffHTML += `</div></section>`;
            return signoffHTML;
        }


        function getHistoryLog(suiteIndex, setIndex, type = 'tgs') {
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const logEl = document.getElementById(`${idPrefix}_historyLog`);
            if (!logEl) return [];
            try {
                return JSON.parse(logEl.value);
            } catch (e) {
                return [];
            }
        }

        function updateHistoryLog(suiteIndex, setIndex, entry, type = 'tgs') {
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const logEl = document.getElementById(`${idPrefix}_historyLog`);
            if (!logEl) return;
            const log = getHistoryLog(suiteIndex, setIndex, type);
            const dateStr = new Date().toISOString().slice(0, 10);
            log.push({ date: dateStr, message: entry });
            logEl.value = JSON.stringify(log);
            debouncedSaveState();
        }

        function resetConflictCheckboxes(suiteIndex, setIndex, roleToReset, type = 'tgs') {
            const containerSelector = type === 'tmp' 
                ? `.tmp-set-container[data-suite-index="${suiteIndex}"]` 
                : `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`;
            
            // Clear flags FOR the role being reset (i.e., flags targeting them)
            const roleIdSuffix = roleToReset.replace(/-/g, '_');
            const selector = `${containerSelector} input[id$="_conflict_${roleIdSuffix}"]`;
            
            document.querySelectorAll(selector).forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            });
        }

        function clearRoleSignoffFields(idPrefix, roleKey) {
            const checkEl = document.getElementById(`${idPrefix}_completion_check_${roleKey}`);
            if (checkEl) checkEl.checked = false;

            const nameEl = document.getElementById(`${idPrefix}_signoff_name_${roleKey}`);
            if (nameEl) nameEl.value = '';

            const dateEl = document.getElementById(`${idPrefix}_signoff_date_${roleKey}`);
            if (dateEl) dateEl.value = '';

            const actionField = document.getElementById(`${idPrefix}_${roleKey}_action`);
            if (actionField) actionField.value = '';

            const decisionName = `${idPrefix}_${roleKey}_decision`;
            document.querySelectorAll(`input[name="${decisionName}"]`).forEach(radio => { radio.checked = false; });

            if (roleKey === 'tmd') {
                const tmdNumEl = document.getElementById(`${idPrefix}_signoff_tmd_number_tmd`);
                if (tmdNumEl) tmdNumEl.value = '';
            }

            const signoffFields = document.getElementById(`${idPrefix}_${roleKey}_signoff_fields`);
            if (signoffFields) signoffFields.style.display = 'none';
        }

        function handleDecision(event) {
            const radio = event.target;
            const match = radio.name.match(/suite(\d+)_((?:tmp)|(?:set\d+))_([\w-]+)_decision/);
            if (!match) return;
            const suiteIndex = match[1];
            const setIdentifier = match[2];
            const roleKey = match[3];
            const action = radio.value;

            const type = setIdentifier === 'tmp' ? 'tmp' : 'tgs';
            const setIndex = type === 'tgs' ? setIdentifier.replace('set', '') : 'tmp';

            const idPrefix = `suite${suiteIndex}_${setIdentifier}`;
            const actionField = document.getElementById(`${idPrefix}_${roleKey}_action`);
            const signoffFields = document.getElementById(`${idPrefix}_${roleKey}_signoff_fields`);

            actionField.value = action;
            if (signoffFields) signoffFields.style.display = 'grid';

            const setContainer = radio.closest('.tmp-set-container, .tgs-set-container');

            const getFlaggedItems = () => {
    // Check if ANY flag is checked in this container targeting the role being sent back to
    const targetRole = action.replace('send_back_', '').replace(/_/g, '-');
    const roleIdSuffix = targetRole.replace(/-/g, '_');
    const flagsForTarget = setContainer.querySelectorAll(`input[id$="_conflict_${roleIdSuffix}"]:checked`);
    
    if (flagsForTarget.length === 0) {
        if (!confirm(`You are sending this back to ${roles[targetRole]?.name || 'previous user'} but haven't flagged any specific questions for them.\n\nThey won't know which items need attention.\n\nProceed anyway?`)) {
            radio.checked = false;
            actionField.value = '';
            if (signoffFields) signoffFields.style.display = 'none';
            return false;
        }
    }
    return true;
};

            if (action.startsWith('send_back_')) {
                const targetRole = action.replace('send_back_', '').replace(/_/g, '-');

                // Only run validation and side effects if this is a user interaction
                // AND the current user is the one assigned to this role
                const currentRole = document.getElementById('role').value;
                if (event.isTrusted && currentRole === roleKey) {
                    if (!getFlaggedItems()) return;

                    updateHistoryLog(suiteIndex, setIndex, `${roles[roleKey].name} sent back to ${roles[targetRole]?.name || targetRole}.`);

                    clearRoleSignoffFields(idPrefix, targetRole);
                    refreshSignoffLocks();
                    updateFormSetAccess();
                    debouncedUpdateFormSetAccess.cancel(); // Cancel pending debounced call since we just did immediate

                    // INCREMENT VERSION
                    const versionField = document.getElementById(`${idPrefix}_reviewVersion`);
                    if (versionField) {
                        let currentVer = parseInt(versionField.value) || 1;
                        versionField.value = currentVer + 1;
                    }

                    alert(`Review Loop Initiated.\n\nVersion incremented. Please Sign Off and Save to send back to ${roles[targetRole].name}.`);
                }

                if (setContainer) setContainer.classList.add('redesign-required');

            } else {
                if (setContainer) setContainer.classList.remove('redesign-required');
            }

            debouncedSaveState();
            debouncedUpdateFormSetAccess();
            updateConflictCheckboxes();
        }

        function handleCheckAllClick(button) {
            const action = button.dataset.action;
            const currentRole = document.getElementById('role').value;

            if (!currentRole) {
                alert("Please select a role first.");
                return;
            }

            const setContainer = button.closest('.tmp-set-container, .tgs-set-container');
            if (!setContainer) return;

            const accordionSection = button.closest('.accordion-section');
            if (!accordionSection) return;

            const { suiteIndex, setIndex, type } = setContainer.dataset;
            const status = getWorkflowStatus(suiteIndex, setIndex, type);

            // Allow editing if it's the current role's turn, OR if it's designer doing initial setup (even if locked technically)
            const isDesignerSetup = currentRole === 'designer' && !status.isFinalized;

            if (status.awaitingRole !== currentRole && !isDesignerSetup) {
                // Optional: warn user, but usually we allow editing until signed off
            }

            const actionText = action === 'yes' ? 'YES' : action === 'no' ? 'NO' : 'N/A';

            let commonComment = '';
            let applyCommonComment = false;
            const commentPrompt = `Optional: enter a common comment to apply to every item marked '${actionText}' for ${roles[currentRole]?.name || currentRole}. Leave blank to skip.`;
            const commentResponse = prompt(commentPrompt, '');
            if (commentResponse !== null) {
                const trimmed = commentResponse.trim();
                if (trimmed) {
                    commonComment = trimmed;
                    applyCommonComment = true;
                }
            }

            const radioInputs = accordionSection.querySelectorAll(`.accordion-content .form-field.role-${currentRole}[type="radio"]`);
            const groups = new Set(Array.from(radioInputs).map(r => r.name));

            let count = 0;
            const touchedQuestions = new Set();
            groups.forEach(groupName => {
                const radioToSelect = accordionSection.querySelector(`input[name="${groupName}"][value="${action}"]`);
                if (radioToSelect && !radioToSelect.disabled) {
                    radioToSelect.checked = true;
                    radioToSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    count++;
                    touchedQuestions.add(groupName.replace(`_${currentRole}_check`, ''));
                }
            });

            if (applyCommonComment) {
                touchedQuestions.forEach(questionId => {
                    const commentField = accordionSection.querySelector(`#${questionId}_${currentRole}_comments`);
                    if (commentField && !commentField.disabled && !commentField.value.trim()) {
                        commentField.value = commonComment;
                        commentField.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });
            }

            if (count > 0) {
                const commentNote = applyCommonComment ? ' with shared comment' : '';
                showToast(`${count} items marked as ${actionText}${commentNote}`, 'Section Updated');
                debouncedSaveState();
                updateProgressBars(currentRole);
            }
        }

        function handleTgsSetBulkCheck(button) {
            const suiteIndex = button.dataset.suiteIndex;
            const setIndex = button.dataset.setIndex;
            const type = button.dataset.type;
            const action = button.dataset.action;

            const currentRole = document.getElementById('role').value;
            if (!currentRole) {
                alert("Please select a role first.");
                return;
            }

            const containerSelector = type === 'tmp' ? `.tmp-set-container[data-suite-index="${suiteIndex}"]` : `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`;
            const setContainer = document.querySelector(containerSelector);
            if (!setContainer) return;

            const actionText = action === 'yes' ? 'YES' : action === 'no' ? 'NO' : 'N/A';
            if (!confirm(`Mark ALL items in this set as '${actionText}' for ${roles[currentRole]?.name || currentRole}?`)) return;

            let commonComment = '';
            let applyCommonComment = false;
            const commentPrompt = `Optional: enter a common comment to apply to every item marked '${actionText}' for ${roles[currentRole]?.name || currentRole}. Leave blank to skip.`;
            const commentResponse = prompt(commentPrompt, '');
            if (commentResponse !== null) {
                const trimmed = commentResponse.trim();
                if (trimmed) {
                    commonComment = trimmed;
                    applyCommonComment = true;
                }
            }

            let totalQuestionsChecked = 0;
            const touchedQuestions = new Set();

            // Find all radio groups for this role in this container
            const allRadios = setContainer.querySelectorAll(`input[type="radio"].role-${currentRole}`);
            const uniqueGroups = new Set();

            allRadios.forEach(radio => {
                // Filter for the specific "Yes/No/NA" checks, ignoring decision radios/site presence
                if (radio.name.includes(`_${currentRole}_check`)) {
                    uniqueGroups.add(radio.name);
                }
            });

            uniqueGroups.forEach(groupName => {
                const radioToSelect = setContainer.querySelector(`input[name="${groupName}"][value="${action}"]`);
                if (radioToSelect && !radioToSelect.disabled) {
                    radioToSelect.checked = true;
                    radioToSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    totalQuestionsChecked++;
                    touchedQuestions.add(groupName.replace(`_${currentRole}_check`, ''));
                }
            });

            // Handle Site Presence separately if applicable
            if (currentRole === 'designer' || currentRole === 'qa') {
                setContainer.querySelectorAll(`.site-presence-field[value="${action}"]`).forEach(radio => {
                    if (!radio.disabled) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
            }

            if (applyCommonComment) {
                touchedQuestions.forEach(questionId => {
                    const commentField = setContainer.querySelector(`#${questionId}_${currentRole}_comments`);
                    if (commentField && !commentField.disabled && !commentField.value.trim()) {
                        commentField.value = commonComment;
                        commentField.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });
            }

            const commentNote = applyCommonComment ? ' with shared comment' : '';
            showToast(`${totalQuestionsChecked} questions marked as '${actionText}'${commentNote}`, 'Bulk Check Complete');
            debouncedSaveState();
            updateProgressBars(currentRole);
        }

        function setupGlobalDelegation() {
            // Remove existing listener if any (to prevent duplicates on reload)
            if (window.globalDelegationHandler) {
                document.body.removeEventListener('click', window.globalDelegationHandler);
            }

            window.globalDelegationHandler = function (event) {
                // Helper to find target whether clicked on button or icon inside
                const target = event.target.closest('button');
                if (!target) return;

                // Handle "Check All" (Section Level)
                if (target.classList.contains('check-all-btn')) {
                    event.preventDefault();
                    event.stopPropagation();
                    handleCheckAllClick(target);
                }

                // Handle "Bulk Check" (Set Level)
                if (target.classList.contains('tgs-set-bulk-btn') || target.classList.contains('tmp-set-bulk-btn')) {
                    event.preventDefault();
                    event.stopPropagation();
                    handleTgsSetBulkCheck(target);
                }

                // Handle "Skip Section"
                if (target.classList.contains('skip-section-btn') || target.classList.contains('skip-btn')) {
                    event.preventDefault();
                    event.stopPropagation();
                    handleSkipClick(target);
                }
            };

            document.body.addEventListener('click', window.globalDelegationHandler);
        }

        function areAllTgsFinalized(suiteIndex) {
            const suiteEl = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
            const tgsSets = suiteEl ? suiteEl.querySelectorAll('.tgs-set-container') : null;
            if (!tgsSets || tgsSets.length === 0) return false;
            for (const set of tgsSets) {
                const status = getWorkflowStatus(set.dataset.suiteIndex, set.dataset.setIndex, 'tgs');
                if (!status.isFinalized) return false;
            }
            return true;
        }

        function updateTMPButtonsState() {
            const currentRole = document.getElementById('role')?.value;

            document.querySelectorAll('.project-suite-container').forEach(suiteEl => {
                const suiteIndex = suiteEl.dataset.suiteIndex;
                const btn = suiteEl.querySelector('.generate-tmp-btn');
                if (!btn) return;

                // Check if TMP is already generated (active)
                const tmpContainer = suiteEl.querySelector('.tmp-checklist');
                const isGenerated = tmpContainer && tmpContainer.innerHTML.trim() !== "";

                // Logic for Button State
                if (currentRole !== 'designer') {
                    // Reviewer Logic: Always allow access to load files
                    btn.disabled = false;
                    btn.innerHTML = isGenerated ? 'Open TMP Section' : 'Initialize TMP Section<br><small>(To Load File)</small>';
                } else {
                    // Designer Logic: Always enable Step 1 (TMP)
                    btn.disabled = false;
                    btn.innerHTML = isGenerated ? 'Open/View TMP Form' : 'Initialize TMP & Unlock TGS';
                }

                // Logic for Status Banner
                const banner = suiteEl.querySelector(`#suite${suiteIndex}_tmp_ready_banner`);
                if (banner) {
                    // Reset classes
                    banner.classList.remove('banner-info', 'banner-success', 'banner-warning');
                    // Reset inline styles that might interfere
                    banner.style.backgroundColor = '';
                    banner.style.color = '';
                    banner.style.border = '';

                    if (!isGenerated) {
                        banner.textContent = 'Step 1: Initialize the Traffic Management Plan to unlock TGS.';
                        banner.classList.add('banner-info');
                    } else {
                        try {
                            const status = getWorkflowStatus(suiteIndex, 'tmp', 'tmp');
                            if (status.isFinalized) {
                                banner.textContent = 'TMP Finalized.';
                                banner.classList.add('banner-success');
                            } else {
                                banner.textContent = `TMP In Progress. Waiting for: ${status.awaitingName}`;
                                banner.classList.add('banner-warning');
                            }
                        } catch (e) {
                            banner.textContent = 'TMP Active';
                            banner.classList.add('banner-success');
                        }
                    }
                }
            });
        }

        function setPillStyle(pill, variant) {
            if (!pill) return;
            if (variant === 'ready') {
                pill.style.backgroundColor = '#e6ffed';
                pill.style.color = '#0b5e2a';
                pill.style.borderColor = '#b7eb8f';
            } else if (variant === 'warning') {
                pill.style.backgroundColor = '#fff7cc';
                pill.style.color = '#7a5d00';
                pill.style.borderColor = '#ffe58f';
            } else if (variant === 'info') {
                pill.style.backgroundColor = '#e6f4ff';
                pill.style.color = '#084298';
                pill.style.borderColor = '#b6e0fe';
            } else if (variant === 'active') {
                pill.style.backgroundColor = '#d4edda';
                pill.style.color = '#155724';
                pill.style.borderColor = '#c3e6cb';
                pill.style.fontWeight = '600';
            } else {
                pill.style.backgroundColor = 'transparent';
                pill.style.color = 'inherit';
                pill.style.borderColor = 'transparent';
            }
        }

        function updateTgsStatusPills() {
            const currentRole = document.getElementById('role')?.value;
            const currentRoleName = (currentRole && roles[currentRole]) ? roles[currentRole].name : null;

            document.querySelectorAll('.tgs-set-container').forEach(container => {
                const suiteIndex = container.dataset.suiteIndex;
                const setIndex = container.dataset.setIndex;
                const status = getWorkflowStatus(suiteIndex, setIndex, 'tgs');
                const pill = document.getElementById(`suite${suiteIndex}_set${setIndex}_statusPill`);
                const userPill = document.getElementById(`suite${suiteIndex}_set${setIndex}_currentUserPill`);

                if (!pill) return;

                // Update current user pill
                if (userPill && currentRoleName) {
                    userPill.textContent = `You: ${currentRoleName}`;
                    userPill.style.backgroundColor = '#f0f9ff';
                    userPill.style.color = '#1e40af';
                    userPill.style.borderColor = '#bfdbfe';
                    userPill.style.fontWeight = '500';
                    userPill.style.display = 'inline-block';
                } else if (userPill) {
                    userPill.style.display = 'none';
                }

                if (status.isFinalized) {
                    pill.textContent = 'Finalized';
                    setPillStyle(pill, 'ready');
                } else if (status.isInReviewLoop) {
                    pill.textContent = 'Review Loop';
                    setPillStyle(pill, 'warning');
                } else {
                    // Show both current user and waiting for
                    let pillText = '';
                    if (currentRoleName && currentRole === status.awaitingRole) {
                        pillText = `Current User: ${currentRoleName}`;
                        setPillStyle(pill, 'active');
                    } else {
                        pillText = `Waiting: ${status.awaitingName || ''}`;
                        setPillStyle(pill, 'info');
                    }
                    pill.textContent = pillText;
                }
            });

            // Update TMP pill(s)
            document.querySelectorAll('.tmp-set-container').forEach(container => {
                const suiteIndex = container.dataset.suiteIndex;
                const setIndex = 'tmp';
                const status = getWorkflowStatus(suiteIndex, setIndex, 'tmp');
                const pill = document.getElementById(`suite${suiteIndex}_tmp_statusPill`);
                const userPill = document.getElementById(`suite${suiteIndex}_tmp_currentUserPill`);

                if (!pill) return;

                // Update current user pill
                if (userPill && currentRoleName) {
                    userPill.textContent = `You: ${currentRoleName}`;
                    userPill.style.backgroundColor = '#fef3c7';
                    userPill.style.color = '#92400e';
                    userPill.style.borderColor = '#fde68a';
                    userPill.style.fontWeight = '500';
                    userPill.style.display = 'inline-block';
                } else if (userPill) {
                    userPill.style.display = 'none';
                }

                if (status.isFinalized) {
                    pill.textContent = 'Finalized';
                    setPillStyle(pill, 'ready');
                } else if (status.isInReviewLoop) {
                    pill.textContent = 'Review Loop';
                    setPillStyle(pill, 'warning');
                } else {
                    // Show both current user and waiting for
                    let pillText = '';
                    if (currentRoleName && currentRole === status.awaitingRole) {
                        pillText = `Current User: ${currentRoleName}`;
                        setPillStyle(pill, 'active');
                    } else {
                        pillText = `Waiting: ${status.awaitingName || ''}`;
                        setPillStyle(pill, 'info');
                    }
                    pill.textContent = pillText;
                }
            });
        }

        // NOTE: generateFormSets is defined at the end of the file using lazy-loading

        function setupAccordions() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                if (!header.dataset.listenerAttached) {
                    header.addEventListener('click', toggleAccordion);
                    header.dataset.listenerAttached = 'true';
                }
            });
        }

        function toggleAccordion(event) {
            if (event.target.closest('.accordion-header-actions')) return;
            const header = event.currentTarget;
            const container = header.closest('.tmp-set-container, .tgs-set-container');

            if (!container || !container.classList.contains('locked-set') || header.closest('[data-section-id="projectdetails"]')) {
                header.classList.toggle('active');
                const content = header.nextElementSibling;
                content.style.display = content.style.display === 'block' ? 'none' : 'block';
            } else {
                alert(container.dataset.lockMessage);
            }
        }

        function setupSkipButtons() {
            document.querySelectorAll('.skip-btn, .skip-section-btn').forEach(btn => {
                btn.removeEventListener('click', handleSkipClick);
                btn.addEventListener('click', handleSkipClick);
            });
        }

        function handleSkipClick(button) {
            const targetId = button.dataset.targetId || button.dataset.targetSectionId;
            const targetEl = document.getElementById(targetId);

            if (targetEl) {
                const header = targetEl.querySelector('.accordion-header');
                if (header) {
                    if (!header.classList.contains('active')) {
                        header.click();
                    }
                    header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function setupAllEventListeners() {
            setupAccordions();
            setupSignoffListeners();
            setupLinkPreviews();
            setupGlobalDelegation();
            
            // Use event delegation to reduce listener count
            const form = document.getElementById('tgs-form');
            if (form && !form.dataset.delegatedListeners) {
                form.dataset.delegatedListeners = 'true';
                
                // Delegate input events for auto-save
                form.addEventListener('input', (e) => {
                    if (e.target.classList.contains('form-field')) {
                        debouncedSaveState();
                    }
                }, { passive: true });
                
                // ROLE PROTECTION: Prevent editing fields that don't belong to current role
                form.addEventListener('focus', (e) => {
                    const field = e.target;
                    if (!field.classList.contains('form-field')) return;
                    if (window._isLoadingFromFile) return;
                    
                    const currentRole = document.getElementById('role')?.value;
                    if (!currentRole) return;
                    
                    // Check if field belongs to current role
                    const fieldRoles = Array.from(field.classList).filter(c => c.startsWith('role-'));
                    const belongsToCurrentRole = fieldRoles.some(c => c === `role-${currentRole}`);
                    
                    if (!belongsToCurrentRole && fieldRoles.length > 0) {
                        // This field belongs to another role - prevent editing
                        field.blur();
                        const targetRole = fieldRoles[0]?.replace('role-', '') || 'another user';
                        const roleName = roles[targetRole]?.name || targetRole;
                        showToast(`This field belongs to ${roleName}. You cannot edit other users' inputs.`, 'Access Denied', 'warning');
                    }
                }, true); // Use capture phase
                
                // Also prevent changes via the change event
                form.addEventListener('change', (e) => {
                    const field = e.target;
                    if (!field.classList.contains('form-field')) return;
                    if (window._isLoadingFromFile) return;
                    
                    const currentRole = document.getElementById('role')?.value;
                    if (!currentRole) return;
                    
                    const fieldRoles = Array.from(field.classList).filter(c => c.startsWith('role-'));
                    const belongsToCurrentRole = fieldRoles.some(c => c === `role-${currentRole}`);
                    
                    if (!belongsToCurrentRole && fieldRoles.length > 0 && !field.classList.contains('conflict-check-field')) {
                        // Revert the change - field should be disabled but as a backup
                        e.preventDefault();
                        e.stopPropagation();
                        // Re-run updateFormSetAccess to ensure fields are properly disabled
                        updateFormSetAccess();
                    }
                }, true);
            }

            // TGS Load/Save Buttons
            document.querySelectorAll('.section-save-btn[data-type="tgs"]').forEach(btn => {
                if (btn.dataset.listenerAttached) return;
                btn.addEventListener('click', (e) => {
                    const { suiteIndex, setIndex } = e.currentTarget.dataset;
                    exportSectionToFile(suiteIndex, setIndex, 'tgs').catch(err => {
                        if (err?.name === 'AbortError') return;
                        console.error('Section export failed:', err);
                        showToast('Unable to save section. Please try again.', 'Save failed', 'error');
                    });
                });
                btn.dataset.listenerAttached = 'true';
            });

            document.querySelectorAll('.section-load-btn[data-type="tgs"]').forEach(btn => {
                if (btn.dataset.listenerAttached) return;
                btn.addEventListener('click', (e) => {
                    importSectionFromFile(e.currentTarget.dataset.suiteIndex, e.currentTarget.dataset.setIndex, 'tgs');
                });
                btn.dataset.listenerAttached = 'true';
            });

            updateSignoffFocus();
            updateConflictCheckboxes();
            updateSuiteHeaders();
            refreshSignoffLocks();
            document.querySelectorAll('.tmp-set-container, .tgs-set-container').forEach(registerLazySection);
            attachValidationRules();
            scheduleSectionNavigatorRefresh();
            if (typeof refreshMiniMap === 'function') refreshMiniMap();
        }

        function showToast(message, title = 'Progress saved', variant = 'success') {
            const container = document.querySelector('.toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast toast-${variant}`;
            toast.innerHTML = `
        <div class="toast-icon">${variant === 'error' ? '' : ''}</div>
        <div class="toast-content">
            <strong>${title}</strong>
            <span>${message}</span>
        </div>
        <button class="toast-close" aria-label="Close"></button>`;
            const closeToast = () => {
                toast.style.animation = 'toastExit 0.25s forwards';
                setTimeout(() => toast.remove(), 250);
            };
            toast.querySelector('.toast-close').addEventListener('click', closeToast);
            container.appendChild(toast);
            setTimeout(closeToast, 5000);
        }

        function isSignoffReady(suiteIndex, setIndex, type, roleKey) {
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const nameField = document.getElementById(`${idPrefix}_signoff_name_${roleKey}`);
            const dateField = document.getElementById(`${idPrefix}_signoff_date_${roleKey}`);
            const actionField = document.getElementById(`${idPrefix}_${roleKey}_action`);
            let ready = !!(nameField?.value.trim() && dateField?.value.trim() && actionField?.value);
            if (roleKey === 'tmd') {
                const tmdNumber = document.getElementById(`${idPrefix}_signoff_tmd_number_tmd`);
                ready = ready && !!tmdNumber?.value.trim();
            }
            return ready;
        }


        function handleSignOffCompletion(event) {
            // Don't auto-export if we're loading from a file
            if (window._isLoadingFromFile) return;
            
            const dateField = event.currentTarget;
            const wrapper = dateField.closest('.signoff-block-wrapper');
            if (!wrapper) return;

            const roleKey = wrapper.dataset.role;
            const container = wrapper.closest('.tmp-set-container, .tgs-set-container');
            const suiteIndex = container.dataset.suiteIndex;
            const setIndex = container.dataset.setIndex;
            const type = container.dataset.type;

            if (!dateField.value.trim()) return;

            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const nameField = document.getElementById(`${idPrefix}_signoff_name_${roleKey}`);
            const actionField = document.getElementById(`${idPrefix}_${roleKey}_action`);

            let allFieldsComplete = nameField?.value.trim() && dateField?.value.trim() && actionField?.value;

            if (roleKey === 'tmd') {
                const tmdNumber = document.getElementById(`${idPrefix}_signoff_tmd_number_tmd`);
                allFieldsComplete = allFieldsComplete && tmdNumber?.value.trim();
            }

            if (!allFieldsComplete) {
                return;
            }

            const completionCheckbox = document.getElementById(`${idPrefix}_completion_check_${roleKey}`);

            setTimeout(async () => {
                const docNo = document.getElementById(`${idPrefix}_docNo`)?.value || (type === 'tmp' ? 'TMP' : `TGS Set ${parseInt(setIndex, 10) + 1}`);
                const roleName = roles[roleKey]?.name || 'Current User';
                const actionValue = actionField?.value || '';

                let nextRoleName = null;
                let message = ` ${roleName} review complete for ${docNo}!`;

                if (actionValue === 'finalize') {
                    nextRoleName = 'Final Archive';
                    message = ` You have finalized ${docNo}! The review is complete.`;
                } else if (actionValue) {
                    if (actionValue.startsWith('pass_')) {
                        const targetKey = actionValue.replace('pass_', '').replace(/_/g, '-');
                        nextRoleName = roles[targetKey]?.name || 'Next Reviewer';
                    } else if (actionValue.startsWith('send_back_')) {
                        const targetKey = actionValue.replace('send_back_', '').replace(/_/g, '-');
                        nextRoleName = roles[targetKey]?.name || 'Next Reviewer';
                    } else {
                        nextRoleName = 'Next Reviewer';
                    }

                    if (nextRoleName) {
                        message += `\nThe form will now be passed to: ${nextRoleName}.`;
                    }
                }

                message += `\n\n The save file dialog will now open automatically.`;

                alert(message);

                try {
                    await exportProgressToFile({ suiteIndex, setIndex, type });

                    if (completionCheckbox) {
                        completionCheckbox.checked = true;
                        completionCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
                    }

                    const toastMessage = nextRoleName
                        ? `${docNo} is saved. Notify ${nextRoleName} with the file.`
                        : `${docNo} is saved.`;
                    showToast(toastMessage, 'File saved');

                    refreshSignoffLocks();
                    updateSignoffStatusTracker();
                    updateTgsStatusPills();
                    updateGlobalNotifyButton();
                    const activeRole = document.getElementById('role')?.value;
                    if (activeRole) updateProgressBars(activeRole);
                    debouncedSaveState();

                } catch (err) {
                    if (completionCheckbox) {
                        completionCheckbox.checked = false;
                        completionCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
                    }

                    if (err.name !== 'AbortError') {
                        console.error(err);
                        showToast('Saving was interrupted. Please try saving again.', 'Save failed', 'error');
                    }

                    refreshSignoffLocks();
                    updateSignoffStatusTracker();
                    updateTgsStatusPills();
                    updateGlobalNotifyButton();
                    const activeRole = document.getElementById('role')?.value;
                    if (activeRole) updateProgressBars(activeRole);
                    debouncedSaveState();
                }
            }, 100);
        }
async function handleSignOffClick(event) {
    const checkbox = event.target;
    const wrapper = checkbox.closest('.signoff-block-wrapper');
    
    if (!wrapper) return;

    if (window._isLoadingFromFile) {
        refreshSignoffLocks();
        return;
    }

    // CASE 1: User is unchecking the box (Unlocking)
    if (!checkbox.checked) {
        // Allow unchecking immediately to unlock
        refreshSignoffLocks(); 
        debouncedSaveState();
        return;
    }

    // CASE 2: User is checking the box (Attempting Sign Off)
    
    // 1. Gather Context
    const roleKey = wrapper.dataset.role;
    const container = wrapper.closest('.tmp-set-container, .tgs-set-container');
    if (!container) {
        checkbox.checked = false;
        alert('Error: Could not find the section container. Please try again.');
        return;
    }

    const suiteIndex = container.dataset.suiteIndex;
    const setIndex = container.dataset.setIndex;
    const type = container.dataset.type || 'tgs';
    
    const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;

    // 2. Validate ALL Required Fields
    const nameField = document.getElementById(`${idPrefix}_signoff_name_${roleKey}`);
    const dateField = document.getElementById(`${idPrefix}_signoff_date_${roleKey}`);
    const actionField = document.getElementById(`${idPrefix}_${roleKey}_action`);
    const tmdNumberField = roleKey === 'tmd' ? document.getElementById(`${idPrefix}_signoff_tmd_number_tmd`) : null;

    // Check name
    if (!nameField || !nameField.value.trim()) {
        checkbox.checked = false;
        event.stopImmediatePropagation();
        alert(`Please enter ${roles[roleKey].name}'s Name before signing off.`);
        nameField?.focus();
        return;
    }

    // Check date
    if (!dateField || !dateField.value.trim()) {
        checkbox.checked = false;
        event.stopImmediatePropagation();
        alert(`Please select the Date before signing off.`);
        dateField?.focus();
        return;
    }

    // Check action
    if (!actionField || !actionField.value) {
        checkbox.checked = false;
        event.stopImmediatePropagation();
        alert(`Please select an Action (Approve, Send Back, or Finalize) before signing off.`);
        actionField?.focus();
        return;
    }

    // Check TMD Number if TMD role
    if (roleKey === 'tmd' && tmdNumberField && !tmdNumberField.value.trim()) {
        checkbox.checked = false;
        event.stopImmediatePropagation();
        alert(`TMD Number is required for TMD sign-off.`);
        tmdNumberField.focus();
        return;
    }

    // 3. All validations passed
    // Set a validation lock to prevent re-entry during export
    if (checkbox.dataset.validating === 'true') {
        return; // Already processing, prevent race condition
    }
    
    // Store context for the callbacks
    window._pendingSignoff = {
        checkbox,
        suiteIndex,
        setIndex,
        type,
        idPrefix,
        roleKey
    };
    
    // For TGS sets, ask if this is the last one
    if (type === 'tgs') {
        document.getElementById('last-tgs-confirm-modal').style.display = 'flex';
        ModalFocusTrap.activate('last-tgs-confirm-modal');
    } else if (type === 'tmp') {
        // For TMP, show handover info modal before sign-off (except for Admin Final)
        if (roleKey === 'admin-final') {
            // Admin Final doesn't need to fill handover - they're finalizing
            proceedWithSignoff(false);
        } else {
            showHandoverModal();
        }
    } else {
        // Default: proceed directly
        proceedWithSignoff(false);
    }
}

// Cancel last TGS confirmation
function cancelLastTgsConfirm() {
    document.getElementById('last-tgs-confirm-modal').style.display = 'none';
    ModalFocusTrap.deactivate('last-tgs-confirm-modal');
    if (window._pendingSignoff?.checkbox) {
        window._pendingSignoff.checkbox.checked = false;
    }
    window._pendingSignoff = null;
}

// Handle the "Is this your last TGS?" choice
function handleLastTgsChoice(isLastTgs) {
    document.getElementById('last-tgs-confirm-modal').style.display = 'none';
    ModalFocusTrap.deactivate('last-tgs-confirm-modal');
    
    // For TGS, just record whether it's the last one and proceed
    // Handover info will be collected during TMP sign-off
    if (window._pendingSignoff) {
        window._pendingSignoff.isLastTgs = isLastTgs;
    }
    proceedWithSignoff(false);
}

// Show the handover info modal
function showHandoverModal() {
    const pending = window._pendingSignoff;
    if (!pending) return;
    
    const { idPrefix, roleKey } = pending;
    
    // Pre-populate handover info with current counts
    const totalSuites = document.querySelectorAll('.project-suite-container').length;
    const totalTGS = document.querySelectorAll('.tgs-set-container').length;
    const actionField2 = document.getElementById(`${idPrefix}_${roleKey}_action`);
    let forwardedTo = '';
    
    if (actionField2?.value) {
        if (actionField2.value.startsWith('pass_')) {
            const targetKey = actionField2.value.replace('pass_', '').replace(/_/g, '-');
            forwardedTo = roles[targetKey]?.name || '';
        } else if (actionField2.value.startsWith('send_back_')) {
            const targetKey = actionField2.value.replace('send_back_', '').replace(/_/g, '-');
            forwardedTo = roles[targetKey]?.name + ' (Send Back)' || '';
        } else if (actionField2.value === 'finalize') {
            forwardedTo = 'Final Archive';
        }
    }
    
    document.getElementById('handover-total-suites').value = totalSuites || 1;
    document.getElementById('handover-total-tgs').value = totalTGS || 0;
    
    // Set dropdown value
    const dropdown = document.getElementById('handover-forwarded-to');
    if (dropdown) {
        // Try to match the forwarded to value with an option
        const options = Array.from(dropdown.options);
        const match = options.find(opt => opt.value === forwardedTo || opt.text === forwardedTo);
        if (match) {
            dropdown.value = match.value;
        } else {
            dropdown.value = '';
        }
    }
    
    document.getElementById('handover-notes').value = '';
    
    // Show the handover modal
    document.getElementById('handover-info-modal').style.display = 'flex';
    ModalFocusTrap.activate('handover-info-modal');
}

// Cancel handover info - uncheck the checkbox
function cancelHandoverInfo() {
    document.getElementById('handover-info-modal').style.display = 'none';
    ModalFocusTrap.deactivate('handover-info-modal');
    if (window._pendingSignoff?.checkbox) {
        window._pendingSignoff.checkbox.checked = false;
    }
    window._pendingSignoff = null;
}

// Confirm handover info and proceed with sign-off
function confirmHandoverInfo() {
    document.getElementById('handover-info-modal').style.display = 'none';
    ModalFocusTrap.deactivate('handover-info-modal');
    
    const pending = window._pendingSignoff;
    if (!pending) return;
    
    const { suiteIndex, setIndex, type, roleKey } = pending;
    
    // Collect handover info
    const handoverInfo = {
        totalSuites: parseInt(document.getElementById('handover-total-suites').value, 10) || 0,
        totalTGS: parseInt(document.getElementById('handover-total-tgs').value, 10) || 0,
        forwardedTo: document.getElementById('handover-forwarded-to').value.trim(),
        notes: document.getElementById('handover-notes').value.trim(),
        fromRole: roles[roleKey]?.name || roleKey,
        timestamp: new Date().toISOString()
    };
    
    // Store handover info in a hidden field or data attribute for this section
    const container = document.querySelector(`.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"], .tmp-set-container[data-suite-index="${suiteIndex}"]`);
    if (container) {
        container.dataset.handoverInfo = JSON.stringify(handoverInfo);
    }
    
    // Also store globally so it gets included in export
    if (!window._sectionHandoverInfo) window._sectionHandoverInfo = {};
    const sectionKey = `${suiteIndex}_${type === 'tmp' ? 'tmp' : setIndex}`;
    window._sectionHandoverInfo[sectionKey] = handoverInfo;
    
    // Proceed with sign-off including handover info
    proceedWithSignoff(true);
}

// Common function to proceed with sign-off
async function proceedWithSignoff(includeHandover) {
    const pending = window._pendingSignoff;
    if (!pending) return;
    
    const { checkbox, suiteIndex, setIndex, type, isLastTgs } = pending;
    window._pendingSignoff = null;
    
    try {
        checkbox.dataset.validating = 'true';
        checkbox.disabled = true;
        
        // Save current form state to session storage first
        const formData = getFormDataAsObject();
        sessionStorage.setItem('formState', JSON.stringify(formData));
        
        // Export file to client - this is async and may be cancelled
        await exportProgressToFile({ suiteIndex, setIndex, type });

        // 4. SUCCESS: Save complete
        showToast(' File saved successfully. Sign-off is complete.', 'Success');
        
        // Keep checkbox checked and form accessible
        checkbox.checked = true;
        checkbox.disabled = false;
        delete checkbox.dataset.validating;
        
        // Update all UI tracking
        updateSignoffStatusTracker();
        updateTgsStatusPills();
        updateGlobalNotifyButton();
        debouncedSaveState();
        
        // 5. For TGS: Handle based on whether this is the user's last TGS
        if (type === 'tgs') {
            if (isLastTgs) {
                // User indicated this is their last TGS - scroll to top of page
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    showToast('All TGS sets complete! You can now proceed with other tasks.', 'Complete', 'success');
                }, 500);
            } else {
                // User has more TGS sets to review - prompt for additional sets
                setTimeout(() => {
                    promptForAdditionalTgsSet(suiteIndex, setIndex);
                }, 500); // Small delay to let the success message show
            }
        }

    } catch (error) {
        // 5. CANCEL/FAIL: Handle appropriately
        console.error("Sign-off save error:", error);
        
        // Don't disable the checkbox permanently on error
        checkbox.disabled = false;
        delete checkbox.dataset.validating;
        
        // Check for User Cancellation (AbortError)
        if (error.name === 'AbortError' || error.message.includes('User cancelled')) {
            // User cancelled - Uncheck the box so they can try again
            checkbox.checked = false;
            showToast('Save cancelled. Sign-off not recorded.', 'Cancelled', 'info');
        } else {
            // Actual error - uncheck and show alert
            checkbox.checked = false;
            event.stopImmediatePropagation();
            alert('Save failed due to an error. Please try again.\n\nError: ' + error.message);
        }
    } finally {
        // Always clear validation lock and refresh locks
        delete checkbox.dataset.validating;
        refreshSignoffLocks();
    }
}
        // Keep sign-off dependent widgets and controls in sync on any field change.
        function handleSignoffFieldStateChange(event) {
            const field = event.currentTarget;
            const wrapper = field.closest('.signoff-block-wrapper');
            if (!wrapper) {
                debouncedSaveState();
                return;
            }

            const container = wrapper.closest('.tmp-set-container, .tgs-set-container');
            if (!container) {
                debouncedSaveState();
                return;
            }

            const suiteIndex = container.dataset.suiteIndex;
            const type = container.dataset.type || 'tgs';
            const rawSetIndex = container.dataset.setIndex;
            const normalizedSetIndex = type === 'tmp' ? 'tmp' : rawSetIndex;
            const roleKey = wrapper.dataset.role;

            if (suiteIndex === undefined || normalizedSetIndex === undefined || !roleKey) {
                debouncedSaveState();
                return;
            }

            updateSignoffStatusTracker();
            updateTgsStatusPills();
            updateGlobalNotifyButton();

            const activeRole = document.getElementById('role')?.value;
            if (activeRole) updateProgressBars(activeRole);

            refreshSignoffLocks();
            debouncedSaveState();
        }

        function setupSignoffListeners() {
        // General Input listeners for auto-save - use data attribute to prevent duplicates
        document.querySelectorAll('.form-field').forEach(field => {
            if (field.dataset.saveListenerAttached !== 'true') {
                field.addEventListener('change', debouncedSaveState);
                if (field.tagName.toLowerCase() !== 'select' && field.type !== 'radio' && field.type !== 'checkbox') {
                    field.addEventListener('input', debouncedSaveState);
                }
                field.dataset.saveListenerAttached = 'true';
            }
        });

        // Updates for UI status (pills, trackers) - prevent duplicates
        document.querySelectorAll('.signoff-field, .decision-radio, .link-field, .conflict-check-field').forEach(field => {
            if (field.dataset.statusListenerAttached !== 'true') {
                field.addEventListener('change', debouncedUpdateFormSetAccess);
                field.dataset.statusListenerAttached = 'true';
            }
        });

        document.querySelectorAll('.signoff-field, .decision-radio, .link-field').forEach(field => {
            if (field.dataset.stateListenerAttached !== 'true') {
                field.addEventListener('input', handleSignoffFieldStateChange);
                field.addEventListener('change', handleSignoffFieldStateChange);
                field.dataset.stateListenerAttached = 'true';
            }
        });

        // Decision Radio Logic - prevent duplicates
        document.querySelectorAll('.decision-radio').forEach(radio => {
            if (radio.dataset.decisionListenerAttached !== 'true') {
                radio.addEventListener('change', handleDecision);
                radio.dataset.decisionListenerAttached = 'true';
            }
        });

        // Doc Header Updates - prevent duplicates
        document.querySelectorAll('[id*="_docNo"]').forEach(field => {
            if (field.dataset.docHeaderListenerAttached !== 'true') {
                field.addEventListener('input', updateDocHeader);
                field.dataset.docHeaderListenerAttached = 'true';
            }
        });

        // Show hidden signoff blocks if decision is already made
        document.querySelectorAll('.decision-radio:checked').forEach(radio => {
            const match = radio.name.match(/suite(\d+)_(tmp|set\d+)_([\w-]+)_decision/);
            if (match) {
                const signoffBlock = document.getElementById(`suite${match[1]}_${match[2]}_${match[3]}_signoff_fields`);
                if (signoffBlock) signoffBlock.style.display = 'grid';
            }
        });

            // *** NEW: Main Sign-Off Logic attached to the Checkbox ***
            document.querySelectorAll('input[id*="_completion_check_"]').forEach(checkbox => {
                if (checkbox.dataset.signoffCheckListenerAttached !== 'true') {
                    checkbox.addEventListener('change', handleSignOffClick);
                    checkbox.dataset.signoffCheckListenerAttached = 'true';
                }
            });
        }

        function updateDocHeader(event) {
            const field = event.currentTarget;
            const setContainer = field.closest('.tmp-set-container, .tgs-set-container');
            const header = setContainer.querySelector('.tgs-set-header, .tmp-set-header');

            if (header) {
                const value = field.value.trim();
                const type = setContainer.dataset.type;
                const suiteIndex = parseInt(setContainer.dataset.suiteIndex) + 1;
                const setIndex = parseInt(setContainer.dataset.setIndex) + 1;
                const defaultText = type === 'tmp' ? `TMP Checklist (Suite ${suiteIndex})` : `TGS Set ${setIndex} (Suite ${suiteIndex})`;
                header.textContent = value ? `Details for: ${value}` : defaultText;
            }
        }

        function updateSignoffStatusTracker() {
            const tracker = document.getElementById('signoff-status-tracker');
            if (!tracker) return;

            const checklistItems = document.querySelectorAll('.tmp-set-container, .tgs-set-container');
            if (checklistItems.length === 0) {
                tracker.style.display = 'none';
                return;
            }

            tracker.style.display = 'grid';

            let overallStatus = { awaitingRole: null, allAtSameStage: true };
            if (checklistItems.length > 0) {
                const firstStatus = getWorkflowStatus(checklistItems[0].dataset.suiteIndex, checklistItems[0].dataset.setIndex, checklistItems[0].dataset.type);
                overallStatus.awaitingRole = firstStatus.awaitingRole;
                for (let i = 1; i < checklistItems.length; i++) {
                    const status = getWorkflowStatus(checklistItems[i].dataset.suiteIndex, checklistItems[i].dataset.setIndex, checklistItems[i].dataset.type);
                    if (status.awaitingRole !== overallStatus.awaitingRole) {
                        overallStatus.allAtSameStage = false;
                        break;
                    }
                }
            }

            let statusSummaryHTML = '';
            if (overallStatus.awaitingRole === null) {
                statusSummaryHTML = `<div class="status-item status-summary"><span>All items finalized</span><span class="status-indicator status-complete">Complete</span></div>`;
            } else if (overallStatus.allAtSameStage) {
                const roleInfo = roles[overallStatus.awaitingRole];
                const roleName = roleInfo?.name || 'Unknown';
                const roleColor = roleInfo?.color || 'var(--primary-color)';
                statusSummaryHTML = `<div class="status-item status-summary"><span>Awaiting action from:</span><span class="status-indicator role-chip" style="--role-chip-bg: ${roleColor};">${roleName}</span></div>`;
            } else {
                statusSummaryHTML = `<div class="status-item status-summary"><span>Items are at different review stages.</span></div>`;
            }

            let roleStatusesHTML = '';
            signOffVisualOrder.forEach(roleKey => {
                let completedCount = 0, skippedCount = 0;
                checklistItems.forEach(item => {
                    if (isRoleSignedOff(item.dataset.suiteIndex, item.dataset.setIndex, roleKey, item.dataset.type)) completedCount++;
                    else if (wasRoleSkipped(item.dataset.suiteIndex, item.dataset.setIndex, roleKey, item.dataset.type)) skippedCount++;
                });

                let statusClass = 'status-pending', statusText = 'Pending';
                if (completedCount === checklistItems.length) { statusClass = 'status-complete'; statusText = 'Completed'; }
                else if (skippedCount === checklistItems.length) { statusClass = 'status-skipped'; statusText = 'Skipped'; }
                else if (completedCount > 0 || skippedCount > 0) statusText = `${completedCount + skippedCount}/${checklistItems.length}`;

                roleStatusesHTML += `<div class="status-item"><span>${roles[roleKey].name}</span><span class="status-indicator ${statusClass}">${statusText}</span></div>`;
            });

            tracker.innerHTML = `<h4>Overall Status</h4>` + roleStatusesHTML + statusSummaryHTML;
        }

        function wasRoleSkipped(suiteIndex, setIndex, roleKey, type = 'tgs') {
            // If the role has signed off, they weren't skipped
            if (isRoleSignedOff(suiteIndex, setIndex, roleKey, type)) return false;
            
            const currentIndex = roleOrder.indexOf(roleKey);
            if (currentIndex <= 0) return false;
            
            // Get all signed off roles for reference
            const signedOffRoles = roleOrder.filter(role => isRoleSignedOff(suiteIndex, setIndex, role, type));
            
            // Trace back through all previous roles to find a signed-off role that skipped past this one
            for (let i = currentIndex - 1; i >= 0; i--) {
                const prevRole = roleOrder[i];
                if (signedOffRoles.includes(prevRole)) {
                    // This previous role signed off - check their action
                    const prevRoleActionEl = document.getElementById(`suite${suiteIndex}_${type === 'tmp' ? 'tmp' : 'set' + setIndex}_${prevRole}_action`);
                    if (prevRoleActionEl && prevRoleActionEl.value) {
                        const nextRoleInAction = prevRoleActionEl.value.replace('pass_', '').replace(/_/g, '-');
                        const targetIndex = roleOrder.indexOf(nextRoleInAction);
                        // If action targets a role beyond the current role, this role was skipped
                        if (targetIndex > currentIndex) {
                            return true;
                        }
                        // If action targets exactly the next role after this signed-off one, 
                        // continue checking earlier roles (in case of send-back scenarios)
                        if (targetIndex === i + 1 && targetIndex <= currentIndex) {
                            continue;
                        }
                    }
                }
            }
            
            // Also check if any later role has signed off (indicating this role was skipped)
            for (let i = currentIndex + 1; i < roleOrder.length; i++) {
                if (isRoleSignedOff(suiteIndex, setIndex, roleOrder[i], type)) return true;
            }
            
            return false;
        }

        function updateProgressBars(role) {
            if (!role) return;
            document.querySelectorAll('.tmp-set-container, .tgs-set-container').forEach(container => {
                const suiteIndex = container.dataset.suiteIndex;
                const setIndex = container.dataset.setIndex;
                const type = container.dataset.type;
                const progressBarId = type === 'tmp' ? `suite${suiteIndex}_progress-bar-tmp` : `suite${suiteIndex}_progress-bar-set${setIndex}`;
                const progressBar = document.getElementById(progressBarId);
                if (!progressBar) return;

                const radioButtons = container.querySelectorAll(`.form-field.role-${role}[type="radio"]`);
                const questionGroups = new Set(Array.from(radioButtons).filter(r => r.name.includes(`_${role}_check`)).map(r => r.name));

                const totalItems = questionGroups.size;
                if (totalItems === 0) {
                    progressBar.style.width = '100%';
                    progressBar.textContent = 'N/A';
                    return;
                }

                let completedItems = 0;
                questionGroups.forEach(groupName => {
                    if (container.querySelector(`input[name="${groupName}"]:checked`)) completedItems++;
                });

                const percentage = Math.round((completedItems / totalItems) * 100);
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${percentage}% Complete`;

                // NEW: Update a chart if element exists
                const chart = document.getElementById(`suite${suiteIndex}_chart-set${setIndex}`);
                if (chart) {
                    chart.style.setProperty('--pct', `${percentage}%`);
                    const chartText = chart.querySelector('.chart-text');
                    if (chartText) chartText.textContent = `${percentage}%`;
                }
            });
        }

        function updateGlobalNotifyButton() {
            const currentRole = document.getElementById('role').value;
            const notifyBtn = document.getElementById('global-notify-btn');
            const notifyBtnText = document.getElementById('global-notify-btn-text');

            if (!notifyBtn || !currentRole) {
                if (notifyBtn) notifyBtn.style.display = 'none';
                return;
            }

            const checklistItems = document.querySelectorAll('.tmp-set-container, .tgs-set-container');
            if (checklistItems.length === 0) {
                notifyBtn.style.display = 'none';
                return;
            }

            const firstStatus = getWorkflowStatus(checklistItems[0].dataset.suiteIndex, checklistItems[0].dataset.setIndex, checklistItems[0].dataset.type);
            const nextRoleKey = firstStatus.awaitingRole;

            if (!nextRoleKey || firstStatus.isFinalized) {
                notifyBtn.style.display = 'none';
                return;
            }

            const allReady = Array.from(checklistItems).every(item => {
                const status = getWorkflowStatus(item.dataset.suiteIndex, item.dataset.setIndex, item.dataset.type);
                return isRoleSignedOff(item.dataset.suiteIndex, item.dataset.setIndex, currentRole, item.dataset.type) && status.awaitingRole === nextRoleKey;
            });

            notifyBtnText.textContent = `Notify ${roles[nextRoleKey].name}`;
            notifyBtn.style.display = 'inline-flex';
            notifyBtn.disabled = !allReady;
        }

        function getWorkflowStatus(suiteIndex, setIndex, type = 'tgs') {
            const status = { awaitingRole: 'designer', isFinalized: false, isInReviewLoop: false, lockMessage: '' };
            const signedOffRoles = roleOrder.filter(role => isRoleSignedOff(suiteIndex, setIndex, role, type));

            if (signedOffRoles.length === roleOrder.length) {
                const adminFinalAction = document.getElementById(`suite${suiteIndex}_${type === 'tmp' ? 'tmp' : 'set' + setIndex}_admin-final_action`)?.value;
                if (adminFinalAction === 'finalize') {
                    status.isFinalized = true;
                    status.awaitingRole = null;
                } else {
                    status.awaitingRole = 'admin-final'; // Waiting for finalize action
                }
            } else {
                // Helper: Check if a role was skipped by tracing back through the action chain
                const checkIfRoleWasSkipped = (roleToCheck) => {
                    const roleIndex = roleOrder.indexOf(roleToCheck);
                    if (roleIndex <= 0) return false;
                    
                    // Trace back through all previous roles to find a signed-off role that skipped past this one
                    for (let i = roleIndex - 1; i >= 0; i--) {
                        const prevRole = roleOrder[i];
                        if (signedOffRoles.includes(prevRole)) {
                            // This previous role signed off - check their action
                            const actionEl = document.getElementById(`suite${suiteIndex}_${type === 'tmp' ? 'tmp' : 'set' + setIndex}_${prevRole}_action`);
                            if (actionEl && actionEl.value) {
                                const nextRoleInAction = actionEl.value.replace('pass_', '').replace(/_/g, '-');
                                const targetIndex = roleOrder.indexOf(nextRoleInAction);
                                // If action targets a role at or beyond the role we're checking, it was skipped
                                if (targetIndex > roleIndex) {
                                    return true;
                                }
                                // If action targets exactly the next role after this signed-off one, stop searching
                                if (targetIndex === i + 1) {
                                    return false;
                                }
                            }
                        }
                    }
                    return false;
                };
                
                // Find the first role that hasn't signed off and wasn't skipped
                for (const role of roleOrder) {
                    if (!signedOffRoles.includes(role)) {
                        // Check if this role was skipped using full chain trace
                        if (!checkIfRoleWasSkipped(role)) {
                            status.awaitingRole = role;
                            break;
                        }
                    }
                }
                
                // If all unsigned roles were skipped, we're waiting on admin-final
                if (!signedOffRoles.includes('admin-final')) {
                    const allUnsignedWereSkipped = roleOrder.every(role => 
                        signedOffRoles.includes(role) || checkIfRoleWasSkipped(role)
                    );
                    if (allUnsignedWereSkipped) {
                        status.awaitingRole = 'admin-final';
                    }
                }
            }

            // Check for send-back loops - only consider active send-backs
            // A send-back is active if the issuing role has signed off but the target role has NOT re-signed off
            roleOrder.forEach(role => {
                const actionEl = document.getElementById(`suite${suiteIndex}_${type === 'tmp' ? 'tmp' : 'set' + setIndex}_${role}_action`);
                if (actionEl && actionEl.value.startsWith('send_back_')) {
                    const targetRole = actionEl.value.replace('send_back_', '').replace(/_/g, '-');
                    // Only treat as active send-back if the issuing role signed off AND target hasn't re-signed
                    const issuingRoleSignedOff = signedOffRoles.includes(role);
                    const targetRoleSignedOff = signedOffRoles.includes(targetRole);
                    
                    if (issuingRoleSignedOff && !targetRoleSignedOff) {
                        status.isInReviewLoop = true;
                        status.awaitingRole = targetRole;
                    }
                }
            }); status.awaitingName = status.isFinalized ? 'Finalized' : (roles[status.awaitingRole]?.name || 'Completion');
            status.lockMessage = status.isFinalized ? `LOCKED: Report has been finalized.` : `LOCKED: Waiting for ${status.awaitingName}.`;

            return status;
        }

        // Notify modal + sharing helpers
        function openNotifyModal() {
            const modal = document.getElementById('notify-modal');
            if (!modal) return;
            updateEmailTemplatePreviewFromSelection();
            modal.style.display = 'block';
            ModalFocusTrap.activate('notify-modal');
        }

        function closeNotifyModal() {
            const modal = document.getElementById('notify-modal');
            if (modal) modal.style.display = 'none';
            ModalFocusTrap.deactivate('notify-modal');
        }

        function generateNotificationMessage() {
            const currentRole = document.getElementById('role').value;
            const items = Array.from(document.querySelectorAll('.tmp-set-container, .tgs-set-container'));
            if (!items.length) return { subject: 'Checklist Handoff', body: 'Checklist is ready for review.' };
            const first = items[0];
            const nextRoleKey = getWorkflowStatus(first.dataset.suiteIndex, first.dataset.setIndex, first.dataset.type).awaitingRole;
            const cc = document.getElementById('ccNumber')?.value || '';
            const project = document.getElementById('projectName')?.value || '';
            const counts = {
                tgs: items.filter(i => i.dataset.type === 'tgs').length,
                tmp: items.filter(i => i.dataset.type === 'tmp').length
            };
            const suites = new Set(items.map(i => i.dataset.suiteIndex));
            const subject = `${cc || 'CC-'} ${project}  Ready for ${roles[nextRoleKey]?.name || 'next reviewer'}`;
            const lines = [];
            lines.push(`From: ${roles[currentRole]?.name || currentRole}`);
            lines.push(`To: ${roles[nextRoleKey]?.name || 'Next Reviewer'}`);
            lines.push(`Project: ${project}`);
            lines.push(`CC Number: ${cc}`);
            lines.push(`Suites: ${Array.from(suites).map(s => `#${s}`).join(', ')}`);
            lines.push(`Sections: ${counts.tgs} TGS${counts.tgs === 1 ? '' : ' sets'}${counts.tmp ? `, ${counts.tmp} TMP` : ''}`);
            lines.push(`Notes: Please load the attached .json progress file and continue your review.`);
            const templateText = document.getElementById('email-template-preview')?.value?.trim();
            if (templateText) {
                lines.push('', templateText);
            }
            const body = lines.join('\n');
            return { subject, body };
        }

        function shareViaEmail() {
            const { subject, body } = generateNotificationMessage();
            const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailto;
        }

        async function shareViaTeams() {
            try {
                const { subject, body } = generateNotificationMessage();
                await navigator.clipboard.writeText(`${subject}\n\n${body}`);
                alert('Message copied to clipboard. Paste into Teams to share.');
            } catch (e) {
                alert('Unable to copy to clipboard. Please copy manually.');
            }
        }

        function detectCloudDriveEnvironment() {
            const banner = document.getElementById('cloud-drive-banner');
            if (!banner || banner.dataset.dismissed === 'true') return;
            const href = window.location.href.toLowerCase();
            const isCloud = href.includes('sharepoint') || href.includes('onedrive') || href.includes('google') || href.includes('dropbox');
            banner.classList.toggle('is-visible', isCloud);
            banner.setAttribute('aria-hidden', (!isCloud).toString());

            // Auto-dismiss after 10 seconds
            if (isCloud) {
                setTimeout(() => {
                    dismissCloudDriveBanner();
                }, 10000);
            }
        }

        function dismissCloudDriveBanner() {
            const banner = document.getElementById('cloud-drive-banner');
            if (!banner) return;
            banner.dataset.dismissed = 'true';
            banner.classList.remove('is-visible');
            banner.setAttribute('aria-hidden', 'true');
        }

        // Debounced version to prevent excessive calls
        const debouncedUpdateFormSetAccess = debounce(() => updateFormSetAccess(), 150);
        
        // Check if designer is in re-review mode (sent back from another role)
        function isDesignerInReReviewMode() {
            const containers = document.querySelectorAll('.tgs-set-container, .tmp-set-container');
            for (const container of containers) {
                const suiteIndex = container.dataset.suiteIndex;
                const setIndex = container.dataset.setIndex;
                const type = container.dataset.type || 'tgs';
                const status = getWorkflowStatus(suiteIndex, setIndex, type);
                // Designer is in re-review if workflow is in review loop and awaiting designer
                if (status.isInReviewLoop && status.awaitingRole === 'designer') {
                    return true;
                }
            }
            return false;
        }
        
        function updateFormSetAccess() {
            // Skip updates if we're adding a new set
            if (window._isAddingNewSet) return;
            
            const currentRole = document.getElementById('role').value;

            // Handle Project Details Visibility
            const projectDetailsSection = document.querySelector('[data-section-id="projectdetails"]');
            if (projectDetailsSection) {
                const isDesigner = currentRole === 'designer';
                const header = projectDetailsSection.querySelector('.accordion-header');
                const content = projectDetailsSection.querySelector('.accordion-content');

                if (!isDesigner) {
                    // Collapse by default for non-designers
                    if (header.classList.contains('active')) {
                        header.classList.remove('active');
                        content.style.display = 'none';
                    }
                    // Disable inputs
                    content.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true);
                    header.style.opacity = '0.6';
                    header.title = "Read-only for non-designers";
                } else {
                    // Enable for designer
                    content.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false);
                    header.style.opacity = '1';
                    header.title = "";
                }
            }

            // Handle Suite-Level Details Visibility
            document.querySelectorAll('.project-suite-container').forEach(suite => {
                // The first question block contains the Suite Name
                const suiteNameBlock = suite.querySelector('.question-block');
                if (suiteNameBlock) {
                    const isDesigner = currentRole === 'designer';
                    if (!isDesigner) {
                        suiteNameBlock.style.display = 'none';
                    } else {
                        suiteNameBlock.style.display = 'block';
                        suiteNameBlock.querySelectorAll('input, textarea').forEach(el => el.disabled = false);
                    }
                }
            });

            document.querySelectorAll('.tmp-set-container, .tgs-set-container').forEach(container => {
                const suiteIndex = container.dataset.suiteIndex;
                const setIndex = container.dataset.setIndex;
                const type = container.dataset.type;

                const status = getWorkflowStatus(suiteIndex, setIndex, type);
                let lockMessage = status.lockMessage;

                // Simplified locking logic for workflow flexibility:
                // Only lock if document is finalized OR no role selected
                // Allow all roles to work on sections (they'll load their assigned files)
                let isSetLocked = false;

                if (status.isFinalized) {
                    isSetLocked = true;
                    lockMessage = 'LOCKED: This section has been finalized.';
                } else if (!currentRole) {
                    isSetLocked = true;
                    lockMessage = 'Please select your role to begin working.';
                }
                // Don't lock based on sign-off status - users load their section files as needed

                container.classList.toggle('redesign-required', status.isInReviewLoop);
                const shouldLock = isSetLocked && currentRole;
                container.classList.toggle('locked-set', shouldLock);
                if (shouldLock && currentRole && lockMessage) container.dataset.lockMessage = lockMessage;
                else container.removeAttribute('data-lock-message');

                container.querySelectorAll('.form-field').forEach(field => {
                    const isConflictFlag = field.classList.contains('conflict-check-field');
                    const isSignoffLocked = field.dataset.signoffLocked === 'true';

                    if (isConflictFlag) {
                        field.disabled = isSignoffLocked || shouldLock;
                        field.classList.toggle('field-locked', isSignoffLocked || shouldLock);
                        return;
                    }

                    // Check if this field belongs to the current role
                    const fieldRoles = Array.from(field.classList).filter(c => c.startsWith('role-'));
                    const belongsToCurrentRole = fieldRoles.some(c => c === `role-${currentRole}`);
                    
                    // Field is editable only if it belongs to current role and section isn't locked
                    const isEditable = belongsToCurrentRole && !shouldLock && !isSignoffLocked;
                    field.disabled = !isEditable;
                    field.classList.toggle('field-locked', isSignoffLocked);
                    
                    // Add readonly attribute as backup for textareas (some browsers ignore disabled on textarea)
                    if (field.tagName === 'TEXTAREA') {
                        field.readOnly = !isEditable;
                    }
                });
                
                // Also disable quick-comment-selectors for other roles
                container.querySelectorAll('.quick-comment-selector').forEach(selector => {
                    const targetId = selector.dataset.target;
                    if (targetId) {
                        // Extract role from target ID (e.g., "suite0_set0_q1_designer_comments" -> "designer")
                        const roleMatch = targetId.match(/_([a-z]+(?:-[a-z]+)?)_comments$/);
                        if (roleMatch) {
                            const fieldRole = roleMatch[1];
                            const belongsToCurrentRole = fieldRole === currentRole || 
                                                        fieldRole.replace('-', '_') === currentRole?.replace('-', '_');
                            selector.disabled = shouldLock || !belongsToCurrentRole;
                        }
                    }
                });

                if (!window._isLoadingFromFile) {
                    applyFocusMode(suiteIndex, setIndex, type);
                }
            });

            handlePrintAndFinalizeButtons(currentRole);
            updateSignoffStatusTracker();
            updateProgressBars(currentRole);
            updateGlobalNotifyButton();
            updateTMPButtonsState();
            updateTgsStatusPills();
            refreshSignoffLocks();
            updateLoadButtonsVisibility(currentRole);
        }

        // Hide Load TGS/TMP buttons for designers in new project mode
        function updateLoadButtonsVisibility(currentRole) {
            const isDesignerNewProject = currentRole === 'designer' && !window.dataLoadedFromStorage;
            
            // Use body class for CSS-based hiding (most reliable)
            document.body.classList.toggle('designer-new-project', isDesignerNewProject);
        }

        // Manage visibility and enablement of the print/finalize controls based on role and status
        function handlePrintAndFinalizeButtons(currentRole) {
            const printButtons = document.querySelectorAll('.js-print-draft-btn');
            const finalizeButtons = document.querySelectorAll('.js-finalize-btn');
            const hasAnySections = Boolean(document.querySelector('.tmp-set-container, .tgs-set-container'));

            const canPrint = Boolean(currentRole) && hasAnySections;
            printButtons.forEach(btn => {
                if (!btn) return;
                btn.disabled = !canPrint;
                btn.classList.toggle('disabled', !canPrint);
            });

            const isAdminFinal = currentRole === 'admin-final';
            finalizeButtons.forEach(btn => {
                if (!btn) return;
                btn.style.display = isAdminFinal ? 'inline-flex' : 'none';
            });

            if (!isAdminFinal) return;

            const sections = Array.from(document.querySelectorAll('.tgs-set-container, .tmp-set-container'));
            const hasActiveSections = sections.length > 0;
            const pendingFinalizations = sections.some(container => {
                const suiteIndex = container.dataset.suiteIndex;
                const setIndex = container.dataset.setIndex;
                const type = container.dataset.type;

                if (type === 'tmp') {
                    const skippedInput = document.getElementById(`suite${suiteIndex}_tmpSkipped`);
                    const isSkipped = skippedInput?.value === 'true';
                    if (isSkipped) return false;
                }

                const status = getWorkflowStatus(suiteIndex, setIndex, type);
                if (status.isFinalized) return false;
                if (!status.awaitingRole || status.awaitingRole === 'admin-final') return false;
                if (wasRoleSkipped(suiteIndex, setIndex, status.awaitingRole, type)) return false;
                return true;
            });

            const disableFinalize = !hasActiveSections || pendingFinalizations;
            finalizeButtons.forEach(btn => {
                if (!btn) return;
                btn.disabled = disableFinalize;
                btn.classList.toggle('disabled', disableFinalize);
            });
        }

        function applyFocusMode(suiteIndex, setIndex, type) {
            const containerSelector = type === 'tmp' 
                ? `.tmp-set-container[data-suite-index="${suiteIndex}"]` 
                : `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`;
            const container = document.querySelector(containerSelector);
            if (!container) return;

            const banner = container.querySelector('.focus-mode-banner');
            const statusPill = container.querySelector('.focus-mode-status-pill');
            const setStatusPill = (text, isFocus = false) => {
                if (!statusPill) return;
                statusPill.textContent = text;
                statusPill.classList.toggle('is-focus', Boolean(isFocus));
            };

            const status = getWorkflowStatus(suiteIndex, setIndex, type);
            const currentRole = document.getElementById('role').value;
            if (!currentRole) {
                setStatusPill('Normal Mode');
                if (banner) banner.style.display = 'none';
                container.querySelectorAll('.question-block').forEach(block => block.classList.remove('hidden-by-focus'));
                container.classList.remove('focus-mode-off');
                return;
            }

            // Build target role identifier for field IDs
            const roleIdSuffix = currentRole.replace(/-/g, '_');
            
            // Find ALL checked flags in this section (any role can flag any previous role)
            const allCheckedFlags = container.querySelectorAll('input[class*="conflict-check-field"]:checked');
            
            // Find flags FOR current user specifically (set by others)
            const flagsForCurrentUser = container.querySelectorAll(`input[id$="_conflict_${roleIdSuffix}"]:checked`);
            const hasFlagsForMe = flagsForCurrentUser.length > 0;
            const hasAnyFlags = allCheckedFlags.length > 0;

            if (!hasAnyFlags) {
                // No flags at all - normal mode
                setStatusPill('Normal Mode');
                if (banner) banner.style.display = 'none';
                container.querySelectorAll('.question-block').forEach(block => block.classList.remove('hidden-by-focus'));
                container.classList.remove('focus-mode-off');
                return;
            }

            // FOCUS MODE ACTIVE - There are flagged items
            setStatusPill('Focus Mode', true);
            
            // Collect all flagged question blocks
            const flaggedBlocks = new Set();
            allCheckedFlags.forEach(cb => {
                const block = cb.closest('.question-block');
                if (block) flaggedBlocks.add(block);
            });

            const flagCount = flaggedBlocks.size;

            if (banner) {
                const bannerMessage = hasFlagsForMe 
                    ? `<strong>ACTION REQUIRED:</strong> ${flagCount} item(s) flagged for your review by previous users.`
                    : `<strong>INFO:</strong> ${flagCount} item(s) flagged in this section (you set ${flagsForCurrentUser.length > 0 ? 'some of these' : 'these'} flags).`;
                
                const bannerColor = hasFlagsForMe ? '#dc2626' : '#2563eb'; // Red for action, blue for info
                
                banner.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
                        <span style="font-size:1.1em;">${hasFlagsForMe ? '' : ''} ${bannerMessage}</span>
                        <button type="button" class="btn btn-sm btn-secondary toggle-focus-btn" style="margin-left:10px; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white;">Show All Questions</button>
                    </div>`;
                banner.style.display = 'block';
                banner.style.backgroundColor = bannerColor;
                banner.style.color = 'white';
                banner.style.padding = '15px 20px';
                banner.style.borderRadius = '8px';
                banner.style.marginBottom = '20px';
            }

            // Apply focus mode filtering
            const isOff = container.classList.contains('focus-mode-off');
            container.querySelectorAll('.question-block').forEach(block => {
                if (isOff) {
                    block.classList.remove('hidden-by-focus');
                } else {
                    block.classList.toggle('hidden-by-focus', !flaggedBlocks.has(block));
                }
            });

            // Setup toggle button
            if (banner) {
                const toggleBtn = banner.querySelector('.toggle-focus-btn');
                if (toggleBtn) {
                    const cloned = toggleBtn.cloneNode(true);
                    toggleBtn.replaceWith(cloned);
                    cloned.addEventListener('click', (e) => {
                        e.preventDefault();
                        container.classList.toggle('focus-mode-off');
                        const currentlyOff = container.classList.contains('focus-mode-off');
                        cloned.textContent = currentlyOff ? 'Show Only Flagged' : 'Show All Questions';
                        container.querySelectorAll('.question-block').forEach(block => {
                            if (currentlyOff) {
                                block.classList.remove('hidden-by-focus');
                            } else {
                                block.classList.toggle('hidden-by-focus', !flaggedBlocks.has(block));
                            }
                        });
                    });
                }
            }
        }

        // Preload one suite with TMP and one TGS set for new project mode
        function preloadNewProjectForms() {
            // Check if suites already exist
            const existingSuites = document.querySelectorAll('.project-suite-container');
            if (existingSuites.length > 0) return;
            
            // Set suite count to 1 and generate
            const suitesCountInput = document.getElementById('projectSuitesCount');
            if (suitesCountInput) {
                suitesCountInput.value = '1';
            }
            
            // Generate one suite
            generateSuites(true);
            
            // Wait for suite to be created, then generate TMP and TGS
            setTimeout(() => {
                const suiteIndex = 0;
                
                // Generate TMP form
                if (typeof generateTMPFormSafe === 'function') {
                    generateTMPFormSafe(suiteIndex, true);
                }
                
                // Generate one TGS set
                setTimeout(() => {
                    if (typeof addNewLazyTGSSet === 'function') {
                        addNewLazyTGSSet(suiteIndex, { skipPrompt: true });
                    }
                    
                    // Update UI
                    updateFormSetAccess();
                    
                    // Ensure load buttons are hidden for designer new project - call with delay
                    setTimeout(() => {
                        updateLoadButtonsVisibility(currentRole);
                    }, 50);
                    
                    // Show helpful toast
                    if (typeof showToast === 'function') {
                        showToast('New project initialized with TMP and TGS Set 1. Fill in project details and complete the checklists.', 'Project Ready', 'success', 5000);
                    }
                }, 200);
            }, 100);
        }

        function handleDesignerChoice(choice) {
            const modal = document.getElementById('designer-workflow-modal');
            if (modal) modal.style.display = 'none';
            ModalFocusTrap.deactivate('designer-workflow-modal');

            if (choice === 'new') {
                if (confirm('Start a new project? This will clear current form data.')) {
                    // Set flag to auto-select designer after reload
                    sessionStorage.setItem('autoSelectDesigner', 'true');
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    location.reload();
                }
            } else if (choice === 'review') {
                // Behave like other users: Ensure suites are generated so they can use load buttons
                showNonDesignerGuidance();
            }
        }

        function handleRoleSelection(suppressModal = false) {
            currentRole = document.getElementById('role').value;

            // Show Designer Workflow Modal ONLY if:
            // 1. Current role is designer
            // 2. Modal is not suppressed
            // 3. No form data exists (fresh start)
            const hasExistingData = document.querySelectorAll('.project-suite-container').length > 0 ||
                                   document.getElementById('ccNumber')?.value?.trim() ||
                                   document.getElementById('projectName')?.value?.trim();
            
            const shouldShowModal = currentRole === 'designer' && 
                                   suppressModal !== true && 
                                   !hasExistingData;

            if (shouldShowModal) {
                const modal = document.getElementById('designer-workflow-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    ModalFocusTrap.activate('designer-workflow-modal');
                }
            }

            const display = document.getElementById('current-role-display');
            const roleColors = {
                designer: 'var(--role-designer-color)',
                'admin-intermediate': 'var(--role-admin-intermediate-color)',
                qa: 'var(--role-qa-color)',
                tmd: 'var(--role-tmd-color)',
                'admin-final': 'var(--role-admin-final-color)'
            };

            // Auto-check "Show only my role's fields" if a role is selected and not already checked
            const roleToggle = document.getElementById('toggle-only-current-role');
            if (currentRole && roleToggle && !roleToggle.checked) {
                roleToggle.checked = true;
                try { localStorage.setItem('onlyCurrentRole', 'true'); } catch (_) { }
            }

            // Apply classes based on toggle state
            const isFocusMode = roleToggle ? roleToggle.checked : document.body.classList.contains('only-current-role');
            document.body.className = currentRole ? `role-selected-${currentRole}` : '';
            if (isFocusMode) document.body.classList.add('only-current-role');

            if (currentRole) {
                display.textContent = `Editing as: ${roles[currentRole].name}`;
                display.style.backgroundColor = roleColors[currentRole];
                display.style.display = 'inline-block';
            } else {
                display.style.display = 'none';
            }

            // Only designer can generate forms - other roles should use Load buttons on sections
            // document.getElementById('generate-suites-btn').disabled = currentRole !== 'designer';
            // document.querySelectorAll('.generate-forms-btn').forEach(btn => btn.disabled = currentRole !== 'designer');

            // Guide non-designers to use section load/save buttons
            if (currentRole && currentRole !== 'designer') {
                showNonDesignerGuidance();
            }

            updateFormSetAccess();
            updateSignoffFocus();
            updateConflictCheckboxes();
            debouncedUpdateFormSetAccess(); // Schedule a follow-up check
        }

        // Toggle to show only the current role fields/sections
        function setupOnlyCurrentRoleToggle() {
            const toggle = document.getElementById('toggle-only-current-role');
            if (!toggle) return;
            // Restore previous preference
            try {
                const saved = localStorage.getItem('onlyCurrentRole');
                if (saved === 'true') {
                    toggle.checked = true;
                    document.body.classList.add('only-current-role');
                }
            } catch (_) { }
            toggle.addEventListener('change', () => {
                document.body.classList.toggle('only-current-role', toggle.checked);
                try { localStorage.setItem('onlyCurrentRole', toggle.checked ? 'true' : 'false'); } catch (_) { }
            });
        }

        // Function to prompt user if they have more TGS sets to review after completing one
        function promptForAdditionalTgsSet(suiteIndex, completedSetIndex) {
            const container = document.getElementById(`multi-tgs-container-suite-${suiteIndex}`);
            if (!container) return;
            
            const existingSets = container.querySelectorAll('.tgs-set-container');
            
            // Check if there are already unreviewed sets
            const hasUnreviewedSets = Array.from(existingSets).some(set => {
                const idx = set.dataset.setIndex;
                const idPrefix = `suite${suiteIndex}_set${idx}`;
                const signoffCheck = document.getElementById(`${idPrefix}_completion_check_${currentRole}`);
                return signoffCheck && !signoffCheck.checked;
            });
            
            if (hasUnreviewedSets) {
                // There are already other sets waiting to be reviewed
                return;
            }
            
            // Soft guidance: highlight the add button instead of prompting to avoid duplicate sets
            const addButton = document.querySelector(`#tgs-section-wrapper-${suiteIndex} .add-tgs-set-btn`);
            if (addButton) {
                const originalAnimation = addButton.style.animation;
                addButton.classList.add('attention-highlight');
                if (typeof addButton.focus === 'function') {
                    addButton.focus({ preventScroll: false });
                }
                setTimeout(() => {
                    addButton.classList.remove('attention-highlight');
                    addButton.style.animation = originalAnimation || '';
                }, 2200);
            }

            if (typeof showToast === 'function') {
                showToast('Need another TGS set? Use the "Add TGS Set" or "Load TGS File" button in this section.', 'Add Another Set', 'info', 6000);
            }
        }
        
        // Function to add a new TGS set for non-designer users
        function addNewTgsSetForReview(suiteIndex, options = {}) {
            const container = document.getElementById(`multi-tgs-container-suite-${suiteIndex}`);
            if (!container) return;
            
            const existingSets = container.querySelectorAll('.tgs-set-container');
            const newSetIndex = existingSets.length;
            window._isAddingNewSet = true;
            const { suggestedName, skipPrompt } = options;

            const defaultName = suggestedName || `TGS Set ${newSetIndex + 1}`;
            let tgsName = defaultName;

            // Non-designers should not be prompted - they load names from file
            const currentRole = document.getElementById('role')?.value;
            const isDesigner = currentRole === 'designer';
            
            if (!skipPrompt && isDesigner) {
                const response = prompt(`Enter the name for TGS Set ${newSetIndex + 1}:`, defaultName);
                if (response === null) {
                    window._isAddingNewSet = false;
                    return;
                }
                tgsName = response.trim() || defaultName;
            }
            const fallback = tgsName || defaultName;
            
            // Create new set
            const setWrapper = document.createElement('div');
            setWrapper.className = 'tgs-set-container';
            setWrapper.dataset.suiteIndex = suiteIndex;
            setWrapper.dataset.setIndex = newSetIndex;
            setWrapper.dataset.type = 'tgs';
            
            setWrapper.innerHTML = `
            <div class="focus-mode-status-pill" aria-live="polite">Normal Mode</div>
            <div class="focus-mode-banner" style="display: none;"></div>
            <button type="button" class="btn btn-warning conflict-review-btn no-print" onclick="openConflictReview(${suiteIndex}, ${newSetIndex}, 'tgs')" style="margin-bottom:10px;">Review Flagged Items</button>
            <div class="progress-bar-container no-print" style="display: flex; align-items: center; gap: 16px;">
                <div class="progress-bar" id="suite${suiteIndex}_progress-bar-set${newSetIndex}">0%</div>
                <div id="suite${suiteIndex}_chart-set${newSetIndex}" class="chart-donut"><span class="chart-text">0%</span></div>
            </div>
            <h2 class="tgs-set-header no-print" data-doc-no-id="suite${suiteIndex}_set${newSetIndex}_docNo" style="display:flex; align-items:center; justify-content:space-between;">
                <span>${fallback}</span>
                <span style="display:flex; gap:8px; align-items:center;">
                    <span class="current-user-pill" id="suite${suiteIndex}_set${newSetIndex}_currentUserPill" style="padding:2px 8px; border-radius:999px; font-size:0.8em; border:1px solid transparent; display:none;"></span>
                    <span class="status-pill" id="suite${suiteIndex}_set${newSetIndex}_statusPill" style="padding:2px 8px; border-radius:999px; font-size:0.8em; border:1px solid transparent;"></span>
                </span>
            </h2>
            <div class="section-save-load no-print" style="margin: 15px 0 25px; padding: 12px 20px; background: var(--surface-elevated); border-radius: 50px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="background: var(--info-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${newSetIndex + 1}</div>
                    <div>
                        <strong style="color: var(--heading-color); font-size: 1em;">Load Next TGS Set</strong>
                        <span style="color: var(--text-secondary); font-size: 0.9em; margin-left: 8px;">Load your next TGS file to continue.</span>
                    </div>
                </div>
                <div>
                    <button type="button" class="btn btn-load section-load-btn" data-suite-index="${suiteIndex}" data-set-index="${newSetIndex}" data-type="tgs" style="border-radius: 20px; padding: 8px 20px;">
                        <svg><use href="#icon-upload"></use></svg><span> Load TGS File</span>
                    </button>
                </div>
            </div>
            ${buildChecklist(suiteIndex, newSetIndex, 'tgs')}
            ${buildSignOffSection(suiteIndex, newSetIndex, 'tgs')}
        `;
            
            container.appendChild(setWrapper);
            window._isAddingNewSet = false;
            
            // Populate the TGS name field
            const docNoField = document.getElementById(`suite${suiteIndex}_set${newSetIndex}_docNo`);
            if (docNoField) {
                docNoField.value = fallback;
                docNoField.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            // Setup event listeners for the new set
            setupAllEventListeners();
            updateFormSetAccess();
            updateTgsStatusPills();
            attachValidationRules(setWrapper);
            scheduleSectionNavigatorRefresh();
            if (typeof refreshMiniMap === 'function') refreshMiniMap();
            
            // Scroll to the new set
            setTimeout(() => {
                setWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                const loadButton = setWrapper.querySelector('.section-load-btn');
                if (loadButton) {
                    const original = loadButton.style.animation;
                    loadButton.style.animation = 'pulse 0.9s ease-in-out 3';
                    setTimeout(() => { loadButton.style.animation = original || ''; }, 2200);
                }
                // Only show toast if landing page is not visible
                const landingPage = document.getElementById('landing-page');
                const isLandingVisible = landingPage && landingPage.style.display !== 'none';
                if (!isLandingVisible) {
                    showToast(`TGS Set ${newSetIndex + 1} added. Please load your file.`, 'New Set Added', 'info');
                }
            }, 300);
        }
        
        function showNonDesignerGuidance() {
            // Don't show guidance if landing page is still visible
            const landingPage = document.getElementById('landing-page');
            if (landingPage && landingPage.style.display !== 'none') {
                return;
            }
            
            const container = document.getElementById('multi-suite-container');
            const suiteCount = document.getElementById('projectSuitesCount');

            // 1. Ensure Suites Exist
            if (container && container.innerHTML.trim() === '') {
                if (suiteCount && (!suiteCount.value || suiteCount.value === '0')) {
                    suiteCount.value = '1';
                }
                generateSuites(true);
                
                // Show info about the new workflow
                setTimeout(() => {
                    showToast(
                        'Start by loading your first TGS/TMP file. After sign-off, you\'ll be asked if you have more sets to review.',
                        'Review Workflow',
                        'info',
                        8000
                    );
                }, 1000);
            }

            // 2. Try to find existing sets (TMP or TGS) to scroll to
            // Use a small timeout to ensure DOM is ready if we just generated suites
            setTimeout(() => {
                let existingSections = document.querySelectorAll('.tgs-set-container, .tmp-set-container');

                if (existingSections.length > 0) {
                    scrollToLoadSection(existingSections[0]);
                } else {
                    // 3. If no sets, scroll to the first Suite's TMP actions (Initialize button)
                    const firstSuite = document.querySelector('.project-suite-container');
                    if (firstSuite) {
                        const tmpActions = firstSuite.querySelector('.tmp-toggle-section');
                        if (tmpActions) {
                            tmpActions.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Add highlight effect
                            tmpActions.style.animation = 'none';
                            tmpActions.offsetHeight;
                            tmpActions.style.animation = 'pulse 2s ease-in-out 3';

                            // Show toast
                            const now = Date.now();
                            if (now - lastGuidanceToastTime > 3000) {
                                showToast('Please load your file using the Initialize button.', 'Load Project', 'info');
                                lastGuidanceToastTime = now;
                            }
                        }
                    }
                }
            }, 50);
        }

        let lastGuidanceToastTime = 0;

        function scrollToLoadSection(section) {
            const loadSaveArea = section.querySelector('.section-save-load');

            if (loadSaveArea) {
                // Smooth scroll to the section
                loadSaveArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Add a pulsing highlight effect (Reset it first so it restarts if triggered again)
                loadSaveArea.style.animation = 'none';
                loadSaveArea.offsetHeight; // Trigger reflow
                loadSaveArea.style.animation = 'pulse 2s ease-in-out 3';

                // Show a toast notification (Only allows 1 pop-up every 3 seconds)
                const now = Date.now();
                if (now - lastGuidanceToastTime > 3000) {
                    showToast(' Use the " Load TGS/TMP File" button below to load your assigned section file', 'info', 5000);
                    lastGuidanceToastTime = now;
                }
            }
        }

        // Add pulse animation for highlighting
        if (!document.getElementById('pulse-animation-style')) {
            const style = document.createElement('style');
            style.id = 'pulse-animation-style';
            style.textContent = `
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
            50% { transform: scale(1.02); box-shadow: 0 8px 24px rgba(59, 130, 246, 0.35); }
        }
    `;
            document.head.appendChild(style);
        }

        function setupLinkPreviews() {
            document.querySelectorAll('.link-field').forEach(inputEl => {
                inputEl.removeEventListener('input', linkInputChangeHandler);
                inputEl.addEventListener('input', linkInputChangeHandler);
                linkInputChangeHandler({ target: inputEl });
            });
        }


        function updateSignoffFocus() {
            const role = document.getElementById('role')?.value;

            document.querySelectorAll('.signoff-block-wrapper').forEach(w => {
                // If no role selected, show all sections without focus
                if (!role) {
                    w.style.display = 'block';
                    w.classList.remove('focused');
                    w.classList.remove('blurred');
                    w.setAttribute('aria-hidden', 'false');
                    return;
                }

                const wrapperRole = w.dataset.role;

                if (wrapperRole === role) {
                    w.style.display = 'block';
                    w.classList.add('focused');
                    w.classList.remove('blurred');
                    w.setAttribute('aria-hidden', 'false');
                } else {
                    w.style.display = 'none';
                    w.classList.add('blurred');
                    w.classList.remove('focused');
                    w.setAttribute('aria-hidden', 'true');
                }
            });
        }

        function setRoleLockStateForContainer(container, roleKey, isLocked) {
            if (!container) return;
            const fields = container.querySelectorAll(`.form-field.role-${roleKey}`);
            fields.forEach(field => {
                if (field.type === 'hidden') return;
                const isConflictFlag = field.classList.contains('conflict-check-field');

                if (isLocked && !isConflictFlag) {
                    field.dataset.signoffLocked = 'true';
                    field.classList.add('field-locked');
                    field.disabled = true;
                } else {
                    if (field.dataset.signoffLocked === 'true') {
                        delete field.dataset.signoffLocked;
                        field.classList.remove('field-locked');
                    }
                    if (isConflictFlag) {
                        field.disabled = false;
                    }
                }
            });
        }

        function applySignoffLock(wrapper, isLocked) {
            if (!wrapper) return;
            wrapper.classList.toggle('signoff-complete', isLocked);
            const controls = wrapper.querySelectorAll('input, textarea, select, button');
            controls.forEach(control => {
                if (control.type === 'hidden') return;
                if (isLocked) {
                    control.dataset.signoffLocked = 'true';
                    if (control.classList) control.classList.add('field-locked');
                    control.disabled = true;
                } else if (control.dataset.signoffLocked === 'true') {
                    delete control.dataset.signoffLocked;
                    if (control.classList) control.classList.remove('field-locked');
                    control.disabled = false;
                }
            });
        }

        function refreshSignoffLocks() {
            document.querySelectorAll('.tmp-set-container, .tgs-set-container').forEach(container => {
                const suiteIndex = container.dataset.suiteIndex;
                const setIndex = container.dataset.setIndex;
                const type = container.dataset.type;
                const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
                const status = getWorkflowStatus(suiteIndex, setIndex, type);
                const awaitingRole = status.awaitingRole;
                
                // Check if THIS specific container is the one being loaded
                const loadingSection = window._loadingSection;
                const isThisSectionBeingLoaded = loadingSection && 
                    loadingSection.suiteIndex == suiteIndex && 
                    loadingSection.setIndex == setIndex && 
                    loadingSection.type === type;

                container.querySelectorAll('.signoff-block-wrapper').forEach(wrapper => {
                    const roleKey = wrapper.dataset.role;
                    if (!roleKey) return;
                    const completionCheckbox = document.getElementById(`${idPrefix}_completion_check_${roleKey}`);
                    let isComplete = completionCheckbox ? completionCheckbox.checked : false;

                    // FIXED: Only clear sign-offs for the SPECIFIC section being loaded, not all sections
                    // This prevents loading one TGS set from affecting other already-completed sets
                    if (window._isLoadingFromFile && isThisSectionBeingLoaded && isComplete && !status.isFinalized && awaitingRole) {
                        const roleIndex = roleOrder.indexOf(roleKey);
                        const awaitingIndex = roleOrder.indexOf(awaitingRole);
                        
                        // Only clear if this role comes AFTER the awaiting role
                        // This preserves Designer's (and previous reviewers') sign-offs
                        if (awaitingIndex !== -1 && roleIndex > awaitingIndex) {
                            clearRoleSignoffFields(idPrefix, roleKey);
                            if (completionCheckbox) completionCheckbox.checked = false;
                            isComplete = false;
                        }
                    }

                    applySignoffLock(wrapper, isComplete);
                    setRoleLockStateForContainer(container, roleKey, isComplete);
                });
            });
        }

        function updateSuiteHeaders() {
            document.querySelectorAll('.project-suite-container').forEach(container => {
                const suiteIndex = container.dataset.suiteIndex;
                const input = document.getElementById(`suite${suiteIndex}_projectSuiteName`);
                const title = container.querySelector('.project-suite-title');
                const tmpTitle = container.querySelector('.tmp-suite-title');
                const val = (input?.value || '').trim();
                const display = val ? `Details for: ${val}` : `Project Suite ${Number(suiteIndex) + 1}`;
                if (title) title.textContent = display;
                if (tmpTitle) tmpTitle.textContent = `Traffic Management Plan (TMP) for Suite ${val || (Number(suiteIndex) + 1)}`;
            });
        }

        // Conflict flags: build dynamic checkboxes for roles involved in this item
        function getWorkflowInvolvedRlesForItem(suiteIndex, setIndex, type = 'tgs') {
            const involved = new Set(['designer']);
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const order = ['designer', 'admin-intermediate', 'qa', 'tmd', 'admin-final'];
            for (const role of order) {
                if (isRoleSignedOff(suiteIndex, setIndex, role, type)) {
                    involved.add(role);
                    const actionEl = document.getElementById(`${idPrefix}_${role}_action`);
                    const action = actionEl?.value;
                    if (action?.startsWith('pass_')) {
                        const next = action.replace('pass_', '').replace(/_/g, '-');
                        involved.add(next);
                    }
                }
            }
            return Array.from(involved);
        }

        function generateDynamicConflictCheckboxes(suiteIndex, setIndex, questionId, currentRole, type = 'tgs') {
            const flagPermissions = {
                'designer': [],
                'admin-intermediate': ['designer'],
                'qa': ['designer', 'admin-intermediate'],
                'tmd': ['designer', 'admin-intermediate', 'qa'],
                'admin-final': ['designer', 'admin-intermediate', 'qa', 'tmd']
            };

            const allPossibleTargets = ['designer', 'admin-intermediate', 'qa', 'tmd'];
            const allowedFlags = flagPermissions[currentRole] || [];
            let interactiveCount = 0;

            let html = '<div class="site-presence-options" style="gap: 15px; flex-wrap: wrap;">';

            allPossibleTargets.forEach(targetRole => {
                const conflictId = targetRole.replace(/-/g, '_');
                const inputId = `${questionId}_conflict_${conflictId}`;
                const canSetFlag = allowedFlags.includes(targetRole);
                const canClearFlag = targetRole === currentRole;
                const shouldDisplay = canSetFlag && !canClearFlag;
                if (shouldDisplay) interactiveCount++;
                const rowStyle = `border-color:var(--danger-color);${shouldDisplay ? '' : ' display:none;'}`;
                const dataAttrs = `data-target-role="${targetRole}" data-can-set="${canSetFlag}" data-can-clear="${canClearFlag}"`;
                html += `
                    <div class="check-item" style="${rowStyle}">
                        <input type="checkbox" class="form-field conflict-check-field role-${targetRole}" id="${inputId}" ${dataAttrs}>
                        <label for="${inputId}" style="font-size: 0.9em; font-weight: 600; color: var(--danger-color);">Flag for ${roles[targetRole].name}</label>
                    </div>`;
            });

            html += '</div>';

            const wrapperStyle = interactiveCount > 0
                ? 'margin-top:15px; padding:10px; background:rgba(239,68,68,0.05); border-left:3px solid var(--danger-color);'
                : 'margin-top:15px; padding:10px; background:rgba(239,68,68,0.05); border-left:3px solid var(--danger-color); display:none;';

            return `
                <div class="conflict-wrapper" style="${wrapperStyle}">
                    <legend style="color:var(--danger-color); font-weight:700; font-size:0.9em; margin-bottom:8px;">Request Re-Review / Flag Item:</legend>
                    ${html}
                </div>`;
        }

        function updateConflictRowVisibility(checkbox) {
            if (!checkbox) return;
            const row = checkbox.closest('.check-item');
            if (!row) return;
            const canSet = checkbox.dataset?.canSet === 'true';
            const canClear = checkbox.dataset?.canClear === 'true';
            const shouldShow = canSet || (canClear && checkbox.checked);
            row.style.display = shouldShow ? '' : 'none';
        }

        function refreshConflictWrapper(wrapper) {
            if (!wrapper) return;
            const anyVisible = Array.from(wrapper.querySelectorAll('.check-item')).some(item => item.style.display !== 'none');
            wrapper.style.display = anyVisible ? '' : 'none';
        }

        function syncConflictFieldState(field) {
            if (!field) return;
            updateConflictRowVisibility(field);
            refreshConflictWrapper(field.closest('.conflict-wrapper'));
        }

        function handleConflictCheckboxChange(event) {
            const checkbox = event?.target;
            if (!checkbox) return;

            // Skip validation during file loading or data copying
            if (window._isLoadingFromFile || window._isCopyingData) {
                syncConflictFieldState(checkbox);
                return;
            }
            
            const canSet = checkbox.dataset?.canSet === 'true';
            const canClear = checkbox.dataset?.canClear === 'true';
            const isChecking = checkbox.checked;
            
            // Validation: Can only check (set flag) if canSet
            if (isChecking && !canSet) {
                checkbox.checked = false;
                syncConflictFieldState(checkbox);
                const targetRole = roles[checkbox.dataset.targetRole]?.name || 'this user';
                showToast(`You cannot flag items for ${targetRole}. Only designated reviewers can flag previous roles.`, 'Permission Denied', 'warning');
                return;
            }
            
            // Validation: Can only uncheck (clear flag) if canClear OR canSet
            if (!isChecking && !canClear && !canSet) {
                checkbox.checked = true; // Restore checked state
                syncConflictFieldState(checkbox);
                const targetRole = roles[checkbox.dataset.targetRole]?.name || 'this user';
                showToast(`This flag was set for ${targetRole}. Only ${targetRole} can clear it.`, 'Permission Denied', 'warning');
                return;
            }
            
            // Allow clearing for the target role or anyone who set it
            syncConflictFieldState(checkbox);
            debouncedSaveState();
            debouncedUpdateFormSetAccess();
        }

        function updateConflictCheckboxes() {
            const current = document.getElementById('role').value;
            if (!current) return;

            document.querySelectorAll('.conflict-placeholder').forEach(ph => {
                const qid = ph.dataset.questionId;
                const m = qid.match(/suite(\d+)_(tmp|set(\d+))/);
                if (!m) return;
                const suiteIndex = m[1];
                const setIndex = m[2] === 'tmp' ? 'tmp' : m[3];
                const type = m[2] === 'tmp' ? 'tmp' : 'tgs';

                const previousState = {};
                ph.querySelectorAll('.conflict-check-field').forEach(cb => {
                    previousState[cb.id] = cb.checked;
                });

                ph.innerHTML = generateDynamicConflictCheckboxes(suiteIndex, setIndex, qid, current, type);

                const wrapper = ph.querySelector('.conflict-wrapper');
                ph.querySelectorAll('.conflict-check-field').forEach(cb => {
                    if (previousState[cb.id]) {
                        cb.checked = true;
                    }
                    cb.removeEventListener('change', handleConflictCheckboxChange);
                    cb.addEventListener('change', handleConflictCheckboxChange);
                    syncConflictFieldState(cb);
                });
                refreshConflictWrapper(wrapper);
            });
        }

        // Custom questions (for both TGS and TMP)
        function addCustomQuestion(suiteIndex, setIndex, type = 'tgs', text = '', customId = null) {
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const listId = `${idPrefix}_custom_list`;
            const listEl = document.getElementById(listId);
            if (!listEl) return;

            const placeholder = document.getElementById(`${idPrefix}_custom_placeholder`);
            if (placeholder) placeholder.style.display = 'none';

            const prominentButton = listEl.parentElement.querySelector('.custom-add-button-container');
            if (prominentButton) {
                prominentButton.style.display = 'none';
                let addAnother = listEl.parentElement.querySelector('.add-another-container');
                if (!addAnother) {
                    addAnother = document.createElement('div');
                    addAnother.className = 'add-another-container';
                    addAnother.style.cssText = 'text-align:center; margin-top:20px; padding:15px;';
                    addAnother.innerHTML = `
                <button type="button" class="btn btn-secondary no-print" onclick="addCustomQuestion(${suiteIndex}, '${setIndex}', '${type}')">
                    + Add Another Question
                </button>`;
                    listEl.parentElement.appendChild(addAnother);
                }
            }

            const id = customId || `${idPrefix}_custom_${Date.now()}`;
            const wrapper = document.createElement('div');
            wrapper.className = 'question-block custom-question-simple';
            wrapper.dataset.customId = id;
            wrapper.id = `${id}_wrapper`;
            wrapper.innerHTML = `
        <div style="display:flex; gap:12px; align-items:flex-start; padding: 20px; background: #f8fafc; border-radius: 12px; border: 2px dashed #cbd5e1;">
            <textarea class="form-field custom-question-text" id="${id}_text" placeholder="Enter your custom question here..." style="flex:1; min-height: 60px;">${text || ''}</textarea>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <button type="button" class="btn btn-sm btn-success" onclick="expandCustomQuestion('${id}', ${suiteIndex}, '${setIndex}', '${type}')"> Add Features</button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addCustomQuestion(${suiteIndex}, '${setIndex}', '${type}')">+ Add Question</button>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeCustomQuestion('${id}', ${suiteIndex}, '${setIndex}', '${type}')"> Remove</button>
            </div>
        </div>`;
            listEl.appendChild(wrapper);
            wrapper.querySelectorAll('.form-field').forEach(f => f.addEventListener('input', debouncedSaveState));
            setTimeout(() => wrapper.querySelector('.custom-question-text')?.focus(), 100);
        }

        function expandCustomQuestion(customId, suiteIndex, setIndex, type = 'tgs') {
            const wrapper = document.getElementById(`${customId}_wrapper`);
            if (!wrapper) return;
            const currentText = wrapper.querySelector('.custom-question-text')?.value || '';

            let checksHTML = '';
            for (const roleKey in roles) {
                checksHTML += `
            <div class="check-item role-check-group">
                <label>${roles[roleKey].name}:</label>
                <div class="role-checks">
                    <div class="check-item" style="border:none; padding:2px;">
                        <input type="radio" class="form-field role-${roleKey}" name="${customId}_${roleKey}_check" id="${customId}_${roleKey}_check_yes" value="yes">
                        <label for="${customId}_${roleKey}_check_yes">Yes</label>
                    </div>
                    <div class="check-item" style="border:none; padding:2px;">
                        <input type="radio" class="form-field role-${roleKey}" name="${customId}_${roleKey}_check" id="${customId}_${roleKey}_check_no" value="no">
                        <label for="${customId}_${roleKey}_check_no">No</label>
                    </div>
                    <div class="check-item" style="border:none; padding:2px;">
                        <input type="radio" class="form-field role-${roleKey}" name="${customId}_${roleKey}_check" id="${customId}_${roleKey}_check_na" value="na">
                        <label for="${customId}_${roleKey}_check_na">N/A</label>
                    </div>
                </div>
            </div>`;
            }

            let commentsHTML = '<div class="comments-grid">';
            for (const roleKey in roles) {
                commentsHTML += `<div>
                    <label for="${customId}_${roleKey}_comments">${roles[roleKey].name} Comments:</label>
                    <select class="quick-comment-selector" data-target="${customId}_${roleKey}_comments" title="Quick comment for ${roles[roleKey].name}" aria-label="Quick comment selection" style="margin-bottom: 8px; font-size: 0.9em;">
                        <option value="">-- Quick Comments --</option>
                        <option value="Compliant with AGTTM Part 3.">Compliant with AGTTM Part 3.</option>
                        <option value="Signage spacing inadequate for speed limit.">Signage spacing inadequate for speed limit.</option>
                        <option value="Missing taper length calculation.">Missing taper length calculation.</option>
                        <option value="Refer to Standard Drawing.">Refer to Standard Drawing.</option>
                        <option value="Please clarify pedestrian management.">Please clarify pedestrian management.</option>
                        <option value="Traffic control measures appear adequate.">Traffic control measures appear adequate.</option>
                        <option value="Requires RPEQ certification.">Requires RPEQ certification.</option>
                        <option value="Plan needs revision - see comments.">Plan needs revision - see comments.</option>
                        <option value="Approved with conditions.">Approved with conditions.</option>
                        <option value="Please provide additional documentation.">Please provide additional documentation.</option>
                    </select>
                    <div class="comment-wrapper" style="position:relative;">
                        <textarea class="form-field role-${roleKey}" id="${customId}_${roleKey}_comments"></textarea>
                        <button type="button" class="copy-down-btn" title="Copy comment from previous reviewer" aria-label="Copy comment from previous reviewer" style="position:absolute; top:4px; right:4px; width:24px; height:24px; padding:0; border:none; background:var(--secondary-bg); border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center; opacity:0.7; transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z" fill="currentColor"/></svg>
                        </button>
                    </div>
                </div>`;
            }
            commentsHTML += '</div>';

            const sitePresenceHTML = `
        <div class="site-presence-block">
            <legend>Present at site? (Designer/QA Only)</legend>
            <div class="site-presence-options">
                <div class="check-item"><input type="radio" class="form-field role-designer role-qa site-presence-field" name="${customId}_present_at_site" id="${customId}_present_yes" value="yes"><label for="${customId}_present_yes">Yes</label></div>
                <div class="check-item"><input type="radio" class="form-field role-designer role-qa site-presence-field" name="${customId}_present_at_site" id="${customId}_present_no" value="no"><label for="${customId}_present_no">No</label></div>
                <div class="check-item"><input type="radio" class="form-field role-designer role-qa site-presence-field" name="${customId}_present_at_site" id="${customId}_present_na" value="na"><label for="${customId}_present_na">Not applicable</label></div>
            </div>
        </div>`;

            wrapper.className = 'question-block custom-question';
            wrapper.innerHTML = `
        <div style="margin-bottom: 15px;">
            <div style=\"display:flex; gap:12px; align-items:flex-start; margin-bottom:15px;\">
                <textarea class=\"form-field custom-question-text\" id=\"${customId}_text\" placeholder=\"Enter custom question\" style=\"flex:1;\">${currentText}</textarea>
                <div style=\"display:flex; flex-direction:column; gap:8px;\">
                    <button type=\"button\" class=\"btn btn-sm btn-secondary\" onclick=\"addCustomQuestion(${suiteIndex}, '${setIndex}', '${type}')\">+ Add Question</button>
                    <button type=\"button\" class=\"btn btn-sm btn-danger\" onclick=\"removeCustomQuestion('${customId}', ${suiteIndex}, '${setIndex}', '${type}')\"> Remove</button>
                </div>
            </div>
            <div class=\"checks-grid\">${checksHTML}</div>
            ${sitePresenceHTML}
            <div class=\"conflict-placeholder\" data-question-id=\"${customId}\"></div>
            ${commentsHTML}
        </div>`;

            wrapper.querySelectorAll('.form-field').forEach(f => f.addEventListener('input', debouncedSaveState));
            setTimeout(() => updateConflictCheckboxes(), 50);
        }

        function removeCustomQuestion(customId, suiteIndex, setIndex, type = 'tgs') {
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const listEl = document.getElementById(`${idPrefix}_custom_list`);
            const placeholder = document.getElementById(`${idPrefix}_custom_placeholder`);
            const wrapper = document.getElementById(`${customId}_wrapper`) || document.querySelector(`.custom-question[data-custom-id="${customId}"]`);
            if (wrapper) wrapper.remove();
            debouncedSaveState();
            if (listEl && placeholder) {
                const remaining = listEl.querySelectorAll('.custom-question, .custom-question-simple');
                if (remaining.length === 0) {
                    placeholder.style.display = 'block';
                    const prominentButton = listEl.parentElement.querySelector('.custom-add-button-container');
                    if (prominentButton) prominentButton.style.display = 'block';
                    const addAnother = listEl.parentElement.querySelector('.add-another-container');
                    if (addAnother) addAnother.remove();
                }
            }
        }

        function getFormDataAsObject() {
            const data = {
                topLevel: {},
                suites: [],
                selectedRole: document.getElementById('role').value,
            };

            document.querySelectorAll('.top-level-field').forEach(field => data.topLevel[field.id] = field.value);

            document.querySelectorAll('.project-suite-container').forEach(suiteContainer => {
                const suiteIndex = suiteContainer.dataset.suiteIndex;
                const suiteData = { suiteDetails: {}, tmpSet: {}, formSets: [] };

                // *** NEW CODE: Capture Suite Level Fields (like tmpSkipped) ***
                suiteContainer.querySelectorAll('.suite-level-field').forEach(field => {
                    suiteData.suiteDetails[field.id] = field.value;
                });
                // **************************************************************

                // Get TMP data
                const tmpContainer = suiteContainer.querySelector('.tmp-set-container');
                if (tmpContainer) {
                    tmpContainer.querySelectorAll('.form-field').forEach(field => {
                        const key = field.id.replace(`suite${suiteIndex}_tmp_`, '');
                        if (field.type === 'radio') {
                            if (field.checked) suiteData.tmpSet[field.name.replace(`suite${suiteIndex}_tmp_`, '')] = field.value;
                        } else {
                            suiteData.tmpSet[key] = (field.type === 'checkbox') ? field.checked : field.value;
                        }
                    });
                }

                // Get TGS data
                suiteContainer.querySelectorAll('.tgs-set-container').forEach(setContainer => {
                    const setIndex = setContainer.dataset.setIndex;
                    const setData = {};
                    setContainer.querySelectorAll('.form-field').forEach(field => {
                        const key = field.id.replace(`suite${suiteIndex}_set${setIndex}_`, '');
                        if (field.type === 'radio') {
                            if (field.checked) setData[field.name.replace(`suite${suiteIndex}_set${setIndex}_`, '')] = field.value;
                        } else {
                            setData[key] = (field.type === 'checkbox') ? field.checked : field.value;
                        }
                    });
                    suiteData.formSets.push(setData);
                });

                data.suites.push(suiteData);
            });

            return data;
        }

        async function populateFormFromDataObject(data) {
            beginFileLoad();
            try {
                window.dataLoadedFromStorage = true;
                if (data.topLevel) {
                    for (const key in data.topLevel) {
                        const field = document.getElementById(key);
                        if (field) field.value = data.topLevel[key];
                    }
                }

            // Update Role UI immediately
            const roleSelect = document.getElementById('role');
            if (data.selectedRole && (!roleSelect.value || roleSelect.value === "")) {
                roleSelect.value = data.selectedRole;
                handleRoleSelection(true);
            }

            if (data.suites && data.suites.length > 0) {
                document.getElementById('projectSuitesCount').value = data.suites.length;
                generateSuites(true);
                
                // Allow UI to breathe before processing suites
                await new Promise(resolve => setTimeout(resolve, 50));

                for (let suiteIndex = 0; suiteIndex < data.suites.length; suiteIndex++) {
                    const suiteData = data.suites[suiteIndex];
                    const suiteContainer = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
                    if (!suiteContainer) continue;

                    // Suite Details
                    if (suiteData.suiteDetails) {
                        for (const key in suiteData.suiteDetails) {
                            let field = document.getElementById(key);
                            if (!field && key.includes('_tmpSkipped')) {
                                field = document.createElement('input');
                                field.type = 'hidden';
                                field.id = key;
                                field.className = 'suite-level-field';
                                suiteContainer.appendChild(field);
                            }
                            if (field) field.value = suiteData.suiteDetails[key];
                            if (key.includes('_tmpSkipped') && suiteData.suiteDetails[key] === "true") {
                                skipTMP(suiteIndex, true);
                            }
                        }
                    }

                    const tgsWrapper = document.getElementById(`tgs-section-wrapper-${suiteIndex}`);
                    if (tgsWrapper && (suiteData.formSets.length > 0 || (suiteData.suiteDetails && suiteData.suiteDetails[`suite${suiteIndex}_tmpSkipped`] === "true"))) {
                        tgsWrapper.style.display = 'block';
                        tgsWrapper.style.opacity = '1';
                    }

                    // TMP
                    if (suiteData.tmpSet && Object.keys(suiteData.tmpSet).length > 0) {
                        const hasTmp = !!suiteContainer.querySelector('.tmp-set-container');
                        if (!hasTmp) generateTMPForm(suiteIndex, true, true);

                        // 1. Standard
                        for (const key in suiteData.tmpSet) {
                            if (key.includes('_conflict_')) continue;
                            const idKey = `suite${suiteIndex}_tmp_${key}`;
                            const field = document.getElementById(idKey) || document.querySelector(`[name="${idKey}"][value="${suiteData.tmpSet[key]}"]`);
                            if (field) {
                                if (field.type === 'radio') field.checked = true;
                                else if (field.type === 'checkbox') field.checked = !!suiteData.tmpSet[key];
                                else field.value = suiteData.tmpSet[key];
                            }
                        }
                        // 2. Generate DOM
                        updateConflictCheckboxes();
                        // 3. Apply Flags
                        for (const key in suiteData.tmpSet) {
                            if (!key.includes('_conflict_')) continue;
                            const idKey = `suite${suiteIndex}_tmp_${key}`;
                            const field = document.getElementById(idKey);
                            if (field) {
                                field.checked = !!suiteData.tmpSet[key];
                                syncConflictFieldState(field);
                            }
                        }
                    }

                    // TGS
                    if (suiteData.formSets && suiteData.formSets.length > 0) {
                        const calculatedCountInput = document.getElementById(`suite${suiteIndex}_calculatedFormSetsCount`);
                        if (calculatedCountInput) {
                            calculatedCountInput.value = suiteData.formSets.length;
                        }
                        if (suiteData.formSets.length > 1) {
                            const noRadio = document.getElementById(`suite${suiteIndex}_singleFormSet_no`);
                            const countInput = document.getElementById(`suite${suiteIndex}_formSetsCount`);
                            if (noRadio) noRadio.checked = true;
                            if (countInput) countInput.value = suiteData.formSets.length;
                        }
                        if (calculatedCountInput) {
                            handleSuiteFormSetSelector({ currentTarget: calculatedCountInput });
                        }
                        generateFormSets(suiteIndex);

                        for (let setIndex = 0; setIndex < suiteData.formSets.length; setIndex++) {
                            const setData = suiteData.formSets[setIndex];
                            
                            // Batch process fields
                            const setFields = [];
                            const setConflicts = [];
                            
                            for (const key in setData) {
                                const idKey = `suite${suiteIndex}_set${setIndex}_${key}`;
                                if (key.includes('_conflict_')) {
                                    setConflicts.push({ idKey, value: setData[key] });
                                } else {
                                    setFields.push({ idKey, value: setData[key] });
                                }
                            }
                            
                            // Apply standard fields
                            setFields.forEach(({ idKey, value }) => {
                                const field = document.getElementById(idKey) || document.querySelector(`[name="${idKey}"][value="${value}"]`);
                                if (field) {
                                    if (field.type === 'radio') field.checked = true;
                                    else if (field.type === 'checkbox') field.checked = !!value;
                                    else field.value = value;
                                }
                            });
                            
                            // Apply conflict flags
                            if (setConflicts.length > 0) {
                                updateConflictCheckboxes();
                                setConflicts.forEach(({ idKey, value }) => {
                                    const field = document.getElementById(idKey);
                                    if (field) {
                                        field.checked = !!value;
                                        syncConflictFieldState(field);
                                    }
                                });
                            }
                        }
                    }
                    
                    // Allow UI to breathe between suites
                    if (suiteIndex < data.suites.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 30));
                    }
                }
            }

                setupAllEventListeners();
                handleRoleSelection(true);
                updateFormSetAccess();
                scheduleSectionNavigatorRefresh();
            } finally {
                endFileLoad();
            }
        }

        async function exportProgressToFile(options = null) {
            let data;
            try {
                data = getFormDataAsObject();
                if (!data) throw new Error('Failed to generate form data');
            } catch (e) {
                alert("Error preparing data for save: " + e.message);
                return Promise.reject(e);
            }

            const opts = typeof options === 'string' ? { overrideRecipient: options } : (options || {});
            
            // Helper to clean filename segments (spaces become hyphens for cleaner filenames)
            const cleanSeg = (s) => (s || '').toString().trim().replace(/[<>:"/\\|?*]+/g, '').replace(/\s+/g, '-').trim();

            // Get Context Data
            const currentRoleName = cleanSeg(roles[currentRole]?.name) || 'unsaved';
            const ccNumberField = document.getElementById('ccNumber');
            
            // CC Number is the primary identifier (required)
            const ccNumber = cleanSeg(ccNumberField?.value) || 'CC-0000';
            const dateStr = new Date().toISOString().slice(0, 10);

            // Resolve Context (Suite/Set)
            const resolveContext = (preferred = {}) => {
                const normalized = { suiteIndex: null, setIndex: null, type: null };
                if (preferred && typeof preferred === 'object') {
                    if (preferred.suiteIndex !== undefined) normalized.suiteIndex = parseInt(preferred.suiteIndex, 10);
                    if (preferred.setIndex !== undefined) normalized.setIndex = preferred.setIndex === 'tmp' ? 'tmp' : parseInt(preferred.setIndex, 10);
                    if (preferred.type) normalized.type = preferred.type;
                }
                // If still not resolved, auto-detect
                if (normalized.suiteIndex === null || Number.isNaN(normalized.suiteIndex)) {
                    const prioritySelectors = [
                        '.tgs-set-container.manual-save-required',
                        '.tmp-set-container.manual-save-required',
                        '.tgs-set-container[data-suite-index]',
                        '.tmp-set-container[data-suite-index]'
                    ];
                    for (const selector of prioritySelectors) {
                        const container = document.querySelector(selector);
                        if (!container) continue;
                        const suiteIdx = parseInt(container.dataset.suiteIndex, 10);
                        const containerType = container.dataset.type || (container.classList.contains('tmp-set-container') ? 'tmp' : 'tgs');
                        return {
                            suiteIndex: suiteIdx,
                            setIndex: containerType === 'tmp' ? 'tmp' : parseInt(container.dataset.setIndex, 10),
                            type: containerType
                        };
                    }
                }
                return normalized;
            };
            const context = resolveContext({ suiteIndex: opts.suiteIndex, setIndex: opts.setIndex, type: opts.type });

            // Determine Recipient
            let toName = opts.overrideRecipient;
            if (!toName && context.suiteIndex !== null) {
                const idPrefix = `suite${context.suiteIndex}_${context.type === 'tmp' ? 'tmp' : `set${context.setIndex}`}`;
                const actionField = document.getElementById(`${idPrefix}_${currentRole}_action`);
                if (actionField && actionField.value) {
                    if (actionField.value.startsWith('pass_')) toName = roles[actionField.value.replace('pass_', '').replace(/_/g, '-')].name;
                    else if (actionField.value.startsWith('send_back_')) toName = roles[actionField.value.replace('send_back_', '').replace(/_/g, '-')].name;
                    else if (actionField.value === 'finalize') toName = "Final Archive";
                }
                if (!toName && context.setIndex !== null) {
                    const nextRoleKey = getNextReviewer(context.suiteIndex, context.setIndex, context.type || 'tgs');
                    toName = roles[nextRoleKey]?.name || 'Next Stage';
                }
            }
            toName = cleanSeg(toName) || 'archived';

            // Generate Version String
            const versionStr = (() => {
                if (context.suiteIndex !== null && context.setIndex !== null) {
                    const vField = document.getElementById(`suite${context.suiteIndex}_${context.type === 'tmp' ? 'tmp' : `set${context.setIndex}`}_reviewVersion`);
                    const val = vField ? parseInt(vField.value) : 1;
                    return val > 1 ? `_V${val}` : '';
                }
                return '';
            })();

            // --- NAMING LOGIC ---
            // Format: CCNumber_SuiteNo._TGSSetNo_from user_to user_date (for TGS)
            // Format: CCNumber_SuiteNo._from user_to user_date (for TMP)
            let filename = "";
            if (context.suiteIndex !== null) {
                // Get container references for dataset access
                const suiteContainer = document.querySelector(`.project-suite-container[data-suite-index="${context.suiteIndex}"]`);
                const sectionContainer = context.type === 'tmp'
                    ? document.querySelector(`.tmp-set-container[data-suite-index="${context.suiteIndex}"]`)
                    : document.querySelector(`.tgs-set-container[data-suite-index="${context.suiteIndex}"][data-set-index="${context.setIndex}"]`);
                
                // 1. Try container dataset first (most reliable for loaded files)
                let rawSuiteName = "";
                if (suiteContainer?.dataset?.suiteName) {
                    rawSuiteName = suiteContainer.dataset.suiteName;
                } else if (sectionContainer?.dataset?.suiteName) {
                    rawSuiteName = sectionContainer.dataset.suiteName;
                }
                
                // 2. Try DOM field
                if (!rawSuiteName) {
                    const domEl = document.getElementById(`suite${context.suiteIndex}_projectSuiteName`);
                    if (domEl && domEl.value) {
                        rawSuiteName = domEl.value;
                    }
                }
                
                // 3. Try data object as fallback
                if (!rawSuiteName && data.suites && data.suites[context.suiteIndex] && data.suites[context.suiteIndex].suiteDetails) {
                    const key = `suite${context.suiteIndex}_projectSuiteName`;
                    rawSuiteName = data.suites[context.suiteIndex].suiteDetails[key] || '';
                }

                // Suite number (from suite name or index)
                const suiteNo = cleanSeg(rawSuiteName) || `Suite-${context.suiteIndex + 1}`;

                const segments = [ccNumber, suiteNo]; 

                // 4. For TGS, add the TGS Set Number (no extra segment for TMP)
                if (context.type !== 'tmp' && context.setIndex !== null) {
                    let rawDocNo = '';
                    if (sectionContainer?.dataset?.docNo) {
                        rawDocNo = sectionContainer.dataset.docNo;
                    } else {
                        const docEl = document.getElementById(`suite${context.suiteIndex}_set${context.setIndex}_docNo`);
                        rawDocNo = docEl?.value || '';
                    }
                    const tgsSetNo = cleanSeg(rawDocNo) || `TGS-${Number(context.setIndex) + 1}`;
                    segments.push(tgsSetNo);
                }

                filename = `${segments.join('_')}_from (${currentRoleName})_ to (${toName})_${dateStr}${versionStr}.json`;
            } else {
                filename = `${ccNumber}_from (${currentRoleName})_ to (${toName})_${dateStr}${versionStr}.json`;
            }
            // ---------------------------

            // File Creation and Download Logic (with Save As Picker)
            const jsonContent = JSON.stringify(data, null, 2);
            if (!jsonContent || jsonContent.length < 50) {
                alert('Error: No data to save.');
                return Promise.reject(new Error('No data'));
            }
            
            const blob = new Blob([jsonContent], { type: 'application/json' });

            if (window.showSaveFilePicker && window.isSecureContext) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{ description: 'JSON Data File', accept: { 'application/json': ['.json'] } }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    showToast(`File saved: ${handle.name}`, 'Save Complete', 'success');
                    return; 
                } catch (err) {
                    if (err.name === 'AbortError') return Promise.reject(new Error('User cancelled save'));
                    console.warn('Save Picker failed, using download:', err);
                }
            }

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            setTimeout(() => { document.body.removeChild(link); URL.revokeObjectURL(link.href); }, 100);
            showToast(`File saved: ${filename}`, 'Download Complete', 'success');
        }

        // Build a minimal data object for a specific TGS set or TMP section
        function getSectionDataObject(suiteIndex, setIndex, type = 'tgs') {
            const containerSelector = type === 'tmp'
                ? `.tmp-set-container[data-suite-index="${suiteIndex}"]`
                : `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`;
            const container = document.querySelector(containerSelector);
            if (!container) return null;

            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const data = {};

            container.querySelectorAll('.form-field').forEach(field => {
                if (!field.id && field.name && field.type === 'radio') {
                    // radio groups sometimes rely on name only
                    if (field.checked) data[field.name.replace(`${idPrefix}_`, '')] = field.value;
                    return;
                }
                const key = field.id ? field.id.replace(`${idPrefix}_`, '') : null;
                if (!key) return;
                if (field.type === 'radio') {
                    if (field.checked) data[field.name.replace(`${idPrefix}_`, '')] = field.value;
                } else if (field.type === 'checkbox') {
                    data[key] = !!field.checked;
                } else {
                    data[key] = field.value;
                }
            });

            const docNoEl = document.getElementById(`${idPrefix}_docNo`);
            const topLevelDetails = {};
            PROJECT_DETAIL_FIELDS.forEach(fieldId => {
                const fieldEl = document.getElementById(fieldId);
                if (fieldEl) topLevelDetails[fieldId] = fieldEl.value || '';
            });
            
            // Also capture suite-level details (like suite name)
            const suiteDetails = {};
            const suiteContainer = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
            if (suiteContainer) {
                suiteContainer.querySelectorAll('.suite-level-field').forEach(field => {
                    if (field.id) suiteDetails[field.id] = field.value || '';
                });
            }
            
            // Get handover info if available
            const sectionKey = `${suiteIndex}_${type === 'tmp' ? 'tmp' : setIndex}`;
            const handoverInfo = window._sectionHandoverInfo?.[sectionKey] || null;
            
            return {
                kind: type === 'tmp' ? 'tmp-section' : 'tgs-section',
                type,
                suiteIndex: Number(suiteIndex),
                setIndex: type === 'tmp' ? 'tmp' : Number(setIndex),
                timestamp: new Date().toISOString(),
                ccNumber: document.getElementById('ccNumber')?.value || '',
                projectName: document.getElementById('projectName')?.value || '',
                suiteName: document.getElementById(`suite${suiteIndex}_projectSuiteName`)?.value || '',
                docNo: docNoEl ? docNoEl.value : '',
                data,
                topLevel: topLevelDetails,
                suiteDetails,
                handoverInfo
            };
        }

function applySectionDataObject(suiteIndex, setIndex, type, sectionObj) {
    beginFileLoad(suiteIndex, setIndex, type);
    const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
    const data = sectionObj.data || {};

    try {
        // 1. Load Standard Fields
        Object.keys(data).forEach(key => {
            if (key.includes('_conflict_')) return; 
            if (key === 'docNo') return; 

            const fieldId = `${idPrefix}_${key}`;
            const value = data[key];
            
            // Try to find element by ID first
            let el = document.getElementById(fieldId);

            // If not found by ID, it might be a radio group (common for checklists)
            if (!el) {
                // Construct the name attribute expected for this key
                const radioName = fieldId; // The ID construction logic matches the Name logic in this form
                // Find the specific radio button with the saved value
                el = document.querySelector(`input[name="${radioName}"][value="${value}"]`);
            }

            if (el) {
                if (el.type === 'checkbox') {
                    el.checked = !!value;
                } else if (el.type === 'radio') {
                    el.checked = true;
                } else {
                    el.value = value || '';
                }
                // Trigger events to update UI (colors, dependent fields)
                el.dispatchEvent(new Event('input', { bubbles: true }));
                el.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });

        // 2. Force Generation of Conflict Inputs
        updateConflictCheckboxes();

        // 3. Load Flag Data
        Object.keys(data).forEach(key => {
            if (!key.includes('_conflict_')) return;
            const fieldId = `${idPrefix}_${key}`;
            const el = document.getElementById(fieldId);
            const value = data[key];
            if (!el) return;
            const shouldCheck = value === true || value === "true";
            el.checked = shouldCheck;
            syncConflictFieldState(el);
            if (shouldCheck) el.dispatchEvent(new Event('change', { bubbles: true }));
        });

        // 4. Restore Top-Level Details (Only if empty)
        const topLevelData = { ...(sectionObj.topLevel || {}) };
        if (!topLevelData.ccNumber && sectionObj.ccNumber) topLevelData.ccNumber = sectionObj.ccNumber;
        if (!topLevelData.projectName && sectionObj.projectName) topLevelData.projectName = sectionObj.projectName;

        Object.entries(topLevelData).forEach(([fieldId, value]) => {
            const field = document.getElementById(fieldId);
            if (field && !field.value.trim()) {
                field.value = value ?? '';
                field.dispatchEvent(new Event('input', { bubbles: true }));
            }
        });

        // 4b. Restore Suite Name (Critical for Naming) - Always restore from file
        if (sectionObj.suiteName) {
            const suiteNameField = document.getElementById(`suite${suiteIndex}_projectSuiteName`);
            if (suiteNameField) {
                suiteNameField.value = sectionObj.suiteName;
                suiteNameField.dispatchEvent(new Event('input', { bubbles: true }));
            }
            // Store in suite container dataset for reliable export filename generation
            const suiteContainerEl = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
            if (suiteContainerEl) {
                suiteContainerEl.dataset.suiteName = sectionObj.suiteName;
            }
            // Also store in the TGS/TMP container for backup access
            const sectionContainerEl = document.querySelector(
                type === 'tmp' 
                    ? `.tmp-set-container[data-suite-index="${suiteIndex}"]`
                    : `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`
            );
            if (sectionContainerEl) {
                sectionContainerEl.dataset.suiteName = sectionObj.suiteName;
            }
        }
        
        // 4c. Restore Suite Details (includes suite name if saved separately)
        if (sectionObj.suiteDetails) {
            Object.entries(sectionObj.suiteDetails).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field && value) {
                    field.value = value;
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        }

        // 5. Restore Doc No
        const docEl = document.getElementById(`${idPrefix}_docNo`);
        if (docEl && sectionObj.docNo) {
            docEl.value = sectionObj.docNo;
            docEl.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Also store docNo in container dataset for reliable export filename generation
        const sectionContainerSelector = type === 'tmp' ?
            `.tmp-set-container[data-suite-index="${suiteIndex}"]` :
            `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`;
        const sectionContainer = document.querySelector(sectionContainerSelector);
        if (sectionContainer && sectionObj.docNo) {
            sectionContainer.dataset.docNo = sectionObj.docNo;
        }

        // 6. Refresh UI
        setupLinkPreviews();
        debouncedSaveState();
        
        const containerSelector = type === 'tmp' ?
            `.tmp-set-container[data-suite-index="${suiteIndex}"]` :
            `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`;
        const container = document.querySelector(containerSelector);
        if (container) {
            container.classList.remove('focus-mode-off');
            applyFocusMode(suiteIndex, setIndex, type);
        }

        updateFormSetAccess();
        updateTgsStatusPills();
        updateGlobalNotifyButton();
        
        // Restore handover info to global store so it persists in subsequent saves
        if (sectionObj.handoverInfo) {
            if (!window._sectionHandoverInfo) window._sectionHandoverInfo = {};
            const sectionKey = `${suiteIndex}_${type === 'tmp' ? 'tmp' : setIndex}`;
            window._sectionHandoverInfo[sectionKey] = sectionObj.handoverInfo;
            
            // Show handover info modal to non-designers when loading a file
            const currentRole = document.getElementById('role')?.value;
            if (currentRole && currentRole !== 'designer') {
                displayHandoverInfo(sectionObj.handoverInfo, sectionObj.docNo || (type === 'tmp' ? 'TMP' : `TGS Set ${parseInt(setIndex, 10) + 1}`));
            }
        }
    } finally {
        endFileLoad();
    }
}

// Display handover info modal when loading a file (for non-designers)
function displayHandoverInfo(info, sectionName) {
    if (!info) return;
    
    const content = document.getElementById('handover-display-content');
    if (!content) return;
    
    const formatDate = (isoStr) => {
        if (!isoStr) return '';
        try {
            const d = new Date(isoStr);
            return d.toLocaleDateString('en-AU', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch { return isoStr; }
    };
    
    content.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                <span style="font-weight: 600; color: var(--heading-color);"> Section:</span>
                <span style="color: var(--text-color);">${sectionName}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: var(--heading-color);"> From:</span>
                <span style="color: var(--text-color);">${info.fromRole || 'Unknown'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: var(--heading-color);"> Total Suites:</span>
                <span style="color: var(--text-color); font-weight: 600; font-size: 1.1em;">${info.totalSuites || '-'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: var(--heading-color);"> Total TGS Sets:</span>
                <span style="color: var(--text-color); font-weight: 600; font-size: 1.1em;">${info.totalTGS || '-'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: var(--heading-color);"> Forwarded To:</span>
                <span style="color: var(--primary-color); font-weight: 600;">${info.forwardedTo || '-'}</span>
            </div>
            ${info.notes ? `
            <div style="margin-top: 8px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                <span style="font-weight: 600; color: var(--heading-color); display: block; margin-bottom: 6px;"> Notes:</span>
                <p style="margin: 0; color: var(--text-secondary); background: var(--card-background); padding: 10px; border-radius: 8px; font-style: italic;">${info.notes}</p>
            </div>
            ` : ''}
            <div style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary); text-align: right;">
                ${info.timestamp ? `Sent: ${formatDate(info.timestamp)}` : ''}
            </div>
        </div>
    `;
    
    // Show the modal after a short delay to let the form load
    setTimeout(() => {
        document.getElementById('handover-display-modal').style.display = 'flex';
        ModalFocusTrap.activate('handover-display-modal');
    }, 500);
}

// Close handover display modal
function closeHandoverDisplayModal() {
    document.getElementById('handover-display-modal').style.display = 'none';
    ModalFocusTrap.deactivate('handover-display-modal');
}

        async function exportSectionToFile(suiteIndex, setIndex, type = 'tgs') {
            const section = getSectionDataObject(suiteIndex, setIndex, type);
            if (!section) {
                alert('Section not found.');
                return;
            }
            const jsonContent = JSON.stringify(section, null, 2);
            if (!jsonContent || jsonContent.length < 50) {
                alert('Error: No data to save.');
                return;
            }

            // Helper to clean segments (spaces to hyphens)
            const cleanSeg = (s) => (s || '').toString().trim().replace(/[<>:"/\\|?*]+/g, '').replace(/\s+/g, '-').trim();
            
            // Context Data
            const currentRoleName = roles[currentRole]?.name || 'unsaved';
            const ccNumber = cleanSeg(document.getElementById('ccNumber')?.value) || 'CC-0000';
            const dateStr = new Date().toISOString().slice(0, 10);

            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const actionField = document.getElementById(`${idPrefix}_${currentRole}_action`);
            let toName = "Next Stage";
            
            if (actionField && actionField.value) {
                if (actionField.value.startsWith('pass_')) {
                    toName = roles[actionField.value.replace('pass_', '').replace(/_/g, '-')]?.name || toName;
                } else if (actionField.value.startsWith('send_back_')) {
                    toName = roles[actionField.value.replace('send_back_', '').replace(/_/g, '-')]?.name || toName;
                } else if (actionField.value === 'finalize') {
                    toName = "Final Archive";
                }
            }

            // Get container references
            const containerSelector = type === 'tmp' 
                ? `.tmp-set-container[data-suite-index="${suiteIndex}"]` 
                : `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`;
            const container = document.querySelector(containerSelector);
            const suiteContainer = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
            const suiteNameField = document.getElementById(`suite${suiteIndex}_projectSuiteName`);
            
            // Suite Name - check multiple sources in priority order
            let rawSuiteName = '';
            
            // 1. First check the TGS/TMP container dataset (set when file is loaded)
            if (container?.dataset?.suiteName?.trim()) {
                rawSuiteName = container.dataset.suiteName.trim();
            }
            // 2. Then check the section data object (from loaded JSON)
            else if (section.suiteName?.trim()) {
                rawSuiteName = section.suiteName.trim();
            }
            // 3. Then check the suite container dataset
            else if (suiteContainer?.dataset?.suiteName?.trim()) {
                rawSuiteName = suiteContainer.dataset.suiteName.trim();
            }
            // 4. Finally check the actual input field
            else if (suiteNameField?.value?.trim()) {
                rawSuiteName = suiteNameField.value.trim();
            }
            
            // Use user-entered value, or fallback to Suite-N format
            const suiteNo = cleanSeg(rawSuiteName) || `Suite-${Number(suiteIndex) + 1}`;

            // Build filename segments (CC + Suite)
            const segments = [ccNumber, suiteNo];

            // For TGS, add the TGS Set Name (TMP does not get an extra segment)
            if (type !== 'tmp') {
                let rawDocNo = '';
                if (container?.dataset?.docNo) {
                    rawDocNo = container.dataset.docNo;
                } else if (section.docNo) {
                    rawDocNo = section.docNo;
                } else {
                    rawDocNo = document.getElementById(`${idPrefix}_docNo`)?.value || '';
                }
                const tgsSetNo = cleanSeg(rawDocNo) || `TGS-${Number(setIndex) + 1}`;
                segments.push(tgsSetNo);
            }

            // Final Filename
            const filename = `${segments.join('_')}_from (${currentRoleName})_ to (${toName})_${dateStr}.json`;
            // console.log('Generated filename:', filename);

            const blob = new Blob([jsonContent], { type: 'application/json' });
            
            const clearManualSaveFlag = () => {
                if (container && container.dataset.manualSaveRequired) {
                    delete container.dataset.manualSaveRequired;
                    updateFormSetAccess();
                }
            };
            
            // Save File Picker Logic
            if (window.showSaveFilePicker && window.isSecureContext) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    showToast(`File saved: ${filename}`, 'Save Complete', 'success');
                    clearManualSaveFlag();
                    return;
                } catch (err) {
                    if (err.name !== 'AbortError') console.warn('Save picker failed, using download fallback:', err);
                    else return; // User cancelled
                }
            }
            
            // Fallback download
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            setTimeout(() => { document.body.removeChild(link); URL.revokeObjectURL(link.href); }, 100);
            showToast(`File saved: ${filename}`, 'Download Complete', 'success');
            clearManualSaveFlag();
        }

        function importSectionFromFile(suiteIndex, setIndex, type = 'tgs') {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            document.body.appendChild(input);

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) { 
                    if (document.body.contains(input)) document.body.removeChild(input);
                    return; 
                }

                const reader = new FileReader();
                reader.onload = (ev) => {
                    const content = ev.target.result;
                    if (!content || content.trim().length === 0) {
                        alert('Error: The file is empty.');
                        if (document.body.contains(input)) document.body.removeChild(input);
                        return;
                    }
                    
                    try {
                        const obj = JSON.parse(content);
                        let dataToLoad = null;

                        // SCENARIO 1: Specific Section File (Small file saved via "Save TMP" or "Save TGS")
                        if (obj && (obj.kind === 'tgs-section' || obj.kind === 'tmp-section')) {
                            const fileType = obj.type || (obj.kind === 'tmp-section' ? 'tmp' : 'tgs');

                            if (fileType !== type) {
                                alert(`Mismatch: You are trying to load a ${fileType.toUpperCase()} file into a ${type.toUpperCase()} section.`);
                                if (document.body.contains(input)) document.body.removeChild(input);
                                return;
                            }
                            
                            dataToLoad = obj;
                        }
                        // SCENARIO 2: Full Project File (Big file saved via global "Save Progress")
                        else if (obj.suites && Array.isArray(obj.suites)) {
                            const sourceSuite = obj.suites[suiteIndex] || obj.suites[0];
                            const topLevelFromFile = { ...(obj.topLevel || {}) };

                            if (sourceSuite) {
                                if (type === 'tmp') {
                                    // Extract TMP data
                                    if (sourceSuite.tmpSet && Object.keys(sourceSuite.tmpSet).length > 0) {
                                        dataToLoad = { 
                                            data: sourceSuite.tmpSet, 
                                            topLevel: topLevelFromFile,
                                            kind: 'tmp-section',
                                            suiteName: sourceSuite.suiteName || '',
                                            handoverInfo: sourceSuite.handoverInfo || null
                                        };
                                    }
                                } else {
                                    // Extract TGS data
                                    const targetSet = sourceSuite.formSets && sourceSuite.formSets[setIndex] 
                                        ? sourceSuite.formSets[setIndex]
                                        : (sourceSuite.formSets && sourceSuite.formSets.length > 0 ? sourceSuite.formSets[0] : null);
                                    
                                    if (targetSet) {
                                        // Extract docNo from the data if available
                                        const docNoFromData = targetSet.docNo || '';
                                        dataToLoad = { 
                                            data: targetSet, 
                                            topLevel: topLevelFromFile,
                                            kind: 'tgs-section',
                                            docNo: docNoFromData,
                                            suiteName: sourceSuite.suiteName || ''
                                        };
                                    }
                                }
                            }

                            if (!dataToLoad) {
                                alert(`Could not find ${type.toUpperCase()} data in this file for Suite ${parseInt(suiteIndex) + 1}.`);
                                if (document.body.contains(input)) document.body.removeChild(input);
                                return;
                            }
                        }
                        // SCENARIO 3: Check if it's top-level export from admin
                        else if (obj.selectedRole || obj.topLevel) {
                            // This is a full form export - load all data
                            populateFormFromDataObject(obj);
                            showToast('Project data loaded successfully', 'File Loaded', 'success');
                            if (document.body.contains(input)) document.body.removeChild(input);
                            return;
                        }

                        // Execute the load
                        if (dataToLoad) {
                            // Ensure TMP form exists if we're loading into TMP
                            if (type === 'tmp') {
                                const existing = document.querySelector(`.tmp-set-container[data-suite-index="${suiteIndex}"]`);
                                if (!existing) generateTMPForm(Number(suiteIndex), true, true);
                            }

                            applySectionDataObject(suiteIndex, setIndex, type, dataToLoad);

                            // Refresh UI for this section
                            debouncedUpdateFormSetAccess();
                            updateTgsStatusPills();
                            debouncedSaveState();

                            showToast(`${type.toUpperCase()} section loaded successfully`, 'File Loaded', 'success');
                        } else {
                            alert('Error: The file format is not recognized or does not contain compatible data.');
                        }

                    } catch (err) {
                        console.error('Import error:', err);
                        alert('Error loading file: ' + err.message);
                    } finally {
                        if (document.body.contains(input)) document.body.removeChild(input);
                    }
                };
                reader.readAsText(file);
            });

            input.click();
        }

        function generateFinalReport() {
    if (currentRole !== 'admin-final') {
        alert("Only the Admin Final role can finalize the report.");
        return;
    }

    // Check if there's any content to report
    const hasTGS = document.querySelectorAll('.tgs-set-container').length > 0;
    const hasTMP = document.querySelectorAll('.tmp-set-container').length > 0;

    if (!hasTGS && !hasTMP) {
        alert('Cannot generate report: No TMP or TGS sections have been created yet.\n\nPlease complete at least one section before finalizing.');
        return;
    }

    // Check if TGS sets are ready - Admin Final should have signed off on all
    let allReady = true;
    let missingSignoffs = [];
    
    document.querySelectorAll('.tgs-set-container').forEach(container => {
        const suiteIndex = container.dataset.suiteIndex;
        const setIndex = container.dataset.setIndex;
        const idPrefix = `suite${suiteIndex}_set${setIndex}`;
        
        // Check if admin-final was skipped (e.g., workflow went to earlier role)
        const wasAdminFinalSkipped = wasRoleSkipped(suiteIndex, setIndex, 'admin-final', 'tgs');
        
        // Only check admin-final sign-off if they weren't skipped
        if (!wasAdminFinalSkipped) {
            const adminFinalCheck = document.getElementById(`${idPrefix}_completion_check_admin-final`);
            
            if (!adminFinalCheck || !adminFinalCheck.checked) {
                allReady = false;
                const docNo = document.getElementById(`${idPrefix}_docNo`)?.value || `TGS Set ${parseInt(setIndex) + 1}`;
                missingSignoffs.push(docNo);
            }
        }
    });

    // Check TMP status only if NOT skipped AND Admin Final was part of the workflow
    document.querySelectorAll('.tmp-set-container').forEach(container => {
        const suiteIndex = container.dataset.suiteIndex;
        const isSkipped = document.getElementById(`suite${suiteIndex}_tmpSkipped`)?.value === "true";
        
        if (!isSkipped) {
            const idPrefix = `suite${suiteIndex}_tmp`;
            
            // Check if Admin Final was skipped in the TMP workflow
            const wasAdminFinalSkipped = wasRoleSkipped(suiteIndex, 'tmp', 'admin-final', 'tmp');
            
            if (!wasAdminFinalSkipped) {
                const adminFinalCheck = document.getElementById(`${idPrefix}_completion_check_admin-final`);
                
                if (!adminFinalCheck || !adminFinalCheck.checked) {
                    allReady = false;
                    const docNo = document.getElementById(`${idPrefix}_docNo`)?.value || 'TMP';
                    missingSignoffs.push(docNo);
                }
            }
        }
    });

    if (!allReady) {
        const missingSections = missingSignoffs.join(', ');
        alert(`Cannot finalize report. The following sections require Admin Final sign-off:\n\n${missingSections}\n\nNote: If intermediate roles (Admin Intermediate, QA, TMD) were skipped in the workflow, they will be marked as "Skipped" in the final report, which is acceptable.\n\nPlease complete all required sign-offs before generating the final report.`);
        return;
    }

    if (!confirm("Are you sure you want to finalize this report? This will hide the form and display the final summary.")) return;

    // Hide the form and show the final summary
    document.getElementById('form-wrapper').style.display = 'none';
    const summaryContainer = document.getElementById('final-summary-container');

    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) themeToggle.style.display = 'none';

    let reportHTML = `<div class="no-print" style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <button class="btn btn-secondary" onclick="document.getElementById('form-wrapper').style.display='block'; document.getElementById('final-summary-container').innerHTML=''; const tt=document.getElementById('theme-toggle'); if(tt) tt.style.display='flex';" title="Return to the checklist editor">Back to Edit</button>
        <button class="btn btn-primary btn-print-report" onclick="window.print()" title="Print the final summary report">Print Report</button>
    </div>`;
    
    reportHTML += `<div class="company-header">Crompton Concepts</div><h2>TMP & TGS Workflow Final Report</h2>`;

    // Project Info
    reportHTML += `<div class="summary-section"><h3>Project Information</h3><div class="summary-details-grid">
        <p><strong>CC Number:</strong> ${document.getElementById('ccNumber').value || 'N/A'}</p>
        <p><strong>Project Name:</strong> ${document.getElementById('projectName').value || 'N/A'}</p>
        <p><strong>Project Location:</strong> ${document.getElementById('projectLocation').value || 'N/A'}</p>
        <p><strong>Nature of Job:</strong> ${document.getElementById('jobNature').value || 'N/A'}</p>
        <p><strong>Client Info:</strong> ${document.getElementById('clientInfo').value || 'N/A'}</p>
    </div></div>`;

    // Loop through suites
    document.querySelectorAll('.project-suite-container').forEach((suiteContainer) => {
        const suiteIndex = suiteContainer.dataset.suiteIndex;
        const suiteName = document.getElementById(`suite${suiteIndex}_projectSuiteName`)?.value || `Project Suite ${parseInt(suiteIndex) + 1}`;
        reportHTML += `<div class="summary-section" style="page-break-before: always;"><h2>Summary for: ${suiteName}</h2></div>`;

        // --- TMP LOGIC START ---
        const isTmpSkipped = document.getElementById(`suite${suiteIndex}_tmpSkipped`)?.value === "true";

        if (!isTmpSkipped) {
            // Only render if the container exists (meaning it was initialized)
            if (suiteContainer.querySelector('.tmp-set-container')) {
                reportHTML += renderChecklistSummary(suiteIndex, 'tmp', 'tmp');
            } else {
                // Optional: Indicate it wasn't initialized if not skipped
                reportHTML += `<div style="padding:15px; border-bottom:1px solid var(--border-color);">Traffic Management Plan (TMP): Not Initialized</div>`;
            }
        } else {
            // Render skipped message
            reportHTML += `<div style="padding:15px 20px; background-color:var(--surface-muted); border:1px solid var(--border-color); border-radius:8px; margin-bottom:20px; font-style:italic;">
                <strong>Traffic Management Plan (TMP):</strong> Not Required / Skipped for this suite.
            </div>`;
        }
        // --- TMP LOGIC END ---

        // Render TGS sets
        suiteContainer.querySelectorAll('.tgs-set-container').forEach(tgsContainer => {
            reportHTML += renderChecklistSummary(suiteIndex, tgsContainer.dataset.setIndex, 'tgs');
        });
    });

    summaryContainer.innerHTML = reportHTML;
    summaryContainer.style.display = 'block';
    window.scrollTo(0, 0);
}

        function renderChecklistSummary(suiteIndex, setIndex, type) {
            const idPrefix = `suite${suiteIndex}_${type === 'tmp' ? 'tmp' : `set${setIndex}`}`;
            const docNo = document.getElementById(`${idPrefix}_docNo`)?.value || (type === 'tmp' ? 'TMP' : `TGS Set ${parseInt(setIndex) + 1}`);
            const headerTitle = type === 'tmp' ? 'Traffic Management Plan (TMP) Summary' : `Traffic Guidance Scheme (TGS) Summary: ${docNo}`;
            const reviewVersion = Math.max(1, parseInt(document.getElementById(`${idPrefix}_reviewVersion`)?.value, 10) || 1);
            const escapeHtml = (value) => String(value || '').replace(/[&<>"']/g, (char) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char] || char));

            let summaryHTML = `<div class="summary-section" style="page-break-before: always; page-break-inside: avoid;"><h3 style="background: var(--primary-light); padding: 10px; border-radius: 8px;">${headerTitle}</h3>`;
            summaryHTML += `<div class="version-pill" aria-label="Current version">Current Version: <strong>V${reviewVersion}</strong></div>`;

            // Sign-offs
            summaryHTML += `<h4>Sign-Offs & Documents</h4><table class="checklist-summary-table"><thead><tr><th>Role</th><th>Signed Off By</th><th>Date</th><th>Document Link</th><th>Action Taken</th></tr></thead><tbody>`;
            for (const roleKey in roles) {
                const signoffName = document.getElementById(`${idPrefix}_signoff_name_${roleKey}`)?.value;
                if (signoffName) {
                    let nameCell = signoffName;
                    if (roleKey === 'tmd') nameCell += ` (TMD No: ${document.getElementById(`${idPrefix}_signoff_tmd_number_tmd`)?.value || 'N/A'})`;

                    const roleNameForId = roleKey.charAt(0).toUpperCase() + roleKey.slice(1).replace('-intermediate', 'Intermediate').replace('-final', 'Final');
                    const linkValue = document.getElementById(`${idPrefix}_tgsFileLink${roleNameForId}`)?.value;
                    const linkCell = linkValue ? `<a href="${linkValue}" target="_blank" rel="noopener noreferrer" style="color: ${roles[roleKey].color}; word-break: break-all;">View Document</a>` : 'N/A';
                    const actionTaken = document.getElementById(`${idPrefix}_${roleKey}_action`)?.value.replace(/_/g, ' ') || 'N/A';

                    summaryHTML += `<tr><td style="color: ${roles[roleKey].color};">${roles[roleKey].name}</td><td>${nameCell}</td><td>${document.getElementById(`${idPrefix}_signoff_date_${roleKey}`)?.value || 'N/A'}</td><td>${linkCell}</td><td style="text-transform: capitalize;">${actionTaken}</td></tr>`;
                } else {
                    // Check if role was skipped
                    const wasSkippedStatus = wasRoleSkipped(suiteIndex, setIndex, roleKey, type);
                    summaryHTML += `<tr><td style="color: ${roles[roleKey].color};">${roles[roleKey].name}</td><td colspan="4" style="text-align:center; ${wasSkippedStatus ? 'font-style:italic; opacity:0.7;' : ''}">${wasSkippedStatus ? ' Skipped' : 'Pending'}</td></tr>`;
                }
            }
            summaryHTML += `</tbody></table>`;

            const historyEntries = getHistoryLog(suiteIndex, setIndex, type) || [];
            if (historyEntries.length) {
                summaryHTML += `<div class="history-log" style="margin-top:20px;">
                    <strong>Version History</strong>
                    <ul>`;
                historyEntries.forEach(entry => {
                    const date = escapeHtml(entry.date || entry.timestamp || 'N/A');
                    const message = escapeHtml(entry.message || 'Update recorded.');
                    summaryHTML += `<li><span style="font-weight:600;">${date}</span> &mdash; ${message}</li>`;
                });
                summaryHTML += `</ul>
                </div>`;
            }

            // Checklist Questions
            summaryHTML += `<h4>Checklist Details</h4><table class="checklist-summary-table"><thead><tr><th class="question-col">Question</th>`;
            Object.keys(roles).forEach(roleKey => { summaryHTML += `<th class="status-col">${roles[roleKey].name}</th>`; });
            summaryHTML += `<th class="comments-col">Comments</th></tr></thead><tbody>`;

            let qIndex = 1;
            for (const sectionTitle in checklistData) {
                summaryHTML += `<tr><td colspan="${Object.keys(roles).length + 2}" style="background-color: var(--primary-light); font-weight: bold;">${sectionTitle}</td></tr>`;
                checklistData[sectionTitle].forEach(question => {
                    const qIdPrefix = `${idPrefix}_q${qIndex}`;
                    summaryHTML += `<tr><td class="question-col">${qIndex}. ${question}</td>`;
                    for (const roleKey in roles) {
                        const checkedValue = document.querySelector(`input[name="${qIdPrefix}_${roleKey}_check"]:checked`)?.value;
                        let statusSymbol = ``;
                        if (checkedValue === 'yes') statusSymbol = `<span style="color: var(--success-color);"></span>`;
                        else if (checkedValue === 'no') statusSymbol = `<span style="color: var(--danger-color);"></span>`;
                        else if (checkedValue === 'na') statusSymbol = `<span style="color: var(--warning-color);">N/A</span>`;
                        summaryHTML += `<td class="status-col">${statusSymbol}</td>`;
                    }
                    summaryHTML += `<td class="comments-col">`;
                    let hasComments = false;
                    for (const roleKey in roles) {
                        const comment = document.getElementById(`${qIdPrefix}_${roleKey}_comments`)?.value;
                        if (comment) {
                            hasComments = true;
                            summaryHTML += `<div class="summary-comment-block"><strong>${roles[roleKey].name}:</strong> ${comment.replace(/\n/g, '<br>')}</div>`;
                        }
                    }
                    if (!hasComments) summaryHTML += '';
                    summaryHTML += `</td></tr>`;
                    qIndex++;
                });
            }
            summaryHTML += `</tbody></table></div>`;
            return summaryHTML;
        }

        function createSuiteHTML(suiteIndex) {
    return `
        <article class="project-suite-container" data-suite-index="${suiteIndex}">
            <h2 class="project-suite-title">Project Suite ${suiteIndex + 1}</h2>
            
            <!-- 1. Project Details -->
            <div class="question-block">
                <label for="suite${suiteIndex}_projectSuiteName">Project Suite Name/Number:</label>
                <textarea class="form-field suite-level-field role-designer" id="suite${suiteIndex}_projectSuiteName"></textarea>
            </div>

            <!-- 2. TMP Section -->
            <section class="tmp-container" data-suite-index="${suiteIndex}" style="margin-top: 30px; padding-bottom: 30px; border-bottom: 2px dashed var(--border-color);" aria-label="Traffic Management Plan">
                <div class="tmp-header">
                    <h3 class="tmp-suite-title">Step 1: Traffic Management Plan (TMP)</h3>
                    <span style="font-size: 0.9em; opacity: 0.8;">(Optional)</span>
                </div>
                
                <!-- TMP Instructions -->
                <div class="workflow-instruction-box highlight no-print" style="margin: 15px 0;">
                    <h4 class="instruction-title"> TMP Workflow</h4>
                    <p><strong>Designer:</strong> Click "Initialize TMP Section" to create the TMP checklist, or "Skip to TGS" if no TMP is needed.</p>
                    <p style="margin-top: 6px;"><strong>Reviewer:</strong> Initialize the section first, then use "Load TMP File" inside to import the progress file.</p>
                </div>
                
                <div class="tmp-toggle-section" id="suite${suiteIndex}_tmp_toggle_section">
                    <div id="suite${suiteIndex}_tmp_ready_banner" class="tmp-ready-banner no-print" aria-live="polite" style="margin: 8px 0 12px; padding: 10px 12px; border-radius: 6px; font-size: 0.95em;"></div>
                    
                    <div class="tmp-actions" style="display: flex; gap: 15px; align-items: center; margin-top: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-primary generate-tmp-btn" onclick="generateTMPFormSafe(${suiteIndex})">
                            Initialize TMP Section
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="skipTMP(${suiteIndex})" style="font-size: 0.9em;">
                            No TMP Required (Skip to TGS)
                        </button>
                    </div>
                </div>
                <div class="tmp-checklist" id="tmp-checklist-suite-${suiteIndex}" style="display:none;"></div>
            </section>

            <!-- 3. TGS Section (NEW LAZY LOADING STRUCTURE) -->
            <section id="tgs-section-wrapper-${suiteIndex}" style="display:none; opacity: 0; transition: opacity 1s ease-in;" aria-label="Traffic Guidance Schemes">
                <div style="margin: 40px 0 20px; padding: 20px; background: var(--surface-elevated); border-radius: 12px; border: 1px solid var(--border-color);">
                    <h3 style="margin-top: 0;">Step 2: Traffic Guidance Schemes (TGS)</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Each TGS set is created independently. Start with the first set below, then add more as needed.
                    </p>
                    
                    <!-- Add TGS Set Button -->
                    <button type="button" class="btn btn-success add-tgs-set-btn" 
                            onclick="addNewLazyTGSSet(${suiteIndex})"
                            style="display: flex; align-items: center; gap: 8px;">
                        <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24"><use href="#icon-plus"></use></svg>
                        <span>Add TGS Set</span>
                    </button>
                </div>
                
                <!-- Instruction Box -->
                <div class="workflow-instruction-box info no-print" style="margin: 0 0 20px;">
                    <h4 class="instruction-title"> How to use TGS Sets:</h4>
                    <ol>
                        <li><strong>Add a TGS Set</strong>  Click the button above to create a new empty checklist for each TGS drawing.</li>
                        <li><strong>Load an existing file</strong>  Use the "Load TGS File" button inside each set to import a previously saved JSON file.</li>
                        <li><strong>Copy from another set</strong>  After loading the first file, use "Copy From Another Set" to duplicate answers to additional sets (then edit as needed).</li>
                    </ol>
                </div>

                <!-- Container for TGS Sets -->
                <div id="multi-tgs-container-suite-${suiteIndex}" class="tgs-lazy-container">
                    <!-- TGS sets will be added here dynamically -->
                </div>
            </section>
        </article>`;
}

        function generateTMPForm(suiteIndex, _skipConfirm = false, skipGuard = false) {
            // Backwards-compatible wrapper while newer safe generator is in use
            return generateTMPFormSafe(suiteIndex, skipGuard);
        }

        function generateTMPFormSafe(suiteIndex, skipGuard = false) {
            const tmpContainer = document.getElementById(`tmp-checklist-suite-${suiteIndex}`);
            if (!tmpContainer) return;

            // 1. Reveal the TGS Section (Unlock Workflow)
            const tgsWrapper = document.getElementById(`tgs-section-wrapper-${suiteIndex}`);
            if (tgsWrapper) {
                tgsWrapper.style.display = 'block';
                // Small timeout to allow display:block to apply before opacity transition
                setTimeout(() => { tgsWrapper.style.opacity = '1'; }, 50);
            }

            // 2. Check if TMP already exists (Don't regenerate HTML if it does)
            if (tmpContainer.innerHTML.trim() !== "") {
                tmpContainer.style.display = 'block';
                return;
            }

            const currentRole = document.getElementById('role')?.value;

            // 3. Role check for new generation
            if (!skipGuard && currentRole !== 'designer') {
                const proceed = confirm('As a reviewer, you will generate an empty TMP section structure so you can load your file. Proceed?');
                if (!proceed) return;
            }

            // 4. Build TMP HTML (Note the onclick handler for loading)
            const tmpHTML = `
        <div class="tmp-set-container" data-suite-index="${suiteIndex}" data-set-index="tmp" data-type="tmp">
            <div class="focus-mode-status-pill" aria-live="polite">Normal Mode</div>
            <div class="focus-mode-banner" style="display: none;"></div>
            <button type="button" class="btn btn-warning conflict-review-btn no-print" onclick="openConflictReview(${suiteIndex}, 'tmp', 'tmp')" style="margin-bottom:10px;">Review Flagged Items</button>
            <div class="progress-bar-container no-print">
                <div class="progress-bar" id="suite${suiteIndex}_progress-bar-tmp">0%</div>
            </div>
            
            <div class="section-save-load no-print" style="margin: 15px 0 25px; padding: 12px 20px; background: var(--surface-elevated); border-radius: 50px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="background: var(--primary-light); color: var(--primary-dark); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                    <div>
                        <strong style="color: var(--heading-color); font-size: 1em;">TMP Actions</strong>
                        <span style="color: var(--text-secondary); font-size: 0.9em; margin-left: 8px;">Load existing TMP file if available.</span>
                    </div>
                </div>
                <div>
                    <button type="button" class="btn btn-load section-load-btn" data-type="tmp" onclick="handleTMPLoadSafe(this)" data-suite-index="${suiteIndex}" style="border-radius: 20px; padding: 8px 20px;">
                        <svg><use href="#icon-upload"></use></svg><span> Load TMP File</span>
                    </button>
                </div>
            </div>

            <h2 class="tmp-set-header no-print">Traffic Management Plan</h2>
            
            ${buildChecklist(suiteIndex, 'tmp', 'tmp')}
            ${buildSignOffSection(suiteIndex, 'tmp', 'tmp')}
        </div>`;

            tmpContainer.innerHTML = tmpHTML;
            tmpContainer.style.display = 'block';
            const tmpSet = tmpContainer.querySelector('.tmp-set-container');
            registerLazySection(tmpSet);

            // 5. Add hidden marker field
            const markerId = `suite${suiteIndex}_tmpEnabled`;
            if (!document.getElementById(markerId)) {
                const tmpEnabledField = document.createElement('input');
                tmpEnabledField.type = 'hidden';
                tmpEnabledField.className = 'suite-level-field';
                tmpEnabledField.id = markerId;
                tmpEnabledField.value = 'true';
                tmpContainer.parentElement.insertBefore(tmpEnabledField, tmpContainer);
            }

            setupAllEventListeners();
            handleRoleSelection(true);
            scheduleSectionNavigatorRefresh();
            // Let user manually add TGS sets
        }

        function skipTMP(suiteIndex, isRestore = false) {
            if (!isRestore && !confirm("Are you sure you want to skip the TMP section? This will mark it as 'Not Required'.")) return;

            const suiteContainer = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
            const tmpToggle = document.getElementById(`suite${suiteIndex}_tmp_toggle_section`);
            const tmpBanner = document.getElementById(`suite${suiteIndex}_tmp_ready_banner`);
            const tgsWrapper = document.getElementById(`tgs-section-wrapper-${suiteIndex}`);

            // 1. Hide Actions
            if (tmpToggle) {
                const actions = tmpToggle.querySelector('.tmp-actions');
                if (actions) actions.style.display = 'none';
            }

            // 2. Show Banner
            if (tmpBanner) {
                tmpBanner.innerHTML = `<strong>TMP Skipped:</strong> Traffic Management Plan is not required for this suite.`;
                tmpBanner.className = 'tmp-ready-banner skipped no-print';
                tmpBanner.style.display = 'block';
            }

            // 3. Set Hidden Input (ensure it has suite-level-field class for persistence)
            let skippedInput = document.getElementById(`suite${suiteIndex}_tmpSkipped`);
            if (!skippedInput) {
                skippedInput = document.createElement('input');
                skippedInput.type = 'hidden';
                skippedInput.id = `suite${suiteIndex}_tmpSkipped`;
                skippedInput.className = 'suite-level-field form-field'; // Added form-field for consistency
                if (suiteContainer) suiteContainer.appendChild(skippedInput);
            } else {
                // Ensure class is present even if input already exists
                if (!skippedInput.classList.contains('suite-level-field')) {
                    skippedInput.classList.add('suite-level-field', 'form-field');
                }
            }
            skippedInput.value = "true";

            // 4. Unlock TGS
            if (tgsWrapper) {
                tgsWrapper.style.display = 'block';
                setTimeout(() => { tgsWrapper.style.opacity = '1'; }, 50);

                // 5. Scroll to TGS (Only if not restoring)
                if (!isRestore) {
                    tgsWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                // Let user manually add TGS sets
            }
        }

        function handleTMPLoadSafe(btn) {
            const suiteIndex = parseInt(btn.dataset.suiteIndex, 10);
            if (Number.isNaN(suiteIndex)) {
                alert('Unable to determine which suite to load the TMP into.');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            document.body.appendChild(input);

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) { document.body.removeChild(input); return; }

                const reader = new FileReader();
                reader.onload = (ev) => {
                    const content = ev.target.result;
                    if (!content || content.trim().length === 0) {
                        alert('Error: The file is empty.');
                        return;
                    }
                    try {
                        const json = JSON.parse(content);
                        let sectionObj = null;

                        if (json && (json.kind === 'tmp-section' || json.type === 'tmp')) {
                            console.log('Loading TMP section file, handoverInfo:', json.handoverInfo);
                            sectionObj = {
                                kind: 'tmp-section',
                                type: 'tmp',
                                data: json.data || json.tmpSet || {},
                                topLevel: json.topLevel || {},
                                ccNumber: json.ccNumber || json.topLevel?.ccNumber || '',
                                projectName: json.projectName || json.topLevel?.projectName || '',
                                handoverInfo: json.handoverInfo || null,
                                suiteName: json.suiteName || ''
                            };
                        } else if (json?.suites && Array.isArray(json.suites)) {
                            const sourceSuite = json.suites[suiteIndex] || json.suites[0];
                            console.log('Loading from full project file, sourceSuite handoverInfo:', sourceSuite?.handoverInfo);
                            if (sourceSuite?.tmpSet) {
                                sectionObj = {
                                    kind: 'tmp-section',
                                    type: 'tmp',
                                    data: sourceSuite.tmpSet,
                                    topLevel: json.topLevel || {},
                                    ccNumber: json.topLevel?.ccNumber || json.ccNumber || '',
                                    projectName: json.topLevel?.projectName || json.projectName || '',
                                    handoverInfo: sourceSuite.handoverInfo || null,
                                    suiteName: sourceSuite.suiteName || ''
                                };
                            }
                        }

                        if (!sectionObj || !sectionObj.data || Object.keys(sectionObj.data).length === 0) {
                            alert('No TMP data found in this file.');
                            return;
                        }

                        // DO NOT unlock TGS when loading TMP - let user manually add TGS sets

                        applySectionDataObject(suiteIndex, 'tmp', 'tmp', sectionObj);
                        
                        // CRITICAL: Store suite name in dataset for reliable export filename generation
                        if (sectionObj.suiteName) {
                            const suiteContainer = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
                            if (suiteContainer) {
                                suiteContainer.dataset.suiteName = sectionObj.suiteName;
                            }
                            const suiteNameField = document.getElementById(`suite${suiteIndex}_projectSuiteName`);
                            if (suiteNameField) {
                                suiteNameField.value = sectionObj.suiteName;
                                suiteNameField.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }
                        
                        alert('TMP section loaded successfully.');

                    } catch (err) {
                        console.error(err);
                        alert('Error parsing file: ' + err.message);
                    } finally {
                        if (document.body.contains(input)) {
                            document.body.removeChild(input);
                        }
                    }
                };
                reader.readAsText(file);
            });

            input.click();
        }

        function handleTGSLoadSingleFile(suiteIndex) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.multiple = false; // Single file only
            input.style.display = 'none';
            document.body.appendChild(input);

            input.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) { 
                    if (document.body.contains(input)) document.body.removeChild(input);
                    return; 
                }

                // Helper to read the file
                const readFile = (file) => new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => resolve({ name: file.name, content: ev.target.result, success: true });
                    reader.onerror = () => resolve({ name: file.name, success: false });
                    reader.readAsText(file);
                });

                try {
                    const result = await readFile(file);
                    
                    if (!result.success || !result.content || result.content.trim().length === 0) {
                        alert('Error: The file is empty or unreadable.');
                        return;
                    }

                    let json;
                    try {
                        json = JSON.parse(result.content);
                    } catch (err) {
                        alert(`Error: Invalid JSON file. ${err.message}`);
                        return;
                    }

                    let fileSets = [];
                    let extractedSuiteName = null;

                    // Extraction Logic - preserve suiteName and docNo
                    if (json.suites && json.suites[suiteIndex] && json.suites[suiteIndex].formSets) {
                        const sourceSuite = json.suites[suiteIndex];
                        extractedSuiteName = sourceSuite.suiteName || '';
                        fileSets = sourceSuite.formSets.map(fs => ({
                            data: fs.data || fs,
                            docNo: fs.docNo || '',
                            suiteName: sourceSuite.suiteName || ''
                        }));
                    } else if (json.suites && json.suites[0] && json.suites[0].formSets) {
                        const sourceSuite = json.suites[0];
                        extractedSuiteName = sourceSuite.suiteName || '';
                        fileSets = sourceSuite.formSets.map(fs => ({
                            data: fs.data || fs,
                            docNo: fs.docNo || '',
                            suiteName: sourceSuite.suiteName || ''
                        }));
                    } else if (json.formSets) {
                        extractedSuiteName = json.suiteName || '';
                        fileSets = json.formSets.map(fs => ({
                            data: fs.data || fs,
                            docNo: fs.docNo || '',
                            suiteName: json.suiteName || ''
                        }));
                    } else if (json.kind === 'tgs-section' && json.data) {
                        extractedSuiteName = json.suiteName || '';
                        fileSets = [{
                            data: json.data,
                            docNo: json.docNo || '',
                            suiteName: json.suiteName || '',
                            topLevel: json.topLevel || {}
                        }];
                    } else if (json.data) {
                        extractedSuiteName = json.suiteName || '';
                        fileSets = [{
                            data: json.data,
                            docNo: json.docNo || '',
                            suiteName: json.suiteName || ''
                        }];
                    }

                    if (fileSets.length === 0) {
                        alert("No valid TGS data found in the selected file.");
                        return;
                    }

                    // Check if data exists
                    const container = document.getElementById(`multi-tgs-container-suite-${suiteIndex}`);
                    const existingCount = container ? container.querySelectorAll('.tgs-set-container').length : 0;
                    
                    // If sets already exist, offer to preserve them and load into specific sets
                    if (existingCount > 0) {
                        const confirmMsg = fileSets.length === 1 
                            ? `You have ${existingCount} existing TGS set(s). Do you want to:\n\nOK = Load this file into the FIRST EMPTY set\nCancel = Replace ALL ${existingCount} set(s) with this new data`
                            : `This file contains ${fileSets.length} sets. You have ${existingCount} existing set(s).\n\nOK = Replace ALL existing sets\nCancel = Keep existing sets`;
                        
                        const loadIntoEmpty = confirm(confirmMsg);
                        
                        if (fileSets.length === 1 && loadIntoEmpty) {
                            // Load into first empty set
                            beginFileLoad();
                            try {
                                let targetSetIndex = -1;
                                
                                // Find first empty set (no docNo value)
                                for (let i = 0; i < existingCount; i++) {
                                    const docNoField = document.getElementById(`suite${suiteIndex}_set${i}_docNo`);
                                    if (!docNoField || !docNoField.value.trim()) {
                                        targetSetIndex = i;
                                        break;
                                    }
                                }
                                
                                // If all sets are filled, create a new one
                                if (targetSetIndex === -1) {
                                    targetSetIndex = existingCount;
                                    addNewTgsSetForReview(suiteIndex, { skipPrompt: true });
                                }
                                
                                // Load into that specific set - fileSets[0] already has proper structure
                                applySectionDataObject(suiteIndex, targetSetIndex, 'tgs', fileSets[0]);
                                
                                // Also restore suite name if available
                                if (extractedSuiteName) {
                                    const suiteNameField = document.getElementById(`suite${suiteIndex}_projectSuiteName`);
                                    if (suiteNameField) {
                                        suiteNameField.value = extractedSuiteName;
                                        suiteNameField.dispatchEvent(new Event('input', { bubbles: true }));
                                    }
                                    // Store in dataset for reliable export filename generation
                                    const suiteContainer = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
                                    if (suiteContainer) {
                                        suiteContainer.dataset.suiteName = extractedSuiteName;
                                    }
                                    // Also store in the TGS container
                                    const tgsContainer = document.querySelector(`.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${targetSetIndex}"]`);
                                    if (tgsContainer) {
                                        tgsContainer.dataset.suiteName = extractedSuiteName;
                                    }
                                }
                                
                                updateFormSetAccess();
                                updateTgsStatusPills();
                                showToast(`Loaded TGS data into Set ${targetSetIndex + 1}.`, 'File Loaded', 'success');
                            } finally {
                                endFileLoad();
                            }
                            return;
                        } else if (!loadIntoEmpty) {
                            return; // User cancelled
                        }
                    }

                    // Replace ALL existing sets with the loaded file data
                    beginFileLoad();
                    try {
                        const count = fileSets.length;
                        const countInput = document.getElementById(`suite${suiteIndex}_calculatedFormSetsCount`);
                        const manualCountInput = document.getElementById(`suite${suiteIndex}_formSetsCount`);

                        if (countInput) countInput.value = count;
                        if (manualCountInput) manualCountInput.value = count;

                        // Update radio buttons for UI consistency
                        const yesRadio = document.getElementById(`suite${suiteIndex}_singleFormSet_yes`);
                        const noRadio = document.getElementById(`suite${suiteIndex}_singleFormSet_no`);
                        if (count > 1) {
                            if (noRadio) noRadio.checked = true;
                            handleSuiteFormSetSelector({ currentTarget: noRadio });
                        } else {
                            if (yesRadio) yesRadio.checked = true;
                            handleSuiteFormSetSelector({ currentTarget: yesRadio });
                        }

                        generateFormSets(suiteIndex);

                        // Populate the data - ensure DOM elements exist before applying
                        for (let i = 0; i < fileSets.length; i++) {
                            const setData = fileSets[i];
                            
                            // Check if set index exists in DOM
                            let targetSet = document.querySelector(`.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${i}"]`);
                            
                            if (!targetSet) {
                                // Dynamically add the set if it doesn't exist
                                addNewLazyTGSSet(suiteIndex, { skipPrompt: true, suggestedName: setData.docNo || `TGS Set ${i + 1}` });
                                // Small delay to ensure DOM render
                                await new Promise(r => setTimeout(r, 50));
                            }
                            
                            // NOW apply data - setData already has proper structure with data, docNo, suiteName
                            applySectionDataObject(suiteIndex, i, 'tgs', setData);
                        }
                        
                        // Restore suite name if extracted
                        if (extractedSuiteName) {
                            const suiteNameField = document.getElementById(`suite${suiteIndex}_projectSuiteName`);
                            if (suiteNameField) {
                                suiteNameField.value = extractedSuiteName;
                                suiteNameField.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                            // Store in dataset for reliable export filename generation
                            const suiteContainer = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
                            if (suiteContainer) {
                                suiteContainer.dataset.suiteName = extractedSuiteName;
                            }
                            // Also store in all TGS containers in this suite
                            document.querySelectorAll(`.tgs-set-container[data-suite-index="${suiteIndex}"]`).forEach(tgsContainer => {
                                tgsContainer.dataset.suiteName = extractedSuiteName;
                            });
                        }

                        // Refresh UI
                        updateFormSetAccess();
                        updateTgsStatusPills();
                        showToast(`Successfully loaded ${count} TGS set(s).`, 'File Loaded', 'success');
                    } finally {
                        endFileLoad();
                    }

                } catch (err) {
                    console.error(err);
                    alert('Error processing file: ' + err.message);
                } finally {
                    if (document.body.contains(input)) document.body.removeChild(input);
                }
            });
            input.click();
        }

        function handleTGSLoadSafe(suiteIndex) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.multiple = true; // Allow multiple files
            input.style.display = 'none';
            document.body.appendChild(input);

            input.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) { document.body.removeChild(input); return; }

                // Helper to read a single file
                const readFile = (file) => new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => resolve({ name: file.name, content: ev.target.result, success: true });
                    reader.onerror = () => resolve({ name: file.name, success: false });
                    reader.readAsText(file);
                });

                try {
                    const results = await Promise.all(files.map(readFile));
                    let allFormSets = [];
                    let successCount = 0;
                    let topLevelData = null;

                    let extractedSuiteName = null;
                    
                    for (const result of results) {
                        if (!result.success || !result.content || result.content.trim().length === 0) {
                            console.warn(`Skipping empty or unreadable file: ${result.name}`);
                            continue;
                        }

                        try {
                            const json = JSON.parse(result.content);
                            let fileSets = [];

                            // Extraction Logic - handle various export formats
                            if (json.suites && json.suites[suiteIndex] && json.suites[suiteIndex].formSets) {
                                const sourceSuite = json.suites[suiteIndex];
                                fileSets = sourceSuite.formSets.map(fs => ({
                                    data: fs.data || fs,
                                    docNo: fs.docNo || '',
                                    suiteName: sourceSuite.suiteName || '',
                                    topLevel: json.topLevel || json.projectDetails || {}
                                }));
                                if (!extractedSuiteName) extractedSuiteName = sourceSuite.suiteName;
                                if (!topLevelData && json.projectDetails) topLevelData = json.projectDetails;
                            } else if (json.suites && json.suites[0] && json.suites[0].formSets) {
                                const sourceSuite = json.suites[0];
                                fileSets = sourceSuite.formSets.map(fs => ({
                                    data: fs.data || fs,
                                    docNo: fs.docNo || '',
                                    suiteName: sourceSuite.suiteName || '',
                                    topLevel: json.topLevel || json.projectDetails || {}
                                }));
                                if (!extractedSuiteName) extractedSuiteName = sourceSuite.suiteName;
                                if (!topLevelData && json.projectDetails) topLevelData = json.projectDetails;
                            } else if (json.formSets) {
                                fileSets = json.formSets.map(fs => ({
                                    data: fs.data || fs,
                                    docNo: fs.docNo || '',
                                    suiteName: json.suiteName || '',
                                    topLevel: json.topLevel || {}
                                }));
                                if (!extractedSuiteName && json.suiteName) extractedSuiteName = json.suiteName;
                            } else if (json.kind === 'tgs-section' && json.data) {
                                // Single TGS section export - keep full object with data, topLevel, etc.
                                fileSets = [json];
                                if (!extractedSuiteName && json.suiteName) extractedSuiteName = json.suiteName;
                                if (!topLevelData && json.topLevel) topLevelData = json.topLevel;
                            } else if (json.data) {
                                // Direct data object - wrap with metadata
                                fileSets = [{
                                    data: json.data,
                                    docNo: json.docNo || '',
                                    suiteName: json.suiteName || '',
                                    topLevel: json.topLevel || {}
                                }];
                                if (!extractedSuiteName && json.suiteName) extractedSuiteName = json.suiteName;
                            }

                            if (fileSets.length > 0) {
                                allFormSets.push(...fileSets);
                                successCount++;
                            }
                        } catch (err) {
                            console.warn(`Skipping invalid JSON in ${result.name}: ${err.message}`);
                        }
                    }

                    if (allFormSets.length === 0) {
                        alert("No valid TGS data found in the selected file(s).\n\nSupported formats:\n- Full project export (.json)\n- Single TGS section export (.json)");
                        return;
                    }

                    // Get the container
                    const container = document.getElementById(`multi-tgs-container-suite-${suiteIndex}`);
                    if (!container) {
                        alert("Error: TGS container not found. Please ensure the TMP section is initialized first.");
                        return;
                    }

                    // Confirm overwrite if data exists
                    const existingCount = container.children.length;
                    if (existingCount > 0) {
                        if (!confirm(`This will replace the existing ${existingCount} TGS checklist(s) with the ${allFormSets.length} set(s) found in your file(s). Continue?`)) {
                            return;
                        }
                        container.innerHTML = ''; // Clear existing sets
                    }

                    // Load the data
                    beginFileLoad();
                    try {
                        // Restore top-level project details if available
                        if (topLevelData) {
                            Object.entries(topLevelData).forEach(([fieldId, value]) => {
                                const field = document.getElementById(fieldId);
                                if (field && !field.value) {
                                    field.value = value || '';
                                    field.dispatchEvent(new Event('input', { bubbles: true }));
                                }
                            });
                        }

                        // Create and populate each TGS set
                        for (let i = 0; i < allFormSets.length; i++) {
                            const setData = allFormSets[i];
                            
                            // Create the TGS set structure using lazy loading approach
                            const setWrapper = document.createElement('div');
                            setWrapper.className = 'tgs-set-container';
                            setWrapper.dataset.suiteIndex = suiteIndex;
                            setWrapper.dataset.setIndex = i;
                            setWrapper.dataset.type = 'tgs';

                            const fallback = setData.docNo || `TGS Set ${i + 1}`;

                            setWrapper.innerHTML = `
                                <div class="focus-mode-status-pill" aria-live="polite">Normal Mode</div>
                                <div class="focus-mode-banner" style="display: none;"></div>
                                <button type="button" class="btn btn-warning conflict-review-btn no-print" onclick="openConflictReview(${suiteIndex}, ${i}, 'tgs')" style="margin-bottom:10px;">Review Flagged Items</button>
                                <div class="progress-bar-container no-print" style="display: flex; align-items: center; gap: 16px;">
                                    <div class="progress-bar" id="suite${suiteIndex}_progress-bar-set${i}">0%</div>
                                    <div id="suite${suiteIndex}_chart-set${i}" class="chart-donut"><span class="chart-text">0%</span></div>
                                </div>
                                <h2 class="tgs-set-header no-print" data-doc-no-id="suite${suiteIndex}_set${i}_docNo" style="display:flex; align-items:center; justify-content:space-between;">
                                    <span>${fallback}</span>
                                    <span style="display:flex; gap:8px; align-items:center;">
                                        <span class="current-user-pill" id="suite${suiteIndex}_set${i}_currentUserPill" style="padding:2px 8px; border-radius:999px; font-size:0.8em; border:1px solid transparent; display:none;"></span>
                                        <span class="status-pill" id="suite${suiteIndex}_set${i}_statusPill" style="padding:2px 8px; border-radius:999px; font-size:0.8em; border:1px solid transparent;"></span>
                                    </span>
                                </h2>
                                <div class="section-save-load no-print" style="margin: 15px 0 25px; padding: 12px 20px; background: var(--surface-elevated); border-radius: 50px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="background: var(--info-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</div>
                                        <div>
                                            <strong style="color: var(--heading-color); font-size: 1em;">TGS Actions</strong>
                                            <span style="color: var(--text-secondary); font-size: 0.9em; margin-left: 8px;">Load existing TGS file if available.</span>
                                        </div>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-load section-load-btn" data-suite-index="${suiteIndex}" data-set-index="${i}" data-type="tgs" style="border-radius: 20px; padding: 8px 20px;">
                                            <svg><use href="#icon-upload"></use></svg><span> Load TGS File</span>
                                        </button>
                                    </div>
                                </div>
                                ${buildChecklist(suiteIndex, i, 'tgs')}
                                ${buildSignOffSection(suiteIndex, i, 'tgs')}
                            `;
                            container.appendChild(setWrapper);

                            // Now apply the data to the set - setData should already be properly structured
                            applySectionDataObject(suiteIndex, i, 'tgs', setData);
                        }
                        
                        // Restore suite name if extracted from files
                        if (extractedSuiteName) {
                            const suiteNameField = document.getElementById(`suite${suiteIndex}_projectSuiteName`);
                            if (suiteNameField) {
                                suiteNameField.value = extractedSuiteName;
                                suiteNameField.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                            // Store in dataset for reliable export filename generation
                            const suiteContainer = document.querySelector(`.project-suite-container[data-suite-index="${suiteIndex}"]`);
                            if (suiteContainer) {
                                suiteContainer.dataset.suiteName = extractedSuiteName;
                            }
                            // Also store in all TGS containers in this suite
                            document.querySelectorAll(`.tgs-set-container[data-suite-index="${suiteIndex}"]`).forEach(tgsContainer => {
                                tgsContainer.dataset.suiteName = extractedSuiteName;
                            });
                        }

                        // Setup event listeners for newly created elements
                        setupAllEventListeners();
                        updateFormSetAccess();
                        updateTgsStatusPills();
                        
                        showToast(`Successfully loaded ${allFormSets.length} TGS set(s) from ${successCount} file(s).`, 'File Loaded', 'success');
                    } finally {
                        endFileLoad();
                    }

                } catch (err) {
                    console.error(err);
                    alert('Error processing files: ' + err.message);
                } finally {
                    if (document.body.contains(input)) document.body.removeChild(input);
                }
            });
            input.click();
        }

        function generateSuites(force = false) {
    const container = document.getElementById('multi-suite-container');
    if (!container) return;
    
    // CHECK FOR EXISTING SUITES BEFORE WIPING
    const existingSuites = container.querySelectorAll('.project-suite-container');
    const hasExistingSuites = existingSuites.length > 0;
    
    // Also check for any entered data
    const hasValues = Array.from(container.querySelectorAll('input, textarea, select')).some(el => {
        if (el.type === 'checkbox' || el.type === 'radio') return el.checked;
        if (el.tagName === 'SELECT') return el.selectedIndex > 0;
        return el.value.trim() !== '';
    });

    const shouldForce = force === true;
    
    // Warn if suites exist OR if any data has been entered
    if (!shouldForce && (hasExistingSuites || hasValues)) {
        const proceed = confirm(" CAUTION: Project Suites already exist.\n\nGenerating new suites will DELETE ALL current TGS and TMP data.\n\nAre you sure you want to restart?");
        if (!proceed) return;
    }

    const count = parseInt(document.getElementById('projectSuitesCount').value, 10);
    if (isNaN(count) || count < 1) {
        alert("Please enter a valid number of Project Suites (1 or greater).");
        return;
    }

    container.innerHTML = Array.from({ length: count }, (_, i) => createSuiteHTML(i)).join('');

    // Re-attach listeners
    document.querySelectorAll('.generate-forms-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const suiteIdx = parseInt(e.currentTarget.dataset.suiteIndex, 10);
            if (!Number.isNaN(suiteIdx)) generateFormSets(suiteIdx);
        });
    });
    
    // ... rest of existing logic ...
    handleRoleSelection(true);
    setupAllEventListeners();
    applySmartSuiteNameSuggestions();
    scheduleSectionNavigatorRefresh();
}

        function handleSuiteFormSetSelector(event) {
            const target = event.currentTarget;
            const suiteIndex = (target.id || target.name).match(/suite(\d+)/)[1];
            const noRadio = document.getElementById(`suite${suiteIndex}_singleFormSet_no`);
            const multipleInputDiv = document.getElementById(`suite${suiteIndex}_multipleFormSetsInput`);
            const calculatedCountInput = document.getElementById(`suite${suiteIndex}_calculatedFormSetsCount`);

            if (noRadio && noRadio.checked) {
                multipleInputDiv.style.display = 'block';
                calculatedCountInput.value = document.getElementById(`suite${suiteIndex}_formSetsCount`).value || '1';
            } else {
                multipleInputDiv.style.display = 'none';
                calculatedCountInput.value = '1';
            }
        }

        // Simplified and combined other functions like import, reset, scroll buttons, etc.
        // from the original script as they don't need major changes for this feature.
        const linkInputChangeHandler = (e) => {
            const previewEl = document.getElementById(`${e.target.id}_preview`);
            if (!previewEl) return;
            const url = e.target.value.trim();
            if (/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i.test(url)) {
                previewEl.innerHTML = `<a href="${url}" target="_blank" rel="noopener noreferrer">View Document</a>`;
            } else {
                previewEl.innerHTML = '';
            }
        };
        const importFromFile = () => document.getElementById('file-loader').click();
        
        // Store pending file load data for project structure modal
        window._pendingFileLoad = null;
        
        // Analyze project structure from file data
        function analyzeProjectStructure(data) {
            const structure = {
                suites: [],
                totalSuites: 0,
                totalTGS: 0,
                hasTMP: false,
                projectName: '',
                handoverInfo: null
            };
            
            if (data.topLevel) {
                structure.projectName = data.topLevel.projectName || data.topLevel.project_name || '';
            }
            
            if (data.suites && Array.isArray(data.suites)) {
                structure.totalSuites = data.suites.length;
                
                data.suites.forEach((suite, idx) => {
                    const suiteInfo = {
                        index: idx + 1,
                        name: suite.suiteName || `Suite ${idx + 1}`,
                        tgsCount: 0,
                        hasTMP: false
                    };
                    
                    if (suite.formSets && Array.isArray(suite.formSets)) {
                        suiteInfo.tgsCount = suite.formSets.length;
                        structure.totalTGS += suite.formSets.length;
                    }
                    
                    if (suite.tmpSet && Object.keys(suite.tmpSet).length > 0) {
                        suiteInfo.hasTMP = true;
                        structure.hasTMP = true;
                    }
                    
                    structure.suites.push(suiteInfo);
                });
            }
            
            // Check for handover info
            if (data.suites) {
                data.suites.forEach(suite => {
                    if (suite.formSets) {
                        suite.formSets.forEach(set => {
                            if (set.handoverInfo) {
                                structure.handoverInfo = set.handoverInfo;
                            }
                        });
                    }
                });
            }
            
            return structure;
        }
        
        // Show project structure modal for non-designers
        function showProjectStructureModal(structure) {
            const detailsDiv = document.getElementById('project-structure-details');
            
            let html = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${structure.projectName ? `
                        <div style="text-align: center; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                            <span style="font-size: 0.85em; color: var(--text-secondary);">Project:</span>
                            <div style="font-weight: 600; color: var(--heading-color); font-size: 1.1em;">${structure.projectName}</div>
                        </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                        <div style="background: var(--primary-color); color: white; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: 700;">${structure.totalSuites}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">Suite${structure.totalSuites !== 1 ? 's' : ''}</div>
                        </div>
                        <div style="background: var(--accent-color, #6c5ce7); color: white; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: 700;">${structure.totalTGS}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">TGS Set${structure.totalTGS !== 1 ? 's' : ''}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <div style="font-weight: 600; color: var(--heading-color); margin-bottom: 8px;">Suite Details:</div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
            `;
            
            structure.suites.forEach(suite => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--card-background); border-radius: 8px; border: 1px solid var(--border-color);">
                        <span style="font-weight: 500; color: var(--text-color);">${suite.name}</span>
                        <div style="display: flex; gap: 10px; font-size: 0.9em;">
                            <span style="color: var(--primary-color);">${suite.tgsCount} TGS</span>
                            ${suite.hasTMP ? '<span style="color: var(--success-color);"> TMP</span>' : '<span style="color: var(--text-secondary);">No TMP</span>'}
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            detailsDiv.innerHTML = html;
            document.getElementById('project-structure-modal').style.display = 'flex';
            ModalFocusTrap.activate('project-structure-modal');
        }
        
        // Cancel project structure load
        function cancelProjectStructureLoad() {
            document.getElementById('project-structure-modal').style.display = 'none';
            ModalFocusTrap.deactivate('project-structure-modal');
            window._pendingFileLoad = null;
        }
        
        // Proceed with loading project data
        async function proceedWithProjectLoad() {
            document.getElementById('project-structure-modal').style.display = 'none';
            ModalFocusTrap.deactivate('project-structure-modal');
            
            const pending = window._pendingFileLoad;
            if (!pending) return;
            
            window._pendingFileLoad = null;
            
            // Show loading overlay
            const loadingToast = document.createElement('div');
            loadingToast.className = 'toast toast-info';
            loadingToast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
            loadingToast.innerHTML = `
                <div class="toast-icon"></div>
                <div class="toast-content">
                    <strong>Loading Data...</strong>
                    <span>Please wait while we populate the form.</span>
                </div>
            `;
            document.body.appendChild(loadingToast);
            
            try {
                await new Promise(resolve => setTimeout(resolve, 100));
                
                populateFormFromDataObject(pending.data);
                handleRoleSelection(true);
                showToast('Progress loaded successfully!', 'File Loaded', 'success');
            } catch (error) {
                console.error(error);
                alert("Error loading file: " + error.message);
            } finally {
                if (document.body.contains(loadingToast)) {
                    document.body.removeChild(loadingToast);
                }
            }
        }
        
        const handleFileLoad = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Show loading overlay
            LoadingSystem.show("Reading File Data...");
            
            try {
                const content = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => resolve(ev.target.result);
                    reader.onerror = (err) => reject(err);
                    reader.readAsText(file);
                });
                
                if (!content || content.trim().length === 0) {
                    LoadingSystem.hide();
                    alert('Error: The file is empty.');
                    return;
                }
                
                LoadingSystem.show("Processing Data...");
                
                // Simulate a slight delay so the user actually sees the animation
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const data = JSON.parse(content);
                
                // For non-designers, show project structure info first
                if (currentRole !== 'designer') {
                    const structure = analyzeProjectStructure(data);
                    
                    if (structure.totalSuites > 0) {
                        // Store pending load data
                        window._pendingFileLoad = { data, structure };
                        
                        // Hide loading and show structure modal
                        LoadingSystem.hide();
                        showProjectStructureModal(structure);
                        e.target.value = '';
                        return;
                    }
                }
                
                LoadingSystem.show("Populating Form...");
                
                // For designers or if no suites, load directly
                await new Promise(resolve => setTimeout(resolve, 100));
                
                populateFormFromDataObject(data);

                // Refresh UI and apply Focus Mode if needed
                handleRoleSelection(true);

                // Hide loading overlay
                LoadingSystem.hide();
                
                showToast('Progress loaded successfully!', 'File Loaded', 'success');
            } catch (error) {
                console.error(error);
                LoadingSystem.hide();
                alert("Error loading file: " + error.message);
            } finally {
                e.target.value = '';
            }
        };
        const resetForm = () => {
            if (confirm("Reset form? All unsaved data will be lost.")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                sessionStorage.removeItem('autoSelectDesigner'); // Clear this flag to ensure modal logic resets
                window.location.reload();
            }
        };
        const printDraft = () => { if (currentRole) window.print(); else alert("Please select a role first."); };
        const compressAndStoreState = () => {
            const payload = JSON.stringify(getFormDataAsObject());
            if (typeof pako === 'undefined') {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, payload);
                } catch (err) {
                    if (err.name === 'QuotaExceededError') {
                        showToast(' Storage full! Auto-save failed. Please Export/Save File immediately.', 'Storage Warning', 'error');
                    } else {
                        console.warn('localStorage save failed:', err);
                    }
                }
                return;
            }
            try {
                const compressed = pako.deflate(payload);
                let binary = '';
                for (let i = 0; i < compressed.length; i++) {
                    binary += String.fromCharCode(compressed[i]);
                }
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, btoa(binary));
                } catch (storageErr) {
                    if (storageErr.name === 'QuotaExceededError') {
                        showToast(' Storage full! Auto-save failed. Please Export/Save File immediately.', 'Storage Warning', 'error');
                    } else {
                        console.warn('localStorage save failed:', storageErr);
                    }
                }
            } catch (err) {
                console.warn('Compression failed, attempting plain JSON.', err);
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, payload);
                } catch (storageErr) {
                    if (storageErr.name === 'QuotaExceededError') {
                        showToast(' Storage full! Auto-save failed. Please Export/Save File immediately.', 'Storage Warning', 'error');
                    } else {
                        console.warn('localStorage save failed:', storageErr);
                    }
                }
            }
        };
        const debouncedSaveState = debounce(compressAndStoreState, 800);

        function scheduleSectionNavigatorRefresh() {
            if (sectionNavRefreshHandle) clearTimeout(sectionNavRefreshHandle);
            sectionNavRefreshHandle = setTimeout(refreshSectionNavigatorOptions, 200);
        }

        function refreshSectionNavigatorOptions() {
            const select = document.getElementById('section-jump-select');
            const summary = document.getElementById('section-jump-summary');
            if (!select) return;

            const sections = Array.from(document.querySelectorAll('#tgs-form .accordion-section'));
            if (!sections.length) {
                select.innerHTML = '<option value="">Sections will appear once generated</option>';
                select.disabled = true;
                if (summary) summary.textContent = 'No sections yet  generate suites to enable quick jumps.';
                return;
            }

            select.disabled = false;
            const options = ['<option value="">Jump to section</option>'];
            const seenIds = new Set();

            sections.forEach((section, index) => {
                const header = section.querySelector('.accordion-header');
                const label = header ? header.textContent.trim().replace(/\s+/g, ' ') : `Section ${index + 1}`;
                let sectionId = section.id || section.dataset.sectionId || '';
                const sanitized = label.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                if (!sectionId || seenIds.has(sectionId)) {
                    sectionId = `section-${section.dataset.sectionId || sanitized || index + 1}`;
                }
                if (!section.id || section.id !== sectionId) {
                    section.id = sectionId;
                }
                seenIds.add(sectionId);
                options.push(`<option value="${sectionId}">${label}</option>`);
            });

            select.innerHTML = options.join('');
            if (summary) {
                summary.textContent = `${sections.length} section${sections.length === 1 ? '' : 's'} ready to jump.`;
            }
        }

        function setupSectionNavigator() {
            const select = document.getElementById('section-jump-select');
            if (!select) return;

            if (!select.dataset.listenerAttached) {
                select.addEventListener('change', (event) => {
                    const targetId = event.target.value;
                    if (!targetId) return;
                    const section = document.getElementById(targetId);
                    if (!section) return;
                    const header = section.querySelector('.accordion-header');
                    if (header && !header.classList.contains('active')) {
                        header.click();
                    }
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setTimeout(() => { select.value = ''; }, 400);
                    const summary = document.getElementById('section-jump-summary');
                    if (summary && header) {
                        summary.textContent = `Jumped to ${header.textContent.trim()}.`;
                    }
                });
                select.dataset.listenerAttached = 'true';
            }

            scheduleSectionNavigatorRefresh();
        }

        function setupFormSearch() {
            const input = document.getElementById('form-search-input');
            const feedback = document.getElementById('form-search-feedback');
            if (!input) return;

            const clearHighlights = () => {
                document.querySelectorAll('.search-hit').forEach(el => el.classList.remove('search-hit'));
                document.querySelectorAll('.search-muted').forEach(el => el.classList.remove('search-muted'));
                document.querySelectorAll('.search-section-hit').forEach(el => el.classList.remove('search-section-hit'));
            };

            const runSearch = (query) => {
                const normalized = query.trim().toLowerCase();
                if (!normalized || normalized.length < FORM_SEARCH_MIN_CHARS) return;
                const targets = Array.from(document.querySelectorAll('#tgs-form .question-block, #tgs-form .accordion-header'));
                let firstHit = null;
                let totalHits = 0;
                targets.forEach(target => {
                    const text = target.textContent?.toLowerCase() || '';
                    if (text.includes(normalized)) {
                        target.classList.add('search-hit');
                        const section = target.closest('.accordion-section');
                        if (section) section.classList.add('search-section-hit');
                        if (!firstHit) firstHit = target;
                        totalHits++;
                    } else {
                        target.classList.add('search-muted');
                    }
                });
                if (feedback) {
                    feedback.textContent = totalHits ? `${totalHits} match${totalHits === 1 ? '' : 'es'} highlighted. Press Esc to clear.` : 'No matches found.';
                }
                if (firstHit) {
                    const section = firstHit.closest('.accordion-section');
                    const header = section?.querySelector('.accordion-header');
                    if (header && !header.classList.contains('active')) {
                        header.click();
                    }
                    setTimeout(() => {
                        firstHit.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 200);
                }
            };

            const debouncedSearch = debounce(runSearch, 220);

            input.addEventListener('input', (event) => {
                const value = event.target.value || '';
                clearHighlights();
                if (!value.trim()) {
                    if (feedback) feedback.textContent = 'Enter at least 2 characters to highlight matching fields.';
                    return;
                }
                if (value.trim().length < FORM_SEARCH_MIN_CHARS) {
                    if (feedback) feedback.textContent = 'Keep typing need at least 2 characters.';
                    return;
                }
                debouncedSearch(value);
            });

            input.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    input.value = '';
                    clearHighlights();
                    if (feedback) feedback.textContent = 'Search cleared.';
                }
            });
        }

        // ============================================
        // RECOMMENDED ACTIONS SYSTEM
        // ============================================

        // Undo/Redo System
        const undoStack = [];
        const redoStack = [];
        const MAX_HISTORY = 50;

        function saveStateToHistory() {
            const currentState = JSON.stringify(getFormDataAsObject());

            // Don't save duplicate states
            if (undoStack.length > 0 && undoStack[undoStack.length - 1] === currentState) {
                return;
            }

            undoStack.push(currentState);
            if (undoStack.length > MAX_HISTORY) {
                undoStack.shift();
            }

            // Clear redo stack when new action is taken
            redoStack.length = 0;
        }

        function quickUndo() {
            if (undoStack.length === 0) {
                showToast(' Nothing to undo', 'warning');
                return;
            }

            // Save current state to redo stack
            const currentState = JSON.stringify(getFormDataAsObject());
            redoStack.push(currentState);

            // Restore previous state
            const previousState = undoStack.pop();
            if (previousState) {
                populateFormFromDataObject(JSON.parse(previousState));
                setupLinkPreviews();
                updateFormSetAccess();
                updateTgsStatusPills();
                updateSignoffStatusTracker();
                updateProgressBars(currentRole);
                showToast(' Undo successful', 'success');
            }
        }

        function quickRedo() {
            if (redoStack.length === 0) {
                showToast(' Nothing to redo', 'warning');
                return;
            }

            // Save current state to undo stack
            const currentState = JSON.stringify(getFormDataAsObject());
            undoStack.push(currentState);

            // Restore redo state
            const redoState = redoStack.pop();
            if (redoState) {
                populateFormFromDataObject(JSON.parse(redoState));
                setupLinkPreviews();
                updateFormSetAccess();
                updateTgsStatusPills();
                updateSignoffStatusTracker();
                updateProgressBars(currentRole);
                showToast(' Redo successful', 'success');
            }
        }

        function quickSave() {
            saveStateToHistory();
            debouncedSaveState();
            showToast(' Progress saved', 'success');
            showUndoNotification('Progress saved to browser storage');
        }

        function showUndoNotification(message) {
            const notification = document.getElementById('undo-notification');
            const messageEl = document.getElementById('undo-message');
            if (notification && messageEl) {
                messageEl.textContent = message;
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 5000);
            }
        }

        // Quick Actions Panel
        function showQuickActions() {
            const panel = document.getElementById('quick-actions-panel');
            if (panel) {
                panel.classList.add('show');
            }
        }

        function hideQuickActions() {
            const panel = document.getElementById('quick-actions-panel');
            if (panel) {
                panel.classList.remove('show');
            }
        }

        // Keyboard Shortcuts Modal
        function showShortcutsModal() {
            const modal = document.getElementById('shortcuts-modal');
            if (modal) {
                modal.classList.add('show');
                ModalFocusTrap.activate('shortcuts-modal');
            }
        }

        function hideShortcutsModal() {
            const modal = document.getElementById('shortcuts-modal');
            if (modal) {
                modal.classList.remove('show');
                ModalFocusTrap.deactivate('shortcuts-modal');
            }
        }

        // Help Tooltip System
        function addHelpIcon(element, helpText, title = 'Help') {
            const icon = document.createElement('span');
            icon.className = 'help-icon';
            icon.textContent = '?';
            icon.title = title;

            const tooltip = document.createElement('div');
            tooltip.className = 'help-tooltip';
            tooltip.innerHTML = `<strong>${title}</strong>${helpText}`;

            icon.addEventListener('mouseenter', (e) => {
                document.body.appendChild(tooltip);
                const rect = icon.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.bottom + 8) + 'px';
                tooltip.classList.add('show');
            });

            icon.addEventListener('mouseleave', () => {
                tooltip.classList.remove('show');
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 200);
            });

            element.appendChild(icon);
        }

        // Global Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+S: Save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    quickSave();
                    return;
                }

                // Ctrl+Z: Undo
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    quickUndo();
                    return;
                }

                // Ctrl+Y: Redo
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    quickRedo();
                    return;
                }

                // Ctrl+K: Show quick actions
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    const panel = document.getElementById('quick-actions-panel');
                    if (panel.classList.contains('show')) {
                        hideQuickActions();
                    } else {
                        showQuickActions();
                    }
                    return;
                }

                // ?: Show shortcuts help
                if (e.shiftKey && e.key === '?') {
                    e.preventDefault();
                    showShortcutsModal();
                    return;
                }

                // Ctrl+P: Print
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    printDraft();
                    return;
                }

                // Home: Jump to top
                if (e.key === 'Home' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }

                // End: Jump to bottom
                if (e.key === 'End' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                    return;
                }

                // Esc: Close modals/panels
                if (e.key === 'Escape') {
                    hideQuickActions();
                    hideShortcutsModal();
                    closeNotifyModal();
                }
            });
        }

        // Enhanced tooltips for key UI elements
        function setupEnhancedTooltips() {
            // Add help icons to key sections after page load
            setTimeout(() => {
                // Role selection help
                const roleContainer = document.querySelector('label[for="role"]')?.parentElement;
                if (roleContainer) {
                    addHelpIcon(
                        roleContainer.querySelector('label'),
                        'Select your role to access relevant sections. Designer can generate forms, others can load existing section files.',
                        'Role Selection'
                    );
                }

                // Add help to other key areas as needed
            }, 1000);
        }

        // ============================================
        // SCROLL BUTTONS AND NAVIGATION
        // ============================================
        function setupScrollButtons() {
            const goToTopBtn = document.getElementById('goToTopBtn');
            const goToBottomBtn = document.getElementById('goToBottomBtn');
            const backToTopBtn = document.getElementById('back-to-top');
            
            const handleScroll = () => {
                const scrollY = window.scrollY || window.pageYOffset;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;
                
                // Show/hide Go To Top button
                if (goToTopBtn) {
                    if (scrollY > 300) {
                        goToTopBtn.classList.add('show');
                    } else {
                        goToTopBtn.classList.remove('show');
                    }
                }
                
                // Show/hide Go To Bottom button
                if (goToBottomBtn) {
                    if (scrollY + windowHeight < documentHeight - 300) {
                        goToBottomBtn.classList.add('show');
                    } else {
                        goToBottomBtn.classList.remove('show');
                    }
                }
                
                // Show/hide Back to Top button
                if (backToTopBtn) {
                    if (scrollY > 400) {
                        backToTopBtn.classList.add('show');
                    } else {
                        backToTopBtn.classList.remove('show');
                    }
                }
            };
            
            // Attach scroll listener
            window.addEventListener('scroll', handleScroll, { passive: true });
            
            // Go To Top click handler
            if (goToTopBtn) {
                goToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
            
            // Go To Bottom click handler
            if (goToBottomBtn) {
                goToBottomBtn.addEventListener('click', () => {
                    window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
                });
            }
            
            // Back to Top click handler
            if (backToTopBtn) {
                backToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
            
            // Initial check
            handleScroll();
        }
        
        function checkScroll() {
            const backToTopBtn = document.getElementById('back-to-top');
            const scrollY = window.scrollY || window.pageYOffset;
            if (backToTopBtn) {
                if (scrollY > 400) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            }
        }

        // Auto-save with history tracking
        let lastSaveTime = Date.now();
        function enhancedAutoSave() {
            const now = Date.now();
            // Save to history every 30 seconds of changes
            if (now - lastSaveTime > 30000) {
                saveStateToHistory();
                lastSaveTime = now;
            }
            debouncedSaveState();
        }

        // Initialize recommended actions system
        function initRecommendedActions() {
            setupKeyboardShortcuts();
            setupEnhancedTooltips();

            // Show quick actions panel on first load or after 3 seconds
            const hasSeenQuickActions = localStorage.getItem('hasSeenQuickActions');
            if (!hasSeenQuickActions) {
                setTimeout(() => {
                    showQuickActions();
                    localStorage.setItem('hasSeenQuickActions', 'true');
                    setTimeout(() => hideQuickActions(), 8000);
                }, 3000);
            }

            // Save initial state to history
            setTimeout(() => saveStateToHistory(), 1000);

            // Track changes for undo/redo
            const formElement = document.getElementById('tgs-form');
            if (formElement) {
                let changeTimeout;
                formElement.addEventListener('input', () => {
                    clearTimeout(changeTimeout);
                    changeTimeout = setTimeout(() => {
                        saveStateToHistory();
                    }, 2000);
                });
            }

            console.log(' Recommended Actions System initialized');
            console.log('   - Keyboard shortcuts active (press ? for help)');
            console.log('   - Undo/Redo available (Ctrl+Z / Ctrl+Y)');
            console.log('   - Quick save (Ctrl+S)');
            console.log('   - Quick actions panel (Ctrl+K)');
        }

        function loadProgressFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.multiple = true;  // Allow multiple files for loading multiple sections
            input.style.display = 'none';
            document.body.appendChild(input);

            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                if (files.length === 0) {
                    document.body.removeChild(input);
                    return;
                }

                // Process all selected files
                let filesProcessed = 0;
                let fullProgressFile = null;
                const sectionFiles = [];

                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const content = ev.target.result;
                        if (!content || content.trim().length === 0) {
                            console.error('Error: File is empty:', file.name);
                            filesProcessed++;
                            if (filesProcessed === files.length) {
                                processLoadedFiles(fullProgressFile, sectionFiles);
                                document.body.removeChild(input);
                            }
                            return;
                        }
                        try {
                            const data = JSON.parse(content);

                            // Categorize the file type
                            if (data && (data.topLevel || data.suites || data.selectedRole)) {
                                fullProgressFile = { data, filename: file.name };
                            } else if (data && (data.kind === 'tgs-section' || data.kind === 'tmp-section')) {
                                sectionFiles.push({ data, filename: file.name });
                            }
                        } catch (err) {
                            console.error('Error parsing file:', file.name, err);
                        }

                        filesProcessed++;

                        // When all files are processed
                        if (filesProcessed === files.length) {
                            processLoadedFiles(fullProgressFile, sectionFiles);
                            document.body.removeChild(input);
                        }
                    };

                    reader.onerror = () => {
                        filesProcessed++;
                        if (filesProcessed === files.length) {
                            processLoadedFiles(fullProgressFile, sectionFiles);
                            document.body.removeChild(input);
                        }
                    };

                    reader.readAsText(file);
                });
            });

            input.click();
        }

        function processLoadedFiles(fullProgressFile, sectionFiles) {
            // Priority: Full progress file loads first if present
            if (fullProgressFile) {
                const message = sectionFiles.length > 0
                    ? `Found 1 full progress file and ${sectionFiles.length} section file(s).\n\nLoad the full progress file? (Section files can be loaded individually later using "Load Into This TGS/TMP" buttons)`
                    : 'This will replace all current form data with the loaded file. Continue?';

                if (confirm(message)) {
                    beginFileLoad();
                    try {
                        // Load the full progress file
                        populateFormFromDataObject(fullProgressFile.data);

                        // Update all UI elements
                        setupLinkPreviews();
                        updateFormSetAccess();
                        updateTgsStatusPills();
                        updateSignoffStatusTracker();
                        updateProgressBars(currentRole);
                        updateConflictCheckboxes();

                        // Save to local storage
                        debouncedSaveState();
                    } finally {
                        endFileLoad();
                    }

                    let msg = 'Full progress file loaded successfully!';
                    if (sectionFiles.length > 0) {
                        msg += `\n\nNote: ${sectionFiles.length} section file(s) were also selected. Use "Load Into This TGS/TMP" buttons on specific sections to load them if needed.`;
                    }
                    alert(msg);
                    return;
                }
            }

            

            
            
        }

        const loadStateFromLocalStorage = () => {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!stored) return;
            let parsed = null;
            try {
                if (stored.trim().startsWith('{') || stored.trim().startsWith('[')) {
                    parsed = JSON.parse(stored);
                } else if (typeof pako !== 'undefined') {
                    const binary = atob(stored);
                    const bytes = Uint8Array.from(binary, char => char.charCodeAt(0));
                    const json = pako.inflate(bytes, { to: 'string' });
                    parsed = JSON.parse(json);
                } else {
                    parsed = JSON.parse(stored);
                }
            } catch (err) {
                console.warn('Failed to restore saved state.', err);
                return;
            }
            if (parsed) populateFormFromDataObject(parsed);
        };
        initThemeHandling();
        
        // Use a function that runs immediately if DOM is ready, or waits for DOMContentLoaded
        const initLandingPage = () => {
            const landingPage = document.getElementById('landing-page');
            const appShell = document.getElementById('app-shell');
            const startReviewBtn = document.getElementById('start-review-btn');
            const howItWorksBtn = document.getElementById('how-it-works-btn');
            const tourFeaturesBtn = document.getElementById('tour-features-btn');
            
            // How It Works Modal
            const howItWorksModal = document.getElementById('how-it-works-modal');
            const howItWorksCloseBtn = howItWorksModal?.querySelector('.landing-modal-close');

            // Features Modal
            const featuresModal = document.getElementById('features-modal');
            const featuresCloseBtn = featuresModal?.querySelector('.landing-modal-close');

            const showLandingModal = () => {
                if (!howItWorksModal) return;
                howItWorksModal.classList.add('is-visible');
                howItWorksModal.setAttribute('aria-hidden', 'false');
                ModalFocusTrap.activate('how-it-works-modal');
            };

            const hideLandingModal = () => {
                if (!howItWorksModal) return;
                howItWorksModal.classList.remove('is-visible');
                howItWorksModal.setAttribute('aria-hidden', 'true');
                ModalFocusTrap.deactivate('how-it-works-modal');
            };

            const showFeaturesModal = () => {
                if (!featuresModal) return;
                featuresModal.classList.add('is-visible');
                featuresModal.setAttribute('aria-hidden', 'false');
                ModalFocusTrap.activate('features-modal');
            };

            const hideFeaturesModal = () => {
                if (!featuresModal) return;
                featuresModal.classList.remove('is-visible');
                featuresModal.setAttribute('aria-hidden', 'true');
                ModalFocusTrap.deactivate('features-modal');
            };

            const enterChecklist = (persist = true) => {
                if (persist) sessionStorage.setItem('landingDismissed', 'true');
                if (howItWorksModal?.classList.contains('is-visible')) hideLandingModal();
                if (featuresModal?.classList.contains('is-visible')) hideFeaturesModal();
                
                if (landingPage) {
                    landingPage.style.display = 'none';
                    landingPage.setAttribute('aria-hidden', 'true');
                }
                if (appShell) {
                    appShell.style.display = 'block';
                    appShell.setAttribute('aria-hidden', 'false');
                }
                document.body.classList.remove('landing-active');
                if (window.location.hash !== '#app') {
                    history.replaceState(null, '', '#app');
                }
                setTimeout(() => {
                    const rolePanel = document.getElementById('role-selector-panel');
                    if (rolePanel) rolePanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    document.getElementById('role')?.focus();
                }, 200);
            };

            if (howItWorksBtn) howItWorksBtn.addEventListener('click', showLandingModal);
            if (howItWorksCloseBtn) howItWorksCloseBtn.addEventListener('click', hideLandingModal);
            if (howItWorksModal) {
                howItWorksModal.addEventListener('click', (event) => {
                    if (event.target === howItWorksModal) hideLandingModal();
                });
            }

            if (tourFeaturesBtn) tourFeaturesBtn.addEventListener('click', showFeaturesModal);
            if (featuresCloseBtn) featuresCloseBtn.addEventListener('click', hideFeaturesModal);
            if (featuresModal) {
                featuresModal.addEventListener('click', (event) => {
                    if (event.target === featuresModal) hideFeaturesModal();
                });
            }

            if (startReviewBtn) {
                startReviewBtn.addEventListener('click', () => {
                    enterChecklist();
                });
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (howItWorksModal?.classList.contains('is-visible')) hideLandingModal();
                    if (featuresModal?.classList.contains('is-visible')) hideFeaturesModal();
                }
            }, { capture: true });

            const landingDismissed = sessionStorage.getItem('landingDismissed') === 'true' || window.location.hash === '#app';
            if (landingDismissed) {
                enterChecklist(false);
            } else {
                document.body.classList.add('landing-active');
                if (landingPage) landingPage.setAttribute('aria-hidden', 'false');
                if (appShell) {
                    appShell.style.display = 'none';
                    appShell.setAttribute('aria-hidden', 'true');
                }
            }

            document.getElementById('role').addEventListener('change', handleRoleSelection);
            document.getElementById('generate-suites-btn').addEventListener('click', generateSuites);
            ['projectLocation', 'jobNature'].forEach(id => {
                const field = document.getElementById(id);
                if (field) field.addEventListener('input', applySmartSuiteNameSuggestions);
            });

            const themeToggleBtn = document.getElementById('theme-toggle');
            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleThemePreference);

            const fixedThemeToggle = document.getElementById('fixed-theme-toggle');
            if (fixedThemeToggle) fixedThemeToggle.addEventListener('click', toggleThemePreference);

            // Compact Mode toggle button (quick actions)
            try {
                const compactBtn = document.createElement('button');
                compactBtn.className = 'quick-action-btn';
                compactBtn.type = 'button';
                compactBtn.id = 'compact-mode-toggle';
                compactBtn.setAttribute('aria-pressed', 'false');
                compactBtn.innerHTML = ' Compact Mode';
                compactBtn.onclick = () => {
                    document.body.classList.toggle('compact-mode');
                    const isCompact = document.body.classList.contains('compact-mode');
                    compactBtn.innerHTML = isCompact ? ' Normal Mode' : ' Compact Mode';
                    compactBtn.setAttribute('aria-pressed', String(isCompact));
                    try { localStorage.setItem('tgs_compact_mode', isCompact); } catch (_) { }
                };

                const panel = document.getElementById('quick-actions-panel');
                if (panel) {
                    panel.insertBefore(compactBtn, panel.firstChild);
                } else if (fixedThemeToggle && fixedThemeToggle.parentNode) {
                    fixedThemeToggle.parentNode.insertBefore(compactBtn, fixedThemeToggle.nextSibling);
                }

            // Restore state on load
            if (localStorage.getItem('tgs_compact_mode') === 'true') {
                document.body.classList.add('compact-mode');
                compactBtn.innerHTML = ' Normal Mode';
                compactBtn.setAttribute('aria-pressed', 'true');
            }
            } catch (err) {
                console.warn('Compact mode toggle initialization failed', err);
            }

            // Enforce CC number format and propagate to TMP doc numbers
            const ccEl = document.getElementById('ccNumber');
            const handleCcNumberInput = () => {
                const raw = ccEl.value || '';
                const digits = raw.replace(/\D/g, '');
                ccEl.value = digits ? `CC-${digits}` : '';
                // Sync to all TMP doc numbers
                document.querySelectorAll('[id$="_tmp_docNo"]').forEach(el => { el.value = ccEl.value; });
            };
            ccEl.addEventListener('input', handleCcNumberInput);
            // Initialize once on load
            handleCcNumberInput();
            // Removed global Save/Load buttons; per-section controls are available under each TGS/TMP header
            const fileLoader = document.getElementById('file-loader');
            if (fileLoader) fileLoader.addEventListener('change', handleFileLoad);

            // Global drag-drop zone for loading JSON files
            const dropzone = document.getElementById('global-dropzone');
            if (dropzone) {
                let dragCounter = 0;
                document.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    dragCounter++;
                    dropzone.style.display = 'flex';
                });
                document.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dragCounter--;
                    if (dragCounter <= 0) {
                        dragCounter = 0;
                        dropzone.style.display = 'none';
                    }
                });
                document.addEventListener('dragover', (e) => e.preventDefault());
                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dragCounter = 0;
                    dropzone.style.display = 'none';
                    const files = e.dataTransfer?.files;
                    if (files?.length > 0 && files[0].name.endsWith('.json')) {
                        if (typeof handleFileLoad === 'function') {
                            handleFileLoad({ target: { files } });
                        }
                    } else if (files?.length > 0) {
                        showToast('Please drop a .json file', 'error');
                    }
                });
            }

            // "Copy Answer" button for comment textareas - copies answer from same question to this textarea
            document.getElementById('tgs-form')?.addEventListener('click', (e) => {
                const btn = e.target.closest('.copy-down-btn');
                if (!btn) return;
                const thisTextarea = btn.closest('.comment-wrapper')?.querySelector('textarea');
                if (!thisTextarea) return;
                // Find the question block and the first textarea with content
                const questionBlock = thisTextarea.closest('.question-block');
                if (!questionBlock) return;
                const allTextareas = Array.from(questionBlock.querySelectorAll('.comments-grid textarea'));
                const thisIndex = allTextareas.indexOf(thisTextarea);
                // Look for a filled textarea before this one
                let sourceValue = '';
                for (let i = 0; i < thisIndex; i++) {
                    if (allTextareas[i].value.trim()) {
                        sourceValue = allTextareas[i].value;
                    }
                }
                if (sourceValue) {
                    thisTextarea.value = sourceValue;
                    thisTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                    showToast('Comment copied', 'success');
                } else {
                    showToast('No previous comment to copy', 'info');
                }
            });

            ['print-btn', 'print-btn-bottom'].forEach(id => document.getElementById(id).addEventListener('click', printDraft));
            ['finalize-btn', 'finalize-btn-bottom'].forEach(id => document.getElementById(id).addEventListener('click', generateFinalReport));
            ['reset-btn', 'reset-btn-bottom'].forEach(id => document.getElementById(id).addEventListener('click', resetForm));
            document.getElementById('tgs-form').addEventListener('input', debouncedSaveState);
            const templateSelect = document.getElementById('notification-template-select');
            const templatePreview = document.getElementById('email-template-preview');
            if (templateSelect && templatePreview) {
                templateSelect.addEventListener('change', () => {
                    templatePreview.dataset.fromTemplate = 'true';
                    templatePreview.value = emailTemplates[templateSelect.value] || '';
                });
                templatePreview.addEventListener('input', () => {
                    templatePreview.dataset.fromTemplate = 'false';
                });
                updateEmailTemplatePreviewFromSelection();
            }
            // Update suite titles when suite name/number changes
            document.addEventListener('input', (e) => {
                if (e.target && typeof e.target.id === 'string' && e.target.id.match(/^suite\d+_projectSuiteName$/)) {
                    updateSuiteHeaders();
                }
            });
            setupScrollButtons();
            setupSectionNavigator();
            setupFormSearch();
            // addCopyButtons(); // Add copy buttons
            loadStateFromLocalStorage();
            attachValidationRules();
            applySmartSuiteNameSuggestions();


            // Check for auto-select designer flag (from New Project flow)
            if (sessionStorage.getItem('autoSelectDesigner') === 'true') {
                const roleSelect = document.getElementById('role');
                if (roleSelect) {
                    roleSelect.value = 'designer';
                    handleRoleSelection(true); // Suppress modal (we just clicked New Project)
                    
                    // Let user manually generate TMP and TGS forms
                    // (removed auto-generation of forms)
                }
                sessionStorage.removeItem('autoSelectDesigner');
            } else {
                // If role is already selected (e.g. browser restored selection after Reset/Refresh)
                const roleSelect = document.getElementById('role');
                if (roleSelect && roleSelect.value) {
                    // If we did NOT load data from storage (meaning this is a Reset or empty Refresh), 
                    // and the role is Designer, we MUST show the modal.
                    if (!window.dataLoadedFromStorage && roleSelect.value === 'designer') {
                        handleRoleSelection(false); // Show Modal
                    } else {
                        // Data was loaded or role isn't designer, just update UI without modal
                        handleRoleSelection(true);
                    }
                }
            }

            // Normalize CC after load and sync TMP doc numbers
            try { handleCcNumberInput(); } catch (_) { }
            // Setup role-only toggle
            setupOnlyCurrentRoleToggle();
            // Notify modal wiring
            const notifyBtn = document.getElementById('global-notify-btn');
            if (notifyBtn) notifyBtn.addEventListener('click', openNotifyModal);
            const modal = document.getElementById('notify-modal');
            if (modal) {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeNotifyModal(); });
                modal.querySelector('.modal-close-btn')?.addEventListener('click', closeNotifyModal);
                const modalSaveBtn = document.getElementById('modal-save-btn');
                modalSaveBtn?.addEventListener('click', () => {
                    exportProgressToFile().catch(err => {
                        if (err?.name === 'AbortError') return;
                        console.error('Global save failed:', err);
                        showToast('Unable to save file. Please try again.', 'Save failed', 'error');
                    });
                });
                document.getElementById('modal-email-btn')?.addEventListener('click', () => { shareViaEmail(); closeNotifyModal(); });
                document.getElementById('modal-teams-btn')?.addEventListener('click', async () => { await shareViaTeams(); closeNotifyModal(); });
            }
            const conflictModal = document.getElementById('conflict-review-modal');
            if (conflictModal) {
                conflictModal.addEventListener('click', (e) => { if (e.target === conflictModal) closeConflictReview(); });
                conflictModal.querySelector('.modal-close-btn')?.addEventListener('click', closeConflictReview);
            }
            // Cloud drive detection
            detectCloudDriveEnvironment();

            // Initialize recommended actions system
            initRecommendedActions();

            // Attach snippet tools for textareas
            try { attachSnippetTools(); } catch (err) { console.warn('attachSnippetTools failed', err); }

            // Quick comment selector handler
            const quickCommentSelect = document.getElementById('quick-comment-select');
            if (quickCommentSelect) {
                quickCommentSelect.addEventListener('change', function() {
                    const selectedComment = this.value;
                    const commentInput = document.getElementById('comment-input');
                    if (selectedComment && commentInput) {
                        commentInput.value = (commentInput.value ? commentInput.value + ' ' : '') + selectedComment;
                        this.value = ''; // Reset dropdown
                    }
                });
            }

            // Quick comment selectors for form comment fields (delegated)
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('quick-comment-selector')) {
                    const selectedValue = e.target.value;
                    const targetId = e.target.getAttribute('data-target');
                    const targetTextarea = document.getElementById(targetId);
                    if (selectedValue && targetTextarea) {
                        targetTextarea.value = (targetTextarea.value ? targetTextarea.value + ' ' : '') + selectedValue;
                        targetTextarea.dispatchEvent(new Event('input', {bubbles: true})); // Trigger autosave
                        e.target.value = ''; // Reset dropdown
                    }
                }
            });

        };
        
        // Run immediately if DOM is already ready, otherwise wait for DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLandingPage);
        } else {
            initLandingPage();
        }

        (function setupButtonTitles() {
            const backBtn = document.getElementById('goToTopBtn');
            document.querySelectorAll('button').forEach(btn => {
                if (btn === backBtn) return; // back-to-top already has a title
                if (!btn.hasAttribute('title')) {
                    // prefer aria-label if present
                    const label = btn.getAttribute('aria-label');
                    if (label) return btn.setAttribute('title', label);
                    const text = (btn.innerText || btn.textContent || '').trim();
                    // skip if button contains only an SVG with no visible text
                    const hasVisibleText = Array.from(btn.childNodes).some(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim());
                    if (text && hasVisibleText) btn.setAttribute('title', text);
                }
            });

            // Ctrl/Cmd+Enter to submit composer note (non-invasive)
            const composer = document.getElementById('comment-input');
            if (composer) {
                composer.addEventListener('keydown', (ev) => {
                    if ((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter') {
                        ev.preventDefault();
                        if (typeof submitComposerNote === 'function') submitComposerNote();
                    }
                });
            }

            // Init
            checkScroll();
            window.addEventListener('scroll', checkScroll, { passive: true });
        })();
    </script>
    <script>
        // Drag-and-drop JSON file loader
        (function () {
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function setupDragAndDrop() {
                const dropZone = document.body;
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });

                dropZone.addEventListener('dragover', () => {
                    document.body.classList.add('drag-active');
                });

                dropZone.addEventListener('dragleave', () => {
                    document.body.classList.remove('drag-active');
                });

                dropZone.addEventListener('drop', (e) => {
                    document.body.classList.remove('drag-active');
                    const dt = e.dataTransfer;
                    const files = dt.files;

                    if (files.length > 0 && files[0].name && files[0].name.toLowerCase().endsWith('.json')) {
                        const loader = document.getElementById('file-loader');
                        if (confirm(`Drop detected: Load "${files[0].name}"?`)) {
                            try {
                                if (loader) {
                                    // Some browsers restrict programmatic assignment to input.files; fallback to manual handling
                                    const evt = { target: { files: files } };
                                    if (typeof handleFileLoad === 'function') {
                                        // prefer direct handler if available
                                        handleFileLoad(evt);
                                    } else if (loader) {
                                        // attempt to trigger existing change handler via input
                                        loader.files = files;
                                        loader.dispatchEvent(new Event('change'));
                                    }
                                }
                            } catch (err) {
                                console.warn('Auto-assigning files to input not supported; falling back to manual.', err);
                                if (typeof handleFileLoad === 'function') handleFileLoad({ target: { files } });
                            }
                        }
                    }
                });
            }

            // Add CSS for drag feedback
            try {
                const style = document.createElement('style');
                style.id = 'drag-drop-style';
                style.textContent = `
                    body.drag-active::after {
                        content: ' Drop JSON File to Load';
                        position: fixed; inset: 0; background: rgba(99, 102, 241, 0.9);
                        color: white; z-index: 10000; display: flex;
                        align-items: center; justify-content: center;
                        font-size: 2rem; font-weight: bold; pointer-events: none;
                    }
                `;
                document.head.appendChild(style);
            } catch (err) { console.warn('Failed to append drag-drop style', err); }

            // Initialize
            try { setupDragAndDrop(); } catch (err) { console.warn('setupDragAndDrop failed', err); }
        })();
    </script>
    <script>
        // Mini-map: visual quick navigation for long checklists
        (function () {
            function createMiniMap() {
                const map = document.createElement('div');
                map.className = 'minimap no-print';
                map.style.cssText = `
                    position: fixed; right: 20px; top: 50%; transform: translateY(-50%);
                    display: flex; flex-direction: column; gap: 8px; z-index: 999;
                `;

                // Refresh function to run whenever suites are generated
                window.refreshMiniMap = () => {
                    map.innerHTML = '';
                    if (window.innerWidth < 1200) return; // Hide on small screens

                    document.querySelectorAll('.accordion-section, .project-suite-container').forEach(section => {
                        const dot = document.createElement('div');
                        const title = section.querySelector('.accordion-header-text, h2')?.textContent || 'Section';
                        dot.title = title;
                        dot.style.cssText = `
                            width: 10px; height: 10px; border-radius: 50%;
                            background: var(--border-color); cursor: pointer;
                            transition: all 0.2s; position: relative;
                        `;

                        // Hover tooltip
                        dot.onmouseenter = () => {
                            dot.style.transform = 'scale(1.5)';
                            dot.style.background = 'var(--primary-color)';
                        };
                        dot.onmouseleave = () => {
                            dot.style.transform = 'scale(1)';
                            dot.style.background = 'var(--border-color)';
                        };

                        dot.onclick = () => {
                            section.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            const header = section.querySelector('.accordion-header');
                            if (header && !header.classList.contains('active')) header.click();
                        };

                        map.appendChild(dot);
                    });
                };

                document.body.appendChild(map);
                // Initial populate
                window.refreshMiniMap();
            }

            // Add CSS media query to hide on mobile
            try {
                const style = document.createElement('style');
                style.id = 'minimap-style';
                style.textContent = `
                    @media (max-width: 1200px) { .minimap { display: none !important; } }
                    .minimap div { box-sizing: border-box; }
                `;
                document.head.appendChild(style);
            } catch (err) { console.warn('Failed to append minimap style', err); }

            try { createMiniMap(); } catch (err) { console.warn('createMiniMap failed', err); }
        })();
    </script>
<div id="ref-sidebar" class="no-print" style="position:fixed; right:-320px; top:0; width:320px; height:100%; background:var(--surface-elevated); border-left:1px solid var(--border-color); transition:0.3s; z-index:10000; padding:20px; box-shadow:-5px 0 15px rgba(0,0,0,0.1); overflow-y:auto;">
    <button onclick="toggleRefSidebar()" style="position:absolute; top:10px; right:10px; border:none; background:none; font-size:1.5rem;">&times;</button>
    <h3>Reference Library</h3>
    <ul style="list-style:none; padding:0; display:flex; flex-direction:column; gap:8px;">
        <li><a href="https://cromptonconcepts.sharepoint.com/:f:/s/Operations/Elm9T7-AN-9FlXD7jiH29cEBzCfCZ8IMFkj_AYmkDxt5gw?e=OlWucQ" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-primary" style="width:100%; font-size:0.9em;"> All Reference Documents</a></li>
        <li style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border-color);"><strong style="font-size:0.85em; color:var(--text-secondary);">AGTTM Guides:</strong></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EYtAvB2KXI9AkaheB9FIo74B9qKf2Q7HbAe30U6cYd_YSQ?e=cCpJ56" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 1: Introduction</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EecH0TYe7WBIlZZhvju1JU8BerbTc_RE2lCd4oMXiZRg_Q?e=K3EtSM" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 2: Traffic Management Planning</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EQTswdDZdnhHpheuwNm-9mgBUfnvGXzxWoa_AwqnjndlsA?e=jgiV5S" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 3: Static Worksites</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/Efa3_OPD4N9Op5ETdSLHJLsBdiUCsSb7S6hoODxXAsRV4Q?e=g0PPPx" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 4: Mobile Works</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/Edn8wFHWGUdOtl09hGn9gr0BkRBinmy009za0235vF9XuA?e=rxFP8J" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 5: Short Term Low Impact Worksites</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/ERWEO2akP_NCuN0C8DuYVQYBrSWGCTQFkf85MF-KW4OuVA?e=iYuSCj" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 6: Field Staff</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EffpxPjWlipHnSBaEtXnKs8B1pZhtKcc5uCzdfV6dbWJPg?e=k1itQK" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 7: Traffic Controllers</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EZp29GbK34VBoYxg575i-Z8BO4xNQUJGZKEpA5uM4Kobhg?e=kJQJ1e" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 8: Processes and Procedures</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EcP5IS662zJCnkbVP7ti7BEBM13VLAADB2FUZL8d_PRJ4A?e=945OsM" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 9: Sample Layouts</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EfwKNtI81dlFkypHo_n7hUYB_Sbt6nsgRLJfRJqEZkPMRg?e=mWCBie" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 10: Supporting Guidance</a></li>
        <li style="margin-top:12px; padding-top:8px; border-top:1px solid var(--border-color);"><strong style="font-size:0.85em; color:var(--text-secondary);">QGTTM Guides (QLD):</strong></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EcpdbOpQYOJKmnsNk3cpqtkBoSH1X7jhG527uP2sXAkFLw?e=5qARAZ" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 1: Introduction</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EVxQ4pdkBslCt_tahgNznw4BBiw3Od42m85Ze-nzXhFF7A?e=dE8HHD" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 2: Traffic Management Planning</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EacqzfrABMJIjUzE9mvTs5kB1BWa3zlkCfaDMH8gLJPdZA?e=CrdGLC" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 3: Static Worksites</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/Eei71zngMnRAov0e3j0pc5cB80ehlwd24anyfCts_Lzm5Q?e=9BVHDy" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 4: Mobile Works</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EfDqIJB3oWlPocHFPWMK_YIBrgzi-ZOnxV_a0bNUnCWa2A?e=eMvGlv" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 5: Short Term Low Impact Worksites</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EfBwiVIH6ptElrT3redCePYB2m9Ul4kMWqeC2c0IXt076g?e=Hmx7UX" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 6: Field Staff</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EeO3VwJpkX1Frtxq7LfVn78BigGXxr2dCRKCwTZnl_X7MQ?e=h8cQoZ" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 7: Traffic Controllers</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/ERbNFlGUAHZLr7CjxGd9ZAgBCfMAm-24JWJkdWts5glOJw?e=yaUsJY" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 8: Processes and Procedures</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EU_znNYSA9xGjg55vYYV3rAB0XR7NLhX4T-Y5jkioQTQgA?e=OAndUz" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 9: Sample Layouts</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EeRuzGmc_ZRCuJJ-pF3aysUBUFFjiGEGCTJIcZBtqvhEtQ?e=ak7yh6" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 10: Supporting Guidance</a></li>
        <li style="margin-top:12px; padding-top:8px; border-top:1px solid var(--border-color);"><strong style="font-size:0.85em; color:var(--text-secondary);">MUTCD:</strong></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/Ebvg1_xzH3RApXUIxn614HcBbYJnWeTAZtvhz8T_b2T7Jw?e=UIPtXg" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 1: Introduction & General Provisions</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EXSQRD055dtEu4DQmYpbhHMB0sParghPAA7itYAYE4vRTw?e=tbD4Hi" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 2: Traffic Control Devices for General Use</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/Ed80XTGjnchPpan1CpxF1n8BuK1PY3HvlBcXGqFs9f8U5Q?e=7Eb7Xm" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 3: Traffic Control for Road Works</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EUTMhs7F9RpJhM2vIOgaBD4BxXsAUZqPmQJVMRFtu2Dhdg?e=oDP95V" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 4: Speed Controls</a></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:b:/s/Operations/EUG3DIEbjz9JgIoOlfhAEsEBmFs1-HYIClPZ5D_GjdOB6A?e=yLjhG6" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-secondary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;">Part 5: Traffic Management for Special Events</a></li>
        <li style="margin-top:12px; padding-top:8px; border-top:1px solid var(--border-color);"><strong style="font-size:0.85em; color:var(--text-secondary);">TC Signs:</strong></li>
        <li><a href="https://cromptonconcepts.sharepoint.com/:f:/s/Operations/En8BNf1fwUBCilZ-C61GjdoBLsx5oQMwwLSLkFdtPrwZ_g?e=uYMHwn" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-primary" style="width:100%; font-size:0.8em; text-align:left; padding:6px 10px;"> TC Signs Folder</a></li>
    </ul>
</div>
<button onclick="toggleRefSidebar()" class="btn btn-info no-print" style="position:fixed; right:0; top:150px; border-radius: 8px 0 0 8px; padding:8px 4px; writing-mode: vertical-rl; z-index:9999;">References</button>

<!-- Sticky Table of Contents Sidebar -->
<div id="sticky-toc" class="no-print">
    <button id="toc-toggle" type="button" title="Toggle Table of Contents" aria-label="Toggle navigation sidebar"></button>
    <div class="toc-content">
        <h4> Navigation</h4>
        <div id="toc-links"></div>
    </div>
</div>

<script>
function toggleRefSidebar() {
    const sb = document.getElementById('ref-sidebar');
    const isOpen = sb.style.right === '0px';
    sb.style.right = isOpen ? '-320px' : '0px';
}

// Sticky TOC Functions
function updateTOC() {
    const tocLinks = document.getElementById('toc-links');
    if (!tocLinks) return;
    tocLinks.innerHTML = '';
    
    const suites = document.querySelectorAll('.project-suite-container');
    if (suites.length === 0) {
        tocLinks.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.85rem; padding: 10px;">No suites generated yet.<br>Generate Project Suites to see navigation.</div>';
        return;
    }
    
    suites.forEach((suite, sIdx) => {
        // Add Suite Header
        const suiteName = document.getElementById(`suite${sIdx}_projectSuiteName`)?.value || `Suite ${sIdx + 1}`;
        const sLink = document.createElement('div');
        sLink.className = 'toc-link toc-suite';
        sLink.textContent = ` ${suiteName}`;
        sLink.onclick = () => {
            suite.scrollIntoView({ behavior: 'smooth', block: 'start' });
            highlightTocLink(sLink);
        };
        tocLinks.appendChild(sLink);

        // Add TMP if exists
        const tmpContainer = suite.querySelector('.tmp-set-container');
        if (tmpContainer) {
            const tmpLink = document.createElement('div');
            tmpLink.className = 'toc-link toc-tmp';
            tmpLink.textContent = ' TMP Section';
            tmpLink.onclick = () => {
                tmpContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                highlightTocLink(tmpLink);
            };
            tocLinks.appendChild(tmpLink);
        }

        // Add TGS Sets
        suite.querySelectorAll('.tgs-set-container').forEach((tgs, tIdx) => {
            const tLink = document.createElement('div');
            tLink.className = 'toc-link toc-tgs';
            const docNo = document.getElementById(`suite${sIdx}_set${tIdx}_docNo`)?.value || `TGS Set ${tIdx + 1}`;
            tLink.textContent = ` ${docNo}`;
            tLink.onclick = () => {
                tgs.scrollIntoView({ behavior: 'smooth', block: 'start' });
                highlightTocLink(tLink);
            };
            tocLinks.appendChild(tLink);
        });
    });
}

function highlightTocLink(link) {
    document.querySelectorAll('.toc-link.active').forEach(el => el.classList.remove('active'));
    link.classList.add('active');
}

// Initialize TOC toggle
document.addEventListener('DOMContentLoaded', () => {
    const tocToggle = document.getElementById('toc-toggle');
    if (tocToggle) {
        tocToggle.addEventListener('click', () => {
            document.getElementById('sticky-toc').classList.toggle('open');
            updateTOC(); // Refresh on open
        });
    }
});
</script>
<script>
let currentSketchTarget = null;
function openSketchPad(targetInputId) {
    let modal = document.getElementById('sketch-modal');
    if(!modal) {
        modal = document.createElement('div');
        modal.id = 'sketch-modal';
        modal.className = 'modal-overlay no-print';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <h3>Draw Diagram</h3>
                <canvas id="sketch-canvas" width="500" height="300" style="border:1px solid #ccc; background: #fff; cursor: crosshair; touch-action: none;"></canvas>
                <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-danger" onclick="clearSketch()">Clear</button>
                    <button class="btn btn-primary" onclick="saveSketch()">Save to Comment</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('sketch-modal').style.display='none'">Cancel</button>
                </div>
            </div>`;
    }
}

// Lazy-loading TGS set helpers (added from lazzyloading.js)

// Initialize first TGS set when TMP is ready
function initializeFirstTGSSet(suiteIndex) {
    const container = document.getElementById(`multi-tgs-container-suite-${suiteIndex}`);
    if (!container) return;
    
    // Only create first set if none exist
    if (container.children.length === 0) {
        addNewLazyTGSSet(suiteIndex, { skipPrompt: true });
    }
}

// Add a new TGS set dynamically
function addNewLazyTGSSet(suiteIndex, options = {}) {
    const container = document.getElementById(`multi-tgs-container-suite-${suiteIndex}`);
    if (!container) return;
    
    const existingCount = container.querySelectorAll('.tgs-set-container').length;
    const newSetIndex = existingCount;
    
    // Prompt for TGS name - skip for non-designers (they'll load from file)
    const currentRole = document.getElementById('role')?.value;
    const isDesigner = currentRole === 'designer';
    const { skipPrompt = false, suggestedName } = options;
    const defaultName = suggestedName || `TGS Set ${newSetIndex + 1}`;
    let inputName = defaultName;

    // Only prompt designers; non-designers get their name from the loaded file
    if (!skipPrompt && isDesigner) {
        const response = prompt(`Enter name for this TGS set:`, defaultName);
        if (response === null) return; // User cancelled
        inputName = response.trim() || defaultName;
    }

    const resolvedName = (skipPrompt && suggestedName ? suggestedName : inputName)?.trim() || defaultName;
    
    const setWrapper = document.createElement('div');
    setWrapper.className = 'tgs-set-container';
    setWrapper.dataset.suiteIndex = suiteIndex;
    setWrapper.dataset.setIndex = newSetIndex;
    setWrapper.dataset.type = 'tgs';
    
    // Build the HTML for this set
    setWrapper.innerHTML = `
        <div class="focus-mode-status-pill" aria-live="polite">Normal Mode</div>
        <div class="focus-mode-banner" style="display: none;"></div>
        
        <button type="button" class="btn btn-warning conflict-review-btn no-print" 
                onclick="openConflictReview(${suiteIndex}, ${newSetIndex}, 'tgs')" 
                style="margin-bottom:10px;">Review Flagged Items</button>
        
        <div class="progress-bar-container no-print" style="display: flex; align-items: center; gap: 16px;">
            <div class="progress-bar" id="suite${suiteIndex}_progress-bar-set${newSetIndex}">0%</div>
            <div id="suite${suiteIndex}_chart-set${newSetIndex}" class="chart-donut"><span class="chart-text">0%</span></div>
        </div>
        
        <h2 class="tgs-set-header no-print" data-doc-no-id="suite${suiteIndex}_set${newSetIndex}_docNo" 
            style="display:flex; align-items:center; justify-content:space-between;">
            <span>${resolvedName}</span>
            <span style="display:flex; gap:8px; align-items:center;">
                <span class="current-user-pill" id="suite${suiteIndex}_set${newSetIndex}_currentUserPill" 
                      style="padding:2px 8px; border-radius:999px; font-size:0.8em; border:1px solid transparent; display:none;"></span>
                <span class="status-pill" id="suite${suiteIndex}_set${newSetIndex}_statusPill" 
                      style="padding:2px 8px; border-radius:999px; font-size:0.8em; border:1px solid transparent;"></span>
            </span>
        </h2>
        
        <!-- Action Buttons for This Set -->
        <div class="tgs-set-actions no-print" style="margin: 15px 0 25px; padding: 15px; background: var(--surface-elevated); border-radius: 12px; border: 1px solid var(--border-color);">
            <p style="margin: 0 0 12px 0; font-size: 0.9em; color: var(--text-secondary);">
                <strong> Tip:</strong> Load a TGS file first, then use "Copy From Another Set" to duplicate answers to additional sets.
            </p>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                <!-- Load File Button - uses section-load-btn class for event delegation, no inline onclick -->
                <button type="button" class="btn btn-load section-load-btn" 
                        data-suite-index="${suiteIndex}" data-set-index="${newSetIndex}" data-type="tgs"
                        style="flex: 1; min-width: 150px;">
                    <svg><use href="#icon-upload"></use></svg>
                    <span> Load TGS File</span>
                </button>
                
                <!-- Copy from Previous (only show if not first set) -->
                ${newSetIndex > 0 ? `
                    <button type="button" class="btn btn-secondary" 
                            onclick="copyFromPreviousTGSSet(${suiteIndex}, ${newSetIndex})"
                            style="flex: 1; min-width: 150px;">
                         Copy From Another Set
                    </button>
                ` : ''}
                
                <!-- Remove This Set (only if not the only set) -->
                ${newSetIndex > 0 || existingCount > 0 ? `
                    <button type="button" class="btn btn-danger btn-sm" 
                            onclick="removeTGSSet(${suiteIndex}, ${newSetIndex})"
                            style="padding: 8px 16px;">
                         Remove
                    </button>
                ` : ''}
            </div>
        </div>
        
        ${buildChecklist(suiteIndex, newSetIndex, 'tgs')}
        ${buildSignOffSection(suiteIndex, newSetIndex, 'tgs')}
    `;
    
    container.appendChild(setWrapper);
    
    // Set the TGS name in the docNo field
    const docNoField = document.getElementById(`suite${suiteIndex}_set${newSetIndex}_docNo`);
    if (docNoField) {
        docNoField.value = resolvedName;
        docNoField.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    // Setup listeners and UI updates
    if (typeof registerLazySection === 'function') registerLazySection(setWrapper);
    if (typeof setupAllEventListeners === 'function') setupAllEventListeners();
    if (typeof updateFormSetAccess === 'function') updateFormSetAccess();
    if (typeof updateTgsStatusPills === 'function') updateTgsStatusPills();
    if (typeof attachValidationRules === 'function') attachValidationRules(setWrapper);
    if (typeof scheduleSectionNavigatorRefresh === 'function') scheduleSectionNavigatorRefresh();
    
    // Update load button visibility for designer new project mode
    if (typeof updateLoadButtonsVisibility === 'function') {
        updateLoadButtonsVisibility(currentRole);
    }
    
    // Scroll to the new set
    setTimeout(() => {
        setWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Only show toast if landing page is not visible
        const landingPage = document.getElementById('landing-page');
        const isLandingVisible = landingPage && landingPage.style.display !== 'none';
        if (typeof showToast === 'function' && !isLandingVisible) {
            showToast(`TGS Set ${newSetIndex + 1} created. Load a file or enter data manually.`, 'New Set Added', 'info');
        }
    }, 100);
}

// Load file into a specific TGS set
function loadIntoThisTGSSet(suiteIndex, setIndex) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.style.display = 'none';
    document.body.appendChild(input);
    
    input.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) {
            document.body.removeChild(input);
            return;
        }

        try {
            const content = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (ev) => resolve(ev.target.result);
                reader.onerror = (err) => reject(new Error('Failed to read file: ' + err));
                reader.readAsText(file);
            });

            console.log('TGS Load - File read result:', { 
                fileName: file.name, 
                fileSize: file.size, 
                contentLength: content ? content.length : 0 
            });

            if (!content || content.trim().length === 0) {
                alert(`Error: The file "${file.name}" appears to be empty (size: ${file.size} bytes). Please check the file and try again.`);
                return;
            }

            const json = JSON.parse(content);
            let sectionData = null;

            // Handle different file formats
            if (json.kind === 'tgs-section' && json.data) {
                sectionData = { 
                    data: json.data, 
                    topLevel: json.topLevel || {},
                    docNo: json.docNo || '',
                    suiteName: json.suiteName || '',
                    suiteDetails: json.suiteDetails || {}
                };
            } else if (json.suites && json.suites[suiteIndex] && json.suites[suiteIndex].formSets) {
                const sourceSuite = json.suites[suiteIndex];
                const formSets = sourceSuite.formSets;
                if (formSets[setIndex]) {
                    sectionData = { 
                        data: formSets[setIndex], 
                        topLevel: json.topLevel || {},
                        suiteName: sourceSuite.suiteName || ''
                    };
                } else if (formSets[0]) {
                    sectionData = { 
                        data: formSets[0], 
                        topLevel: json.topLevel || {},
                        suiteName: sourceSuite.suiteName || ''
                    };
                }
            } else if (json.formSets && json.formSets[setIndex]) {
                sectionData = { data: json.formSets[setIndex], suiteName: json.suiteName || '' };
            } else if (json.formSets && json.formSets[0]) {
                sectionData = { data: json.formSets[0], suiteName: json.suiteName || '' };
            } else if (json.data) {
                sectionData = { data: json.data, docNo: json.docNo || '', suiteName: json.suiteName || '' };
            }

            if (!sectionData || !sectionData.data) {
                alert('No valid TGS data found in this file for the selected set.');
                return;
            }

            // applySectionDataObject handles its own beginFileLoad/endFileLoad
            if (typeof applySectionDataObject === 'function') {
                applySectionDataObject(suiteIndex, setIndex, 'tgs', sectionData);
            }
            if (typeof showToast === 'function') {
                showToast(`TGS Set ${setIndex + 1} loaded successfully`, 'File Loaded', 'success');
            }
        } catch (error) {
            console.error('Load error:', error);
            alert('Error loading file: ' + error.message);
        } finally {
            if (document.body.contains(input)) {
                document.body.removeChild(input);
            }
        }
    });
    
    input.click();
}

// Copy data from another TGS set
function copyFromPreviousTGSSet(suiteIndex, targetSetIndex) {
    const targetContainer = document.querySelector(
        `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${targetSetIndex}"]`
    );
    if (!targetContainer) {
        alert('Target set could not be found.');
        return;
    }

    const suiteContainer = document.getElementById(`multi-tgs-container-suite-${suiteIndex}`);
    if (!suiteContainer) return;

    const availableIndices = Array.from(suiteContainer.querySelectorAll('.tgs-set-container'))
        .map(set => parseInt(set.dataset.setIndex, 10))
        .filter(idx => idx !== targetSetIndex)
        .sort((a, b) => a - b);

    if (availableIndices.length === 0) {
        alert('No other TGS sets are available to copy from.');
        return;
    }

    // Default to the immediately previous set when present
    let sourceSetIndex = availableIndices.includes(targetSetIndex - 1)
        ? targetSetIndex - 1
        : availableIndices[0];

    if (availableIndices.length > 1) {
        const optionList = availableIndices.map(idx => {
            const label = document.getElementById(`suite${suiteIndex}_set${idx}_docNo`)?.value?.trim() || `TGS Set ${idx + 1}`;
            return `${idx + 1}: ${label}`;
        }).join('\n');

        const selection = prompt(
            `Copy responses into Set ${targetSetIndex + 1}.\n\nAvailable source sets:\n${optionList}\n\nEnter the set number to copy from:`,
            (sourceSetIndex + 1).toString()
        );

        if (selection === null) return; // user cancelled

        const chosenIndex = parseInt(selection, 10) - 1;
        if (!availableIndices.includes(chosenIndex)) {
            alert('Invalid set number. Copy cancelled.');
            return;
        }
        sourceSetIndex = chosenIndex;
    }

    const sourceContainer = document.querySelector(
        `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${sourceSetIndex}"]`
    );
    if (!sourceContainer) {
        alert('Selected source set could not be found.');
        return;
    }

    const sourceName = document.getElementById(`suite${suiteIndex}_set${sourceSetIndex}_docNo`)?.value?.trim() || `TGS Set ${sourceSetIndex + 1}`;
    const targetName = document.getElementById(`suite${suiteIndex}_set${targetSetIndex}_docNo`)?.value?.trim() || `TGS Set ${targetSetIndex + 1}`;

    if (!confirm(`Copy all answers from "${sourceName}" into "${targetName}"?\n\nSign-off fields will not be copied.`)) {
        return;
    }

    window._isCopyingData = true;
    let copiedCount = 0;

    try {
        sourceContainer.querySelectorAll('.form-field').forEach(field => {
            const fieldId = field.id || '';

            // Skip TGS name, sign-offs, actions, decisions, and file links
            if (fieldId.includes('_docNo') ||
                fieldId.includes('_signoff_') ||
                fieldId.includes('_completion_check_') ||
                fieldId.includes('_action') ||
                fieldId.includes('_decision') ||
                fieldId.includes('_tgsFileLink')) {
                return;
            }

            const targetFieldId = fieldId.replace(`_set${sourceSetIndex}_`, `_set${targetSetIndex}_`);
            const targetField = document.getElementById(targetFieldId);
            if (!targetField) return;

            try {
                if (field.type === 'checkbox' || field.type === 'radio') {
                    targetField.checked = field.checked;
                } else {
                    targetField.value = field.value;
                }
                copiedCount++;
            } catch (error) {
                console.warn('Copy field error:', error);
            }
        });
    } finally {
        window._isCopyingData = false;
    }

    if (typeof debouncedSaveState === 'function') debouncedSaveState();
    const currentRole = document.getElementById('role')?.value;
    if (currentRole && typeof updateProgressBars === 'function') updateProgressBars(currentRole);

    if (typeof showToast === 'function') {
        showToast(`${copiedCount} fields copied from ${sourceName} into ${targetName}`, 'Copy Complete', 'success');
    }
}

// Remove a TGS set
function removeTGSSet(suiteIndex, setIndex) {
    const container = document.querySelector(
        `.tgs-set-container[data-suite-index="${suiteIndex}"][data-set-index="${setIndex}"]`
    );
    
    if (!container) return;
    
    const docNo = document.getElementById(`suite${suiteIndex}_set${setIndex}_docNo`)?.value || `Set ${setIndex + 1}`;
    
    if (!confirm(`Remove "${docNo}"?\n\nThis cannot be undone.`)) {
        return;
    }
    
    container.remove();
    
    // Re-index remaining sets
    reindexTGSSets(suiteIndex);
    
    if (typeof showToast === 'function') showToast(`${docNo} removed`, 'Set Removed', 'info');
    if (typeof debouncedSaveState === 'function') debouncedSaveState();
}

// Re-index TGS sets after removal
function reindexTGSSets(suiteIndex) {
    const container = document.getElementById(`multi-tgs-container-suite-${suiteIndex}`);
    if (!container) return;
    
    const sets = container.querySelectorAll('.tgs-set-container');
    
    sets.forEach((set, newIndex) => {
        const oldIndex = set.dataset.setIndex;
        
        if (parseInt(oldIndex) !== newIndex) {
            // Update dataset
            set.dataset.setIndex = newIndex;
            
            // Update all IDs and names within this set
            // Use regex with word boundary to prevent set1 matching set10
            const regex = new RegExp(`_set${oldIndex}(_|$)`, 'g');
            set.querySelectorAll('[id], [name]').forEach(el => {
                if (el.id) {
                    el.id = el.id.replace(regex, `_set${newIndex}$1`);
                }
                if (el.name) {
                    el.name = el.name.replace(regex, `_set${newIndex}$1`);
                }
            });
            
            // Update header text
            const header = set.querySelector('.tgs-set-header span:first-child');
            if (header && header.textContent.includes('Set')) {
                const docNoField = set.querySelector('[id$="_docNo"]');
                const docNo = docNoField?.value || `Set ${newIndex + 1}`;
                header.textContent = docNo;
            }
            
            // Update action button onclick attributes
            set.querySelectorAll('button[onclick]').forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick) {
                    btn.setAttribute('onclick', onclick.replace(
                        new RegExp(`, ${oldIndex}\\)`, 'g'),
                        `, ${newIndex})`
                    ));
                }
            });
        }
    });
    
    // Refresh UI
    if (typeof setupAllEventListeners === 'function') setupAllEventListeners();
    if (typeof updateFormSetAccess === 'function') updateFormSetAccess();
    if (typeof updateTgsStatusPills === 'function') updateTgsStatusPills();
}

// Override the old generateFormSets to use lazy-loading behaviour
function generateFormSets(suiteIndex) {
    const container = document.getElementById(`multi-tgs-container-suite-${suiteIndex}`);
    if (!container) return;

    const countInput = document.getElementById(`suite${suiteIndex}_calculatedFormSetsCount`);
    const requestedCount = parseInt(countInput?.value, 10);
    const totalSets = Number.isFinite(requestedCount) && requestedCount > 0 ? requestedCount : 1;

    container.innerHTML = '';
    for (let i = 0; i < totalSets; i++) {
        addNewLazyTGSSet(suiteIndex, { skipPrompt: true });
    }
}

</script>
<script>
    // ============================================================
    // FIX: CONSOLIDATED LOADING SYSTEM (Place at end of body)
    // ============================================================
    
    // 1. Robust Loading System that forces visibility - reassign existing variable
    LoadingSystem = {
        show: function(message = "Loading...") {
            const overlay = document.getElementById('loading-overlay');
            const text = document.getElementById('loading-text');
            
            if (overlay) {
                // Force display flex to override any inline 'display: none'
                overlay.style.display = 'flex';
                // Small timeout to allow browser to register display change before opacity transition
                requestAnimationFrame(() => {
                    overlay.classList.add('active');
                    overlay.style.opacity = '1';
                });
            }
            if (text) text.textContent = message;
        },
        hide: function() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.classList.remove('active');
                
                // Wait for transition to finish before hiding
                setTimeout(() => {
                    if (!overlay.classList.contains('active')) {
                        overlay.style.display = 'none';
                    }
                }, 300);
            }
        }
    };

    // 2. Overwrite the Old System to use the New System
    // This ensures "Load TGS File" buttons use the nice animation instantly
    window.beginFileLoad = function(suiteIndex = null, setIndex = null, type = null) {
        window._fileLoadDepth = (window._fileLoadDepth || 0) + 1;
        window._isLoadingFromFile = true;
        
        // Track section
        if (suiteIndex !== null) {
            window._loadingSection = { suiteIndex, setIndex, type };
        }
        
        // SHOW IMMEDIATELY (Removed the 300ms delay)
        LoadingSystem.show("Processing File...");
    };

    window.endFileLoad = function() {
        window._fileLoadDepth = Math.max(0, (window._fileLoadDepth || 0) - 1);
        
        if (window._fileLoadDepth === 0) {
            // Hide the new system
            LoadingSystem.hide();
            
            // Clean up old system if it was triggered
            const oldOverlay = document.getElementById('file-loading-overlay');
            if (oldOverlay) oldOverlay.style.display = 'none';
            
            window._loadingSection = null;
            
            // Small buffer to ensure UI is ready
            setTimeout(() => { 
                if (window._fileLoadDepth === 0) window._isLoadingFromFile = false; 
            }, 50);
        }
    };

    // 3. Shim legacy calls just in case
    window.showLoadingOverlay = function(msg) { LoadingSystem.show(msg); };
    window.hideLoadingOverlay = function() { LoadingSystem.hide(); };

    console.log(" Loading Animation Fix Applied: Delays removed.");
</script>
<script>
    // ============================================
    // FEATURE: VOICE DICTATION
    // ============================================
    (function enableVoiceDictation() {
        // Check browser support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return; // Feature not supported, do nothing

        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-AU'; // Australian English
        recognition.interimResults = false;

        let activeInput = null;

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            if (activeInput) {
                // Append text if not empty, otherwise set it
                const currentVal = activeInput.value;
                activeInput.value = currentVal ? currentVal + " " + transcript : transcript;
                activeInput.dispatchEvent(new Event('input', { bubbles: true })); // Trigger auto-save
                showToast(' Text added: "' + transcript + '"', 'Dictation', 'info');
            }
        };

        recognition.onend = function() {
            if (activeInput && activeInput.nextElementSibling && activeInput.nextElementSibling.classList.contains('mic-btn')) {
                activeInput.nextElementSibling.style.color = '#94a3b8'; // Reset color
                activeInput.nextElementSibling.classList.remove('listening');
            }
        };

        // Add Mic Button to all Textareas
        function attachMic(textarea) {
            if (textarea.parentNode.querySelector('.mic-btn')) return; // Already attached

            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            textarea.parentNode.insertBefore(wrapper, textarea);
            wrapper.appendChild(textarea);

            const btn = document.createElement('button');
            btn.innerHTML = '';
            btn.className = 'mic-btn no-print';
            btn.title = "Click to Speak";
            btn.type = "button"; // Prevent form submit
            
            // Style the button
            btn.style.cssText = `
                position: absolute; bottom: 8px; right: 8px; 
                background: transparent; border: none; font-size: 1.2rem; 
                cursor: pointer; opacity: 0.6; transition: all 0.2s;
                color: #94a3b8; z-index: 10;
            `;

            btn.onmouseover = () => btn.style.opacity = '1';
            btn.onmouseout = () => { if(!btn.classList.contains('listening')) btn.style.opacity = '0.6'; };

            btn.onclick = (e) => {
                e.preventDefault();
                if (btn.classList.contains('listening')) {
                    recognition.stop();
                } else {
                    activeInput = textarea;
                    btn.classList.add('listening');
                    btn.style.color = '#ef4444'; // Red when recording
                    btn.style.transform = 'scale(1.2)';
                    recognition.start();
                }
            };

            wrapper.appendChild(btn);
        }

        // Attach to existing
        document.querySelectorAll('textarea.form-field').forEach(attachMic);

        // Observer for lazy-loaded sections
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) {
                        if (node.tagName === 'TEXTAREA' && node.classList.contains('form-field')) attachMic(node);
                        node.querySelectorAll?.('textarea.form-field').forEach(attachMic);
                    }
                });
            });
        });
        observer.observe(document.body, { childList: true, subtree: true });
        
        // console.log(" Voice Dictation Enabled");
    })();

    // ============================================
    // FEATURE: ACTIVE SCROLLSPY (TOC HIGHLIGHT)
    // ============================================
    (function enableScrollSpy() {
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -60% 0px', // Active when element is in top-middle of screen
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute('id') || entry.target.getAttribute('data-section-id');
                    // Find matching link in TOC
                    // We search by text content mostly as IDs might differ slightly in your generation logic
                    const headerText = entry.target.querySelector('.accordion-header, h2')?.textContent?.trim();
                    
                    if (headerText) {
                        document.querySelectorAll('.toc-link').forEach(link => {
                            if (link.textContent.includes(headerText) || (id && link.dataset.targetId === id)) {
                                link.classList.add('active');
                                // Auto-scroll sidebar to keep link in view
                                link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            } else {
                                link.classList.remove('active');
                            }
                        });
                    }
                }
            });
        }, observerOptions);

        // Hook into the DOM
        function observeSections() {
            document.querySelectorAll('.project-suite-container, .tgs-set-container, .tmp-set-container').forEach(section => {
                observer.observe(section);
            });
        }

        // Run initially and whenever DOM changes (lazy load)
        observeSections();
        
        // Local debounce helper for this scope
        const localDebounce = (fn, delay) => {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        };
        
        const domObserver = new MutationObserver(localDebounce(observeSections, 500));
        const suiteContainer = document.getElementById('multi-suite-container');
        if (suiteContainer) {
            domObserver.observe(suiteContainer, { childList: true, subtree: true });
        }
        
        // console.log(" ScrollSpy TOC Highlight Enabled");
    })();

    // ============================================
    // FEATURE: CELEBRATION CONFETTI
    // ============================================
    function fireConfetti() {
        const canvas = document.createElement('canvas');
        canvas.style.position = 'fixed';
        canvas.style.top = '0';
        canvas.style.left = '0';
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        canvas.style.pointerEvents = 'none';
        canvas.style.zIndex = '99999';
        document.body.appendChild(canvas);

        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const particles = [];
        const colors = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#3b82f6'];

        for (let i = 0; i < 150; i++) {
            particles.push({
                x: window.innerWidth / 2,
                y: window.innerHeight / 2,
                r: Math.random() * 6 + 2,
                dx: Math.random() * 10 - 5,
                dy: Math.random() * 10 - 5,
                color: colors[Math.floor(Math.random() * colors.length)],
                life: 100
            });
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, index) => {
                p.x += p.dx;
                p.y += p.dy;
                p.dy += 0.2; // Gravity
                p.life--;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
                if (p.life <= 0) particles.splice(index, 1);
            });

            if (particles.length > 0) requestAnimationFrame(animate);
            else document.body.removeChild(canvas);
        }
        animate();
    }

    // Hook into your existing generateFinalReport function
    const originalFinalize = window.generateFinalReport;
    window.generateFinalReport = function() {
        // Run the original logic
        const result = originalFinalize.apply(this, arguments);
        
        // If the summary container is visible, it means it succeeded
        const summary = document.getElementById('final-summary-container');
        if (summary && summary.style.display !== 'none') {
            fireConfetti();
        }
        return result;
    };
    
    // console.log(" Celebration Confetti Enabled");
</script>
</body>
</html>